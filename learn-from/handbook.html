<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>handbook</title>
  <style>

code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}

html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
background-color: #232629;
color: #7a7c7d;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d; padding-left: 4px; }
div.sourceCode
{ color: #cfcfc2; background-color: #232629; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #cfcfc2; } 
code span.al { color: #95da4c; background-color: #4d1f24; font-weight: bold; } 
code span.an { color: #3f8058; } 
code span.at { color: #2980b9; } 
code span.bn { color: #f67400; } 
code span.bu { color: #7f8c8d; } 
code span.cf { color: #fdbc4b; font-weight: bold; } 
code span.ch { color: #3daee9; } 
code span.cn { color: #27aeae; font-weight: bold; } 
code span.co { color: #7a7c7d; } 
code span.cv { color: #7f8c8d; } 
code span.do { color: #a43340; } 
code span.dt { color: #2980b9; } 
code span.dv { color: #f67400; } 
code span.er { color: #da4453; text-decoration: underline; } 
code span.ex { color: #0099ff; font-weight: bold; } 
code span.fl { color: #f67400; } 
code span.fu { color: #8e44ad; } 
code span.im { color: #27ae60; } 
code span.in { color: #c45b00; } 
code span.kw { color: #cfcfc2; font-weight: bold; } 
code span.op { color: #cfcfc2; } 
code span.ot { color: #27ae60; } 
code span.pp { color: #27ae60; } 
code span.re { color: #2980b9; background-color: #153042; } 
code span.sc { color: #3daee9; } 
code span.ss { color: #da4453; } 
code span.st { color: #f44f4f; } 
code span.va { color: #27aeae; } 
code span.vs { color: #da4453; } 
code span.wa { color: #da4453; } 
</style>
  <style type="text/css">body {
background-color: #0d0d0d;
color: #e0e0e0;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
line-height: 1.7;
padding: 50px;
max-width: 900px;
margin: 0 auto;
}
h1, h2, h3, h4 { color: #61afef; }
h1 { border-bottom: 2px solid #61afef; padding-bottom: 12px; margin-top: 2.5em; }
h2 { margin-top: 2.5em; color: #c678dd; }
h3 { color: #98c379; }
h4 { color: #e5c07b; }
a { color: #56b6c2; }
a:hover { color: #61afef; }
code {
background-color: #1a1a1a;
color: #e06c75;
padding: 3px 8px;
border-radius: 4px;
font-family: "SF Mono", "Fira Code", Menlo, Monaco, monospace;
font-size: 0.9em;
}
pre {
background-color: #1a1a1a;
padding: 20px;
border-radius: 8px;
overflow-x: auto;
font-size: 14px;
border: 1px solid #2a2a2a;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
}
pre code {
padding: 0;
background: none;
color: #abb2bf;
}

code span.kw { color: #c678dd; font-weight: bold; } 
code span.dt { color: #e5c07b; } 
code span.dv { color: #d19a66; } 
code span.bn { color: #d19a66; } 
code span.fl { color: #d19a66; } 
code span.ch { color: #98c379; } 
code span.st { color: #98c379; } 
code span.co { color: #5c6370; font-style: italic; } 
code span.ot { color: #56b6c2; } 
code span.al { color: #e06c75; font-weight: bold; } 
code span.fu { color: #61afef; } 
code span.er { color: #e06c75; font-weight: bold; } 
code span.wa { color: #e5c07b; font-weight: bold; } 
code span.cn { color: #d19a66; } 
code span.sc { color: #98c379; } 
code span.vs { color: #98c379; } 
code span.ss { color: #98c379; } 
code span.im { color: #c678dd; } 
code span.va { color: #e06c75; } 
code span.cf { color: #c678dd; font-weight: bold; } 
code span.op { color: #56b6c2; } 
code span.bu { color: #e5c07b; } 
code span.ex { color: #61afef; } 
code span.pp { color: #c678dd; } 
code span.at { color: #d19a66; } 
code span.do { color: #5c6370; font-style: italic; } 
code span.an { color: #5c6370; font-style: italic; } 
code span.cv { color: #5c6370; font-style: italic; } 
code span.in { color: #5c6370; font-style: italic; } 
blockquote {
border-left: 4px solid #c678dd;
padding-left: 20px;
color: #98c379;
background-color: #141414;
margin: 20px 0;
padding: 16px 20px;
border-radius: 0 8px 8px 0;
font-style: italic;
}
table {
border-collapse: collapse;
width: 100%;
margin: 20px 0;
}
th, td {
border: 1px solid #333;
padding: 12px 16px;
text-align: left;
}
th {
background-color: #1a1a1a;
color: #61afef;
font-weight: 600;
}
tr:nth-child(even) { background-color: #141414; }
tr:hover { background-color: #1f1f1f; }
hr {
border: none;
border-top: 1px solid #333;
margin: 3em 0;
}
ul, ol {
padding-left: 28px;
}
li {
margin: 6px 0;
}
li code {
background-color: #1a1a1a;
}
strong { color: #e5c07b; }
em { color: #c678dd; }
#TOC {
background-color: #141414;
padding: 24px;
border-radius: 8px;
margin-bottom: 2.5em;
border: 1px solid #2a2a2a;
}
#TOC a {
text-decoration: none;
color: #61afef;
}
#TOC a:hover {
text-decoration: underline;
color: #98c379;
}
#TOC ul {
list-style-type: none;
padding-left: 20px;
}
#TOC > ul {
padding-left: 0;
}

h1 {
page-break-before: always;
}
h1:first-of-type {
page-break-before: avoid;
}
pre {
page-break-inside: avoid;
}
</style>
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#ai-dj-resonance---complete-developer-handbook" id="toc-ai-dj-resonance---complete-developer-handbook">AI DJ (Resonance)
- Complete Developer Handbook</a>
<ul>
<li><a href="#purpose" id="toc-purpose">Purpose</a></li>
</ul></li>
<li><a href="#table-of-contents" id="toc-table-of-contents">TABLE OF
CONTENTS</a></li>
<li><a href="#swift-language-fundamentals" id="toc-swift-language-fundamentals">1. SWIFT LANGUAGE FUNDAMENTALS</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj" id="toc-why-this-matters-for-ai-dj">Why This Matters for AI DJ</a></li>
<li><a href="#core-language-syntax" id="toc-core-language-syntax">1.1
Core Language Syntax</a></li>
<li><a href="#control-flow" id="toc-control-flow">1.2 Control
Flow</a></li>
<li><a href="#functions" id="toc-functions">1.3 Functions</a></li>
<li><a href="#optionals" id="toc-optionals">1.4 Optionals</a></li>
<li><a href="#closures" id="toc-closures">1.5 Closures</a></li>
<li><a href="#error-handling" id="toc-error-handling">1.6 Error
Handling</a></li>
<li><a href="#generics" id="toc-generics">1.7 Generics</a></li>
<li><a href="#memory-management-arc" id="toc-memory-management-arc">1.8
Memory Management (ARC)</a></li>
<li><a href="#key-takeaways---swift-fundamentals" id="toc-key-takeaways---swift-fundamentals">Key Takeaways - Swift
Fundamentals</a></li>
</ul></li>
<li><a href="#xcode-apple-development-environment" id="toc-xcode-apple-development-environment">2. XCODE &amp; APPLE
DEVELOPMENT ENVIRONMENT</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-1" id="toc-why-this-matters-for-ai-dj-1">Why This Matters for AI
DJ</a></li>
<li><a href="#xcode-interface" id="toc-xcode-interface">2.1 Xcode
Interface</a></li>
<li><a href="#project-structure" id="toc-project-structure">2.2 Project
Structure</a></li>
<li><a href="#swift-package-manager" id="toc-swift-package-manager">2.3
Swift Package Manager</a></li>
<li><a href="#capabilities-and-entitlements" id="toc-capabilities-and-entitlements">2.4 Capabilities and
Entitlements</a></li>
<li><a href="#debugging" id="toc-debugging">2.5 Debugging</a></li>
<li><a href="#key-takeaways---xcode" id="toc-key-takeaways---xcode">Key
Takeaways - Xcode</a></li>
</ul></li>
<li><a href="#swiftui-framework" id="toc-swiftui-framework">3. SWIFTUI
FRAMEWORK</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-2" id="toc-why-this-matters-for-ai-dj-2">Why This Matters for AI
DJ</a></li>
<li><a href="#the-declarative-paradigm" id="toc-the-declarative-paradigm">3.1 The Declarative Paradigm</a></li>
<li><a href="#basic-views" id="toc-basic-views">3.2 Basic Views</a></li>
<li><a href="#layout" id="toc-layout">3.3 Layout</a></li>
<li><a href="#state-management" id="toc-state-management">3.4 State
Management</a></li>
<li><a href="#navigation" id="toc-navigation">3.5 Navigation</a></li>
<li><a href="#ai-dj-example---now-playing-view" id="toc-ai-dj-example---now-playing-view">3.6 AI DJ Example - Now
Playing View</a></li>
<li><a href="#key-takeaways---swiftui" id="toc-key-takeaways---swiftui">Key Takeaways - SwiftUI</a></li>
</ul></li>
<li><a href="#swift-concurrency-combine" id="toc-swift-concurrency-combine">4. SWIFT CONCURRENCY &amp;
COMBINE</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-3" id="toc-why-this-matters-for-ai-dj-3">Why This Matters for AI
DJ</a></li>
<li><a href="#asyncawait-basics" id="toc-asyncawait-basics">4.1
Async/Await Basics</a></li>
<li><a href="#structured-concurrency" id="toc-structured-concurrency">4.2 Structured Concurrency</a></li>
<li><a href="#actors---safe-concurrent-state" id="toc-actors---safe-concurrent-state">4.3 Actors - Safe Concurrent
State</a></li>
<li><a href="#combine-framework" id="toc-combine-framework">4.4 Combine
Framework</a></li>
<li><a href="#key-takeaways---swift-concurrency-combine" id="toc-key-takeaways---swift-concurrency-combine">Key Takeaways - Swift
Concurrency &amp; Combine</a></li>
</ul></li>
<li><a href="#data-persistence-with-coredata" id="toc-data-persistence-with-coredata">5. DATA PERSISTENCE WITH
COREDATA</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-4" id="toc-why-this-matters-for-ai-dj-4">Why This Matters for AI
DJ</a></li>
<li><a href="#coredata-stack" id="toc-coredata-stack">5.1 CoreData
Stack</a></li>
<li><a href="#crud-operations" id="toc-crud-operations">5.2 CRUD
Operations</a></li>
<li><a href="#swiftui-integration" id="toc-swiftui-integration">5.3
SwiftUI Integration</a></li>
<li><a href="#background-processing-and-cloudkit-sync" id="toc-background-processing-and-cloudkit-sync">5.4 Background
Processing and CloudKit Sync</a></li>
<li><a href="#key-takeaways---coredata" id="toc-key-takeaways---coredata">Key Takeaways - CoreData</a></li>
</ul></li>
<li><a href="#ios-app-architecture-patterns" id="toc-ios-app-architecture-patterns">6. iOS APP ARCHITECTURE
PATTERNS</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-5" id="toc-why-this-matters-for-ai-dj-5">Why This Matters for AI
DJ</a></li>
<li><a href="#mvvm-pattern" id="toc-mvvm-pattern">6.1 MVVM
Pattern</a></li>
<li><a href="#dependency-injection" id="toc-dependency-injection">6.2
Dependency Injection</a></li>
<li><a href="#service-layer-pattern" id="toc-service-layer-pattern">6.3
Service Layer Pattern</a></li>
<li><a href="#the-brain---core-logic-module" id="toc-the-brain---core-logic-module">6.4 The Brain - Core Logic
Module</a></li>
<li><a href="#key-takeaways---architecture" id="toc-key-takeaways---architecture">Key Takeaways -
Architecture</a></li>
</ul></li>
<li><a href="#musickit-framework" id="toc-musickit-framework">7.
MUSICKIT FRAMEWORK</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-6" id="toc-why-this-matters-for-ai-dj-6">Why This Matters for AI
DJ</a></li>
<li><a href="#authorization" id="toc-authorization">7.1
Authorization</a></li>
<li><a href="#fetching-music" id="toc-fetching-music">7.2 Fetching
Music</a></li>
<li><a href="#playback-control" id="toc-playback-control">7.3 Playback
Control</a></li>
<li><a href="#ai-dj-musickit-service" id="toc-ai-dj-musickit-service">7.4 AI DJ MusicKit Service</a></li>
<li><a href="#key-takeaways---musickit" id="toc-key-takeaways---musickit">Key Takeaways - MusicKit</a></li>
</ul></li>
<li><a href="#healthkit-framework" id="toc-healthkit-framework">8.
HEALTHKIT FRAMEWORK</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-7" id="toc-why-this-matters-for-ai-dj-7">Why This Matters for AI
DJ</a></li>
<li><a href="#authorization-1" id="toc-authorization-1">8.1
Authorization</a></li>
<li><a href="#reading-health-data" id="toc-reading-health-data">8.2
Reading Health Data</a></li>
<li><a href="#real-time-monitoring" id="toc-real-time-monitoring">8.3
Real-Time Monitoring</a></li>
<li><a href="#ai-dj-healthkit-service" id="toc-ai-dj-healthkit-service">8.4 AI DJ HealthKit Service</a></li>
<li><a href="#key-takeaways---healthkit" id="toc-key-takeaways---healthkit">Key Takeaways - HealthKit</a></li>
</ul></li>
<li><a href="#watchos-development" id="toc-watchos-development">9.
WATCHOS DEVELOPMENT</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-8" id="toc-why-this-matters-for-ai-dj-8">Why This Matters for AI
DJ</a></li>
<li><a href="#watchos-project-setup" id="toc-watchos-project-setup">9.1
watchOS Project Setup</a></li>
<li><a href="#healthkit-on-watchos" id="toc-healthkit-on-watchos">9.2
HealthKit on watchOS</a></li>
<li><a href="#watch-app-architecture" id="toc-watch-app-architecture">9.3 Watch App Architecture</a></li>
<li><a href="#key-takeaways---watchos" id="toc-key-takeaways---watchos">Key Takeaways - watchOS</a></li>
</ul></li>
<li><a href="#watchconnectivity-framework" id="toc-watchconnectivity-framework">10. WATCHCONNECTIVITY FRAMEWORK</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-9" id="toc-why-this-matters-for-ai-dj-9">Why This Matters for AI
DJ</a></li>
<li><a href="#setup-and-activation" id="toc-setup-and-activation">10.1
Setup and Activation</a></li>
<li><a href="#data-transfer-methods" id="toc-data-transfer-methods">10.2
Data Transfer Methods</a></li>
<li><a href="#complete-ai-dj-connectivity" id="toc-complete-ai-dj-connectivity">10.3 Complete AI DJ
Connectivity</a></li>
<li><a href="#key-takeaways---watchconnectivity" id="toc-key-takeaways---watchconnectivity">Key Takeaways -
WatchConnectivity</a></li>
</ul></li>
<li><a href="#macos-development-menu-bar-apps" id="toc-macos-development-menu-bar-apps">11. MACOS DEVELOPMENT (MENU BAR
APPS)</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-10" id="toc-why-this-matters-for-ai-dj-10">Why This Matters for AI
DJ</a></li>
<li><a href="#menu-bar-app-structure" id="toc-menu-bar-app-structure">11.1 Menu Bar App Structure</a></li>
<li><a href="#syncing-with-iphone" id="toc-syncing-with-iphone">11.2
Syncing with iPhone</a></li>
<li><a href="#macos-specific-considerations" id="toc-macos-specific-considerations">11.3 macOS-Specific
Considerations</a></li>
<li><a href="#key-takeaways---macos-menu-bar" id="toc-key-takeaways---macos-menu-bar">Key Takeaways - macOS Menu
Bar</a></li>
</ul></li>
<li><a href="#background-processing-app-lifecycle" id="toc-background-processing-app-lifecycle">12. BACKGROUND PROCESSING
&amp; APP LIFECYCLE</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-11" id="toc-why-this-matters-for-ai-dj-11">Why This Matters for AI
DJ</a></li>
<li><a href="#app-lifecycle" id="toc-app-lifecycle">12.1 App
Lifecycle</a></li>
<li><a href="#background-modes" id="toc-background-modes">12.2
Background Modes</a></li>
<li><a href="#healthkit-background-delivery" id="toc-healthkit-background-delivery">12.3 HealthKit Background
Delivery</a></li>
<li><a href="#key-takeaways---background-processing" id="toc-key-takeaways---background-processing">Key Takeaways -
Background Processing</a></li>
</ul></li>
<li><a href="#widgets-complications" id="toc-widgets-complications">13.
WIDGETS &amp; COMPLICATIONS</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-12" id="toc-why-this-matters-for-ai-dj-12">Why This Matters for AI
DJ</a></li>
<li><a href="#ios-widgets-widgetkit" id="toc-ios-widgets-widgetkit">13.1
iOS Widgets (WidgetKit)</a></li>
<li><a href="#watch-complications" id="toc-watch-complications">13.2
Watch Complications</a></li>
<li><a href="#key-takeaways---widgets-complications" id="toc-key-takeaways---widgets-complications">Key Takeaways - Widgets
&amp; Complications</a></li>
</ul></li>
<li><a href="#biometrics-signal-processing" id="toc-biometrics-signal-processing">14. BIOMETRICS &amp; SIGNAL
PROCESSING</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-13" id="toc-why-this-matters-for-ai-dj-13">Why This Matters for AI
DJ</a></li>
<li><a href="#heart-rate-fundamentals" id="toc-heart-rate-fundamentals">14.1 Heart Rate Fundamentals</a></li>
<li><a href="#signal-processing" id="toc-signal-processing">14.2 Signal
Processing</a></li>
<li><a href="#user-state-classification" id="toc-user-state-classification">14.3 User State
Classification</a></li>
<li><a href="#key-takeaways---biometrics-signal-processing" id="toc-key-takeaways---biometrics-signal-processing">Key Takeaways -
Biometrics &amp; Signal Processing</a></li>
</ul></li>
<li><a href="#algorithm-scoring-system-design" id="toc-algorithm-scoring-system-design">15. ALGORITHM &amp; SCORING
SYSTEM DESIGN</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-14" id="toc-why-this-matters-for-ai-dj-14">Why This Matters for AI
DJ</a></li>
<li><a href="#scoring-fundamentals" id="toc-scoring-fundamentals">15.1
Scoring Fundamentals</a></li>
<li><a href="#ranking-and-selection" id="toc-ranking-and-selection">15.2
Ranking and Selection</a></li>
<li><a href="#learning-from-feedback" id="toc-learning-from-feedback">15.3 Learning from Feedback</a></li>
<li><a href="#advanced-scoring-concepts" id="toc-advanced-scoring-concepts">15.4 Advanced Scoring
Concepts</a></li>
<li><a href="#key-takeaways---algorithm-scoring" id="toc-key-takeaways---algorithm-scoring">Key Takeaways - Algorithm
&amp; Scoring</a></li>
</ul></li>
<li><a href="#testing-in-swift" id="toc-testing-in-swift">16. TESTING IN
SWIFT</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-15" id="toc-why-this-matters-for-ai-dj-15">Why This Matters for AI
DJ</a></li>
<li><a href="#xctest-basics" id="toc-xctest-basics">16.1 XCTest
Basics</a></li>
<li><a href="#async-testing" id="toc-async-testing">16.2 Async
Testing</a></li>
<li><a href="#dependency-injection-for-testability" id="toc-dependency-injection-for-testability">16.3 Dependency Injection
for Testability</a></li>
<li><a href="#ui-testing" id="toc-ui-testing">16.4 UI Testing</a></li>
<li><a href="#key-takeaways---testing" id="toc-key-takeaways---testing">Key Takeaways - Testing</a></li>
</ul></li>
<li><a href="#security-privacy-entitlements" id="toc-security-privacy-entitlements">17. SECURITY, PRIVACY &amp;
ENTITLEMENTS</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-16" id="toc-why-this-matters-for-ai-dj-16">Why This Matters for AI
DJ</a></li>
<li><a href="#privacy-permissions" id="toc-privacy-permissions">17.1
Privacy Permissions</a></li>
<li><a href="#data-security" id="toc-data-security">17.2 Data
Security</a></li>
<li><a href="#entitlements" id="toc-entitlements">17.3
Entitlements</a></li>
<li><a href="#key-takeaways---security-privacy" id="toc-key-takeaways---security-privacy">Key Takeaways - Security &amp;
Privacy</a></li>
</ul></li>
<li><a href="#app-distribution-deployment" id="toc-app-distribution-deployment">18. APP DISTRIBUTION &amp;
DEPLOYMENT</a>
<ul>
<li><a href="#why-this-matters-for-ai-dj-17" id="toc-why-this-matters-for-ai-dj-17">Why This Matters for AI
DJ</a></li>
<li><a href="#build-archive" id="toc-build-archive">18.1 Build &amp;
Archive</a></li>
<li><a href="#testflight" id="toc-testflight">18.2 TestFlight</a></li>
<li><a href="#app-store-submission" id="toc-app-store-submission">18.3
App Store Submission</a></li>
<li><a href="#release-management" id="toc-release-management">18.4
Release Management</a></li>
<li><a href="#key-takeaways---distribution" id="toc-key-takeaways---distribution">Key Takeaways -
Distribution</a></li>
</ul></li>
<li><a href="#conclusion" id="toc-conclusion">Conclusion</a></li>
</ul>
</nav>
<h1 id="ai-dj-resonance---complete-developer-handbook">AI DJ (Resonance)
- Complete Developer Handbook</h1>
<h2 id="purpose">Purpose</h2>
<p>This handbook provides detailed explanations of every concept listed
in learning.md. It assumes basic programming knowledge but explains
Swift and iOS-specific concepts from the ground up. Use this as your
primary reference while building the AI DJ project.</p>
<p><strong>How to use this handbook:</strong> - Each section starts with
<strong>why this concept matters for AI DJ</strong> - Code snippets
include <strong>what weâ€™re doing</strong> and <strong>what
happens</strong> explanations - Real examples show <strong>how AI DJ
uses this concept</strong> - Key takeaways are highlighted at section
ends</p>
<hr />
<h1 id="table-of-contents">TABLE OF CONTENTS</h1>
<ol type="1">
<li><a href="#1-swift-language-fundamentals">Swift Language
Fundamentals</a></li>
<li><a href="#2-xcode--apple-development-environment">Xcode &amp; Apple
Development Environment</a></li>
<li><a href="#3-swiftui-framework">SwiftUI Framework</a></li>
<li><a href="#4-swift-concurrency--combine">Swift Concurrency &amp;
Combine</a></li>
<li><a href="#5-data-persistence-with-coredata">Data Persistence with
CoreData</a></li>
<li><a href="#6-ios-app-architecture-patterns">iOS App Architecture
Patterns</a></li>
<li><a href="#7-musickit-framework">MusicKit Framework</a></li>
<li><a href="#8-healthkit-framework">HealthKit Framework</a></li>
<li><a href="#9-watchos-development">watchOS Development</a></li>
<li><a href="#10-watchconnectivity-framework">WatchConnectivity
Framework</a></li>
<li><a href="#11-macos-development-menu-bar-apps">macOS Development
(Menu Bar Apps)</a></li>
<li><a href="#12-background-processing--app-lifecycle">Background
Processing &amp; App Lifecycle</a></li>
<li><a href="#13-widgets--complications">Widgets &amp;
Complications</a></li>
<li><a href="#14-biometrics--signal-processing-concepts">Biometrics
&amp; Signal Processing Concepts</a></li>
<li><a href="#15-algorithm--scoring-system-design">Algorithm &amp;
Scoring System Design</a></li>
<li><a href="#16-testing-in-swift">Testing in Swift</a></li>
<li><a href="#17-security-privacy--entitlements">Security, Privacy &amp;
Entitlements</a></li>
<li><a href="#18-app-distribution--deployment">App Distribution &amp;
Deployment</a></li>
</ol>
<hr />
<h1 id="swift-language-fundamentals">1. SWIFT LANGUAGE FUNDAMENTALS</h1>
<h2 id="why-this-matters-for-ai-dj">Why This Matters for AI DJ</h2>
<p>Swift is the language that powers every line of code in our AI DJ
project. Whether weâ€™re reading heart rate data from Apple Watch,
querying playlists from MusicKit, or calculating song scores, weâ€™ll
write it all in Swift. Understanding Swiftâ€™s safety features (like
optionals and strong typing) is crucial because weâ€™re handling real-time
health data where crashes or incorrect values could ruin the user
experience.</p>
<p><strong>In AI DJ, youâ€™ll use Swift to:</strong> - Define data
structures for songs, playlists, and biometric readings - Write
algorithms that calculate song scores based on user state - Handle
asynchronous operations like fetching health data - Manage state across
iOS, watchOS, and macOS platforms</p>
<hr />
<h2 id="core-language-syntax">1.1 Core Language Syntax</h2>
<h3 id="variables-constants">Variables &amp; Constants</h3>
<p>Swift distinguishes between values that can change and values that
stay fixed. This distinction helps the compiler catch bugs early and
enables important performance optimizations. Unlike many other languages
where mutability is the default, Swift encourages immutability by making
<code>let</code> (constants) the preferred choice. This design
philosophy stems from functional programming principles and helps
prevent entire categories of bugs related to unexpected state
changes.</p>
<p>When you declare a variable with <code>let</code>, youâ€™re making a
promise to the compiler that this value will never change after its
initial assignment. The compiler uses this information to optimize your
code and catch mistakes at compile time rather than runtime. When you
use <code>var</code>, youâ€™re explicitly signaling that this value will
be modified during the programâ€™s execution.</p>
<p><strong>What weâ€™re doing:</strong> Declaring storage for values in
our program using Swiftâ€™s two declaration keywords.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">constant</span> <span class="op">=</span> <span class="dv">42</span>        <span class="co">// Cannot be changed after assignment</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">variable</span> <span class="op">=</span> <span class="dv">42</span>        <span class="co">// Can be reassigned</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>variable <span class="op">=</span> <span class="dv">100</span>          <span class="co">// OK - variables can change</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">// constant = 100       // Compile error! Constants cannot change</span></span></code></pre></div>
<p><strong>What happens:</strong> The compiler enforces immutability for
<code>let</code> constants. If you try to modify a constant, your code
wonâ€™t compile. This prevents accidental changes to values that should
stay fixed.</p>
<p><strong>Why this matters:</strong> - <strong><code>let</code>
(constants):</strong> Use by default. When we store a songâ€™s ID or a
userâ€™s baseline heart rate, we donâ€™t want it accidentally changed.
Constants also enable compiler optimizations. - <strong><code>var</code>
(variables):</strong> Use when the value genuinely needs to change, like
a running average of heart rate samples or the current playback
position.</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// These never change once set, so we use &#39;let&#39;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">songId</span> <span class="op">=</span> <span class="st">&quot;abc123&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">userBaseline</span> <span class="op">=</span> <span class="fl">72.5</span>  <span class="co">// Resting heart rate</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">// These change during playback, so we use &#39;var&#39;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">currentBPM</span> <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">heartRateSamples</span><span class="op">:</span> <span class="op">[</span>Double<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span></code></pre></div>
<hr />
<h3 id="type-inference-and-explicit-types">Type Inference and Explicit
Types</h3>
<p>Swift is a statically-typed language, meaning every variable has a
fixed type that cannot change at runtime. However, Swiftâ€™s type
inference system means you rarely need to write types explicitlyâ€”the
compiler analyzes your code and determines the appropriate type based on
context. This gives you the safety of static typing with the convenience
of dynamic-feeling code.</p>
<p>The type inference engine examines the right-hand side of
assignments, function return types, and surrounding context to deduce
types. For example, if you write <code>let x = 42</code>, Swift sees the
integer literal and infers <code>Int</code>. If you write
<code>let x = 42.0</code>, it infers <code>Double</code>. This happens
at compile time, so thereâ€™s no runtime performance costâ€”your code runs
exactly as fast as if you had written all the types explicitly.</p>
<p><strong>What weâ€™re doing:</strong> Letting Swift determine types
automatically, or explicitly specifying them when needed for clarity or
to override the default inference.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Swift automatically determines these types from the values</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;AI DJ&quot;</span>       <span class="co">// Swift infers this is a String</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">count</span> <span class="op">=</span> <span class="dv">42</span>           <span class="co">// Swift infers this is an Int</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">price</span> <span class="op">=</span> <span class="fl">9.99</span>         <span class="co">// Swift infers this is a Double</span></span></code></pre></div>
<p><strong>What happens:</strong> The compiler analyzes the right-hand
side of each assignment and determines the appropriate type. Once set,
the type is fixedâ€”you canâ€™t assign a String to a variable the compiler
determined was an Int.</p>
<p><strong>When to be explicit:</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Sometimes we need to tell Swift exactly what we want</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">explicitDouble</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">42</span>    <span class="co">// We want 42.0, not Int 42</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">songId</span><span class="op">:</span> String <span class="op">=</span> <span class="st">&quot;abc123&quot;</span>      <span class="co">// Being clear about the type</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">heartRate</span><span class="op">:</span> Float <span class="op">=</span> <span class="fl">72.5</span>        <span class="co">// Using Float instead of Double</span></span></code></pre></div>
<p><strong>Why be explicit?</strong> When working with HealthKit, values
often need to be specific types. Heart rate is typically a
<code>Double</code>, but some APIs expect <code>Float</code>. Being
explicit prevents subtle type mismatch bugs.</p>
<hr />
<h3 id="string-interpolation">String Interpolation</h3>
<p>We frequently need to combine text with valuesâ€”for logging, UI
display, or debugging. In many languages, this requires awkward
concatenation with plus signs or format specifiers. Swift provides
string interpolation, a clean syntax that lets you embed any expression
directly within a string literal using the <code>\()</code> syntax.</p>
<p>String interpolation is not just syntactic sugarâ€”itâ€™s type-safe and
extensible. Any type that conforms to
<code>CustomStringConvertible</code> (which includes all standard types)
can be interpolated. You can even include complex expressions, method
calls, and ternary operators inside the interpolation braces. The Swift
compiler converts these interpolations into efficient string building
operations at compile time.</p>
<p><strong>What weâ€™re doing:</strong> Embedding variable values and
expressions directly into strings using <code>\()</code> syntax, which
Swift evaluates and converts to string representations.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> <span class="st">&quot;Bohemian Rhapsody&quot;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">artist</span> <span class="op">=</span> <span class="st">&quot;Queen&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">bpm</span> <span class="op">=</span> <span class="dv">76</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Combine text and values seamlessly</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">message</span> <span class="op">=</span> <span class="st">&quot;Now playing: </span><span class="er">\(</span><span class="st">song) by </span><span class="er">\(</span><span class="st">artist)&quot;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Result: &quot;Now playing: Bohemian Rhapsody by Queen&quot;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">debugInfo</span> <span class="op">=</span> <span class="st">&quot;Song BPM: </span><span class="er">\(</span><span class="st">bpm), matches target: </span><span class="er">\(</span><span class="st">bpm &gt; 70)&quot;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Result: &quot;Song BPM: 76, matches target: true&quot;</span></span></code></pre></div>
<p><strong>What happens:</strong> Swift evaluates each <code>\()</code>
expression and converts the result to a string, inserting it at that
position. This works with any type that can be converted to a
string.</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">heartRate</span> <span class="op">=</span> <span class="fl">85.0</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">stressLevel</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">selectedSong</span> <span class="op">=</span> <span class="st">&quot;Calm Waters&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>print<span class="op">(</span><span class="st">&quot;HR: </span><span class="er">\(</span><span class="st">heartRate) BPM | Stress: </span><span class="er">\(</span><span class="st">stressLevel) | Playing: </span><span class="er">\(</span><span class="st">selectedSong)&quot;</span><span class="op">)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Output: &quot;HR: 85.0 BPM | Stress: 0.3 | Playing: Calm Waters&quot;</span></span></code></pre></div>
<hr />
<h3 id="basic-types">Basic Types</h3>
<p>Swift provides built-in primitive types for common data, each
carefully designed for specific use cases. Understanding which type to
use is crucial for writing efficient, bug-free code. Swiftâ€™s type system
is stricter than languages like JavaScript or Pythonâ€”you cannot
accidentally mix an integer with a string, and numeric types donâ€™t
implicitly convert to each other. This strictness catches bugs at
compile time that would otherwise cause subtle runtime errors.</p>
<p>The numeric types in Swift come in various sizes (8, 16, 32, and 64
bits), but in most cases youâ€™ll use <code>Int</code> for whole numbers
and <code>Double</code> for decimals. <code>Int</code> automatically
uses the native word size of your platform (64-bit on all modern Apple
devices), providing the best performance. <code>Double</code> uses
64-bit IEEE 754 floating point, offering approximately 15-17 significant
decimal digits of precisionâ€”more than enough for biometric calculations
in AI DJ.</p>
<p><strong>What weâ€™re doing:</strong> Understanding the fundamental
building blocks for storing different kinds of data and choosing the
appropriate type for each use case.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// INTEGERS - Whole numbers</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Use for: counts, indices, discrete values</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">age</span><span class="op">:</span> Int <span class="op">=</span> <span class="dv">30</span>                    <span class="co">// Platform-native size (64-bit on modern devices)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">playCount</span><span class="op">:</span> Int <span class="op">=</span> <span class="dv">42</span>              <span class="co">// How many times a song was played</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">skipCount</span><span class="op">:</span> Int <span class="op">=</span> <span class="dv">3</span>               <span class="co">// How many times user skipped</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">// FLOATING POINT - Numbers with decimals</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Use Double for most cases (better precision)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">heartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">72.5</span>         <span class="co">// 64-bit, ~15 decimal digits precision</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">score</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.847</span>            <span class="co">// Song ranking scores</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">percentage</span><span class="op">:</span> Float <span class="op">=</span> <span class="fl">0.95</span>         <span class="co">// 32-bit, ~6 decimal digits (rarely needed)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">// TEXT</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">title</span><span class="op">:</span> String <span class="op">=</span> <span class="st">&quot;Hello&quot;</span>          <span class="co">// Song title, artist name, etc.</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">emoji</span><span class="op">:</span> Character <span class="op">=</span> <span class="st">&quot;ðŸŽµ&quot;</span>          <span class="co">// Single character</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">// BOOLEAN - True/False</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">isPlaying</span><span class="op">:</span> Bool <span class="op">=</span> <span class="kw">true</span>           <span class="co">// Only two possible values</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">needsCalm</span><span class="op">:</span> Bool <span class="op">=</span> <span class="kw">false</span></span></code></pre></div>
<p><strong>What happens:</strong> Swift allocates the appropriate amount
of memory for each type. <code>Int</code> and <code>Double</code> are 64
bits on modern Apple devices, giving them large ranges and high
precision.</p>
<p><strong>Important - Type Safety:</strong> Swift prevents you from
accidentally mixing types that could cause data loss:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">intValue</span> <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">doubleValue</span> <span class="op">=</span> <span class="fl">3.14</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">// This would cause a compile error:</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">// let sum = intValue + doubleValue  // Error: Can&#39;t add Int to Double!</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">// You must explicitly convert:</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">sum</span> <span class="op">=</span> Double<span class="op">(</span>intValue<span class="op">)</span> <span class="op">+</span> doubleValue  <span class="co">// OK: 45.14</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">// This prevents subtle bugs like:</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">// let result = 5 / 2       // In some languages this is 2.5, in Swift it&#39;s 2 (Int division)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> <span class="fl">5.0</span> <span class="op">/</span> <span class="fl">2.0</span>     <span class="co">// This is 2.5 (Double division)</span></span></code></pre></div>
<p><strong>Why this matters for AI DJ:</strong> When calculating song
scores, we need precision. A score of 0.847 vs 0.85 could change which
song gets selected. Using <code>Double</code> ensures we have the
precision needed for our ranking algorithms.</p>
<hr />
<h3 id="collection-types">Collection Types</h3>
<p>We constantly work with groups of dataâ€”lists of songs, heart rate
samples, song scores. Swift provides three main collection types, each
optimized for different access patterns. Choosing the right collection
can make the difference between code that runs instantly and code that
crawls, especially when processing hundreds of songs or thousands of
health samples.</p>
<p>All Swift collections are value types that use copy-on-write
optimization. This means passing a collection to a function or assigning
it to another variable doesnâ€™t immediately copy all the dataâ€”Swift only
creates a copy when you actually modify one of the copies. This gives
you the safety of value semantics with the performance of reference
semantics in most cases.</p>
<h4 id="array---ordered-lists">Array - Ordered Lists</h4>
<p>Arrays are Swiftâ€™s most commonly used collection type. They store
elements in a specific order and allow duplicate values. Elements are
accessed by their zero-based integer index. Under the hood, arrays use
contiguous memory storage, which makes index-based access extremely fast
(constant time O(1)) but insertion and deletion in the middle slower
(linear time O(n)) because elements must be shifted.</p>
<p><strong>What weâ€™re doing:</strong> Storing ordered sequences of items
of the same type, where position matters and we may need to access
elements by their numeric index.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating arrays</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>String<span class="op">]</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Song A&quot;</span><span class="op">,</span> <span class="st">&quot;Song B&quot;</span><span class="op">,</span> <span class="st">&quot;Song C&quot;</span><span class="op">]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">heartRateSamples</span> <span class="op">=</span> <span class="op">[</span><span class="fl">72.0</span><span class="op">,</span> <span class="fl">74.5</span><span class="op">,</span> <span class="fl">71.0</span><span class="op">,</span> <span class="fl">73.5</span><span class="op">]</span>  <span class="co">// Type inferred as [Double]</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">empty</span><span class="op">:</span> <span class="op">[</span>Double<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span>  <span class="co">// Empty array, ready to be filled</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Accessing elements (indices start at 0)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">firstSong</span> <span class="op">=</span> songs<span class="op">[</span><span class="dv">0</span><span class="op">]</span>              <span class="co">// &quot;Song A&quot;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">lastSong</span> <span class="op">=</span> songs<span class="op">[</span>songs<span class="op">.</span>count <span class="op">-</span> <span class="dv">1</span><span class="op">]</span> <span class="co">// &quot;Song C&quot;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Safer access with optional</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">maybeSong</span> <span class="op">=</span> songs<span class="op">.</span>first           <span class="co">// Optional(&quot;Song A&quot;)</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">safeLast</span> <span class="op">=</span> songs<span class="op">.</span>last             <span class="co">// Optional(&quot;Song C&quot;)</span></span></code></pre></div>
<p><strong>What happens:</strong> Arrays store elements in contiguous
memory, making index access very fast (O(1)). Accessing an out-of-bounds
index crashes your app, so always check bounds or use safe methods like
<code>.first</code> and <code>.last</code>.</p>
<p><strong>Modifying arrays:</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Adding elements</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>songs<span class="op">.</span>append<span class="op">(</span><span class="st">&quot;Song D&quot;</span><span class="op">)</span>                <span class="co">// Add to end: [&quot;Song A&quot;, &quot;Song B&quot;, &quot;Song C&quot;, &quot;Song D&quot;]</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>songs<span class="op">.</span>insert<span class="op">(</span><span class="st">&quot;Song Z&quot;</span><span class="op">,</span> at<span class="op">:</span> <span class="dv">0</span><span class="op">)</span>         <span class="co">// Insert at position: [&quot;Song Z&quot;, &quot;Song A&quot;, ...]</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Removing elements</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>songs<span class="op">.</span>remove<span class="op">(</span>at<span class="op">:</span> <span class="dv">1</span><span class="op">)</span>                   <span class="co">// Remove second element</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>songs<span class="op">.</span>removeLast<span class="op">()</span>                    <span class="co">// Remove and return last element</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>songs<span class="op">.</span>removeAll<span class="op">()</span>                     <span class="co">// Clear the array</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Replacing</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>songs<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;New Song&quot;</span>                 <span class="co">// Replace first element</span></span></code></pre></div>
<p><strong>Iterating (very common in AI DJ):</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Process each song</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> song <span class="cf">in</span> songs <span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">// When you need the index too</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>index<span class="op">,</span> song<span class="op">)</span> <span class="cf">in</span> songs<span class="op">.</span>enumerated<span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">index + 1). </span><span class="er">\(</span><span class="st">song)&quot;</span><span class="op">)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate average of heart rate samples</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">total</span> <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sample <span class="cf">in</span> heartRateSamples <span class="op">{</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    total <span class="op">+=</span> sample</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">average</span> <span class="op">=</span> total <span class="op">/</span> Double<span class="op">(</span>heartRateSamples<span class="op">.</span>count<span class="op">)</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Store the last 10 heart rate readings for smoothing</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">recentHeartRates</span><span class="op">:</span> <span class="op">[</span>Double<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">recordHeartRate</span><span class="op">(</span><span class="va">_</span> <span class="va">rate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    recentHeartRates<span class="op">.</span>append<span class="op">(</span>rate<span class="op">)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep only last 10 samples</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> recentHeartRates<span class="op">.</span>count <span class="op">&gt;</span> <span class="dv">10</span> <span class="op">{</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        recentHeartRates<span class="op">.</span>removeFirst<span class="op">()</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">getSmoothedHeartRate</span><span class="op">()</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="op">!</span>recentHeartRates<span class="op">.</span>isEmpty <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">sum</span> <span class="op">=</span> recentHeartRates<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> sum <span class="op">/</span> Double<span class="op">(</span>recentHeartRates<span class="op">.</span>count<span class="op">)</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h4 id="dictionary---key-value-pairs">Dictionary - Key-Value Pairs</h4>
<p>Dictionaries store associations between keys and values. Unlike
arrays where you access elements by position, dictionaries let you
access values using meaningful keysâ€”like looking up a songâ€™s score by
its ID. This is implemented using a hash table data structure, which
provides average O(1) constant-time lookups regardless of how many items
the dictionary contains. This makes dictionaries ideal for caching
computed values, storing configurations, and mapping identifiers to
objects.</p>
<p>The keys in a dictionary must conform to the <code>Hashable</code>
protocol, which includes all of Swiftâ€™s basic types (String, Int, Bool,
etc.) and any custom types you make Hashable. Values can be any type.
One important characteristic: dictionaries are unorderedâ€”you cannot rely
on items being in any particular sequence when you iterate.</p>
<p><strong>What weâ€™re doing:</strong> Storing data that can be looked up
by a unique key, enabling fast retrieval without knowing the position of
the data. This is perfect for mapping song IDs to scores or caching
computed effectiveness ratings.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating dictionaries</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">songScores</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Double<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;songA&quot;</span><span class="op">:</span> <span class="fl">0.85</span><span class="op">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;songB&quot;</span><span class="op">:</span> <span class="fl">0.72</span><span class="op">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;songC&quot;</span><span class="op">:</span> <span class="fl">0.93</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Accessing values (returns Optional because key might not exist)</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">scoreA</span> <span class="op">=</span> songScores<span class="op">[</span><span class="st">&quot;songA&quot;</span><span class="op">]</span>      <span class="co">// Optional(0.85)</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">scoreMissing</span> <span class="op">=</span> songScores<span class="op">[</span><span class="st">&quot;xyz&quot;</span><span class="op">]</span>  <span class="co">// nil (key doesn&#39;t exist)</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Safe access with default value</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">safeScore</span> <span class="op">=</span> songScores<span class="op">[</span><span class="st">&quot;xyz&quot;</span><span class="op">,</span> <span class="kw">default</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">]</span>  <span class="co">// 0.0 (not nil)</span></span></code></pre></div>
<p><strong>What happens:</strong> Dictionaries use hash tables
internally, making lookups extremely fast (O(1) average). Unlike arrays,
order is not guaranteed.</p>
<p><strong>Modifying dictionaries:</strong></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Adding or updating (same syntax)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>songScores<span class="op">[</span><span class="st">&quot;songA&quot;</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.90</span>           <span class="co">// Update existing key</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>songScores<span class="op">[</span><span class="st">&quot;songD&quot;</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0.88</span>           <span class="co">// Add new key-value pair</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Removing</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>songScores<span class="op">[</span><span class="st">&quot;songB&quot;</span><span class="op">]</span> <span class="op">=</span> <span class="kw">nil</span>            <span class="co">// Remove by setting to nil</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>songScores<span class="op">.</span>removeValue<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;songC&quot;</span><span class="op">)</span>  <span class="co">// Remove with method</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Check if key exists</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> songScores<span class="op">[</span><span class="st">&quot;songA&quot;</span><span class="op">]</span> <span class="op">!=</span> <span class="kw">nil</span> <span class="op">{</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;songA has a score&quot;</span><span class="op">)</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Iterating:</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Process all key-value pairs</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>songId<span class="op">,</span> score<span class="op">)</span> <span class="cf">in</span> songScores <span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">songId): </span><span class="er">\(</span><span class="st">score)&quot;</span><span class="op">)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Just keys or values</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> songId <span class="cf">in</span> songScores<span class="op">.</span>keys <span class="op">{</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span>songId<span class="op">)</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> score <span class="cf">in</span> songScores<span class="op">.</span>values <span class="op">{</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span>score<span class="op">)</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Track effectiveness of each song for calming the user</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">songCalmingEffect</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Double<span class="op">]</span> <span class="op">=</span> <span class="op">[:]</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">updateSongEffect</span><span class="op">(</span><span class="va">songId</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">hrvChange</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Positive HRV change = calming effect</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">currentScore</span> <span class="op">=</span> songCalmingEffect<span class="op">[</span>songId<span class="op">,</span> <span class="kw">default</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">]</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Running average: blend new data with old</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">newScore</span> <span class="op">=</span> currentScore <span class="op">*</span> <span class="fl">0.7</span> <span class="op">+</span> hrvChange <span class="op">*</span> <span class="fl">0.3</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    songCalmingEffect<span class="op">[</span>songId<span class="op">]</span> <span class="op">=</span> newScore</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">getMostCalmingSong</span><span class="op">(</span><span class="va">from</span> <span class="va">candidates</span><span class="op">:</span> [<span class="dt">String</span>]<span class="op">)</span> -&gt; <span class="fu">String</span>? <span class="op">{</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">bestSong</span><span class="op">:</span> String<span class="op">?</span> <span class="op">=</span> <span class="kw">nil</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">bestScore</span> <span class="op">=</span> <span class="op">-</span>Double<span class="op">.</span>infinity</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> songId <span class="cf">in</span> candidates <span class="op">{</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">score</span> <span class="op">=</span> songCalmingEffect<span class="op">[</span>songId<span class="op">,</span> <span class="kw">default</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">]</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="op">&gt;</span> bestScore <span class="op">{</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            bestScore <span class="op">=</span> score</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            bestSong <span class="op">=</span> songId</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> bestSong</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h4 id="set---unique-unordered-collections">Set - Unique Unordered
Collections</h4>
<p>Sets are collections that store unique values with no defined order.
Like dictionaries, they use hash tables internally, providing O(1)
constant-time performance for insertion, deletion, and membership
testing. The key difference from arrays is that sets cannot contain
duplicatesâ€”adding a value that already exists has no effect.</p>
<p>Sets excel at tracking â€œhave we seen this before?â€ scenarios and
performing mathematical set operations like union, intersection, and
difference. In AI DJ, sets are perfect for tracking which songs have
been played in a session (preventing repeats) or finding songs that
match multiple criteria simultaneously.</p>
<p><strong>What weâ€™re doing:</strong> Storing unique items where we need
fast membership testing (â€œis this song in the played set?â€) and donâ€™t
care about order. Sets automatically enforce uniquenessâ€”attempting to
add a duplicate simply does nothing.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Creating sets</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">genres</span><span class="op">:</span> Set<span class="op">&lt;</span>String<span class="op">&gt;</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Rock&quot;</span><span class="op">,</span> <span class="st">&quot;Pop&quot;</span><span class="op">,</span> <span class="st">&quot;Jazz&quot;</span><span class="op">]</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">playedSongs</span><span class="op">:</span> Set<span class="op">&lt;</span>String<span class="op">&gt;</span> <span class="op">=</span> <span class="op">[]</span>  <span class="co">// Track which songs we&#39;ve played</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Sets automatically remove duplicates</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">numbers</span><span class="op">:</span> Set <span class="op">=</span> <span class="op">[</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">]</span>   <span class="co">// Becomes {1, 2, 3}</span></span></code></pre></div>
<p><strong>What happens:</strong> Sets use hash tables like
dictionaries, making contains checks very fast (O(1)). Order is not
preserved.</p>
<p><strong>Common operations:</strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Adding and removing</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>genres<span class="op">.</span>insert<span class="op">(</span><span class="st">&quot;Classical&quot;</span><span class="op">)</span>            <span class="co">// Add element</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>genres<span class="op">.</span>remove<span class="op">(</span><span class="st">&quot;Pop&quot;</span><span class="op">)</span>                  <span class="co">// Remove element</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Fast membership test</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> genres<span class="op">.</span>contains<span class="op">(</span><span class="st">&quot;Rock&quot;</span><span class="op">)</span> <span class="op">{</span>          <span class="co">// O(1) lookup</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Rock is available&quot;</span><span class="op">)</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Set operations (very useful!)</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">myGenres</span><span class="op">:</span> Set <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Rock&quot;</span><span class="op">,</span> <span class="st">&quot;Pop&quot;</span><span class="op">,</span> <span class="st">&quot;Jazz&quot;</span><span class="op">]</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">yourGenres</span><span class="op">:</span> Set <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Pop&quot;</span><span class="op">,</span> <span class="st">&quot;Classical&quot;</span><span class="op">,</span> <span class="st">&quot;Jazz&quot;</span><span class="op">]</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">union</span> <span class="op">=</span> myGenres<span class="op">.</span>union<span class="op">(</span>yourGenres<span class="op">)</span>              <span class="co">// All unique: {&quot;Rock&quot;, &quot;Pop&quot;, &quot;Jazz&quot;, &quot;Classical&quot;}</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">common</span> <span class="op">=</span> myGenres<span class="op">.</span>intersection<span class="op">(</span>yourGenres<span class="op">)</span>      <span class="co">// Both have: {&quot;Pop&quot;, &quot;Jazz&quot;}</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">onlyMine</span> <span class="op">=</span> myGenres<span class="op">.</span>subtracting<span class="op">(</span>yourGenres<span class="op">)</span>     <span class="co">// Only I have: {&quot;Rock&quot;}</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Avoid playing the same song twice in a session</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">playedInSession</span><span class="op">:</span> Set<span class="op">&lt;</span>String<span class="op">&gt;</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">selectNextSong</span><span class="op">(</span><span class="va">candidates</span><span class="op">:</span> [<span class="dt">String</span>]<span class="op">)</span> -&gt; <span class="fu">String</span>? <span class="op">{</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter out already-played songs</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">available</span> <span class="op">=</span> candidates<span class="op">.</span>filter <span class="op">{</span> <span class="op">!</span>playedInSession<span class="op">.</span>contains<span class="op">(</span>$<span class="dv">0</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">selected</span> <span class="op">=</span> available<span class="op">.</span>first <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// All songs played, reset session</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        playedInSession<span class="op">.</span>removeAll<span class="op">()</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> candidates<span class="op">.</span>first</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    playedInSession<span class="op">.</span>insert<span class="op">(</span>selected<span class="op">)</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> selected</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key Takeaway - When to use which collection:</strong> |
Collection | Use When | AI DJ Example | |â€”â€”â€”â€”|â€”â€”â€”-|â€”â€”â€”â€”â€”| | Array |
Order matters, duplicates OK | Heart rate samples over time | |
Dictionary | Need fast lookup by key | Song scores by song ID | | Set |
Need uniqueness, order irrelevant | Played songs in session |</p>
<hr />
<h2 id="control-flow">1.2 Control Flow</h2>
<p>Control flow statements determine which code executes and in what
order. Swift provides traditional constructs like <code>if</code>,
<code>switch</code>, and loops, but with important safety enhancements.
For example, Swiftâ€™s <code>switch</code> statements must be exhaustive
(covering all possible cases), and conditions must be explicitly Boolean
(no implicit truthiness like in JavaScript or Python).</p>
<h3 id="if-else-else-if">if / else / else if</h3>
<p>The <code>if</code> statement is the most basic control flow
construct, executing code only when a condition is true. Unlike C or
JavaScript, Swift requires the condition to be a genuine Boolean
valueâ€”you cannot use integers, optionals, or other values as implicit
booleans. This prevents common bugs where a programmer accidentally uses
an assignment (<code>=</code>) instead of a comparison
(<code>==</code>).</p>
<p>The <code>else if</code> clause allows chaining multiple conditions,
with Swift evaluating them in order and executing only the first
matching block. The optional <code>else</code> clause catches any case
not matched by the preceding conditions. This top-to-bottom evaluation
means you should order conditions from most specific to most
general.</p>
<p><strong>What weâ€™re doing:</strong> Making decisions in code based on
Boolean conditions, directing program flow to different code paths
depending on the current state.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">heartRate</span> <span class="op">=</span> <span class="dv">85</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Basic conditional</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> heartRate <span class="op">&lt;</span> <span class="dv">60</span> <span class="op">{</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Low heart rate - very relaxed or athletic&quot;</span><span class="op">)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> heartRate <span class="op">&lt;</span> <span class="dv">100</span> <span class="op">{</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Normal heart rate&quot;</span><span class="op">)</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Elevated heart rate - stressed or active&quot;</span><span class="op">)</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> Swift evaluates conditions
top-to-bottom and executes the first matching block. Only one block
runs, even if multiple conditions are true.</p>
<p><strong>Ternary operator for simple cases:</strong></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// When you just need to pick between two values</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">status</span> <span class="op">=</span> heartRate <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">?</span> <span class="st">&quot;High&quot;</span> <span class="op">:</span> <span class="st">&quot;Normal&quot;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Equivalent to:</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">// let status: String</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">// if heartRate &gt; 100 {</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">//     status = &quot;High&quot;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">// } else {</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">//     status = &quot;Normal&quot;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">// }</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">determineMusicNeed</span><span class="op">(</span><span class="va">heartRate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="va">recentTrend</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">String</span> <span class="op">{</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// recentTrend: positive = rising, negative = falling</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> heartRate <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">&amp;&amp;</span> recentTrend <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;calm&quot;</span>        <span class="co">// High and rising: user needs calming music</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> heartRate <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">&amp;&amp;</span> recentTrend <span class="op">&lt;=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;maintain&quot;</span>    <span class="co">// High but falling: current approach working</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> heartRate <span class="op">&lt;</span> <span class="dv">60</span> <span class="op">{</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;energize&quot;</span>    <span class="co">// Low HR: might need energy boost</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;neutral&quot;</span>     <span class="co">// Normal range</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="switch-statements">switch Statements</h3>
<p>Swiftâ€™s <code>switch</code> statement is far more powerful than its
counterparts in C or Java. It supports pattern matching against any type
(not just integers), requires exhaustiveness (you must handle every
possible case), and doesnâ€™t fall through by default (no need for
<code>break</code> statements). This design prevents the common bug of
forgetting a <code>break</code> and accidentally executing unintended
code.</p>
<p>The exhaustiveness requirement means the compiler verifies youâ€™ve
handled every possible value. For enums, this is checked against all
cases. For other types, you need a <code>default</code> clause to catch
unhandled values. This is a major safety featureâ€”when you add a new case
to an enum, the compiler tells you everywhere that needs updating.</p>
<p>Pattern matching in <code>switch</code> extends beyond simple
equality. You can match ranges (<code>0..&lt;60</code>), tuples,
optionals with binding, and even use <code>where</code> clauses for
additional conditions. This makes <code>switch</code> ideal for complex
classification logic like determining user state from multiple biometric
factors.</p>
<p><strong>What weâ€™re doing:</strong> Handling multiple specific cases
with pattern matching, ensuring exhaustive coverage of all
possibilities. Swiftâ€™s switch is a powerful tool for classifying values
into categories.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">context</span> <span class="op">=</span> <span class="st">&quot;workout&quot;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">switch</span> context <span class="op">{</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="st">&quot;workout&quot;</span><span class="op">:</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Play energetic music&quot;</span><span class="op">)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="st">&quot;sleep&quot;</span><span class="op">,</span> <span class="st">&quot;relax&quot;</span><span class="op">:</span>              <span class="co">// Compound case - multiple values</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Play calm music&quot;</span><span class="op">)</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="st">&quot;focus&quot;</span><span class="op">:</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Play instrumental music&quot;</span><span class="op">)</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="kw">default</span><span class="op">:</span>                             <span class="co">// Required - must handle all cases</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Play anything&quot;</span><span class="op">)</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> Swift matches the value against each
case and runs the matching block. Unlike C/Objective-C, Swift doesnâ€™t
fall through to the next case automatically (no <code>break</code>
needed).</p>
<p><strong>Pattern matching with ranges:</strong></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">bpm</span> <span class="op">=</span> <span class="dv">120</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="cf">switch</span> bpm <span class="op">{</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="fl">0.</span><span class="op">.&lt;</span><span class="dv">60</span><span class="op">:</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Very slow - ambient, meditation&quot;</span><span class="op">)</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="fl">60.</span><span class="op">.&lt;</span><span class="dv">100</span><span class="op">:</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Moderate - chill, acoustic&quot;</span><span class="op">)</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="fl">100.</span><span class="op">.&lt;</span><span class="dv">140</span><span class="op">:</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Upbeat - pop, rock&quot;</span><span class="op">)</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="fl">140.</span><span class="op">..:</span>                         <span class="co">// 140 and above</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Fast - electronic, workout&quot;</span><span class="op">)</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="kw">default</span><span class="op">:</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Unknown&quot;</span><span class="op">)</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Value binding - capture matched values:</strong></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">songMatch</span> <span class="op">=</span> <span class="op">(</span><span class="st">&quot;energize&quot;</span><span class="op">,</span> <span class="fl">0.87</span><span class="op">)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="cf">switch</span> songMatch <span class="op">{</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="op">(</span><span class="st">&quot;calm&quot;</span><span class="op">,</span> <span class="kw">let</span> <span class="va">score</span><span class="op">)</span> <span class="kw">where</span> score <span class="op">&gt;</span> <span class="fl">0.8</span><span class="op">:</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Excellent calm song, score: </span><span class="er">\(</span><span class="st">score)&quot;</span><span class="op">)</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="op">(</span><span class="st">&quot;energize&quot;</span><span class="op">,</span> <span class="kw">let</span> <span class="va">score</span><span class="op">)</span> <span class="kw">where</span> score <span class="op">&gt;</span> <span class="fl">0.8</span><span class="op">:</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Excellent energy song, score: </span><span class="er">\(</span><span class="st">score)&quot;</span><span class="op">)</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="op">(</span><span class="kw">let</span> <span class="va">category</span><span class="op">,</span> <span class="kw">let</span> <span class="va">score</span><span class="op">):</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">category) song with score </span><span class="er">\(</span><span class="st">score)&quot;</span><span class="op">)</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> UserState <span class="op">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> resting</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> active</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> stressed</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> recovering</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">selectPlaylistStrategy</span><span class="op">(</span><span class="va">for</span> <span class="va">state</span><span class="op">:</span> <span class="dt">UserState</span><span class="op">,</span> <span class="va">timeOfDay</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">String</span> <span class="op">{</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>state<span class="op">,</span> timeOfDay<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(.</span>resting<span class="op">,</span> <span class="fl">6.</span><span class="op">.&lt;</span><span class="dv">10</span><span class="op">):</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;gentle-morning&quot;</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(.</span>resting<span class="op">,</span> _<span class="op">):</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;ambient&quot;</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(.</span>active<span class="op">,</span> _<span class="op">):</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;high-energy&quot;</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(.</span>stressed<span class="op">,</span> <span class="fl">18.</span><span class="op">.&lt;</span><span class="dv">24</span><span class="op">):</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;evening-wind-down&quot;</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(.</span>stressed<span class="op">,</span> _<span class="op">):</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;calming&quot;</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">(.</span>recovering<span class="op">,</span> _<span class="op">):</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="st">&quot;recovery-ramp&quot;</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="guard-statements---early-exit-pattern">guard Statements - Early
Exit Pattern</h3>
<p>The <code>guard</code> statement is one of Swiftâ€™s most beloved
features, embodying the â€œearly returnâ€ or â€œbouncer patternâ€ used by
experienced developers. The philosophy is simple: check for invalid
conditions at the start of a function and exit immediately if theyâ€™re
not met, rather than wrapping your entire function body in nested
<code>if</code> statements.</p>
<p>This pattern eliminates the â€œpyramid of doomâ€â€”the rightward drift of
deeply nested conditions that makes code hard to read. With
<code>guard</code>, your preconditions are checked at the top, any bound
variables remain in scope for the rest of the function, and your main
logic stays at the base indentation level. The compiler enforces that
the <code>guard</code>â€™s else clause must exit the current scope (via
<code>return</code>, <code>throw</code>, <code>break</code>,
<code>continue</code>, or <code>fatalError</code>), guaranteeing that if
execution continues past the guard, all conditions were satisfied.</p>
<p><strong>What weâ€™re doing:</strong> Validating preconditions at the
start of functions and exiting early if theyâ€™re not met. This inverts
the typical pattern of nesting success cases inside failure checks,
leading to cleaner, more readable code.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">processHeartRate</span><span class="op">(</span><span class="va">_</span> <span class="va">rate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">?)</span> <span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Without guard - nested &quot;pyramid of doom&quot;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="va">rate</span> <span class="op">=</span> rate <span class="op">{</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rate <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> rate <span class="op">&lt;</span> <span class="dv">300</span> <span class="op">{</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Actually process...</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// With guard - flat and readable</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">rate</span> <span class="op">=</span> rate <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;No heart rate data&quot;</span><span class="op">)</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span>  <span class="co">// Must exit the scope</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> rate <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> rate <span class="op">&lt;</span> <span class="dv">300</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Invalid heart rate: </span><span class="er">\(</span><span class="st">rate)&quot;</span><span class="op">)</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// rate is now safely unwrapped and validated</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All the main logic lives here, not indented</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    calculateArousal<span class="op">(</span>from<span class="op">:</span> rate<span class="op">)</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> <code>guard</code> checks a condition.
If the condition is false (or optional is nil), it runs the else block
which MUST exit the current scope (return, throw, break, continue, or
fatalError). If true, execution continues and any bound variables are
available for the rest of the function.</p>
<p><strong>Why guard is better than if-let:</strong> 1.
<strong>Validates early</strong> - Errors handled at the top, not buried
in code 2. <strong>Keeps main logic unindented</strong> - Easier to read
3. <strong>Variables available after guard</strong> - Unlike if-let
where theyâ€™re scoped to the if block</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">rankSongForCurrentState</span><span class="op">(</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">?,</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">currentHeartRate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">?,</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">hrvValue</span><span class="op">:</span> <span class="dt">Double</span><span class="op">?</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> -&gt; <span class="fu">Double</span>? <span class="op">{</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Validate all inputs up front</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> song <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;No song to rank&quot;</span><span class="op">)</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">nil</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">hr</span> <span class="op">=</span> currentHeartRate<span class="op">,</span> hr <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Invalid heart rate&quot;</span><span class="op">)</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">nil</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">hrv</span> <span class="op">=</span> hrvValue<span class="op">,</span> hrv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Invalid HRV&quot;</span><span class="op">)</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">nil</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// All inputs validated - now do the real work</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">bpmMatch</span> <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> abs<span class="op">(</span>Double<span class="op">(</span>song<span class="op">.</span>bpm<span class="op">)</span> <span class="op">-</span> hr<span class="op">)</span> <span class="op">/</span> <span class="fl">100.0</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">calmingEffect</span> <span class="op">=</span> song<span class="op">.</span>energyLevel <span class="op">&lt;</span> <span class="fl">0.5</span> <span class="op">?</span> hrv <span class="op">/</span> <span class="fl">50.0</span> <span class="op">:</span> <span class="dv">0</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> bpmMatch <span class="op">*</span> <span class="fl">0.6</span> <span class="op">+</span> calmingEffect <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="loops">Loops</h3>
<p><strong>What weâ€™re doing:</strong> Repeating code for each item in a
collection or while a condition is true.</p>
<p><strong>for-in loops:</strong></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Iterate over array</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">songs</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Song A&quot;</span><span class="op">,</span> <span class="st">&quot;Song B&quot;</span><span class="op">,</span> <span class="st">&quot;Song C&quot;</span><span class="op">]</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> song <span class="cf">in</span> songs <span class="op">{</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Playing: </span><span class="er">\(</span><span class="st">song)&quot;</span><span class="op">)</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Iterate over range</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="cf">in</span> <span class="fl">1.</span><span class="op">.</span><span class="fl">.5</span> <span class="op">{</span>        <span class="co">// 1, 2, 3, 4, 5 (inclusive)</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Count: </span><span class="er">\(</span><span class="st">i)&quot;</span><span class="op">)</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="cf">in</span> <span class="fl">0.</span><span class="op">.&lt;</span>songs<span class="op">.</span>count <span class="op">{</span>  <span class="co">// 0, 1, 2 (exclusive end)</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">i): </span><span class="er">\(</span><span class="st">songs[i])&quot;</span><span class="op">)</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co">// With enumerated for index + value</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span>index<span class="op">,</span> song<span class="op">)</span> <span class="cf">in</span> songs<span class="op">.</span>enumerated<span class="op">()</span> <span class="op">{</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">index + 1). </span><span class="er">\(</span><span class="st">song)&quot;</span><span class="op">)</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>while loops:</strong></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">attempts</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> attempts <span class="op">&lt;</span> <span class="dv">3</span> <span class="op">{</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tryConnect<span class="op">()</span> <span class="op">{</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span>  <span class="co">// Exit loop early on success</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    attempts <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">// repeat-while: always executes at least once</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">response</span><span class="op">:</span> Data<span class="op">?</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="cf">repeat</span> <span class="op">{</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> fetchNextChunk<span class="op">()</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    process<span class="op">(</span>response<span class="op">)</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">while</span> response <span class="op">!=</span> <span class="kw">nil</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">findBestMatch</span><span class="op">(</span><span class="va">candidates</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span> <span class="va">targetBPM</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">Song</span>? <span class="op">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">bestSong</span><span class="op">:</span> Song<span class="op">?</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">smallestDiff</span> <span class="op">=</span> Double<span class="op">.</span>infinity</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> song <span class="cf">in</span> candidates <span class="op">{</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">diff</span> <span class="op">=</span> abs<span class="op">(</span>Double<span class="op">(</span>song<span class="op">.</span>bpm<span class="op">)</span> <span class="op">-</span> targetBPM<span class="op">)</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> diff <span class="op">&lt;</span> smallestDiff <span class="op">{</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>            smallestDiff <span class="op">=</span> diff</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>            bestSong <span class="op">=</span> song</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> bestSong</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">// With early exit when perfect match found</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">findExactBPMMatch</span><span class="op">(</span><span class="va">candidates</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span> <span class="va">targetBPM</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Song</span>? <span class="op">{</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> song <span class="cf">in</span> candidates <span class="op">{</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> song<span class="op">.</span>bpm <span class="op">==</span> targetBPM <span class="op">{</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> song  <span class="co">// Found it, stop searching</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="kw">nil</span>  <span class="co">// No exact match</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="defer-statements">defer Statements</h3>
<p><strong>What weâ€™re doing:</strong> Scheduling code to run when
leaving the current scope, regardless of how we exit (normal return,
error throw, or early return).</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">readSensorData</span><span class="op">()</span> -&gt; [<span class="fu">Double</span>] <span class="op">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">sensor</span> <span class="op">=</span> openSensor<span class="op">()</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">defer</span> <span class="op">{</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        closeSensor<span class="op">(</span>sensor<span class="op">)</span>  <span class="co">// Always runs when function exits</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Sensor closed&quot;</span><span class="op">)</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> sensor<span class="op">.</span>isReady <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[]</span>  <span class="co">// defer runs here</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">data</span> <span class="op">=</span> sensor<span class="op">.</span>read<span class="op">()</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> data<span class="op">.</span>isEmpty <span class="op">{</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[]</span>  <span class="co">// defer runs here too</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> data  <span class="co">// defer runs here as well</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> The defer block is registered when
encountered, but executes when the scope exits. Multiple defers execute
in reverse order (LIFO - last in, first out).</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchAndProcessHealthData</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">StateVector</span> <span class="op">{</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> startHealthQuery<span class="op">()</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">defer</span> <span class="op">{</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        stopHealthQuery<span class="op">(</span>query<span class="op">)</span>  <span class="co">// Always clean up the query</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">samples</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> query<span class="op">.</span>execute<span class="op">()</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="op">!</span>samples<span class="op">.</span>isEmpty <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throw</span> DataError<span class="op">.</span>noSamples  <span class="co">// defer still runs</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> processIntoStateVector<span class="op">(</span>samples<span class="op">)</span>  <span class="co">// defer runs after return</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="functions">1.3 Functions</h2>
<p><strong>What weâ€™re doing:</strong> Organizing code into reusable,
named blocks that can take inputs and return outputs.</p>
<h3 id="basic-function-syntax">Basic Function Syntax</h3>
<div class="sourceCode" id="cb34"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// No parameters, no return value</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">greet</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Hello, AI DJ!&quot;</span><span class="op">)</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>greet<span class="op">()</span>  <span class="co">// Call the function</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">// With parameters and return value</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">add</span><span class="op">(</span><span class="va">a</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">b</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Int</span> <span class="op">{</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> a <span class="op">+</span> b</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">sum</span> <span class="op">=</span> add<span class="op">(</span>a<span class="op">:</span> <span class="dv">5</span><span class="op">,</span> b<span class="op">:</span> <span class="dv">3</span><span class="op">)</span>  <span class="co">// 8</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Single expression - implicit return</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">multiply</span><span class="op">(</span><span class="va">a</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">b</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Int</span> <span class="op">{</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    a <span class="op">*</span> b  <span class="co">// &#39;return&#39; keyword optional for single expressions</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> When you call a function, Swift copies
the argument values into the parameters, executes the function body, and
returns the result. Parameters are constants by defaultâ€”you canâ€™t modify
them inside the function.</p>
<hr />
<h3 id="argument-labels-and-parameter-names">Argument Labels and
Parameter Names</h3>
<p>Swift uses two names for function parameters: an external
<strong>argument label</strong> (used when calling) and an internal
<strong>parameter name</strong> (used inside the function).</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;from&#39; is the argument label, &#39;source&#39; is the parameter name</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">move</span><span class="op">(</span><span class="va">from</span> <span class="va">source</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">to</span> <span class="va">destination</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Moving from </span><span class="er">\(</span><span class="st">source) to </span><span class="er">\(</span><span class="st">destination)&quot;</span><span class="op">)</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>move<span class="op">(</span>from<span class="op">:</span> <span class="st">&quot;A&quot;</span><span class="op">,</span> to<span class="op">:</span> <span class="st">&quot;B&quot;</span><span class="op">)</span>  <span class="co">// Reads naturally like English</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Omit external label with underscore</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">greet</span><span class="op">(</span><span class="va">_</span> <span class="va">name</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Hello, </span><span class="er">\(</span><span class="st">name)&quot;</span><span class="op">)</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>greet<span class="op">(</span><span class="st">&quot;World&quot;</span><span class="op">)</span>  <span class="co">// No label needed when calling</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Same name for both (most common)</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">calculateScore</span><span class="op">(</span><span class="va">heartRate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> heartRate <span class="op">/</span> <span class="fl">100.0</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>calculateScore<span class="op">(</span>heartRate<span class="op">:</span> <span class="fl">85.0</span><span class="op">)</span></span></code></pre></div>
<p><strong>Why this matters:</strong> Well-named argument labels make
code read like prose: <code>move(from: &quot;A&quot;, to: &quot;B&quot;)</code> is clearer
than <code>move(&quot;A&quot;, &quot;B&quot;)</code>.</p>
<hr />
<h3 id="default-parameter-values">Default Parameter Values</h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Provide sensible defaults for optional parameters</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetch</span><span class="op">(</span><span class="va">limit</span><span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">50</span><span class="op">,</span> <span class="va">offset</span><span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Implementation...</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>fetch<span class="op">()</span>                         <span class="co">// Uses defaults: limit=50, offset=0</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>fetch<span class="op">(</span>limit<span class="op">:</span> <span class="dv">100</span><span class="op">)</span>               <span class="co">// limit=100, offset=0</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>fetch<span class="op">(</span>limit<span class="op">:</span> <span class="dv">100</span><span class="op">,</span> offset<span class="op">:</span> <span class="dv">50</span><span class="op">)</span>   <span class="co">// Both specified</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">rankSongs</span><span class="op">(</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">candidates</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">targetBPM</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">weightBPM</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="fl">0.4</span><span class="op">,</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">weightEnergy</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">weightFamiliarity</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="fl">0.3</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> -&gt; [<span class="op">(</span><span class="va">Song</span><span class="op">,</span> <span class="va">Double</span><span class="op">)</span>] <span class="op">{</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Default weights sum to 1.0, but caller can customize</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Use defaults</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">ranked</span> <span class="op">=</span> rankSongs<span class="op">(</span>candidates<span class="op">:</span> songs<span class="op">,</span> targetBPM<span class="op">:</span> <span class="dv">120</span><span class="op">)</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Override for workout scenario (weight BPM higher)</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">workoutRanked</span> <span class="op">=</span> rankSongs<span class="op">(</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    candidates<span class="op">:</span> songs<span class="op">,</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    targetBPM<span class="op">:</span> <span class="dv">140</span><span class="op">,</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    weightBPM<span class="op">:</span> <span class="fl">0.6</span><span class="op">,</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    weightEnergy<span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    weightFamiliarity<span class="op">:</span> <span class="fl">0.1</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<hr />
<h3 id="functions-as-values">Functions as Values</h3>
<p>In Swift, functions are â€œfirst-class citizensâ€â€”they can be assigned
to variables, passed as arguments, and returned from other
functions.</p>
<p><strong>What weâ€™re doing:</strong> Treating functions like data,
enabling powerful patterns like callbacks and functional
programming.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Function type: (Int, Int) -&gt; Int</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">multiply</span><span class="op">(</span><span class="va">a</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">b</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Int</span> <span class="op">{</span> a <span class="op">*</span> b <span class="op">}</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">divide</span><span class="op">(</span><span class="va">a</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">b</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Int</span> <span class="op">{</span> a <span class="op">/</span> b <span class="op">}</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Assign function to variable</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">operation</span><span class="op">:</span> <span class="op">(</span>Int<span class="op">,</span> Int<span class="op">)</span> <span class="op">-&gt;</span> Int <span class="op">=</span> multiply</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> operation<span class="op">(</span><span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span>  <span class="co">// 20</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Pass function as parameter</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">apply</span><span class="op">(</span><span class="va">_</span> <span class="va">operation</span><span class="op">:</span> <span class="op">(</span><span class="dt">Int</span><span class="op">,</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">to</span> <span class="va">a</span><span class="op">:</span> <span class="dt">Int</span><span class="op">,</span> <span class="va">and</span> <span class="va">b</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Int</span> <span class="op">{</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> operation<span class="op">(</span>a<span class="op">,</span> b<span class="op">)</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>apply<span class="op">(</span>multiply<span class="op">,</span> to<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> and<span class="op">:</span> <span class="dv">4</span><span class="op">)</span>  <span class="co">// 12</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>apply<span class="op">(</span>divide<span class="op">,</span> to<span class="op">:</span> <span class="dv">12</span><span class="op">,</span> and<span class="op">:</span> <span class="dv">3</span><span class="op">)</span>   <span class="co">// 4</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define scoring strategies as functions</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">calmingScorer</span><span class="op">(</span><span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">,</span> <span class="va">state</span><span class="op">:</span> <span class="dt">StateVector</span><span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> song<span class="op">.</span>energyLevel<span class="op">)</span> <span class="op">*</span> state<span class="op">.</span>stress</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">energizingScorer</span><span class="op">(</span><span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">,</span> <span class="va">state</span><span class="op">:</span> <span class="dt">StateVector</span><span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> song<span class="op">.</span>energyLevel <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> state<span class="op">.</span>energy<span class="op">)</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Choose strategy based on context</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">selectScoringStrategy</span><span class="op">(</span><span class="va">for</span> <span class="va">need</span><span class="op">:</span> <span class="dt">MusicNeed</span><span class="op">)</span> -&gt; <span class="op">(</span><span class="va">Song</span><span class="op">,</span> <span class="va">StateVector</span><span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> need <span class="op">{</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">.</span>calm<span class="op">:</span> <span class="kw">return</span> calmingScorer</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">.</span>energize<span class="op">:</span> <span class="kw">return</span> energizingScorer</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">.</span>maintain<span class="op">:</span> <span class="kw">return</span> <span class="op">{</span> _<span class="op">,</span> _ <span class="cf">in</span> <span class="fl">0.5</span> <span class="op">}</span>  <span class="co">// Neutral score</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Use selected strategy</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">scorer</span> <span class="op">=</span> selectScoringStrategy<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>calm<span class="op">)</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">score</span> <span class="op">=</span> scorer<span class="op">(</span>someSong<span class="op">,</span> currentState<span class="op">)</span></span></code></pre></div>
<hr />
<h2 id="optionals">1.4 Optionals</h2>
<p>Optionals are Swiftâ€™s way of handling the absence of a value. Theyâ€™re
fundamental to Swiftâ€™s safety and youâ€™ll use them constantly.</p>
<h3 id="what-is-an-optional">What is an Optional?</h3>
<p><strong>What weâ€™re doing:</strong> Representing values that might or
might not exist.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">name</span><span class="op">:</span> String <span class="op">=</span> <span class="st">&quot;AI DJ&quot;</span>     <span class="co">// MUST always have a value</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">nickname</span><span class="op">:</span> String<span class="op">?</span> <span class="op">=</span> <span class="kw">nil</span>     <span class="co">// MAY or may not have a value</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Optional is actually an enum:</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">// enum Optional&lt;T&gt; {</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">//     case some(T)   // Has a value</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">//     case none      // No value (nil)</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">// }</span></span></code></pre></div>
<p><strong>Why optionals exist:</strong> Many values in programming are
genuinely optional. A user might not have set a nickname. A network
request might fail. A dictionary lookup might not find the key. Instead
of using â€œmagic valuesâ€ (like -1 or empty string) to indicate absence,
Swift makes it explicit with optionals.</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">// These values might not exist</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">currentlyPlayingSong</span><span class="op">:</span> Song<span class="op">?</span> <span class="op">=</span> <span class="kw">nil</span>      <span class="co">// Nothing playing yet</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">lastHeartRateReading</span><span class="op">:</span> Double<span class="op">?</span> <span class="op">=</span> <span class="kw">nil</span>    <span class="co">// No reading yet</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">userPreferredGenre</span><span class="op">:</span> String<span class="op">?</span> <span class="op">=</span> <span class="kw">nil</span>      <span class="co">// User hasn&#39;t set preference</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">// These must always exist</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">isPlaying</span><span class="op">:</span> Bool <span class="op">=</span> <span class="kw">false</span>                <span class="co">// Always true or false</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">volume</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.8</span>                   <span class="co">// Always has a value</span></span></code></pre></div>
<hr />
<h3 id="unwrapping-optionals">Unwrapping Optionals</h3>
<p>Since optionals might not contain a value, you canâ€™t use them
directlyâ€”you must â€œunwrapâ€ them first.</p>
<p><strong>Force unwrapping (!) - Dangerous, avoid unless
certain:</strong></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">song</span><span class="op">:</span> String<span class="op">?</span> <span class="op">=</span> <span class="st">&quot;Yesterday&quot;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">definitelySong</span> <span class="op">=</span> song<span class="op">!</span>  <span class="co">// Crashes if song is nil!</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Only use when you&#39;re 100% certain the value exists</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">bundlePath</span> <span class="op">=</span> Bundle<span class="op">.</span>main<span class="op">.</span>path<span class="op">(</span>forResource<span class="op">:</span> <span class="st">&quot;config&quot;</span><span class="op">,</span> ofType<span class="op">:</span> <span class="st">&quot;json&quot;</span><span class="op">)!</span></span></code></pre></div>
<p><strong>Optional binding (if let) - Safe:</strong></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">song</span><span class="op">:</span> String<span class="op">?</span> <span class="op">=</span> getSong<span class="op">()</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">let</span> <span class="va">unwrappedSong</span> <span class="op">=</span> song <span class="op">{</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// unwrappedSong is a regular String here, not optional</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Playing: </span><span class="er">\(</span><span class="st">unwrappedSong)&quot;</span><span class="op">)</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;No song selected&quot;</span><span class="op">)</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Swift 5.7+ shorthand - same name</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">{</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Playing: </span><span class="er">\(</span><span class="st">song)&quot;</span><span class="op">)</span>  <span class="co">// song is non-optional in this block</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Chain multiple optional bindings</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> currentSong<span class="op">,</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>   <span class="kw">let</span> <span class="va">artist</span> <span class="op">=</span> song<span class="op">.</span>artist<span class="op">,</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>   <span class="kw">let</span> <span class="va">albumArt</span> <span class="op">=</span> song<span class="op">.</span>albumArtURL <span class="op">{</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    displayNowPlaying<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> artist<span class="op">:</span> artist<span class="op">,</span> art<span class="op">:</span> albumArt<span class="op">)</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> <code>if let</code> checks if the
optional contains a value. If yes, it creates a new non-optional
constant with that value and runs the if block. If nil, it runs the else
block.</p>
<hr />
<p><strong>guard let - Early exit (preferred for
validation):</strong></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">play</span><span class="op">(</span><span class="va">song</span><span class="op">:</span> <span class="dt">String</span><span class="op">?)</span> <span class="op">{</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> song <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;No song to play&quot;</span><span class="op">)</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// song is non-optional for the rest of the function</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    startPlayback<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    updateNowPlaying<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Why guard is often better than if-let:</strong> - The
unwrapped variable is available for the rest of the function, not just
inside a block - Keeps main logic at the top level, not indented - Makes
validation and error cases obvious at the start</p>
<hr />
<p><strong>Nil coalescing (??) - Provide default value:</strong></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">userBPM</span><span class="op">:</span> Int<span class="op">?</span> <span class="op">=</span> getUserPreferredBPM<span class="op">()</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">bpm</span> <span class="op">=</span> userBPM <span class="op">??</span> <span class="dv">120</span>  <span class="co">// Use 120 if userBPM is nil</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Equivalent to:</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co">// let bpm = userBPM != nil ? userBPM! : 120</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Chain defaults</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">theme</span> <span class="op">=</span> userTheme <span class="op">??</span> systemTheme <span class="op">??</span> <span class="st">&quot;default&quot;</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">getCurrentTargetBPM</span><span class="op">()</span> -&gt; <span class="fu">Int</span> <span class="op">{</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try user&#39;s explicit preference first</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Then infer from heart rate</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Finally use default</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> userPreferredBPM <span class="op">??</span> inferredBPMFromHeartRate <span class="op">??</span> <span class="dv">100</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<p><strong>Optional chaining (?.) - Navigate through
optionals:</strong></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Without optional chaining - verbose</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">artistName</span><span class="op">:</span> String<span class="op">?</span> <span class="op">=</span> <span class="kw">nil</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> currentSong <span class="op">{</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="va">artist</span> <span class="op">=</span> song<span class="op">.</span>artist <span class="op">{</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        artistName <span class="op">=</span> artist<span class="op">.</span>name</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">// With optional chaining - concise</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">artistName</span> <span class="op">=</span> currentSong<span class="op">?.</span>artist<span class="op">?.</span>name</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Returns nil if any step in the chain is nil</span></span></code></pre></div>
<p><strong>What happens:</strong> Each <code>?</code> checks if the
value before it is nil. If yes, the entire expression returns nil
immediately. If no, it continues to the next part.</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Safely navigate complex optional structures</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">albumArt</span> <span class="op">=</span> currentSong<span class="op">?.</span>album<span class="op">?.</span>artwork<span class="op">?.</span>url<span class="op">(</span>width<span class="op">:</span> <span class="dv">300</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">300</span><span class="op">)</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Call methods on optionals</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>currentSong<span class="op">?.</span>artist<span class="op">?.</span>fetchBio<span class="op">()</span>  <span class="co">// Only calls if both exist</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Access subscripts on optionals</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">firstGenre</span> <span class="op">=</span> currentSong<span class="op">?.</span>genres<span class="op">?[</span><span class="dv">0</span><span class="op">]</span></span></code></pre></div>
<hr />
<h2 id="closures">1.5 Closures</h2>
<p>Closures are self-contained blocks of code that can be passed around
and executed later. Theyâ€™re essential for asynchronous programming,
callbacks, and functional patterns.</p>
<h3 id="what-is-a-closure">What is a Closure?</h3>
<p><strong>What weâ€™re doing:</strong> Creating anonymous functions that
capture values from their surrounding context.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Named function</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">addTwo</span><span class="op">(</span><span class="va">x</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Int</span> <span class="op">{</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> x <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Equivalent closure</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">addTwoClosure</span> <span class="op">=</span> <span class="op">{</span> <span class="op">(</span>x<span class="op">:</span> Int<span class="op">)</span> <span class="op">-&gt;</span> Int <span class="cf">in</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> x <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Both work the same way</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>addTwo<span class="op">(</span><span class="dv">5</span><span class="op">)</span>        <span class="co">// 7</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>addTwoClosure<span class="op">(</span><span class="dv">5</span><span class="op">)</span> <span class="co">// 7</span></span></code></pre></div>
<p><strong>Closure syntax breakdown:</strong></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="op">(</span>parameters<span class="op">)</span> <span class="op">-&gt;</span> ReturnType <span class="cf">in</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// body</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Full syntax</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">multiply</span><span class="op">:</span> <span class="op">(</span>Int<span class="op">,</span> Int<span class="op">)</span> <span class="op">-&gt;</span> Int <span class="op">=</span> <span class="op">{</span> <span class="op">(</span>a<span class="op">:</span> Int<span class="op">,</span> b<span class="op">:</span> Int<span class="op">)</span> <span class="op">-&gt;</span> Int <span class="cf">in</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> a <span class="op">*</span> b</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Swift can infer types from context</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">multiply2</span><span class="op">:</span> <span class="op">(</span>Int<span class="op">,</span> Int<span class="op">)</span> <span class="op">-&gt;</span> Int <span class="op">=</span> <span class="op">{</span> a<span class="op">,</span> b <span class="cf">in</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> a <span class="op">*</span> b</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Shorthand argument names: $0, $1, $2...</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">multiply3</span><span class="op">:</span> <span class="op">(</span>Int<span class="op">,</span> Int<span class="op">)</span> <span class="op">-&gt;</span> Int <span class="op">=</span> <span class="op">{</span> $<span class="dv">0</span> <span class="op">*</span> $<span class="dv">1</span> <span class="op">}</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="co">// When passed to a function, can use trailing closure syntax</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">sorted</span> <span class="op">=</span> numbers<span class="op">.</span>sorted <span class="op">{</span> $<span class="dv">0</span> <span class="op">&lt;</span> $<span class="dv">1</span> <span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="closures-in-practice">Closures in Practice</h3>
<p>Closures are everywhere in Swift, especially for:</p>
<p><strong>1. Completion handlers (callbacks):</strong></p>
<div class="sourceCode" id="cb51"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchSong</span><span class="op">(</span><span class="va">id</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">completion</span><span class="op">:</span> @<span class="dt">escaping</span> (<span class="va">Song</span>?<span class="op">)</span> -&gt; <span class="fu">Void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Async work happens...</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    DispatchQueue<span class="op">.</span>main<span class="op">.</span><span class="cf">async</span> <span class="op">{</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>        completion<span class="op">(</span>song<span class="op">)</span>  <span class="co">// Call the closure when done</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Using it</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>fetchSong<span class="op">(</span>id<span class="op">:</span> <span class="st">&quot;123&quot;</span><span class="op">)</span> <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> song <span class="op">{</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        play<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>2. Collection operations:</strong></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">numbers</span> <span class="op">=</span> <span class="op">[</span><span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">10</span><span class="op">]</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co">// map: transform each element</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">doubled</span> <span class="op">=</span> numbers<span class="op">.</span>map <span class="op">{</span> $<span class="dv">0</span> <span class="op">*</span> <span class="dv">2</span> <span class="op">}</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [2, 4, 6, 8, 10, 12, 14, 16, 18, 20]</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">// filter: keep elements matching condition</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">evens</span> <span class="op">=</span> numbers<span class="op">.</span>filter <span class="op">{</span> $<span class="dv">0</span> <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">// [2, 4, 6, 8, 10]</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co">// reduce: combine into single value</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">sum</span> <span class="op">=</span> numbers<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">{</span> accumulator<span class="op">,</span> current <span class="cf">in</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    accumulator <span class="op">+</span> current</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>  <span class="co">// 55</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Shorthand</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">sum2</span> <span class="op">=</span> numbers<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span>  <span class="co">// Same result</span></span></code></pre></div>
<p><strong>3. Sorting:</strong></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Song <span class="op">{</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">title</span><span class="op">:</span> String</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">score</span><span class="op">:</span> Double</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[...]</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Sort by score, highest first</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>songs<span class="op">.</span>sort <span class="op">{</span> $<span class="fl">0.</span>score <span class="op">&gt;</span> $<span class="fl">1.</span>score <span class="op">}</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Sort by title alphabetically</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>songs<span class="op">.</span>sort <span class="op">{</span> $<span class="fl">0.</span>title <span class="op">&lt;</span> $<span class="fl">1.</span>title <span class="op">}</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb54"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Rank and filter songs using closures</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">selectSongsForMood</span><span class="op">(</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">candidates</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">mood</span><span class="op">:</span> <span class="dt">Mood</span><span class="op">,</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">limit</span><span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> candidates</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Filter to matching genres</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>filter <span class="op">{</span> $<span class="fl">0.</span>genres<span class="op">.</span>contains<span class="op">(</span>mood<span class="op">.</span>preferredGenre<span class="op">)</span> <span class="op">}</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Score each song</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>map <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> score<span class="op">:</span> calculateScore<span class="op">(</span>song<span class="op">,</span> <span class="cf">for</span><span class="op">:</span> mood<span class="op">))</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sort by score descending</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sorted <span class="op">{</span> $<span class="fl">0.</span>score <span class="op">&gt;</span> $<span class="fl">1.</span>score <span class="op">}</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Take top N</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>prefix<span class="op">(</span>limit<span class="op">)</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Extract just the songs</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>map <span class="op">{</span> $<span class="fl">0.</span>song <span class="op">}</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="capturing-values">Capturing Values</h3>
<p>Closures can capture and store references to variables from their
surrounding context.</p>
<p><strong>What weâ€™re doing:</strong> Creating closures that â€œrememberâ€
values from when they were created.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">makeCounter</span><span class="op">()</span> -&gt; <span class="op">()</span> -&gt; <span class="fu">Int</span> <span class="op">{</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">count</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">counter</span><span class="op">:</span> <span class="op">()</span> <span class="op">-&gt;</span> Int <span class="op">=</span> <span class="op">{</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span>  <span class="co">// Captures &#39;count&#39; from outer scope</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> count</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> counter</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">counter1</span> <span class="op">=</span> makeCounter<span class="op">()</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>counter1<span class="op">()</span>  <span class="co">// 1</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>counter1<span class="op">()</span>  <span class="co">// 2</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>counter1<span class="op">()</span>  <span class="co">// 3</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">counter2</span> <span class="op">=</span> makeCounter<span class="op">()</span>  <span class="co">// Independent counter</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>counter2<span class="op">()</span>  <span class="co">// 1</span></span></code></pre></div>
<p><strong>What happens:</strong> When the closure is created, it
captures a reference to <code>count</code>. Even after
<code>makeCounter()</code> returns, the closure keeps <code>count</code>
alive and can modify it. Each call to <code>makeCounter()</code> creates
a new <code>count</code> variable, so counters are independent.</p>
<hr />
<h3 id="avoiding-retain-cycles-with-capture-lists">Avoiding Retain
Cycles with Capture Lists</h3>
<p>When closures capture <code>self</code> (a class instance), they can
create retain cycles that leak memory.</p>
<p><strong>The problem:</strong></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SongPlayer <span class="op">{</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> String <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onSongEnd</span><span class="op">:</span> <span class="op">(()</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">setup</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This creates a retain cycle!</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Closure captures self strongly</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// self holds closure in onSongEnd</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Neither can be deallocated</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>        onSongEnd <span class="op">=</span> <span class="op">{</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Finished: </span><span class="er">\(</span><span class="st">self.currentSong)&quot;</span><span class="op">)</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>The solution - capture lists:</strong></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SongPlayer <span class="op">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> String <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onSongEnd</span><span class="op">:</span> <span class="op">(()</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">setup</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// [weak self] breaks the retain cycle</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>        onSongEnd <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> <span class="cf">in</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">self</span> <span class="op">=</span> <span class="kw">self</span> <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Finished: </span><span class="er">\(</span><span class="st">self.currentSong)&quot;</span><span class="op">)</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Capture list options:</strong> - <code>[weak self]</code> -
self becomes optional, set to nil if deallocated -
<code>[unowned self]</code> - assumes self exists, crashes if accessed
after deallocation</p>
<p><strong>When to use which:</strong> - <code>[weak self]</code> - When
the closure might outlive self (most common) -
<code>[unowned self]</code> - When youâ€™re certain self will exist for
the closureâ€™s lifetime</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HeartRateMonitor <span class="op">{</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onRateUpdate</span><span class="op">:</span> <span class="op">((</span>Double<span class="op">)</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">startMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>        healthKit<span class="op">.</span>startHeartRateQuery <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> samples <span class="cf">in</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">self</span> <span class="op">=</span> <span class="kw">self</span> <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> sample <span class="cf">in</span> samples <span class="op">{</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>process<span class="op">(</span>sample<span class="op">)</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>onRateUpdate<span class="op">?(</span>sample<span class="op">.</span>value<span class="op">)</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">process</span><span class="op">(</span><span class="va">_</span> <span class="va">sample</span><span class="op">:</span> <span class="dt">Sample</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Process the sample</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="error-handling">1.6 Error Handling</h2>
<p>Swift has a robust error handling system that makes it clear which
functions can fail and forces you to handle those failures.</p>
<h3 id="defining-errors">Defining Errors</h3>
<p><strong>What weâ€™re doing:</strong> Creating custom error types that
describe what can go wrong.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Errors are typically enums conforming to Error protocol</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> NetworkError<span class="op">:</span> <span class="dt">Error</span> <span class="op">{</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> noConnection</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> timeout</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> serverError<span class="op">(</span>code<span class="op">:</span> Int<span class="op">)</span>      <span class="co">// With associated value</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> invalidData</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> DatabaseError<span class="op">:</span> <span class="dt">Error</span> <span class="op">{</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> notFound</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> duplicateEntry</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> corruptData<span class="op">(</span>details<span class="op">:</span> String<span class="op">)</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Can also add descriptions</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> NetworkError<span class="op">:</span> <span class="dt">LocalizedError</span> <span class="op">{</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">errorDescription</span><span class="op">:</span> String<span class="op">?</span> <span class="op">{</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>noConnection<span class="op">:</span> <span class="kw">return</span> <span class="st">&quot;No internet connection&quot;</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>timeout<span class="op">:</span> <span class="kw">return</span> <span class="st">&quot;Request timed out&quot;</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>serverError<span class="op">(</span><span class="kw">let</span> <span class="va">code</span><span class="op">):</span> <span class="kw">return</span> <span class="st">&quot;Server error: </span><span class="er">\(</span><span class="st">code)&quot;</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>invalidData<span class="op">:</span> <span class="kw">return</span> <span class="st">&quot;Invalid data received&quot;</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="throwing-and-catching-errors">Throwing and Catching Errors</h3>
<p><strong>What weâ€™re doing:</strong> Writing functions that can fail,
and handling those failures gracefully.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Mark throwing functions with &#39;throws&#39;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchSong</span><span class="op">(</span><span class="va">id</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="kw">throws</span> -&gt; <span class="fu">Song</span> <span class="op">{</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> isConnected <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throw</span> NetworkError<span class="op">.</span>noConnection</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> database<span class="op">.</span>find<span class="op">(</span>id<span class="op">)</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throw</span> DatabaseError<span class="op">.</span>notFound</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> song</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Calling throwing functions requires &#39;try&#39;</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="cf">do</span> <span class="op">{</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> <span class="cf">try</span> fetchSong<span class="op">(</span>id<span class="op">:</span> <span class="st">&quot;123&quot;</span><span class="op">)</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    play<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> NetworkError<span class="op">.</span>noConnection <span class="op">{</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    showOfflineMessage<span class="op">()</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> NetworkError<span class="op">.</span>serverError<span class="op">(</span><span class="kw">let</span> <span class="va">code</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Server returned error: </span><span class="er">\(</span><span class="st">code)&quot;</span><span class="op">)</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> DatabaseError<span class="op">.</span>notFound <span class="op">{</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>    showSongNotFoundMessage<span class="op">()</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Generic catch for any other error</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Unexpected error: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> When <code>throw</code> is executed,
Swift immediately exits the function and looks for a <code>catch</code>
block that handles that error type. The error propagates up the call
stack until caught.</p>
<hr />
<h3 id="error-propagation">Error Propagation</h3>
<p>You donâ€™t have to catch every errorâ€”you can propagate them to
callers.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This function throws, so it propagates errors from fetchSong</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">loadPlaylist</span><span class="op">(</span><span class="va">ids</span><span class="op">:</span> [<span class="dt">String</span>]<span class="op">)</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> id <span class="cf">in</span> ids <span class="op">{</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> <span class="cf">try</span> fetchSong<span class="op">(</span>id<span class="op">:</span> id<span class="op">)</span>  <span class="co">// Propagates if throws</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        songs<span class="op">.</span>append<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> songs</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Caller must handle the errors</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="cf">do</span> <span class="op">{</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">playlist</span> <span class="op">=</span> <span class="cf">try</span> loadPlaylist<span class="op">(</span>ids<span class="op">:</span> <span class="op">[</span><span class="st">&quot;1&quot;</span><span class="op">,</span> <span class="st">&quot;2&quot;</span><span class="op">,</span> <span class="st">&quot;3&quot;</span><span class="op">])</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>    handleError<span class="op">(</span>error<span class="op">)</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="try-and-try">try? and try!</h3>
<p><strong>try? - Convert error to nil:</strong></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">// If fetchSong throws, result is nil; otherwise, it&#39;s the song</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">maybeSong</span> <span class="op">=</span> <span class="cf">try</span><span class="op">?</span> fetchSong<span class="op">(</span>id<span class="op">:</span> <span class="st">&quot;123&quot;</span><span class="op">)</span>  <span class="co">// Type: Song?</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Useful for optional chaining</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> <span class="cf">try</span><span class="op">?</span> fetchSong<span class="op">(</span>id<span class="op">:</span> <span class="st">&quot;123&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    play<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>try! - Force (crashes on error):</strong></p>
<div class="sourceCode" id="cb63"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Only use when you&#39;re certain it won&#39;t fail</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> <span class="cf">try</span><span class="op">!</span> fetchSong<span class="op">(</span>id<span class="op">:</span> <span class="st">&quot;known-good-id&quot;</span><span class="op">)</span>  <span class="co">// Crashes if error thrown</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">loadUserPreferences</span><span class="op">()</span> -&gt; <span class="fu">UserPreferences</span> <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Try to load from disk, fall back to defaults</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="va">prefs</span> <span class="op">=</span> <span class="cf">try</span><span class="op">?</span> PreferencesStore<span class="op">.</span>load<span class="op">()</span> <span class="op">{</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> prefs</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> UserPreferences<span class="op">.</span><span class="kw">default</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="the-result-type">The Result Type</h3>
<p>An alternative to throwing that makes error handling more
explicit.</p>
<p><strong>What weâ€™re doing:</strong> Representing success or failure as
a value that can be passed around.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchSongResult</span><span class="op">(</span><span class="va">id</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> -&gt; <span class="fu">Result</span><span class="op">&lt;</span><span class="dt">Song</span>, <span class="dt">NetworkError</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> isConnected <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">.</span>failure<span class="op">(.</span>noConnection<span class="op">)</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> database<span class="op">.</span>find<span class="op">(</span>id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">.</span>success<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">.</span>failure<span class="op">(.</span>serverError<span class="op">(</span>code<span class="op">:</span> <span class="dv">404</span><span class="op">))</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Using Result</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> fetchSongResult<span class="op">(</span>id<span class="op">:</span> <span class="st">&quot;123&quot;</span><span class="op">)</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="cf">switch</span> result <span class="op">{</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="op">.</span>success<span class="op">(</span><span class="kw">let</span> <span class="va">song</span><span class="op">):</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    play<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="op">.</span>failure<span class="op">(</span><span class="kw">let</span> <span class="va">error</span><span class="op">):</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>    handleError<span class="op">(</span>error<span class="op">)</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Or convert to throwing</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a><span class="cf">do</span> <span class="op">{</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> <span class="cf">try</span> result<span class="op">.</span><span class="kw">get</span><span class="op">()</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>    play<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    handleError<span class="op">(</span>error<span class="op">)</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>When to use Result vs throws:</strong> -
<strong>throws</strong> - For synchronous functions, simpler syntax -
<strong>Result</strong> - For storing outcomes, async callbacks, when
you need to pass errors around</p>
<hr />
<h2 id="generics">1.7 Generics</h2>
<p>Generics let you write flexible, reusable code that works with any
type while maintaining type safety.</p>
<h3 id="why-generics">Why Generics?</h3>
<p><strong>The problem:</strong> Without generics, youâ€™d need separate
functions for each type.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">swapInts</span><span class="op">(</span><span class="va">_</span> <span class="va">a</span><span class="op">:</span> <span class="dt">inout</span> <span class="va">Int</span><span class="op">,</span> <span class="va">_</span> <span class="va">b</span><span class="op">:</span> <span class="dt">inout</span> <span class="va">Int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">temp</span> <span class="op">=</span> a</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> b</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> temp</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">swapStrings</span><span class="op">(</span><span class="va">_</span> <span class="va">a</span><span class="op">:</span> <span class="dt">inout</span> <span class="va">String</span><span class="op">,</span> <span class="va">_</span> <span class="va">b</span><span class="op">:</span> <span class="dt">inout</span> <span class="va">String</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">temp</span> <span class="op">=</span> a</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> b</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> temp</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="co">// This is repetitive...</span></span></code></pre></div>
<p><strong>The solution:</strong> Use a generic type placeholder.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">swap</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;(</span><span class="va">_</span> <span class="va">a</span><span class="op">:</span> <span class="dt">inout</span> <span class="va">T</span><span class="op">,</span> <span class="va">_</span> <span class="va">b</span><span class="op">:</span> <span class="dt">inout</span> <span class="va">T</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">temp</span> <span class="op">=</span> a</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> b</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> temp</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">x</span> <span class="op">=</span> <span class="dv">5</span><span class="op">,</span> y <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>swap<span class="op">(&amp;</span>x<span class="op">,</span> <span class="op">&amp;</span>y<span class="op">)</span>  <span class="co">// Works with Int</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">s1</span> <span class="op">=</span> <span class="st">&quot;hello&quot;</span><span class="op">,</span> s2 <span class="op">=</span> <span class="st">&quot;world&quot;</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>swap<span class="op">(&amp;</span>s1<span class="op">,</span> <span class="op">&amp;</span>s2<span class="op">)</span>  <span class="co">// Works with String</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">song1</span> <span class="op">=</span> Song<span class="op">(...),</span> song2 <span class="op">=</span> Song<span class="op">(...)</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>swap<span class="op">(&amp;</span>song1<span class="op">,</span> <span class="op">&amp;</span>song2<span class="op">)</span>  <span class="co">// Works with any type!</span></span></code></pre></div>
<p><strong>What happens:</strong> <code>T</code> is a placeholder that
gets replaced with the actual type when you call the function. The
compiler generates specialized versions as needed.</p>
<hr />
<h3 id="generic-types">Generic Types</h3>
<p><strong>What weâ€™re doing:</strong> Creating data structures that work
with any type.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Stack<span class="op">&lt;</span><span class="dt">Element</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">items</span><span class="op">:</span> <span class="op">[</span>Element<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mutating</span> <span class="kw">func</span> <span class="fu">push</span><span class="op">(</span><span class="va">_</span> <span class="va">item</span><span class="op">:</span> <span class="dt">Element</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        items<span class="op">.</span>append<span class="op">(</span>item<span class="op">)</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mutating</span> <span class="kw">func</span> <span class="fu">pop</span><span class="op">()</span> -&gt; <span class="fu">Element</span>? <span class="op">{</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>        items<span class="op">.</span>popLast<span class="op">()</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">top</span><span class="op">:</span> Element<span class="op">?</span> <span class="op">{</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        items<span class="op">.</span>last</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">isEmpty</span><span class="op">:</span> Bool <span class="op">{</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        items<span class="op">.</span>isEmpty</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Use with any type</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">intStack</span> <span class="op">=</span> Stack<span class="op">&lt;</span>Int<span class="op">&gt;()</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>intStack<span class="op">.</span>push<span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>intStack<span class="op">.</span>push<span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>intStack<span class="op">.</span>pop<span class="op">()</span>  <span class="co">// 2</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">songStack</span> <span class="op">=</span> Stack<span class="op">&lt;</span>Song<span class="op">&gt;()</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>songStack<span class="op">.</span>push<span class="op">(</span>Song<span class="op">(</span>title<span class="op">:</span> <span class="st">&quot;Hello&quot;</span><span class="op">))</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Generic buffer for any type of samples</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> RingBuffer<span class="op">&lt;</span><span class="dt">T</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">items</span><span class="op">:</span> <span class="op">[</span>T<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">capacity</span><span class="op">:</span> Int</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">(</span>capacity<span class="op">:</span> Int<span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>capacity <span class="op">=</span> capacity</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mutating</span> <span class="kw">func</span> <span class="fu">add</span><span class="op">(</span><span class="va">_</span> <span class="va">item</span><span class="op">:</span> <span class="dt">T</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> items<span class="op">.</span>count <span class="op">&gt;=</span> capacity <span class="op">{</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>            items<span class="op">.</span>removeFirst<span class="op">()</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>        items<span class="op">.</span>append<span class="op">(</span>item<span class="op">)</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">average</span><span class="op">:</span> T <span class="kw">where</span> T<span class="op">:</span> BinaryFloatingPoint <span class="op">{</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="op">!</span>items<span class="op">.</span>isEmpty <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sum</span> <span class="op">=</span> items<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> sum <span class="op">/</span> T<span class="op">(</span>items<span class="op">.</span>count<span class="op">)</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">all</span><span class="op">:</span> <span class="op">[</span>T<span class="op">]</span> <span class="op">{</span> items <span class="op">}</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Use for heart rate samples</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">heartRateBuffer</span> <span class="op">=</span> RingBuffer<span class="op">&lt;</span>Double<span class="op">&gt;(</span>capacity<span class="op">:</span> <span class="dv">10</span><span class="op">)</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>heartRateBuffer<span class="op">.</span>add<span class="op">(</span><span class="fl">72.5</span><span class="op">)</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>heartRateBuffer<span class="op">.</span>add<span class="op">(</span><span class="fl">74.0</span><span class="op">)</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">avg</span> <span class="op">=</span> heartRateBuffer<span class="op">.</span>average</span></code></pre></div>
<hr />
<h3 id="type-constraints">Type Constraints</h3>
<p>Sometimes generics need to be constrained to types with certain
capabilities.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Only works with Comparable types</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">findMax</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">:</span> <span class="dt">Comparable</span><span class="op">&gt;(</span><span class="va">_</span> <span class="va">array</span><span class="op">:</span> [<span class="dt">T</span>]<span class="op">)</span> -&gt; <span class="fu">T</span>? <span class="op">{</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    array<span class="op">.</span>max<span class="op">()</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Multiple constraints</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">process</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">:</span> <span class="dt">Hashable</span> &amp; <span class="dt">Codable</span><span class="op">&gt;(</span><span class="va">_</span> <span class="va">item</span><span class="op">:</span> <span class="dt">T</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// T must be both Hashable and Codable</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Where clauses for complex constraints</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">merge</span><span class="op">&lt;</span><span class="dt">T</span>, <span class="dt">U</span><span class="op">&gt;(</span><span class="va">_</span> <span class="va">a</span><span class="op">:</span> <span class="dt">T</span><span class="op">,</span> <span class="va">_</span> <span class="va">b</span><span class="op">:</span> <span class="dt">U</span><span class="op">)</span> -&gt; <span class="fu">String</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">where</span> <span class="fu">T</span><span class="op">:</span> <span class="dt">CustomStringConvertible</span><span class="op">,</span> U<span class="op">:</span> CustomStringConvertible <span class="op">{</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> a<span class="op">.</span>description <span class="op">+</span> b<span class="op">.</span>description</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Scorer that works with any song-like type</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="kw">protocol</span> Scorable <span class="op">{</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">energyLevel</span><span class="op">:</span> Double <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">bpm</span><span class="op">:</span> Int <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">familiarity</span><span class="op">:</span> Double <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">rankItems</span><span class="op">&lt;</span><span class="dt">T</span><span class="op">:</span> <span class="dt">Scorable</span> &amp; <span class="dt">Identifiable</span><span class="op">&gt;(</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">_</span> <span class="va">items</span><span class="op">:</span> [<span class="dt">T</span>]<span class="op">,</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">targetBPM</span><span class="op">:</span> <span class="dt">Double</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> -&gt; [<span class="op">(</span><span class="va">item</span><span class="op">:</span> <span class="dt">T</span><span class="op">,</span> <span class="va">score</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span>] <span class="op">{</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>    items<span class="op">.</span>map <span class="op">{</span> item <span class="cf">in</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">bpmScore</span> <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> abs<span class="op">(</span>Double<span class="op">(</span>item<span class="op">.</span>bpm<span class="op">)</span> <span class="op">-</span> targetBPM<span class="op">)</span> <span class="op">/</span> <span class="fl">100.0</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">score</span> <span class="op">=</span> bpmScore <span class="op">*</span> <span class="fl">0.5</span> <span class="op">+</span> item<span class="op">.</span>familiarity <span class="op">*</span> <span class="fl">0.5</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">(</span>item<span class="op">,</span> score<span class="op">)</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>sorted <span class="op">{</span> $<span class="fl">0.</span>score <span class="op">&gt;</span> $<span class="fl">1.</span>score <span class="op">}</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="memory-management-arc">1.8 Memory Management (ARC)</h2>
<p>Swift uses Automatic Reference Counting to manage memory for class
instances. Understanding ARC prevents memory leaks.</p>
<h3 id="how-arc-works">How ARC Works</h3>
<p><strong>Whatâ€™s happening:</strong> Swift tracks how many references
point to each class instance. When the count reaches zero, the instance
is deallocated.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Song <span class="op">{</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">title</span><span class="op">:</span> String</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">(</span>title<span class="op">:</span> String<span class="op">)</span> <span class="op">{</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>title <span class="op">=</span> title</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">title) initialized&quot;</span><span class="op">)</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deinit</span> <span class="op">{</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">title) deallocated&quot;</span><span class="op">)</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">song1</span><span class="op">:</span> Song<span class="op">?</span> <span class="op">=</span> Song<span class="op">(</span>title<span class="op">:</span> <span class="st">&quot;Hello&quot;</span><span class="op">)</span>  <span class="co">// Count: 1, prints &quot;Hello initialized&quot;</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">song2</span> <span class="op">=</span> song1   <span class="co">// Count: 2 (both point to same object)</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">song3</span> <span class="op">=</span> song1   <span class="co">// Count: 3</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>song1 <span class="op">=</span> <span class="kw">nil</span>  <span class="co">// Count: 2</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>song2 <span class="op">=</span> <span class="kw">nil</span>  <span class="co">// Count: 1</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>song3 <span class="op">=</span> <span class="kw">nil</span>  <span class="co">// Count: 0, prints &quot;Hello deallocated&quot;</span></span></code></pre></div>
<hr />
<h3 id="retain-cycles---the-problem">Retain Cycles - The Problem</h3>
<p><strong>What weâ€™re doing:</strong> Understanding how strong
references can prevent deallocation.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Song <span class="op">{</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">artist</span><span class="op">:</span> Artist<span class="op">?</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Artist <span class="op">{</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">song</span><span class="op">:</span> Song<span class="op">?</span> <span class="op">=</span> Song<span class="op">()</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">artist</span><span class="op">:</span> Artist<span class="op">?</span> <span class="op">=</span> Artist<span class="op">()</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>song<span class="op">!.</span>artist <span class="op">=</span> artist    <span class="co">// Song â†’ Artist (strong)</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>artist<span class="op">!.</span>songs<span class="op">.</span>append<span class="op">(</span>song<span class="op">!)</span>  <span class="co">// Artist â†’ Song (strong)</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a><span class="co">// This creates a cycle:</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Song â†’ Artist â†’ Song â†’ Artist â†’ ...</span></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>song <span class="op">=</span> <span class="kw">nil</span>   <span class="co">// Song still exists (Artist references it)</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>artist <span class="op">=</span> <span class="kw">nil</span> <span class="co">// Artist still exists (Song references it)</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Memory leak! Neither can be deallocated</span></span></code></pre></div>
<hr />
<h3 id="breaking-cycles-with-weak-and-unowned">Breaking Cycles with weak
and unowned</h3>
<p><strong>weak - Optional reference that doesnâ€™t prevent
deallocation:</strong></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Song <span class="op">{</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">weak</span> <span class="kw">var</span> <span class="va">artist</span><span class="op">:</span> Artist<span class="op">?</span>  <span class="co">// Weak reference</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Artist <span class="op">{</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span>  <span class="co">// Strong reference</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Now:</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Song -weakâ†’ Artist â†strong- Song</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Artist -strongâ†’ Song</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="co">// When artist = nil, Artist can be deallocated</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="co">// song.artist automatically becomes nil</span></span></code></pre></div>
<p><strong>unowned - Non-optional reference that doesnâ€™t prevent
deallocation:</strong></p>
<div class="sourceCode" id="cb75"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CreditCard <span class="op">{</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">unowned</span> <span class="kw">let</span> <span class="va">customer</span><span class="op">:</span> Customer  <span class="co">// Customer must exist for card to exist</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">(</span>customer<span class="op">:</span> Customer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>customer <span class="op">=</span> customer</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Use unowned when:</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co">// - The referenced object will always exist while this object exists</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co">// - You want non-optional semantics</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">CAUTION</span><span class="co">: Accessing after deallocation causes crash!</span></span></code></pre></div>
<p><strong>When to use which:</strong> | Reference Type | When to Use |
Example | |â€”â€”â€”â€”â€”|â€”â€”â€”â€”-|â€”â€”â€”| | strong (default) | Owner of the object |
Artist owns their songs | | weak | Child â†’ parent, delegates | Song â†’
Artist | | unowned | Guaranteed to outlive | CreditCard â†’ Customer |</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NowPlayingController <span class="op">{</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> Song<span class="op">?</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onSongChange</span><span class="op">:</span> <span class="op">((</span>Song<span class="op">?)</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">setupNotifications</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use weak self to avoid retain cycle</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>        NotificationCenter<span class="op">.</span><span class="kw">default</span><span class="op">.</span>addObserver<span class="op">(</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>            forName<span class="op">:</span> <span class="op">.</span>songEnded<span class="op">,</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>            object<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>            queue<span class="op">:</span> <span class="op">.</span>main</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> notification <span class="cf">in</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>handleSongEnded<span class="op">()</span>  <span class="co">// self might be nil</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Song <span class="op">{</span></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">weak</span> <span class="kw">var</span> <span class="va">nowPlayingController</span><span class="op">:</span> NowPlayingController<span class="op">?</span>  <span class="co">// Avoid cycle</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---swift-fundamentals">Key Takeaways - Swift
Fundamentals</h2>
<ol type="1">
<li><strong>Use <code>let</code> by default</strong>, <code>var</code>
only when you need to mutate</li>
<li><strong>Optionals make nil explicit</strong> - unwrap safely with
<code>if let</code> or <code>guard let</code></li>
<li><strong>Prefer <code>guard</code> for validation</strong> - keeps
main logic unindented</li>
<li><strong>Use closures for callbacks</strong> - but watch for retain
cycles with <code>[weak self]</code></li>
<li><strong>Throw errors for recoverable failures</strong> - use
<code>Result</code> for async callbacks</li>
<li><strong>Generics enable reusable code</strong> - constrain when you
need specific capabilities</li>
<li><strong>Understand ARC</strong> - use <code>weak</code> for
delegates and parent references</li>
</ol>
<hr />
<h1 id="xcode-apple-development-environment">2. XCODE &amp; APPLE
DEVELOPMENT ENVIRONMENT</h1>
<h2 id="why-this-matters-for-ai-dj-1">Why This Matters for AI DJ</h2>
<p>Xcode is the only way to build apps for Apple platforms.
Understanding it well will save you hours of frustration. For the AI DJ
project specifically, youâ€™ll need to: - Create a multi-target project
(iOS, watchOS, macOS) - Set up entitlements for HealthKit and MusicKit -
Debug across devices and simulators - Use SwiftUI previews for rapid UI
development</p>
<hr />
<h2 id="xcode-interface">2.1 Xcode Interface</h2>
<h3 id="the-four-main-areas">The Four Main Areas</h3>
<p>When you open Xcode, you see four distinct panels:</p>
<p><strong>1. Navigator Panel (Left - âŒ˜0 to toggle)</strong> This is
your file browser and much more: - <strong>Project Navigator
(âŒ˜1):</strong> Browse files, add/remove files, organize groups -
<strong>Source Control (âŒ˜2):</strong> Git branches, commits, uncommitted
changes - <strong>Symbol Navigator (âŒ˜3):</strong> All classes,
functions, properties indexed - <strong>Find Navigator (âŒ˜4):</strong>
Project-wide search with regex support - <strong>Issue Navigator
(âŒ˜5):</strong> Errors and warnings from builds - <strong>Test Navigator
(âŒ˜6):</strong> Test suites and their pass/fail status - <strong>Debug
Navigator (âŒ˜7):</strong> CPU, memory, network during debugging -
<strong>Breakpoint Navigator (âŒ˜8):</strong> All breakpoints in
project</p>
<p><strong>2. Editor Area (Center)</strong> Where you write code.
Features: - Syntax highlighting and auto-completion - Inline error and
warning display - Split view (âŒƒâŒ˜T) for viewing multiple files - SwiftUI
Canvas (âŒ˜âŒ¥â†©ï¸Ž) for live previews</p>
<p><strong>3. Inspector Panel (Right - âŒ˜âŒ¥0 to toggle)</strong> -
<strong>File Inspector:</strong> File settings, target membership -
<strong>Quick Help:</strong> Documentation for selected symbol -
<strong>Attributes Inspector:</strong> UI element properties in
Interface Builder</p>
<p><strong>4. Debug Area (Bottom - âŒ˜â‡§Y to toggle)</strong> - Console:
print() output, logs, errors - Variables view: Inspect values during
breakpoints</p>
<hr />
<h3 id="essential-keyboard-shortcuts">Essential Keyboard Shortcuts</h3>
<p>Learn theseâ€”theyâ€™ll make you much faster:</p>
<pre><code>BUILDING &amp; RUNNING
âŒ˜B          Build project
âŒ˜R          Build and run
âŒ˜.          Stop running
âŒ˜U          Run tests
âŒ˜â‡§K         Clean build folder (when builds act weird)

NAVIGATION
âŒ˜â‡§O         Open Quickly - search files and symbols
âŒƒâŒ˜J         Jump to definition (where is this defined?)
âŒ˜âŒ¥â†/â†’       Navigate back/forward through history
âŒ˜L          Go to line number
âŒƒâŒ¥âŒ˜â†©        Open in new window

EDITING
âŒƒI          Re-indent selected code
âŒ˜/          Toggle comment
âŒ˜D          Duplicate line/selection
âŒ˜âŒ¥[/]       Move line up/down
âŒƒâŒ˜E         Rename symbol in scope

PANELS
âŒ˜0          Toggle navigator
âŒ˜âŒ¥0         Toggle inspector
âŒ˜â‡§Y         Toggle debug area
âŒ˜â†©          Toggle SwiftUI canvas</code></pre>
<hr />
<h3 id="swiftui-previews">SwiftUI Previews</h3>
<p>One of Xcodeâ€™s best features for UI development. Previews update live
as you code.</p>
<p><strong>What weâ€™re doing:</strong> Setting up live previews to see UI
changes instantly without building and running.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> NowPlayingView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>        VStack <span class="op">{</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span><span class="st">&quot;Now Playing&quot;</span><span class="op">)</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span><span class="st">&quot;Song Title&quot;</span><span class="op">)</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Preview provider</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>#Preview <span class="op">{</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    NowPlayingView<span class="op">()</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Multiple previews</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>#Preview<span class="op">(</span><span class="st">&quot;Light Mode&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    NowPlayingView<span class="op">()</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>#Preview<span class="op">(</span><span class="st">&quot;Dark Mode&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    NowPlayingView<span class="op">()</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>preferredColorScheme<span class="op">(.</span>dark<span class="op">)</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>#Preview<span class="op">(</span><span class="st">&quot;Large Text&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>    NowPlayingView<span class="op">()</span></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>environment<span class="op">(</span>\<span class="op">.</span>sizeCategory<span class="op">,</span> <span class="op">.</span>accessibilityLarge<span class="op">)</span></span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Tips:</strong> - Press âŒ˜â†©ï¸Ž to toggle canvas on/off - Click
â€œResumeâ€ if preview pauses - Pin previews to keep them visible while
editing other files - Use <code>.previewDevice()</code> to see different
device sizes</p>
<hr />
<h2 id="project-structure">2.2 Project Structure</h2>
<h3 id="understanding-targets">Understanding Targets</h3>
<p>A <strong>target</strong> defines what to build. Our AI DJ project
needs multiple targets:</p>
<table>
<thead>
<tr>
<th>Target</th>
<th>Platform</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>AIDJ</td>
<td>iOS</td>
<td>Main iPhone app</td>
</tr>
<tr>
<td>AIDJ Watch App</td>
<td>watchOS</td>
<td>Apple Watch companion</td>
</tr>
<tr>
<td>AIDJ macOS</td>
<td>macOS</td>
<td>Menu bar helper</td>
</tr>
<tr>
<td>AIDJWidgets</td>
<td>iOS</td>
<td>Lock screen and home screen widgets</td>
</tr>
<tr>
<td>AIDJTests</td>
<td>iOS</td>
<td>Unit tests</td>
</tr>
<tr>
<td>AIDJUITests</td>
<td>iOS</td>
<td>UI automation tests</td>
</tr>
</tbody>
</table>
<p><strong>Creating targets:</strong> File â†’ New â†’ Target â†’ Select
platform and template</p>
<p>Each target has its own: - Source files (or shares them via target
membership) - Build settings - Entitlements and capabilities -
Info.plist</p>
<hr />
<h3 id="schemes">Schemes</h3>
<p>A <strong>scheme</strong> defines how to build, run, and test a
target. Think of it as a â€œrecipeâ€ for working with your app.</p>
<p>Edit schemes: Product â†’ Scheme â†’ Edit Scheme (âŒ˜â‡§&lt;)</p>
<p><strong>Scheme actions:</strong> - <strong>Build:</strong> Which
targets and configurations to build - <strong>Run:</strong> Launch
arguments, environment variables - <strong>Test:</strong> Which test
suites to run - <strong>Profile:</strong> Launch into Instruments for
profiling - <strong>Analyze:</strong> Static analysis for potential bugs
- <strong>Archive:</strong> Build for distribution</p>
<p><strong>AI DJ Tip:</strong> Create separate schemes for: -
Development (debug build, simulator) - Device testing (debug build,
physical device) - Release (optimized build for TestFlight)</p>
<hr />
<h3 id="build-configurations">Build Configurations</h3>
<p>Default configurations: - <strong>Debug:</strong> Unoptimized,
includes debug symbols, assertions enabled - <strong>Release:</strong>
Optimized, stripped symbols, for distribution</p>
<p>You can create custom configurations for: - Staging/beta environments
- Different API endpoints - Feature flags</p>
<hr />
<h2 id="swift-package-manager">2.3 Swift Package Manager</h2>
<p>SPM is Appleâ€™s dependency manager, integrated directly into
Xcode.</p>
<h3 id="adding-dependencies">Adding Dependencies</h3>
<p><strong>Via Xcode:</strong> File â†’ Add Package Dependencies â†’ Enter
URL â†’ Select version</p>
<p><strong>Version rules:</strong> | Rule | Syntax | Meaning |
|â€”â€”|â€”â€”â€“|â€”â€”â€”| | Up to Next Major | <code>from: &quot;1.0.0&quot;</code> | 1.x.x
(most common) | | Up to Next Minor |
<code>.upToNextMinor(from: &quot;1.2.0&quot;)</code> | 1.2.x | | Exact |
<code>exact: &quot;1.2.3&quot;</code> | Only this version | | Branch |
<code>.branch(&quot;main&quot;)</code> | Track a branch | | Range |
<code>&quot;1.0.0&quot;..&lt;&quot;2.0.0&quot;</code> | Custom range |</p>
<h3 id="creating-local-packages">Creating Local Packages</h3>
<p>For shared code between targets (like our <code>Brain</code>
module):</p>
<ol type="1">
<li>File â†’ New â†’ Package</li>
<li>Drag package folder into project navigator</li>
<li>Add package dependency to targets that need it</li>
</ol>
<p><strong>AI DJ Structure:</strong></p>
<pre><code>AIDJ/
â”œâ”€â”€ AIDJ/              (iOS app)
â”œâ”€â”€ AIDJ Watch App/    (watchOS app)
â”œâ”€â”€ AIDJ macOS/        (macOS app)
â””â”€â”€ Packages/
    â””â”€â”€ AIDJCore/      (shared logic)
        â”œâ”€â”€ Sources/
        â”‚   â”œâ”€â”€ Brain/      (state engine, ranking)
        â”‚   â”œâ”€â”€ HealthKit/  (health data access)
        â”‚   â””â”€â”€ MusicKit/   (music access)
        â””â”€â”€ Tests/</code></pre>
<hr />
<h2 id="capabilities-and-entitlements">2.4 Capabilities and
Entitlements</h2>
<p>Apple restricts access to sensitive features. You must request
capabilities in Xcode.</p>
<h3 id="adding-capabilities">Adding Capabilities</h3>
<ol type="1">
<li>Select project in navigator</li>
<li>Select target</li>
<li>Go to â€œSigning &amp; Capabilitiesâ€ tab</li>
<li>Click â€œ+ Capabilityâ€</li>
</ol>
<p><strong>Capabilities needed for AI DJ:</strong></p>
<table>
<thead>
<tr>
<th>Capability</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>HealthKit</td>
<td>Read heart rate, HRV, workouts</td>
</tr>
<tr>
<td>MusicKit</td>
<td>Access Apple Music library</td>
</tr>
<tr>
<td>App Groups</td>
<td>Share data between app and extensions</td>
</tr>
<tr>
<td>Background Modes</td>
<td>Audio, Health updates, Background fetch</td>
</tr>
</tbody>
</table>
<p><strong>What happens when you add a capability:</strong> 1. Entry
added to entitlements file (.entitlements) 2. App ID configured in
developer portal 3. Provisioning profile updated</p>
<h3 id="entitlements-file">Entitlements File</h3>
<p>An XML plist that declares what your app can do:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span> <span class="ot">version=</span><span class="st">&quot;1.0&quot;</span> <span class="ot">encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">plist</span> PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;...&quot;<span class="dt">&gt;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">plist</span> <span class="ot">version=</span><span class="st">&quot;1.0&quot;</span>&gt;</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dict</span>&gt;</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;com.apple.developer.healthkit&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">true</span>/&gt;</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;com.apple.developer.healthkit.access&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">array</span>&gt;</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">string</span>&gt;health-records&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">array</span>&gt;</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;com.apple.security.application-groups&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">array</span>&gt;</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">string</span>&gt;group.com.yourcompany.aidj&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">array</span>&gt;</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dict</span>&gt;</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">plist</span>&gt;</span></code></pre></div>
<hr />
<h2 id="debugging">2.5 Debugging</h2>
<h3 id="breakpoints">Breakpoints</h3>
<p><strong>Setting breakpoints:</strong> Click the gutter (line number
area) to add a breakpoint.</p>
<p><strong>Conditional breakpoints:</strong> Right-click breakpoint â†’
Edit Breakpoint - Condition: <code>heartRate &gt; 150</code> - Action:
Log message, play sound, run debugger command - Options: Automatically
continue after evaluating</p>
<p><strong>Symbolic breakpoints:</strong> Break on any call to a method:
- Debug â†’ Breakpoints â†’ Create Symbolic Breakpoint - Symbol:
<code>-[UIViewController viewDidAppear:]</code></p>
<h3 id="lldb-commands">LLDB Commands</h3>
<p>When stopped at a breakpoint, use the debug console:</p>
<pre class="lldb"><code>po object              # Print object description
p variable             # Print variable value
expr variable = 5      # Change variable value
bt                     # Backtrace (call stack)
c                      # Continue execution
n                      # Step over (next line)
s                      # Step into (enter function)
frame variable         # Show all local variables</code></pre>
<h3 id="view-debugging">View Debugging</h3>
<p>For UI issues: Debug â†’ View Debugging â†’ Capture View Hierarchy</p>
<p>This shows a 3D exploded view of your UI hierarchyâ€”incredibly useful
for finding layout issues.</p>
<hr />
<h2 id="key-takeaways---xcode">Key Takeaways - Xcode</h2>
<ol type="1">
<li><strong>Learn the keyboard shortcuts</strong> - âŒ˜â‡§O (Open Quickly)
and âŒ˜B (Build) are essential</li>
<li><strong>Use SwiftUI previews</strong> - Faster iteration than
build-and-run</li>
<li><strong>Understand targets and schemes</strong> - Youâ€™ll have
multiple for AI DJ</li>
<li><strong>Set up capabilities early</strong> - HealthKit and MusicKit
require entitlements</li>
<li><strong>Use local packages for shared code</strong> - Keeps code
organized across platforms</li>
<li><strong>Master the debugger</strong> - Breakpoints and LLDB save
hours of debugging</li>
</ol>
<hr />
<h1 id="swiftui-framework">3. SWIFTUI FRAMEWORK</h1>
<h2 id="why-this-matters-for-ai-dj-2">Why This Matters for AI DJ</h2>
<p>SwiftUI is how we build the user interface across all Apple
platformsâ€”iOS, watchOS, and macOS. With SwiftUI, we write UI code once
and it adapts to each platform. For AI DJ, weâ€™ll use SwiftUI to create:
- Now Playing screens with album art and song info - Real-time heart
rate displays - Mood selection interfaces - Watch complications and
widgets</p>
<p>The declarative nature of SwiftUI means our UI automatically updates
when data changesâ€”perfect for real-time health data.</p>
<hr />
<h2 id="the-declarative-paradigm">3.1 The Declarative Paradigm</h2>
<h3 id="what-makes-swiftui-different">What Makes SwiftUI Different</h3>
<p><strong>Imperative (old way - UIKit):</strong></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create button</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">button</span> <span class="op">=</span> UIButton<span class="op">()</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>button<span class="op">.</span>setTitle<span class="op">(</span><span class="st">&quot;Play&quot;</span><span class="op">,</span> <span class="cf">for</span><span class="op">:</span> <span class="op">.</span>normal<span class="op">)</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>button<span class="op">.</span>backgroundColor <span class="op">=</span> <span class="op">.</span>blue</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>view<span class="op">.</span>addSubview<span class="op">(</span>button<span class="op">)</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>button<span class="op">.</span>frame <span class="op">=</span> CGRect<span class="op">(</span>x<span class="op">:</span> <span class="dv">20</span><span class="op">,</span> y<span class="op">:</span> <span class="dv">100</span><span class="op">,</span> width<span class="op">:</span> <span class="dv">100</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">44</span><span class="op">)</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>button<span class="op">.</span>addTarget<span class="op">(</span><span class="kw">self</span><span class="op">,</span> action<span class="op">:</span> #selector<span class="op">(</span>playTapped<span class="op">),</span> <span class="cf">for</span><span class="op">:</span> <span class="op">.</span>touchUpInside<span class="op">)</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Later, to update:</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>button<span class="op">.</span>setTitle<span class="op">(</span><span class="st">&quot;Pause&quot;</span><span class="op">,</span> <span class="cf">for</span><span class="op">:</span> <span class="op">.</span>normal<span class="op">)</span></span></code></pre></div>
<p><strong>Declarative (SwiftUI):</strong></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> PlayerView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@State</span> <span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>        Button<span class="op">(</span>isPlaying <span class="op">?</span> <span class="st">&quot;Pause&quot;</span> <span class="op">:</span> <span class="st">&quot;Play&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>            isPlaying<span class="op">.</span>toggle<span class="op">()</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">()</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>background<span class="op">(.</span>blue<span class="op">)</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co">// UI automatically updates when isPlaying changes!</span></span></code></pre></div>
<p><strong>What happens:</strong> In SwiftUI, you describe what you want
based on the current state. When state changes, SwiftUI automatically
figures out what needs to update and animates the changes.</p>
<hr />
<h3 id="the-view-protocol">The View Protocol</h3>
<p>Every SwiftUI view conforms to the <code>View</code> protocol:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">protocol</span> View <span class="op">{</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    associatedtype Body<span class="op">:</span> View</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> Self<span class="op">.</span>Body <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What this means:</strong> Each view must provide a
<code>body</code> property that returns another view (or composition of
views). The <code>some View</code> return type hides the complex
concrete type.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> NowPlayingView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">songTitle</span><span class="op">:</span> String</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">artistName</span><span class="op">:</span> String</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>        VStack <span class="op">{</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span>songTitle<span class="op">)</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>title<span class="op">)</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span>artistName<span class="op">)</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>subheadline<span class="op">)</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="basic-views">3.2 Basic Views</h2>
<h3 id="text">Text</h3>
<p><strong>What weâ€™re doing:</strong> Displaying text with various
styles.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Basic text</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span><span class="st">&quot;Hello, World!&quot;</span><span class="op">)</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Styled text</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span><span class="st">&quot;Now Playing&quot;</span><span class="op">)</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>font<span class="op">(.</span>largeTitle<span class="op">)</span>      <span class="co">// System font style</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>fontWeight<span class="op">(.</span>bold<span class="op">)</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>foregroundStyle<span class="op">(.</span>blue<span class="op">)</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>italic<span class="op">()</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Dynamic content</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span><span class="st">&quot;BPM: </span><span class="er">\(</span><span class="st">heartRate, format: .number.precision(.fractionLength(0)))&quot;</span><span class="op">)</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Shows &quot;BPM: 72&quot; (no decimals)</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Formatted dates</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span>Date<span class="op">.</span>now<span class="op">,</span> style<span class="op">:</span> <span class="op">.</span>time<span class="op">)</span>  <span class="co">// &quot;3:45 PM&quot;</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span>Date<span class="op">.</span>now<span class="op">,</span> style<span class="op">:</span> <span class="op">.</span>relative<span class="op">)</span>  <span class="co">// &quot;2 minutes ago&quot;</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Markdown support (iOS 15+)</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span><span class="st">&quot;**Bold** and *italic* and [links](https://example.com)&quot;</span><span class="op">)</span></span></code></pre></div>
<hr />
<h3 id="image">Image</h3>
<p><strong>What weâ€™re doing:</strong> Displaying images from SF Symbols,
assets, or URLs.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">// SF Symbols (built-in icons)</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>font<span class="op">(.</span>largeTitle<span class="op">)</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>foregroundStyle<span class="op">(.</span>red<span class="op">)</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="co">// From asset catalog</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>Image<span class="op">(</span><span class="st">&quot;albumArt&quot;</span><span class="op">)</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>resizable<span class="op">()</span>                    <span class="co">// Enable resizing</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>aspectRatio<span class="op">(</span>contentMode<span class="op">:</span> <span class="op">.</span>fit<span class="op">)</span> <span class="co">// Maintain proportions</span></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>frame<span class="op">(</span>width<span class="op">:</span> <span class="dv">200</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">200</span><span class="op">)</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>clipShape<span class="op">(</span>RoundedRectangle<span class="op">(</span>cornerRadius<span class="op">:</span> <span class="dv">12</span><span class="op">))</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Async image loading from URL</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>AsyncImage<span class="op">(</span>url<span class="op">:</span> albumArtURL<span class="op">)</span> <span class="op">{</span> phase <span class="cf">in</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> phase <span class="op">{</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">.</span>empty<span class="op">:</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>        ProgressView<span class="op">()</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">.</span>success<span class="op">(</span><span class="kw">let</span> <span class="va">image</span><span class="op">):</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>        image</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>resizable<span class="op">()</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>aspectRatio<span class="op">(</span>contentMode<span class="op">:</span> <span class="op">.</span>fill<span class="op">)</span></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">.</span>failure<span class="op">:</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>        Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">)</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>font<span class="op">(.</span>largeTitle<span class="op">)</span></span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@unknown</span> <span class="kw">default</span><span class="op">:</span></span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>        EmptyView<span class="op">()</span></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>frame<span class="op">(</span>width<span class="op">:</span> <span class="dv">200</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">200</span><span class="op">)</span></span></code></pre></div>
<hr />
<h3 id="button">Button</h3>
<p><strong>What weâ€™re doing:</strong> Creating tappable elements that
trigger actions.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple button</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>Button<span class="op">(</span><span class="st">&quot;Play&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    startPlayback<span class="op">()</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="co">// With icon</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>Button <span class="op">{</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    togglePlayback<span class="op">()</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> label<span class="op">:</span> <span class="op">{</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>    Label<span class="op">(</span><span class="st">&quot;Play&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;play.fill&quot;</span><span class="op">)</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>buttonStyle<span class="op">(.</span>borderedProminent<span class="op">)</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom styled button</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>Button<span class="op">(</span>action<span class="op">:</span> skipNext<span class="op">)</span> <span class="op">{</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    HStack <span class="op">{</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>        Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;forward.fill&quot;</span><span class="op">)</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>        Text<span class="op">(</span><span class="st">&quot;Skip&quot;</span><span class="op">)</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>padding<span class="op">()</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>background<span class="op">(.</span>blue<span class="op">)</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>foregroundStyle<span class="op">(.</span>white<span class="op">)</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>clipShape<span class="op">(</span>Capsule<span class="op">())</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Button styles:</strong></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>Button<span class="op">(</span><span class="st">&quot;Tap&quot;</span><span class="op">)</span> <span class="op">{</span> <span class="op">}</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>buttonStyle<span class="op">(.</span>automatic<span class="op">)</span>      <span class="co">// Platform default</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>buttonStyle<span class="op">(.</span>bordered<span class="op">)</span>       <span class="co">// Bordered</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>buttonStyle<span class="op">(.</span>borderedProminent<span class="op">)</span>  <span class="co">// Prominent bordered</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>buttonStyle<span class="op">(.</span>plain<span class="op">)</span>          <span class="co">// No visual treatment</span></span></code></pre></div>
<hr />
<h3 id="input-controls">Input Controls</h3>
<p><strong>TextField:</strong></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="at">@State</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">searchText</span> <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>TextField<span class="op">(</span><span class="st">&quot;Search songs...&quot;</span><span class="op">,</span> text<span class="op">:</span> $searchText<span class="op">)</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>textFieldStyle<span class="op">(.</span>roundedBorder<span class="op">)</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>autocapitalization<span class="op">(.</span>none<span class="op">)</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>onSubmit <span class="op">{</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        performSearch<span class="op">()</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Secure input</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>SecureField<span class="op">(</span><span class="st">&quot;Password&quot;</span><span class="op">,</span> text<span class="op">:</span> $password<span class="op">)</span></span></code></pre></div>
<p><strong>Toggle:</strong></p>
<div class="sourceCode" id="cb91"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="at">@State</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">shuffleEnabled</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>Toggle<span class="op">(</span><span class="st">&quot;Shuffle&quot;</span><span class="op">,</span> isOn<span class="op">:</span> $shuffleEnabled<span class="op">)</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>Toggle<span class="op">(</span>isOn<span class="op">:</span> $shuffleEnabled<span class="op">)</span> <span class="op">{</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    Label<span class="op">(</span><span class="st">&quot;Shuffle&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;shuffle&quot;</span><span class="op">)</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Slider:</strong></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="at">@State</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">volume</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>Slider<span class="op">(</span>value<span class="op">:</span> $volume<span class="op">,</span> <span class="cf">in</span><span class="op">:</span> <span class="fl">0.</span><span class="op">.</span><span class="fl">.1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Volume&quot;</span><span class="op">)</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> minimumValueLabel<span class="op">:</span> <span class="op">{</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;speaker&quot;</span><span class="op">)</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> maximumValueLabel<span class="op">:</span> <span class="op">{</span></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;speaker.wave.3&quot;</span><span class="op">)</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Picker:</strong></p>
<div class="sourceCode" id="cb93"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="at">@State</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">selectedMood</span> <span class="op">=</span> <span class="st">&quot;neutral&quot;</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>Picker<span class="op">(</span><span class="st">&quot;Mood&quot;</span><span class="op">,</span> selection<span class="op">:</span> $selectedMood<span class="op">)</span> <span class="op">{</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Calm&quot;</span><span class="op">).</span>tag<span class="op">(</span><span class="st">&quot;calm&quot;</span><span class="op">)</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Neutral&quot;</span><span class="op">).</span>tag<span class="op">(</span><span class="st">&quot;neutral&quot;</span><span class="op">)</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Energize&quot;</span><span class="op">).</span>tag<span class="op">(</span><span class="st">&quot;energize&quot;</span><span class="op">)</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>pickerStyle<span class="op">(.</span>segmented<span class="op">)</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Menu style</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>Picker<span class="op">(</span><span class="st">&quot;Genre&quot;</span><span class="op">,</span> selection<span class="op">:</span> $genre<span class="op">)</span> <span class="op">{</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    ForEach<span class="op">(</span>genres<span class="op">,</span> id<span class="op">:</span> \<span class="op">.</span><span class="kw">self</span><span class="op">)</span> <span class="op">{</span> genre <span class="cf">in</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>        Text<span class="op">(</span>genre<span class="op">)</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>pickerStyle<span class="op">(.</span>menu<span class="op">)</span></span></code></pre></div>
<hr />
<h2 id="layout">3.3 Layout</h2>
<h3 id="stack-views">Stack Views</h3>
<p><strong>VStack - Vertical arrangement:</strong></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>VStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">,</span> spacing<span class="op">:</span> <span class="dv">8</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Title&quot;</span><span class="op">)</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Subtitle&quot;</span><span class="op">)</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Description&quot;</span><span class="op">)</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>HStack - Horizontal arrangement:</strong></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>HStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">16</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;72 BPM&quot;</span><span class="op">)</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    Spacer<span class="op">()</span>  <span class="co">// Pushes remaining content to the right</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Normal&quot;</span><span class="op">)</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>ZStack - Layered (back to front):</strong></p>
<div class="sourceCode" id="cb96"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>ZStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>bottomTrailing<span class="op">)</span> <span class="op">{</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>    Image<span class="op">(</span><span class="st">&quot;albumArt&quot;</span><span class="op">)</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>resizable<span class="op">()</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Overlay badge</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Playing&quot;</span><span class="op">)</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">(</span><span class="dv">6</span><span class="op">)</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>background<span class="op">(.</span>black<span class="op">.</span>opacity<span class="op">(</span><span class="fl">0.7</span><span class="op">))</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>clipShape<span class="op">(</span>Capsule<span class="op">())</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">(</span><span class="dv">8</span><span class="op">)</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="spacer-and-padding">Spacer and Padding</h3>
<p><strong>Spacer:</strong> Expands to fill available space.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>HStack <span class="op">{</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Left&quot;</span><span class="op">)</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    Spacer<span class="op">()</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Right&quot;</span><span class="op">)</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>VStack <span class="op">{</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Top&quot;</span><span class="op">)</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>    Spacer<span class="op">()</span>  <span class="co">// Pushes top to top, bottom to bottom</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>    Text<span class="op">(</span><span class="st">&quot;Bottom&quot;</span><span class="op">)</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Padding:</strong> Adds space around a view.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span><span class="st">&quot;Hello&quot;</span><span class="op">)</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>padding<span class="op">()</span>                    <span class="co">// Default padding all sides</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>padding<span class="op">(.</span>horizontal<span class="op">,</span> <span class="dv">20</span><span class="op">)</span>     <span class="co">// Horizontal only</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>padding<span class="op">(.</span>top<span class="op">,</span> <span class="dv">10</span><span class="op">)</span>           <span class="co">// Top only</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>padding<span class="op">(</span>EdgeInsets<span class="op">(</span>top<span class="op">:</span> <span class="dv">10</span><span class="op">,</span> leading<span class="op">:</span> <span class="dv">20</span><span class="op">,</span> bottom<span class="op">:</span> <span class="dv">10</span><span class="op">,</span> trailing<span class="op">:</span> <span class="dv">20</span><span class="op">))</span></span></code></pre></div>
<hr />
<h3 id="frame-and-alignment">Frame and Alignment</h3>
<div class="sourceCode" id="cb99"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span><span class="st">&quot;Hello&quot;</span><span class="op">)</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>frame<span class="op">(</span>width<span class="op">:</span> <span class="dv">200</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">100</span><span class="op">)</span>  <span class="co">// Fixed size</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>frame<span class="op">(</span>maxWidth<span class="op">:</span> <span class="op">.</span>infinity<span class="op">)</span>      <span class="co">// Expand horizontally</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>frame<span class="op">(</span>minHeight<span class="op">:</span> <span class="dv">44</span><span class="op">)</span>            <span class="co">// Minimum height</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>frame<span class="op">(</span>maxWidth<span class="op">:</span> <span class="op">.</span>infinity<span class="op">,</span> alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">)</span>  <span class="co">// Left-aligned</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Alignment within frame</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>Text<span class="op">(</span><span class="st">&quot;Aligned&quot;</span><span class="op">)</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>frame<span class="op">(</span>width<span class="op">:</span> <span class="dv">200</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">100</span><span class="op">,</span> alignment<span class="op">:</span> <span class="op">.</span>topLeading<span class="op">)</span></span></code></pre></div>
<hr />
<h3 id="lists-and-grids">Lists and Grids</h3>
<p><strong>List:</strong></p>
<div class="sourceCode" id="cb100"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Song<span class="op">:</span> <span class="dt">Identifiable</span> <span class="op">{</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">id</span><span class="op">:</span> UUID</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">title</span><span class="op">:</span> String</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">artist</span><span class="op">:</span> String</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> SongListView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>        List<span class="op">(</span>songs<span class="op">)</span> <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>            HStack <span class="op">{</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>                VStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">)</span> <span class="op">{</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>                    Text<span class="op">(</span>song<span class="op">.</span>title<span class="op">)</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>                    Text<span class="op">(</span>song<span class="op">.</span>artist<span class="op">)</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>                Spacer<span class="op">()</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>                Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;chevron.right&quot;</span><span class="op">)</span></span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>LazyVGrid:</strong></p>
<div class="sourceCode" id="cb101"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">columns</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    GridItem<span class="op">(.</span>adaptive<span class="op">(</span>minimum<span class="op">:</span> <span class="dv">150</span><span class="op">))</span>  <span class="co">// As many as fit, min 150pt wide</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>LazyVGrid<span class="op">(</span>columns<span class="op">:</span> columns<span class="op">,</span> spacing<span class="op">:</span> <span class="dv">20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    ForEach<span class="op">(</span>songs<span class="op">)</span> <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>        AlbumArtView<span class="op">(</span>song<span class="op">:</span> song<span class="op">)</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="state-management">3.4 State Management</h2>
<p>This is crucial for SwiftUIâ€”understanding how data flows through your
views.</p>
<h3 id="state---local-view-state"><span class="citation" data-cites="State">@State</span> - Local View State</h3>
<p><strong>What weâ€™re doing:</strong> Creating mutable state that
belongs to a single view.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> PlayerControls<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@State</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span>  <span class="co">// View owns this state</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@State</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">volume</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>        VStack <span class="op">{</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>            Button<span class="op">(</span>isPlaying <span class="op">?</span> <span class="st">&quot;Pause&quot;</span> <span class="op">:</span> <span class="st">&quot;Play&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>                isPlaying<span class="op">.</span>toggle<span class="op">()</span>  <span class="co">// Modifying state triggers UI update</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>            Slider<span class="op">(</span>value<span class="op">:</span> $volume<span class="op">)</span>  <span class="co">// $volume is a Binding</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> When <code>@State</code> values
change, SwiftUI re-renders the view. The <code>$</code> prefix creates a
<code>Binding</code> that allows two-way data flow.</p>
<hr />
<h3 id="binding---shared-mutable-state"><span class="citation" data-cites="Binding">@Binding</span> - Shared Mutable State</h3>
<p><strong>What weâ€™re doing:</strong> Passing state down to child views
so they can read and modify it.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ParentView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@State</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">volume</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>        VolumeSlider<span class="op">(</span>volume<span class="op">:</span> $volume<span class="op">)</span>  <span class="co">// Pass binding to child</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> VolumeSlider<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Binding</span> <span class="kw">var</span> <span class="va">volume</span><span class="op">:</span> Double  <span class="co">// Receive binding</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>        Slider<span class="op">(</span>value<span class="op">:</span> $volume<span class="op">,</span> <span class="cf">in</span><span class="op">:</span> <span class="fl">0.</span><span class="op">.</span><span class="fl">.1</span><span class="op">)</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Changes here update ParentView&#39;s volume</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="stateobject-and-observedobject"><span class="citation" data-cites="StateObject">@StateObject</span> and <span class="citation" data-cites="ObservedObject">@ObservedObject</span></h3>
<p>For complex state that needs to persist or be shared, use
<code>ObservableObject</code>:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The data model</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NowPlayingState<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> Song<span class="op">?</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">heartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">play</span><span class="op">(</span><span class="va">_</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>        currentSong <span class="op">=</span> song</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>        isPlaying <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="co">// View that owns the state object</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ContentView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">@StateObject</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">nowPlaying</span> <span class="op">=</span> NowPlayingState<span class="op">()</span></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>        PlayerView<span class="op">(</span>state<span class="op">:</span> nowPlaying<span class="op">)</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Child view that observes it</span></span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> PlayerView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ObservedObject</span> <span class="kw">var</span> <span class="va">state</span><span class="op">:</span> NowPlayingState</span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>        VStack <span class="op">{</span></span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> state<span class="op">.</span>currentSong <span class="op">{</span></span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>song<span class="op">.</span>title<span class="op">)</span></span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span><span class="st">&quot;HR: </span><span class="er">\(</span><span class="st">state.heartRate, format: .number)&quot;</span><span class="op">)</span></span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>When to use which:</strong> - <code>@StateObject</code> -
View creates and owns the object (use in parent) -
<code>@ObservedObject</code> - View receives object from elsewhere (use
in children) - <code>@State</code> - Simple value types, local to
view</p>
<hr />
<h3 id="environmentobject---dependency-injection"><span class="citation" data-cites="EnvironmentObject">@EnvironmentObject</span> - Dependency
Injection</h3>
<p>For data that many views need access to:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AppState<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">user</span><span class="op">:</span> User<span class="op">?</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isAuthenticated</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co">// At app root</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="at">@main</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AIDJApp<span class="op">:</span> <span class="dt">App</span> <span class="op">{</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@StateObject</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">appState</span> <span class="op">=</span> AppState<span class="op">()</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some Scene <span class="op">{</span></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>        WindowGroup <span class="op">{</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>            ContentView<span class="op">()</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>environmentObject<span class="op">(</span>appState<span class="op">)</span>  <span class="co">// Inject into environment</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Any descendant view can access it</span></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> SettingsView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">@EnvironmentObject</span> <span class="kw">var</span> <span class="va">appState</span><span class="op">:</span> AppState  <span class="co">// Pull from environment</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> appState<span class="op">.</span>isAuthenticated <span class="op">{</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Show settings</span></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="navigation">3.5 Navigation</h2>
<h3 id="navigationstack-ios-16">NavigationStack (iOS 16+)</h3>
<div class="sourceCode" id="cb106"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MainView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>        NavigationStack <span class="op">{</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>            List<span class="op">(</span>songs<span class="op">)</span> <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>                NavigationLink<span class="op">(</span>value<span class="op">:</span> song<span class="op">)</span> <span class="op">{</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>                    SongRow<span class="op">(</span>song<span class="op">:</span> song<span class="op">)</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>navigationTitle<span class="op">(</span><span class="st">&quot;Songs&quot;</span><span class="op">)</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>navigationDestination<span class="op">(</span><span class="cf">for</span><span class="op">:</span> Song<span class="op">.</span><span class="kw">self</span><span class="op">)</span> <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>                SongDetailView<span class="op">(</span>song<span class="op">:</span> song<span class="op">)</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="tabview">TabView</h3>
<div class="sourceCode" id="cb107"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MainTabView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>        TabView <span class="op">{</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>            NowPlayingView<span class="op">()</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>tabItem <span class="op">{</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;Now Playing&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;play.circle&quot;</span><span class="op">)</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>            LibraryView<span class="op">()</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>tabItem <span class="op">{</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;Library&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;music.note.list&quot;</span><span class="op">)</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>            SettingsView<span class="op">()</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>tabItem <span class="op">{</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;Settings&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;gear&quot;</span><span class="op">)</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="ai-dj-example---now-playing-view">3.6 AI DJ Example - Now
Playing View</h2>
<p>Putting it all together:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> NowPlayingView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@StateObject</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">viewModel</span> <span class="op">=</span> NowPlayingViewModel<span class="op">()</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>        VStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Album Art</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>            AsyncImage<span class="op">(</span>url<span class="op">:</span> viewModel<span class="op">.</span>currentSong<span class="op">?.</span>artworkURL<span class="op">)</span> <span class="op">{</span> image <span class="cf">in</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>                image<span class="op">.</span>resizable<span class="op">()</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> placeholder<span class="op">:</span> <span class="op">{</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>                RoundedRectangle<span class="op">(</span>cornerRadius<span class="op">:</span> <span class="dv">12</span><span class="op">)</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>fill<span class="op">(.</span>gray<span class="op">.</span>opacity<span class="op">(</span><span class="fl">0.3</span><span class="op">))</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>overlay <span class="op">{</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>                        Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">)</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>                            <span class="op">.</span>font<span class="op">(.</span>largeTitle<span class="op">)</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>aspectRatio<span class="op">(</span><span class="dv">1</span><span class="op">,</span> contentMode<span class="op">:</span> <span class="op">.</span>fit<span class="op">)</span></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>frame<span class="op">(</span>maxWidth<span class="op">:</span> <span class="dv">300</span><span class="op">)</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>clipShape<span class="op">(</span>RoundedRectangle<span class="op">(</span>cornerRadius<span class="op">:</span> <span class="dv">12</span><span class="op">))</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>shadow<span class="op">(</span>radius<span class="op">:</span> <span class="dv">10</span><span class="op">)</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Song Info</span></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>            VStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>viewModel<span class="op">.</span>currentSong<span class="op">?.</span>title <span class="op">??</span> <span class="st">&quot;Not Playing&quot;</span><span class="op">)</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>title2<span class="op">)</span></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>fontWeight<span class="op">(.</span>semibold<span class="op">)</span></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>viewModel<span class="op">.</span>currentSong<span class="op">?.</span>artist <span class="op">??</span> <span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>subheadline<span class="op">)</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Biometric Info</span></span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>            HStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">30</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a>                BiometricPill<span class="op">(</span></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>                    icon<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">,</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>                    value<span class="op">:</span> <span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(viewModel.heartRate))&quot;</span><span class="op">,</span></span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>                    unit<span class="op">:</span> <span class="st">&quot;BPM&quot;</span><span class="op">,</span></span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">:</span> <span class="op">.</span>red</span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">)</span></span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a>                BiometricPill<span class="op">(</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a>                    icon<span class="op">:</span> <span class="st">&quot;waveform.path.ecg&quot;</span><span class="op">,</span></span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a>                    value<span class="op">:</span> <span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(viewModel.hrv))&quot;</span><span class="op">,</span></span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>                    unit<span class="op">:</span> <span class="st">&quot;HRV&quot;</span><span class="op">,</span></span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">:</span> <span class="op">.</span>green</span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a>                <span class="op">)</span></span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Playback Controls</span></span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a>            HStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">40</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a>                Button <span class="op">{</span> viewModel<span class="op">.</span>previousSong<span class="op">()</span> <span class="op">}</span> label<span class="op">:</span> <span class="op">{</span></span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a>                    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;backward.fill&quot;</span><span class="op">)</span></span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>title<span class="op">)</span></span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a>                Button <span class="op">{</span> viewModel<span class="op">.</span>togglePlayback<span class="op">()</span> <span class="op">}</span> label<span class="op">:</span> <span class="op">{</span></span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a>                    Image<span class="op">(</span>systemName<span class="op">:</span> viewModel<span class="op">.</span>isPlaying <span class="op">?</span> <span class="st">&quot;pause.circle.fill&quot;</span> <span class="op">:</span> <span class="st">&quot;play.circle.fill&quot;</span><span class="op">)</span></span>
<span id="cb108-59"><a href="#cb108-59" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>system<span class="op">(</span>size<span class="op">:</span> <span class="dv">64</span><span class="op">))</span></span>
<span id="cb108-60"><a href="#cb108-60" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb108-61"><a href="#cb108-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-62"><a href="#cb108-62" aria-hidden="true" tabindex="-1"></a>                Button <span class="op">{</span> viewModel<span class="op">.</span>nextSong<span class="op">()</span> <span class="op">}</span> label<span class="op">:</span> <span class="op">{</span></span>
<span id="cb108-63"><a href="#cb108-63" aria-hidden="true" tabindex="-1"></a>                    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;forward.fill&quot;</span><span class="op">)</span></span>
<span id="cb108-64"><a href="#cb108-64" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>title<span class="op">)</span></span>
<span id="cb108-65"><a href="#cb108-65" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb108-66"><a href="#cb108-66" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-67"><a href="#cb108-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>foregroundStyle<span class="op">(.</span>primary<span class="op">)</span></span>
<span id="cb108-68"><a href="#cb108-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-69"><a href="#cb108-69" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Why this song</span></span>
<span id="cb108-70"><a href="#cb108-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="va">reason</span> <span class="op">=</span> viewModel<span class="op">.</span>selectionReason <span class="op">{</span></span>
<span id="cb108-71"><a href="#cb108-71" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>reason<span class="op">)</span></span>
<span id="cb108-72"><a href="#cb108-72" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb108-73"><a href="#cb108-73" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb108-74"><a href="#cb108-74" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>padding<span class="op">(.</span>horizontal<span class="op">)</span></span>
<span id="cb108-75"><a href="#cb108-75" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>multilineTextAlignment<span class="op">(.</span>center<span class="op">)</span></span>
<span id="cb108-76"><a href="#cb108-76" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-77"><a href="#cb108-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-78"><a href="#cb108-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">()</span></span>
<span id="cb108-79"><a href="#cb108-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-80"><a href="#cb108-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb108-81"><a href="#cb108-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-82"><a href="#cb108-82" aria-hidden="true" tabindex="-1"></a><span class="co">// Reusable component</span></span>
<span id="cb108-83"><a href="#cb108-83" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> BiometricPill<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb108-84"><a href="#cb108-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">icon</span><span class="op">:</span> String</span>
<span id="cb108-85"><a href="#cb108-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">value</span><span class="op">:</span> String</span>
<span id="cb108-86"><a href="#cb108-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">unit</span><span class="op">:</span> String</span>
<span id="cb108-87"><a href="#cb108-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">color</span><span class="op">:</span> Color</span>
<span id="cb108-88"><a href="#cb108-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-89"><a href="#cb108-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb108-90"><a href="#cb108-90" aria-hidden="true" tabindex="-1"></a>        HStack <span class="op">{</span></span>
<span id="cb108-91"><a href="#cb108-91" aria-hidden="true" tabindex="-1"></a>            Image<span class="op">(</span>systemName<span class="op">:</span> icon<span class="op">)</span></span>
<span id="cb108-92"><a href="#cb108-92" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>foregroundStyle<span class="op">(</span>color<span class="op">)</span></span>
<span id="cb108-93"><a href="#cb108-93" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span>value<span class="op">)</span></span>
<span id="cb108-94"><a href="#cb108-94" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>fontWeight<span class="op">(.</span>semibold<span class="op">)</span></span>
<span id="cb108-95"><a href="#cb108-95" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span>unit<span class="op">)</span></span>
<span id="cb108-96"><a href="#cb108-96" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb108-97"><a href="#cb108-97" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb108-98"><a href="#cb108-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-99"><a href="#cb108-99" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">(.</span>horizontal<span class="op">,</span> <span class="dv">12</span><span class="op">)</span></span>
<span id="cb108-100"><a href="#cb108-100" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">(.</span>vertical<span class="op">,</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb108-101"><a href="#cb108-101" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>background<span class="op">(.</span>regularMaterial<span class="op">)</span></span>
<span id="cb108-102"><a href="#cb108-102" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>clipShape<span class="op">(</span>Capsule<span class="op">())</span></span>
<span id="cb108-103"><a href="#cb108-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-104"><a href="#cb108-104" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---swiftui">Key Takeaways - SwiftUI</h2>
<ol type="1">
<li><strong>Think declaratively</strong> - Describe what you want, not
how to create it</li>
<li><strong>State drives UI</strong> - When state changes, UI updates
automatically</li>
<li><strong>Use the right state wrapper:</strong>
<ul>
<li><code>@State</code> for simple, local view state</li>
<li><code>@StateObject</code> for complex objects you create</li>
<li><code>@ObservedObject</code> for complex objects passed to you</li>
<li><code>@EnvironmentObject</code> for app-wide state</li>
</ul></li>
<li><strong>Modifiers create new views</strong> - Order matters!</li>
<li><strong>Extract reusable components</strong> - Like
<code>BiometricPill</code> above</li>
<li><strong>Use previews</strong> - Faster than build-and-run</li>
</ol>
<hr />
<h1 id="swift-concurrency-combine">4. SWIFT CONCURRENCY &amp;
COMBINE</h1>
<h2 id="why-this-matters-for-ai-dj-3">Why This Matters for AI DJ</h2>
<p>AI DJ constantly performs asynchronous operations: fetching health
data from HealthKit, querying songs from MusicKit, sending data between
iPhone and Watch, and updating the UI with real-time biometrics. Swiftâ€™s
modern concurrency system (async/await) makes this code readable and
safe, while Combine provides reactive streams for continuous data like
heart rate updates.</p>
<p><strong>In AI DJ, youâ€™ll use concurrency for:</strong> - Fetching
heart rate samples without blocking the UI - Loading playlists and song
metadata in parallel - Streaming real-time health updates to the scoring
algorithm - Coordinating data between Watch and iPhone</p>
<hr />
<h2 id="asyncawait-basics">4.1 Async/Await Basics</h2>
<p>Swiftâ€™s structured concurrency, introduced in Swift 5.5 and refined
through Swift 6, represents a fundamental shift in how we write
asynchronous code. According to <a href="https://www.avanderlee.com/swift/async-await/">SwiftLee</a> and
other Swift experts, async/await eliminates entire categories of bugs
related to forgotten completions, retain cycles in closures, and the
cognitive overhead of â€œcallback hell.â€ The Swift compiler now helps
verify correctness of concurrent code at compile time rather than
leaving you to discover race conditions at runtime.</p>
<h3 id="the-problem-with-callbacks">The Problem with Callbacks</h3>
<p>Before async/await, asynchronous programming in Swift used completion
handlersâ€”closures that get called when an operation finishes. While
functional, this approach leads to deeply nested code, scattered error
handling, and a non-linear flow thatâ€™s hard to follow. Each level of
nesting adds cognitive load, and itâ€™s easy to forget to call a
completion handler in some code path.</p>
<p>The async/await model transforms this into sequential-looking code.
Your function suspends at <code>await</code> points, freeing the thread
to do other work, then resumes exactly where it left off when the result
is ready. The compiler tracks this flow, ensuring you handle errors
properly and canâ€™t accidentally forget to await an async call.</p>
<p><strong>What weâ€™re doing:</strong> Understanding why async/await is
better than traditional callbacks, and how it transforms asynchronous
code into readable, maintainable form.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co">// OLD WAY - Callback hell (nested, hard to read)</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">loadDashboard</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    fetchUser <span class="op">{</span> user <span class="cf">in</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>        fetchPlaylists<span class="op">(</span><span class="cf">for</span><span class="op">:</span> user<span class="op">)</span> <span class="op">{</span> playlists <span class="cf">in</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>            fetchHealthData <span class="op">{</span> health <span class="cf">in</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Finally do something with all the data</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Error handling is scattered everywhere</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a><span class="co">// NEW WAY - Async/await (linear, readable)</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">loadDashboard</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">user</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> fetchUser<span class="op">()</span></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">playlists</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> fetchPlaylists<span class="op">(</span><span class="cf">for</span><span class="op">:</span> user<span class="op">)</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">health</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> fetchHealthData<span class="op">()</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clean, linear code that reads top-to-bottom</span></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> With async/await, the function
suspends at each <code>await</code> point, yielding the thread so other
code can run. When the awaited operation completes, the Swift runtime
resumes execution at exactly that point. Importantly, as noted by <a href="https://www.zen8labs.com/insights/mobile-application/best-practices-for-mastering-concurrency-in-swift-with-async-await/">zen8labs</a>,
each await might resume on a different threadâ€”you should never assume
the thread remains the same across await points.</p>
<hr />
<h3 id="declaring-async-functions">Declaring Async Functions</h3>
<p>The <code>async</code> keyword marks a function as potentially
suspendingâ€”it might pause execution to wait for some operation to
complete. When you call an async function, you must use
<code>await</code>, which signals to the compiler and to readers that
this is a suspension point. The combination of <code>async</code> and
<code>throws</code> (written as <code>async throws</code>) indicates a
function that can both suspend and fail.</p>
<p>One important performance consideration from <a href="https://medium.com/@qquang269/async-await-in-swift-best-practices-and-pitfalls-to-avoid-865ddc2921dd">Mediumâ€™s
best practices guide</a>: async functions have a slightly different
calling convention than synchronous functions, meaning thereâ€™s a small
overhead. For hot paths called thousands of times, you might keep
synchronous versions. But for I/O operations like network requests or
health data queries, this overhead is negligible compared to the
operation itself.</p>
<p><strong>What weâ€™re doing:</strong> Creating functions that can
perform asynchronous work by marking them with <code>async</code>, and
optionally <code>throws</code> if they can fail. These functions can
suspend their execution at <code>await</code> points without blocking
any thread.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Mark function as async - it can suspend</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchHeartRate</span><span class="op">()</span> <span class="fu">async</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simulate async work</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span><span class="op">?</span> <span class="cf">await</span> Task<span class="op">.</span>sleep<span class="op">(</span>nanoseconds<span class="op">:</span> <span class="dv">1_000_000_000</span><span class="op">)</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="fl">72.5</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Async function that can also throw errors</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchSong</span><span class="op">(</span><span class="va">id</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">Song</span> <span class="op">{</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">url</span> <span class="op">=</span> URL<span class="op">(</span>string<span class="op">:</span> <span class="st">&quot;https://api.music.apple.com/songs/</span><span class="er">\(</span><span class="st">id)&quot;</span><span class="op">)</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throw</span> NetworkError<span class="op">.</span>invalidURL</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (<span class="va">data</span><span class="op">,</span> _<span class="op">)</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> URLSession<span class="op">.</span>shared<span class="op">.</span>data<span class="op">(</span>from<span class="op">:</span> url<span class="op">)</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="cf">try</span> JSONDecoder<span class="op">().</span>decode<span class="op">(</span>Song<span class="op">.</span><span class="kw">self</span><span class="op">,</span> from<span class="op">:</span> data<span class="op">)</span></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Calling async functions - must use await</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">updateUI</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRate</span> <span class="op">=</span> <span class="cf">await</span> fetchHeartRate<span class="op">()</span>  <span class="co">// Suspends here</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Heart rate: </span><span class="er">\(</span><span class="st">heartRate)&quot;</span><span class="op">)</span>        <span class="co">// Resumes when done</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> The <code>async</code> keyword marks a
function as asynchronous. Inside, you can use <code>await</code> to call
other async functions. The function suspends at <code>await</code>
points without blocking the threadâ€”the thread is freed to do other work
until the operation completes.</p>
<hr />
<h3 id="calling-async-code-from-sync-context">Calling Async Code from
Sync Context</h3>
<p><strong>What weâ€™re doing:</strong> Bridging between synchronous code
(like SwiftUI views) and async functions.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In SwiftUI, use .task modifier</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> HeartRateView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@State</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">heartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>        Text<span class="op">(</span><span class="st">&quot;HR: </span><span class="er">\(</span><span class="st">Int(heartRate)) BPM&quot;</span><span class="op">)</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>task <span class="op">{</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>                <span class="co">// This runs async when view appears</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>                heartRate <span class="op">=</span> <span class="cf">await</span> fetchHeartRate<span class="op">()</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Or use Task to create async context</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ViewModel<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">loadSongs</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">{</span></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Now we&#39;re in async context</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>                songs <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> fetchAllSongs<span class="op">()</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a>                print<span class="op">(</span><span class="st">&quot;Failed to load: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> <code>Task { }</code> creates a new
asynchronous context. The <code>.task</code> modifier in SwiftUI
automatically creates and cancels tasks tied to the viewâ€™s
lifecycle.</p>
<hr />
<h2 id="structured-concurrency">4.2 Structured Concurrency</h2>
<h3 id="task-groups---parallel-execution">Task Groups - Parallel
Execution</h3>
<p><strong>What weâ€™re doing:</strong> Running multiple async operations
in parallel and collecting results.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Fetch multiple songs in parallel</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchSongs</span><span class="op">(</span><span class="va">ids</span><span class="op">:</span> [<span class="dt">String</span>]<span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="cf">await</span> withThrowingTaskGroup<span class="op">(</span>of<span class="op">:</span> Song<span class="op">.</span><span class="kw">self</span><span class="op">)</span> <span class="op">{</span> group <span class="cf">in</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> id <span class="cf">in</span> ids <span class="op">{</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>            group<span class="op">.</span>addTask <span class="op">{</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span> <span class="cf">await</span> fetchSong<span class="op">(</span>id<span class="op">:</span> id<span class="op">)</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="cf">try</span> <span class="cf">await</span> song <span class="cf">in</span> group <span class="op">{</span></span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>            songs<span class="op">.</span>append<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> songs</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> Each <code>addTask</code> creates a
child task that runs concurrently. The <code>for try await</code> loop
collects results as they complete. If any task throws, the group cancels
remaining tasks.</p>
<p><strong>AI DJ Example:</strong></p>
<div class="sourceCode" id="cb113"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Fetch health data and music data in parallel</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">loadDashboardData</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">DashboardData</span> <span class="op">{</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">let</span> <span class="va">healthData</span> <span class="op">=</span> fetchHealthData<span class="op">()</span>      <span class="co">// Starts immediately</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">let</span> <span class="va">playlists</span> <span class="op">=</span> fetchPlaylists<span class="op">()</span>        <span class="co">// Starts immediately</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">let</span> <span class="va">recommendations</span> <span class="op">=</span> getRecommendations<span class="op">()</span>  <span class="co">// Starts immediately</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Wait for all three to complete</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="cf">try</span> <span class="cf">await</span> DashboardData<span class="op">(</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>        health<span class="op">:</span> healthData<span class="op">,</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>        playlists<span class="op">:</span> playlists<span class="op">,</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>        recommendations<span class="op">:</span> recommendations</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> <code>async let</code> starts each
operation immediately and runs them concurrently. The <code>await</code>
at the end waits for all to complete. This is faster than sequential
awaits.</p>
<hr />
<h3 id="task-cancellation">Task Cancellation</h3>
<p><strong>What weâ€™re doing:</strong> Handling cancellation gracefully
when operations are no longer needed.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchWithCancellation</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> id <span class="cf">in</span> songIds <span class="op">{</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if task was cancelled</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> Task<span class="op">.</span>checkCancellation<span class="op">()</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Or check without throwing</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> Task<span class="op">.</span>isCancelled <span class="op">{</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> songs  <span class="co">// Return partial results</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> fetchSong<span class="op">(</span>id<span class="op">:</span> id<span class="op">)</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>        songs<span class="op">.</span>append<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> songs</span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Cancel a task</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">task</span> <span class="op">=</span> Task <span class="op">{</span></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="cf">await</span> fetchWithCancellation<span class="op">()</span></span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Later, if user navigates away</span></span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>task<span class="op">.</span>cancel<span class="op">()</span></span></code></pre></div>
<p><strong>What happens:</strong> <code>Task.checkCancellation()</code>
throws <code>CancellationError</code> if cancelled.
<code>Task.isCancelled</code> lets you check without throwing. Always
handle cancellation in long-running operations.</p>
<hr />
<h2 id="actors---safe-concurrent-state">4.3 Actors - Safe Concurrent
State</h2>
<h3 id="the-problem-data-races">The Problem: Data Races</h3>
<p><strong>What weâ€™re doing:</strong> Understanding why we need actors
for shared mutable state.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co">// UNSAFE - Data race possible</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UnsafeCounter <span class="op">{</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">count</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">increment</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span>  <span class="co">// Multiple threads can conflict here</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a><span class="co">// SAFE - Actor protects state</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="cf">actor</span> SafeCounter <span class="op">{</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">count</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">increment</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> <span class="dv">1</span>  <span class="co">// Only one caller at a time</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Using an actor</span></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">counter</span> <span class="op">=</span> SafeCounter<span class="op">()</span></span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> counter<span class="op">.</span>increment<span class="op">()</span>  <span class="co">// Must await actor methods</span></span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">value</span> <span class="op">=</span> <span class="cf">await</span> counter<span class="op">.</span>count  <span class="co">// Must await property access too</span></span></code></pre></div>
<p><strong>What happens:</strong> Actors serialize access to their
state. Only one task can execute actor code at a time, preventing data
races. All access from outside requires <code>await</code>.</p>
<hr />
<h3 id="ai-dj-example---state-manager-actor">AI DJ Example - State
Manager Actor</h3>
<div class="sourceCode" id="cb116"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="cf">actor</span> BiometricStateManager <span class="op">{</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">heartRateSamples</span><span class="op">:</span> <span class="op">[</span>Double<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">hrvSamples</span><span class="op">:</span> <span class="op">[</span>Double<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">maxSamples</span> <span class="op">=</span> <span class="dv">60</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">addHeartRate</span><span class="op">(</span><span class="va">_</span> <span class="va">rate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>        heartRateSamples<span class="op">.</span>append<span class="op">(</span>rate<span class="op">)</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> heartRateSamples<span class="op">.</span>count <span class="op">&gt;</span> maxSamples <span class="op">{</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>            heartRateSamples<span class="op">.</span>removeFirst<span class="op">()</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">addHRV</span><span class="op">(</span><span class="va">_</span> <span class="va">hrv</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a>        hrvSamples<span class="op">.</span>append<span class="op">(</span>hrv<span class="op">)</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> hrvSamples<span class="op">.</span>count <span class="op">&gt;</span> maxSamples <span class="op">{</span></span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>            hrvSamples<span class="op">.</span>removeFirst<span class="op">()</span></span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb116-19"><a href="#cb116-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-20"><a href="#cb116-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">averageHeartRate</span><span class="op">:</span> Double <span class="op">{</span></span>
<span id="cb116-21"><a href="#cb116-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="op">!</span>heartRateSamples<span class="op">.</span>isEmpty <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb116-22"><a href="#cb116-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> heartRateSamples<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span> <span class="op">/</span> Double<span class="op">(</span>heartRateSamples<span class="op">.</span>count<span class="op">)</span></span>
<span id="cb116-23"><a href="#cb116-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb116-24"><a href="#cb116-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-25"><a href="#cb116-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">currentState</span><span class="op">:</span> StateVector <span class="op">{</span></span>
<span id="cb116-26"><a href="#cb116-26" aria-hidden="true" tabindex="-1"></a>        StateVector<span class="op">(</span></span>
<span id="cb116-27"><a href="#cb116-27" aria-hidden="true" tabindex="-1"></a>            heartRate<span class="op">:</span> averageHeartRate<span class="op">,</span></span>
<span id="cb116-28"><a href="#cb116-28" aria-hidden="true" tabindex="-1"></a>            hrv<span class="op">:</span> hrvSamples<span class="op">.</span>last <span class="op">??</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb116-29"><a href="#cb116-29" aria-hidden="true" tabindex="-1"></a>            trend<span class="op">:</span> calculateTrend<span class="op">()</span></span>
<span id="cb116-30"><a href="#cb116-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb116-31"><a href="#cb116-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb116-32"><a href="#cb116-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-33"><a href="#cb116-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">calculateTrend</span><span class="op">()</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb116-34"><a href="#cb116-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> heartRateSamples<span class="op">.</span>count <span class="op">&gt;=</span> <span class="dv">10</span> <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb116-35"><a href="#cb116-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">recent</span> <span class="op">=</span> Array<span class="op">(</span>heartRateSamples<span class="op">.</span>suffix<span class="op">(</span><span class="dv">5</span><span class="op">))</span></span>
<span id="cb116-36"><a href="#cb116-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">older</span> <span class="op">=</span> Array<span class="op">(</span>heartRateSamples<span class="op">.</span>suffix<span class="op">(</span><span class="dv">10</span><span class="op">).</span>prefix<span class="op">(</span><span class="dv">5</span><span class="op">))</span></span>
<span id="cb116-37"><a href="#cb116-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> recent<span class="op">.</span>average <span class="op">-</span> older<span class="op">.</span>average</span>
<span id="cb116-38"><a href="#cb116-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb116-39"><a href="#cb116-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb116-40"><a href="#cb116-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-41"><a href="#cb116-41" aria-hidden="true" tabindex="-1"></a><span class="co">// Usage</span></span>
<span id="cb116-42"><a href="#cb116-42" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">stateManager</span> <span class="op">=</span> BiometricStateManager<span class="op">()</span></span>
<span id="cb116-43"><a href="#cb116-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-44"><a href="#cb116-44" aria-hidden="true" tabindex="-1"></a><span class="co">// From HealthKit callback</span></span>
<span id="cb116-45"><a href="#cb116-45" aria-hidden="true" tabindex="-1"></a>Task <span class="op">{</span></span>
<span id="cb116-46"><a href="#cb116-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> stateManager<span class="op">.</span>addHeartRate<span class="op">(</span><span class="fl">75.0</span><span class="op">)</span></span>
<span id="cb116-47"><a href="#cb116-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">state</span> <span class="op">=</span> <span class="cf">await</span> stateManager<span class="op">.</span>currentState</span>
<span id="cb116-48"><a href="#cb116-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> updateMusicSelection<span class="op">(</span><span class="cf">for</span><span class="op">:</span> state<span class="op">)</span></span>
<span id="cb116-49"><a href="#cb116-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="mainactor---ui-thread-safety">MainActor - UI Thread Safety</h3>
<p><strong>What weâ€™re doing:</strong> Ensuring UI updates happen on the
main thread.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Mark entire class as MainActor</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="at">@MainActor</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NowPlayingViewModel<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> Song<span class="op">?</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">heartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">updateHeartRate</span><span class="op">(</span><span class="va">_</span> <span class="va">rate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        heartRate <span class="op">=</span> rate  <span class="co">// Safe - guaranteed on main thread</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Or mark individual functions</span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataManager <span class="op">{</span></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@MainActor</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">updateUI</span><span class="op">(</span><span class="va">with</span> <span class="va">data</span><span class="op">:</span> <span class="dt">Data</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This always runs on main thread</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">processInBackground</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> <span class="cf">await</span> heavyComputation<span class="op">()</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Switch to main thread for UI update</span></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a>            updateUI<span class="op">(</span>with<span class="op">:</span> result<span class="op">)</span></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> <code>@MainActor</code> ensures code
runs on the main thread. Use it for all UI-related code. SwiftUIâ€™s
<code>@Published</code> properties should be updated on MainActor.</p>
<hr />
<h2 id="combine-framework">4.4 Combine Framework</h2>
<h3 id="publishers-and-subscribers">Publishers and Subscribers</h3>
<p><strong>What weâ€™re doing:</strong> Creating reactive streams of
values over time.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">Combine</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Publisher emits values over time</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">heartRatePublisher</span> <span class="op">=</span> PassthroughSubject<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;()</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Subscriber receives values</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">cancellable</span> <span class="op">=</span> heartRatePublisher</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>sink <span class="op">{</span> rate <span class="cf">in</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Heart rate: </span><span class="er">\(</span><span class="st">rate)&quot;</span><span class="op">)</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Emit values</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>heartRatePublisher<span class="op">.</span>send<span class="op">(</span><span class="fl">72.0</span><span class="op">)</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>heartRatePublisher<span class="op">.</span>send<span class="op">(</span><span class="fl">75.0</span><span class="op">)</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>heartRatePublisher<span class="op">.</span>send<span class="op">(</span><span class="fl">71.0</span><span class="op">)</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Store cancellable to keep subscription alive</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="va">cancellables</span> <span class="op">=</span> Set<span class="op">&lt;</span>AnyCancellable<span class="op">&gt;()</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>heartRatePublisher</span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>sink <span class="op">{</span> rate <span class="cf">in</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Rate: </span><span class="er">\(</span><span class="st">rate)&quot;</span><span class="op">)</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>store<span class="op">(</span><span class="cf">in</span><span class="op">:</span> <span class="op">&amp;</span>cancellables<span class="op">)</span></span></code></pre></div>
<p><strong>What happens:</strong> Publishers emit values, operators
transform them, subscribers receive them. <code>sink</code> creates a
subscriber. Store the <code>AnyCancellable</code> or the subscription
ends immediately.</p>
<hr />
<h3 id="common-operators">Common Operators</h3>
<p><strong>What weâ€™re doing:</strong> Transforming and filtering streams
of data.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">heartRates</span> <span class="op">=</span> PassthroughSubject<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;()</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>heartRates</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Transform values</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>map <span class="op">{</span> rate <span class="cf">in</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">?</span> <span class="st">&quot;High&quot;</span> <span class="op">:</span> <span class="st">&quot;Normal&quot;</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter values</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>filter <span class="op">{</span> $<span class="dv">0</span> <span class="op">==</span> <span class="st">&quot;High&quot;</span> <span class="op">}</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Remove duplicates</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>removeDuplicates<span class="op">()</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Debounce rapid changes (wait 0.5s of stability)</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>debounce<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>seconds<span class="op">(</span><span class="fl">0.5</span><span class="op">),</span> scheduler<span class="op">:</span> RunLoop<span class="op">.</span>main<span class="op">)</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Receive on main thread</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>receive<span class="op">(</span>on<span class="op">:</span> DispatchQueue<span class="op">.</span>main<span class="op">)</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>sink <span class="op">{</span> status <span class="cf">in</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>        showAlert<span class="op">(</span>status<span class="op">)</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>store<span class="op">(</span><span class="cf">in</span><span class="op">:</span> <span class="op">&amp;</span>cancellables<span class="op">)</span></span></code></pre></div>
<p><strong>Key operators for AI DJ:</strong> | Operator | Purpose | AI
DJ Use Case | |â€”â€”â€”-|â€”â€”â€”|â€”â€”â€”â€”â€”-| | <code>map</code> | Transform values |
Convert HR to stress level | | <code>filter</code> | Keep matching
values | Only process significant changes | | <code>debounce</code> |
Wait for stability | Avoid rapid song switching | |
<code>throttle</code> | Limit rate | Cap UI updates to 1/second | |
<code>combineLatest</code> | Merge streams | Combine HR + HRV into state
| | <code>removeDuplicates</code> | Skip unchanged | Donâ€™t re-rank if
state unchanged |</p>
<hr />
<h3 id="ai-dj-example---reactive-state-processing">AI DJ Example -
Reactive State Processing</h3>
<div class="sourceCode" id="cb120"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BiometricProcessor<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentState</span><span class="op">:</span> UserState <span class="op">=</span> <span class="op">.</span>neutral</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">recommendedMood</span><span class="op">:</span> MusicMood <span class="op">=</span> <span class="op">.</span>neutral</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">cancellables</span> <span class="op">=</span> Set<span class="op">&lt;</span>AnyCancellable<span class="op">&gt;()</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">heartRateSubject</span> <span class="op">=</span> PassthroughSubject<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;()</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">hrvSubject</span> <span class="op">=</span> PassthroughSubject<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;()</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>        setupPipeline<span class="op">()</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">setupPipeline</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Combine heart rate and HRV into unified state</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>        Publishers<span class="op">.</span>CombineLatest<span class="op">(</span></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>            heartRateSubject</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>collect<span class="op">(.</span>byTime<span class="op">(</span>RunLoop<span class="op">.</span>main<span class="op">,</span> <span class="op">.</span>seconds<span class="op">(</span><span class="dv">5</span><span class="op">)))</span>  <span class="co">// Collect 5 seconds</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map <span class="op">{</span> samples <span class="cf">in</span> samples<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span> <span class="op">/</span> Double<span class="op">(</span>samples<span class="op">.</span>count<span class="op">)</span> <span class="op">},</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>            hrvSubject</span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>map <span class="op">{</span> <span class="op">(</span>avgHR<span class="op">,</span> hrv<span class="op">)</span> <span class="op">-&gt;</span> UserState <span class="cf">in</span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Determine user state from biometrics</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> avgHR <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">&amp;&amp;</span> hrv <span class="op">&lt;</span> <span class="dv">30</span> <span class="op">{</span></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="op">.</span>stressed</span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> avgHR <span class="op">&lt;</span> <span class="dv">65</span> <span class="op">&amp;&amp;</span> hrv <span class="op">&gt;</span> <span class="dv">50</span> <span class="op">{</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="op">.</span>relaxed</span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> avgHR <span class="op">&gt;</span> <span class="dv">85</span> <span class="op">{</span></span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="op">.</span>active</span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="op">.</span>neutral</span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>removeDuplicates<span class="op">()</span></span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>debounce<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>seconds<span class="op">(</span><span class="dv">10</span><span class="op">),</span> scheduler<span class="op">:</span> RunLoop<span class="op">.</span>main<span class="op">)</span>  <span class="co">// Stable for 10s</span></span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>receive<span class="op">(</span>on<span class="op">:</span> DispatchQueue<span class="op">.</span>main<span class="op">)</span></span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sink <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> state <span class="cf">in</span></span>
<span id="cb120-38"><a href="#cb120-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>currentState <span class="op">=</span> state</span>
<span id="cb120-39"><a href="#cb120-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>recommendedMood <span class="op">=</span> state<span class="op">.</span>suggestedMood</span>
<span id="cb120-40"><a href="#cb120-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb120-41"><a href="#cb120-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>store<span class="op">(</span><span class="cf">in</span><span class="op">:</span> <span class="op">&amp;</span>cancellables<span class="op">)</span></span>
<span id="cb120-42"><a href="#cb120-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb120-43"><a href="#cb120-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-44"><a href="#cb120-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">recordHeartRate</span><span class="op">(</span><span class="va">_</span> <span class="va">rate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb120-45"><a href="#cb120-45" aria-hidden="true" tabindex="-1"></a>        heartRateSubject<span class="op">.</span>send<span class="op">(</span>rate<span class="op">)</span></span>
<span id="cb120-46"><a href="#cb120-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb120-47"><a href="#cb120-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-48"><a href="#cb120-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">recordHRV</span><span class="op">(</span><span class="va">_</span> <span class="va">hrv</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb120-49"><a href="#cb120-49" aria-hidden="true" tabindex="-1"></a>        hrvSubject<span class="op">.</span>send<span class="op">(</span>hrv<span class="op">)</span></span>
<span id="cb120-50"><a href="#cb120-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb120-51"><a href="#cb120-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="converting-between-asyncawait-and-combine">Converting Between
Async/Await and Combine</h3>
<div class="sourceCode" id="cb121"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Combine publisher to async sequence</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">heartRates</span><span class="op">:</span> some Publisher<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="cf">await</span> rate <span class="cf">in</span> heartRates<span class="op">.</span>values <span class="op">{</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">&quot;Rate: </span><span class="er">\(</span><span class="st">rate)&quot;</span><span class="op">)</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Async function to publisher</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchSongsPublisher</span><span class="op">()</span> -&gt; <span class="fu">AnyPublisher</span><span class="op">&lt;</span>[<span class="dt">Song</span>], <span class="dt">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>    Future <span class="op">{</span> promise <span class="cf">in</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">{</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="va">songs</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> fetchSongs<span class="op">()</span></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>                promise<span class="op">(.</span>success<span class="op">(</span>songs<span class="op">))</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>                promise<span class="op">(.</span>failure<span class="op">(</span>error<span class="op">))</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>eraseToAnyPublisher<span class="op">()</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---swift-concurrency-combine">Key Takeaways - Swift
Concurrency &amp; Combine</h2>
<ol type="1">
<li><strong>Use async/await for cleaner async code</strong> - Reads
linearly, handles errors naturally</li>
<li><strong>Use <code>async let</code> for parallel operations</strong>
- Fetch health and music data simultaneously</li>
<li><strong>Actors protect shared state</strong> - Use for biometric
state management</li>
<li><strong>MainActor for UI updates</strong> - All <span class="citation" data-cites="Published">@Published</span> properties
should update on MainActor</li>
<li><strong>Combine for reactive streams</strong> - Perfect for
continuous heart rate data</li>
<li><strong>Debounce to avoid rapid changes</strong> - Donâ€™t switch
songs every heartbeat</li>
<li><strong>Always handle cancellation</strong> - Users navigate away,
operations should stop</li>
</ol>
<hr />
<h1 id="data-persistence-with-coredata">5. DATA PERSISTENCE WITH
COREDATA</h1>
<h2 id="why-this-matters-for-ai-dj-4">Why This Matters for AI DJ</h2>
<p>AI DJ needs to persist data locally: user preferences, song
effectiveness history, baseline biometric profiles, and listening
patterns. CoreData provides a robust object graph and persistence layer
that syncs across devices via iCloud. This allows the AI to learn from
past sessions and improve recommendations over time.</p>
<p><strong>In AI DJ, youâ€™ll use CoreData for:</strong> - Storing
historical song effectiveness scores - Persisting userâ€™s baseline heart
rate and HRV - Caching playlist and song metadata - Syncing preferences
between iPhone, Watch, and Mac</p>
<hr />
<h2 id="coredata-stack">5.1 CoreData Stack</h2>
<h3 id="understanding-the-components">Understanding the Components</h3>
<p><strong>What weâ€™re doing:</strong> Setting up the foundation for data
persistence.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">CoreData</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PersistenceController <span class="op">{</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">let</span> <span class="va">shared</span> <span class="op">=</span> PersistenceController<span class="op">()</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">container</span><span class="op">:</span> NSPersistentContainer</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>        container <span class="op">=</span> NSPersistentContainer<span class="op">(</span>name<span class="op">:</span> <span class="st">&quot;AIDJModel&quot;</span><span class="op">)</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>        container<span class="op">.</span>loadPersistentStores <span class="op">{</span> description<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="va">error</span> <span class="op">=</span> error <span class="op">{</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">fatalError</span><span class="op">(</span><span class="st">&quot;Unable to load persistent stores: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Enable automatic merging of changes</span></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>        container<span class="op">.</span>viewContext<span class="op">.</span>automaticallyMergesChangesFromParent <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">viewContext</span><span class="op">:</span> NSManagedObjectContext <span class="op">{</span></span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>        container<span class="op">.</span>viewContext</span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Background context for heavy operations</span></span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">newBackgroundContext</span><span class="op">()</span> -&gt; <span class="fu">NSManagedObjectContext</span> <span class="op">{</span></span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true" tabindex="-1"></a>        container<span class="op">.</span>newBackgroundContext<span class="op">()</span></span>
<span id="cb122-28"><a href="#cb122-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-29"><a href="#cb122-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> - <code>NSPersistentContainer</code>
manages the entire CoreData stack - <code>viewContext</code> is the main
thread context for UI - Background contexts prevent blocking the UI
during heavy operations</p>
<hr />
<h3 id="data-model-.xcdatamodeld">Data Model (.xcdatamodeld)</h3>
<p><strong>What weâ€™re doing:</strong> Defining entities (tables) and
attributes (columns) in Xcodeâ€™s data model editor.</p>
<pre><code>// In Xcode: File â†’ New â†’ Data Model

Entity: SongHistory
â”œâ”€â”€ Attributes:
â”‚   â”œâ”€â”€ songId: String
â”‚   â”œâ”€â”€ title: String
â”‚   â”œâ”€â”€ artist: String
â”‚   â”œâ”€â”€ playCount: Integer 32
â”‚   â”œâ”€â”€ skipCount: Integer 32
â”‚   â”œâ”€â”€ averageHeartRateEffect: Double
â”‚   â”œâ”€â”€ averageHRVEffect: Double
â”‚   â”œâ”€â”€ lastPlayed: Date
â”‚   â””â”€â”€ effectivenessScore: Double
â””â”€â”€ Relationships:
    â””â”€â”€ contexts: [PlayContext] (to-many)

Entity: PlayContext
â”œâ”€â”€ Attributes:
â”‚   â”œâ”€â”€ timestamp: Date
â”‚   â”œâ”€â”€ heartRateBefore: Double
â”‚   â”œâ”€â”€ heartRateAfter: Double
â”‚   â”œâ”€â”€ hrvBefore: Double
â”‚   â”œâ”€â”€ hrvAfter: Double
â”‚   â”œâ”€â”€ wasSkipped: Boolean
â”‚   â””â”€â”€ playDuration: Double
â””â”€â”€ Relationships:
    â””â”€â”€ song: SongHistory (to-one)</code></pre>
<hr />
<h3 id="generated-entity-classes">Generated Entity Classes</h3>
<p><strong>What weâ€™re doing:</strong> Using Xcode-generated
NSManagedObject subclasses.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Xcode generates these from your data model</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Editor â†’ Create NSManagedObject Subclass</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="at">@objc</span><span class="op">(</span>SongHistory<span class="op">)</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SongHistory<span class="op">:</span> <span class="dt">NSManagedObject</span> <span class="op">{</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSManaged</span> <span class="kw">public</span> <span class="kw">var</span> <span class="va">songId</span><span class="op">:</span> String</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSManaged</span> <span class="kw">public</span> <span class="kw">var</span> <span class="va">title</span><span class="op">:</span> String</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSManaged</span> <span class="kw">public</span> <span class="kw">var</span> <span class="va">artist</span><span class="op">:</span> String</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSManaged</span> <span class="kw">public</span> <span class="kw">var</span> <span class="va">playCount</span><span class="op">:</span> Int32</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSManaged</span> <span class="kw">public</span> <span class="kw">var</span> <span class="va">skipCount</span><span class="op">:</span> Int32</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSManaged</span> <span class="kw">public</span> <span class="kw">var</span> <span class="va">effectivenessScore</span><span class="op">:</span> Double</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSManaged</span> <span class="kw">public</span> <span class="kw">var</span> <span class="va">lastPlayed</span><span class="op">:</span> Date<span class="op">?</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSManaged</span> <span class="kw">public</span> <span class="kw">var</span> <span class="va">contexts</span><span class="op">:</span> Set<span class="op">&lt;</span>PlayContext<span class="op">&gt;</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> SongHistory <span class="op">{</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@nonobjc</span> <span class="kw">public</span> <span class="kw">class</span> <span class="kw">func</span> fetchRequest<span class="op">()</span> <span class="op">-&gt;</span> NSFetchRequest<span class="op">&lt;</span>SongHistory<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> NSFetchRequest<span class="op">&lt;</span>SongHistory<span class="op">&gt;(</span>entityName<span class="op">:</span> <span class="st">&quot;SongHistory&quot;</span><span class="op">)</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">skipRate</span><span class="op">:</span> Double <span class="op">{</span></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> playCount <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Double<span class="op">(</span>skipCount<span class="op">)</span> <span class="op">/</span> Double<span class="op">(</span>playCount<span class="op">)</span></span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="crud-operations">5.2 CRUD Operations</h2>
<h3 id="creating-objects">Creating Objects</h3>
<p><strong>What weâ€™re doing:</strong> Inserting new records into
CoreData.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">recordSongPlay</span><span class="op">(</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">songId</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">title</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">artist</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">context</span><span class="op">:</span> <span class="dt">PlayContext</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">viewContext</span> <span class="op">=</span> PersistenceController<span class="op">.</span>shared<span class="op">.</span>viewContext</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check if song already exists</span></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">fetchRequest</span><span class="op">:</span> NSFetchRequest<span class="op">&lt;</span>SongHistory<span class="op">&gt;</span> <span class="op">=</span> SongHistory<span class="op">.</span>fetchRequest<span class="op">()</span></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>    fetchRequest<span class="op">.</span>predicate <span class="op">=</span> NSPredicate<span class="op">(</span>format<span class="op">:</span> <span class="st">&quot;songId == %@&quot;</span><span class="op">,</span> songId<span class="op">)</span></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">results</span> <span class="op">=</span> <span class="cf">try</span> viewContext<span class="op">.</span>fetch<span class="op">(</span>fetchRequest<span class="op">)</span></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span><span class="op">:</span> SongHistory</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">existing</span> <span class="op">=</span> results<span class="op">.</span>first <span class="op">{</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>            song <span class="op">=</span> existing</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>playCount <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>            song <span class="op">=</span> SongHistory<span class="op">(</span>context<span class="op">:</span> viewContext<span class="op">)</span></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>songId <span class="op">=</span> songId</span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>title <span class="op">=</span> title</span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>artist <span class="op">=</span> artist</span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>playCount <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>skipCount <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb125-27"><a href="#cb125-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb125-28"><a href="#cb125-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-29"><a href="#cb125-29" aria-hidden="true" tabindex="-1"></a>        song<span class="op">.</span>lastPlayed <span class="op">=</span> Date<span class="op">()</span></span>
<span id="cb125-30"><a href="#cb125-30" aria-hidden="true" tabindex="-1"></a>        song<span class="op">.</span>contexts<span class="op">.</span>insert<span class="op">(</span>context<span class="op">)</span></span>
<span id="cb125-31"><a href="#cb125-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-32"><a href="#cb125-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> viewContext<span class="op">.</span>save<span class="op">()</span></span>
<span id="cb125-33"><a href="#cb125-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb125-34"><a href="#cb125-34" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Failed to save: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb125-35"><a href="#cb125-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb125-36"><a href="#cb125-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="reading-with-fetch-requests">Reading with Fetch Requests</h3>
<p><strong>What weâ€™re doing:</strong> Querying data with predicates and
sort descriptors.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple fetch all</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchAllSongHistory</span><span class="op">()</span> -&gt; [<span class="fu">SongHistory</span>] <span class="op">{</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">request</span><span class="op">:</span> NSFetchRequest<span class="op">&lt;</span>SongHistory<span class="op">&gt;</span> <span class="op">=</span> SongHistory<span class="op">.</span>fetchRequest<span class="op">()</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>sortDescriptors <span class="op">=</span> <span class="op">[</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>        NSSortDescriptor<span class="op">(</span>keyPath<span class="op">:</span> \SongHistory<span class="op">.</span>lastPlayed<span class="op">,</span> ascending<span class="op">:</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">]</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="cf">try</span> PersistenceController<span class="op">.</span>shared<span class="op">.</span>viewContext<span class="op">.</span>fetch<span class="op">(</span>request<span class="op">)</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Fetch failed: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[]</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Fetch with predicate (filter)</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchEffectiveSongs</span><span class="op">(</span><span class="va">minScore</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; [<span class="fu">SongHistory</span>] <span class="op">{</span></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">request</span><span class="op">:</span> NSFetchRequest<span class="op">&lt;</span>SongHistory<span class="op">&gt;</span> <span class="op">=</span> SongHistory<span class="op">.</span>fetchRequest<span class="op">()</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>predicate <span class="op">=</span> NSPredicate<span class="op">(</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>        format<span class="op">:</span> <span class="st">&quot;effectivenessScore &gt;= %f AND playCount &gt;= %d&quot;</span><span class="op">,</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>        minScore<span class="op">,</span> <span class="dv">3</span></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>sortDescriptors <span class="op">=</span> <span class="op">[</span></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>        NSSortDescriptor<span class="op">(</span>keyPath<span class="op">:</span> \SongHistory<span class="op">.</span>effectivenessScore<span class="op">,</span> ascending<span class="op">:</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">]</span></span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>fetchLimit <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="cf">try</span> PersistenceController<span class="op">.</span>shared<span class="op">.</span>viewContext<span class="op">.</span>fetch<span class="op">(</span>request<span class="op">)</span></span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[]</span></span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a><span class="co">// Compound predicates</span></span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchSongsForCalming</span><span class="op">()</span> -&gt; [<span class="fu">SongHistory</span>] <span class="op">{</span></span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">request</span><span class="op">:</span> NSFetchRequest<span class="op">&lt;</span>SongHistory<span class="op">&gt;</span> <span class="op">=</span> SongHistory<span class="op">.</span>fetchRequest<span class="op">()</span></span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">highEffectiveness</span> <span class="op">=</span> NSPredicate<span class="op">(</span>format<span class="op">:</span> <span class="st">&quot;effectivenessScore &gt;= 0.7&quot;</span><span class="op">)</span></span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">lowSkipRate</span> <span class="op">=</span> NSPredicate<span class="op">(</span>format<span class="op">:</span> <span class="st">&quot;skipCount &lt; playCount * 0.2&quot;</span><span class="op">)</span></span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">recentlyEffective</span> <span class="op">=</span> NSPredicate<span class="op">(</span>format<span class="op">:</span> <span class="st">&quot;lastPlayed &gt; %@&quot;</span><span class="op">,</span></span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>        Calendar<span class="op">.</span>current<span class="op">.</span>date<span class="op">(</span>byAdding<span class="op">:</span> <span class="op">.</span>day<span class="op">,</span> value<span class="op">:</span> <span class="op">-</span><span class="dv">30</span><span class="op">,</span> to<span class="op">:</span> Date<span class="op">())!</span> <span class="kw">as</span> NSDate<span class="op">)</span></span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>predicate <span class="op">=</span> NSCompoundPredicate<span class="op">(</span>andPredicateWithSubpredicates<span class="op">:</span> <span class="op">[</span></span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a>        highEffectiveness<span class="op">,</span> lowSkipRate<span class="op">,</span> recentlyEffective</span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">])</span></span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="cf">try</span> PersistenceController<span class="op">.</span>shared<span class="op">.</span>viewContext<span class="op">.</span>fetch<span class="op">(</span>request<span class="op">)</span></span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[]</span></span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="updating-and-deleting">Updating and Deleting</h3>
<div class="sourceCode" id="cb127"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Update</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">updateSongEffectiveness</span><span class="op">(</span><span class="va">songId</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">newScore</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">context</span> <span class="op">=</span> PersistenceController<span class="op">.</span>shared<span class="op">.</span>viewContext</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">request</span><span class="op">:</span> NSFetchRequest<span class="op">&lt;</span>SongHistory<span class="op">&gt;</span> <span class="op">=</span> SongHistory<span class="op">.</span>fetchRequest<span class="op">()</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>predicate <span class="op">=</span> NSPredicate<span class="op">(</span>format<span class="op">:</span> <span class="st">&quot;songId == %@&quot;</span><span class="op">,</span> songId<span class="op">)</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> <span class="cf">try</span> context<span class="op">.</span>fetch<span class="op">(</span>request<span class="op">).</span>first <span class="op">{</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Blend new score with historical (exponential moving average)</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>effectivenessScore <span class="op">=</span> song<span class="op">.</span>effectivenessScore <span class="op">*</span> <span class="fl">0.7</span> <span class="op">+</span> newScore <span class="op">*</span> <span class="fl">0.3</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> context<span class="op">.</span>save<span class="op">()</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Update failed: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Delete</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">deleteSongHistory</span><span class="op">(</span><span class="va">song</span><span class="op">:</span> <span class="dt">SongHistory</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">context</span> <span class="op">=</span> PersistenceController<span class="op">.</span>shared<span class="op">.</span>viewContext</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>    context<span class="op">.</span>delete<span class="op">(</span>song<span class="op">)</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> context<span class="op">.</span>save<span class="op">()</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Delete failed: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Batch delete (efficient for many records)</span></span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">clearOldHistory</span><span class="op">(</span><span class="va">olderThan</span> <span class="va">days</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">context</span> <span class="op">=</span> PersistenceController<span class="op">.</span>shared<span class="op">.</span>viewContext</span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">cutoffDate</span> <span class="op">=</span> Calendar<span class="op">.</span>current<span class="op">.</span>date<span class="op">(</span>byAdding<span class="op">:</span> <span class="op">.</span>day<span class="op">,</span> value<span class="op">:</span> <span class="op">-</span>days<span class="op">,</span> to<span class="op">:</span> Date<span class="op">())!</span></span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">request</span> <span class="op">=</span> NSFetchRequest<span class="op">&lt;</span>NSFetchRequestResult<span class="op">&gt;(</span>entityName<span class="op">:</span> <span class="st">&quot;PlayContext&quot;</span><span class="op">)</span></span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>predicate <span class="op">=</span> NSPredicate<span class="op">(</span>format<span class="op">:</span> <span class="st">&quot;timestamp &lt; %@&quot;</span><span class="op">,</span> cutoffDate <span class="kw">as</span> NSDate<span class="op">)</span></span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">deleteRequest</span> <span class="op">=</span> NSBatchDeleteRequest<span class="op">(</span>fetchRequest<span class="op">:</span> request<span class="op">)</span></span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> context<span class="op">.</span>execute<span class="op">(</span>deleteRequest<span class="op">)</span></span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> context<span class="op">.</span>save<span class="op">()</span></span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Batch delete failed: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="swiftui-integration">5.3 SwiftUI Integration</h2>
<h3 id="fetchrequest-property-wrapper"><span class="citation" data-cites="FetchRequest">@FetchRequest</span> Property Wrapper</h3>
<p><strong>What weâ€™re doing:</strong> Automatically fetching and
observing CoreData in SwiftUI views.</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> SongHistoryListView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Environment</span><span class="op">(</span>\<span class="op">.</span>managedObjectContext<span class="op">)</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">viewContext</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@FetchRequest</span><span class="op">(</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>        sortDescriptors<span class="op">:</span> <span class="op">[</span>NSSortDescriptor<span class="op">(</span>keyPath<span class="op">:</span> \SongHistory<span class="op">.</span>lastPlayed<span class="op">,</span> ascending<span class="op">:</span> <span class="kw">false</span><span class="op">)],</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>        predicate<span class="op">:</span> NSPredicate<span class="op">(</span>format<span class="op">:</span> <span class="st">&quot;playCount &gt;= 1&quot;</span><span class="op">),</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>        animation<span class="op">:</span> <span class="op">.</span><span class="kw">default</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">songs</span><span class="op">:</span> FetchedResults<span class="op">&lt;</span>SongHistory<span class="op">&gt;</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>        List<span class="op">(</span>songs<span class="op">)</span> <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>            VStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">)</span> <span class="op">{</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>song<span class="op">.</span>title<span class="op">)</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>headline<span class="op">)</span></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>song<span class="op">.</span>artist<span class="op">)</span></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>subheadline<span class="op">)</span></span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>                HStack <span class="op">{</span></span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>                    Text<span class="op">(</span><span class="st">&quot;Plays: </span><span class="er">\(</span><span class="st">song.playCount)&quot;</span><span class="op">)</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>                    Spacer<span class="op">()</span></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>                    Text<span class="op">(</span><span class="st">&quot;Score: </span><span class="er">\(</span><span class="st">song.effectivenessScore, format: .percent)&quot;</span><span class="op">)</span></span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Inject the context at app level</span></span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a><span class="at">@main</span></span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AIDJApp<span class="op">:</span> <span class="dt">App</span> <span class="op">{</span></span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">persistenceController</span> <span class="op">=</span> PersistenceController<span class="op">.</span>shared</span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some Scene <span class="op">{</span></span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>        WindowGroup <span class="op">{</span></span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>            ContentView<span class="op">()</span></span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>environment<span class="op">(</span>\<span class="op">.</span>managedObjectContext<span class="op">,</span> persistenceController<span class="op">.</span>viewContext<span class="op">)</span></span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> <code>@FetchRequest</code>
automatically executes the query and updates the view when data changes.
No manual refresh needed.</p>
<hr />
<h2 id="background-processing-and-cloudkit-sync">5.4 Background
Processing and CloudKit Sync</h2>
<h3 id="background-context-operations">Background Context
Operations</h3>
<div class="sourceCode" id="cb129"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">processPlaySession</span><span class="op">(</span><span class="va">data</span><span class="op">:</span> <span class="dt">SessionData</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use background context for heavy work</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">backgroundContext</span> <span class="op">=</span> PersistenceController<span class="op">.</span>shared<span class="op">.</span>newBackgroundContext<span class="op">()</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>    backgroundContext<span class="op">.</span>perform <span class="op">{</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// All work here is off the main thread</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> songData <span class="cf">in</span> data<span class="op">.</span>songs <span class="op">{</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> SongHistory<span class="op">(</span>context<span class="op">:</span> backgroundContext<span class="op">)</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>songId <span class="op">=</span> songData<span class="op">.</span>id</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>            song<span class="op">.</span>title <span class="op">=</span> songData<span class="op">.</span>title</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ... set other properties</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> backgroundContext<span class="op">.</span>save<span class="op">()</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Changes automatically merge to viewContext</span></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Background save failed: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="cloudkit-integration">CloudKit Integration</h3>
<div class="sourceCode" id="cb130"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In PersistenceController init</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>    container <span class="op">=</span> NSPersistentCloudKitContainer<span class="op">(</span>name<span class="op">:</span> <span class="st">&quot;AIDJModel&quot;</span><span class="op">)</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Configure for CloudKit sync</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">description</span> <span class="op">=</span> container<span class="op">.</span>persistentStoreDescriptions<span class="op">.</span>first <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">fatalError</span><span class="op">(</span><span class="st">&quot;No store description&quot;</span><span class="op">)</span></span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a>    description<span class="op">.</span>setOption<span class="op">(</span><span class="kw">true</span> <span class="kw">as</span> NSNumber<span class="op">,</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a>        forKey<span class="op">:</span> NSPersistentHistoryTrackingKey<span class="op">)</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a>    description<span class="op">.</span>setOption<span class="op">(</span><span class="kw">true</span> <span class="kw">as</span> NSNumber<span class="op">,</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>        forKey<span class="op">:</span> NSPersistentStoreRemoteChangeNotificationPostOptionKey<span class="op">)</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>    container<span class="op">.</span>loadPersistentStores <span class="op">{</span> _<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">error</span> <span class="op">=</span> error <span class="op">{</span></span>
<span id="cb130-17"><a href="#cb130-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">fatalError</span><span class="op">(</span><span class="st">&quot;Store failed: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb130-18"><a href="#cb130-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb130-19"><a href="#cb130-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb130-20"><a href="#cb130-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-21"><a href="#cb130-21" aria-hidden="true" tabindex="-1"></a>    container<span class="op">.</span>viewContext<span class="op">.</span>automaticallyMergesChangesFromParent <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb130-22"><a href="#cb130-22" aria-hidden="true" tabindex="-1"></a>    container<span class="op">.</span>viewContext<span class="op">.</span>mergePolicy <span class="op">=</span> NSMergeByPropertyObjectTrumpMergePolicy</span>
<span id="cb130-23"><a href="#cb130-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong>
<code>NSPersistentCloudKitContainer</code> automatically syncs data to
iCloud. Changes on iPhone appear on Mac and Watch automatically.</p>
<hr />
<h2 id="key-takeaways---coredata">Key Takeaways - CoreData</h2>
<ol type="1">
<li><strong>Use NSPersistentContainer</strong> - Manages the entire
stack for you</li>
<li><strong>viewContext for UI, background context for heavy
work</strong> - Never block main thread</li>
<li><strong><span class="citation" data-cites="FetchRequest">@FetchRequest</span> in SwiftUI</strong> -
Automatic updates when data changes</li>
<li><strong>Predicates filter data</strong> - Learn NSPredicate format
strings</li>
<li><strong>Use CloudKit container for sync</strong> - Free iCloud sync
across devices</li>
<li><strong>Batch operations for bulk changes</strong> - More efficient
than one-by-one</li>
<li><strong>Store effectiveness scores</strong> - AI DJ learns from
history</li>
</ol>
<hr />
<h1 id="ios-app-architecture-patterns">6. iOS APP ARCHITECTURE
PATTERNS</h1>
<h2 id="why-this-matters-for-ai-dj-5">Why This Matters for AI DJ</h2>
<p>A well-architected app is easier to test, debug, and extend. AI DJ
has complex logic: biometric processing, music scoring, cross-device
communication. Without good architecture, this becomes spaghetti code.
MVVM (Model-View-ViewModel) separates concerns so the Brain can be
tested without UI, and views stay simple.</p>
<p><strong>In AI DJ, architecture helps you:</strong> - Test the scoring
algorithm independently - Share Brain logic between iOS, watchOS, and
macOS - Keep SwiftUI views simple and focused on display - Mock
HealthKit and MusicKit for testing</p>
<hr />
<h2 id="mvvm-pattern">6.1 MVVM Pattern</h2>
<h3 id="the-three-layers">The Three Layers</h3>
<p><strong>What weâ€™re doing:</strong> Separating data (Model), display
(View), and logic (ViewModel).</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co">// MODEL - Pure data structures</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Song<span class="op">:</span> <span class="dt">Identifiable</span> <span class="op">{</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">id</span><span class="op">:</span> String</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">title</span><span class="op">:</span> String</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">artist</span><span class="op">:</span> String</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">bpm</span><span class="op">:</span> Int</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">energyLevel</span><span class="op">:</span> Double</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> BiometricState <span class="op">{</span></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRate</span><span class="op">:</span> Double</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">hrv</span><span class="op">:</span> Double</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">trend</span><span class="op">:</span> Double</span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">stressLevel</span><span class="op">:</span> Double <span class="op">{</span></span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// High HR + Low HRV = stress</span></span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hrFactor</span> <span class="op">=</span> min<span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> max<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">(</span>heartRate <span class="op">-</span> <span class="dv">60</span><span class="op">)</span> <span class="op">/</span> <span class="dv">60</span><span class="op">))</span></span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hrvFactor</span> <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> min<span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> hrv <span class="op">/</span> <span class="dv">100</span><span class="op">)</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">(</span>hrFactor <span class="op">+</span> hrvFactor<span class="op">)</span> <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a><span class="co">// VIEWMODEL - Business logic, state management</span></span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a><span class="at">@MainActor</span></span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NowPlayingViewModel<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> Song<span class="op">?</span></span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">biometrics</span><span class="op">:</span> BiometricState<span class="op">?</span></span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">songQueue</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">musicService</span><span class="op">:</span> MusicServiceProtocol</span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">healthService</span><span class="op">:</span> HealthServiceProtocol</span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">brain</span><span class="op">:</span> ScoringBrain</span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">(</span></span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a>        musicService<span class="op">:</span> MusicServiceProtocol<span class="op">,</span></span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a>        healthService<span class="op">:</span> HealthServiceProtocol<span class="op">,</span></span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a>        brain<span class="op">:</span> ScoringBrain</span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>musicService <span class="op">=</span> musicService</span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>healthService <span class="op">=</span> healthService</span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>brain <span class="op">=</span> brain</span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">selectNextSong</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">state</span> <span class="op">=</span> biometrics <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">candidates</span> <span class="op">=</span> <span class="cf">await</span> musicService<span class="op">.</span>getPlaylistSongs<span class="op">()</span></span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">ranked</span> <span class="op">=</span> brain<span class="op">.</span>rankSongs<span class="op">(</span>candidates<span class="op">,</span> <span class="cf">for</span><span class="op">:</span> state<span class="op">)</span></span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">best</span> <span class="op">=</span> ranked<span class="op">.</span>first <span class="op">{</span></span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a>            currentSong <span class="op">=</span> best<span class="op">.</span>song</span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> musicService<span class="op">.</span>play<span class="op">(</span>best<span class="op">.</span>song<span class="op">)</span></span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a>            isPlaying <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a><span class="co">// VIEW - Pure UI, delegates to ViewModel</span></span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> NowPlayingView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb131-61"><a href="#cb131-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">@StateObject</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">viewModel</span><span class="op">:</span> NowPlayingViewModel</span>
<span id="cb131-62"><a href="#cb131-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-63"><a href="#cb131-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">(</span>viewModel<span class="op">:</span> NowPlayingViewModel<span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-64"><a href="#cb131-64" aria-hidden="true" tabindex="-1"></a>        _viewModel <span class="op">=</span> StateObject<span class="op">(</span>wrappedValue<span class="op">:</span> viewModel<span class="op">)</span></span>
<span id="cb131-65"><a href="#cb131-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-66"><a href="#cb131-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-67"><a href="#cb131-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb131-68"><a href="#cb131-68" aria-hidden="true" tabindex="-1"></a>        VStack <span class="op">{</span></span>
<span id="cb131-69"><a href="#cb131-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> viewModel<span class="op">.</span>currentSong <span class="op">{</span></span>
<span id="cb131-70"><a href="#cb131-70" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>song<span class="op">.</span>title<span class="op">)</span></span>
<span id="cb131-71"><a href="#cb131-71" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>title<span class="op">)</span></span>
<span id="cb131-72"><a href="#cb131-72" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>song<span class="op">.</span>artist<span class="op">)</span></span>
<span id="cb131-73"><a href="#cb131-73" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb131-74"><a href="#cb131-74" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb131-75"><a href="#cb131-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-76"><a href="#cb131-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="va">bio</span> <span class="op">=</span> viewModel<span class="op">.</span>biometrics <span class="op">{</span></span>
<span id="cb131-77"><a href="#cb131-77" aria-hidden="true" tabindex="-1"></a>                HStack <span class="op">{</span></span>
<span id="cb131-78"><a href="#cb131-78" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(bio.heartRate))&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb131-79"><a href="#cb131-79" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(bio.hrv))&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;waveform.path.ecg&quot;</span><span class="op">)</span></span>
<span id="cb131-80"><a href="#cb131-80" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb131-81"><a href="#cb131-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb131-82"><a href="#cb131-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-83"><a href="#cb131-83" aria-hidden="true" tabindex="-1"></a>            Button<span class="op">(</span>viewModel<span class="op">.</span>isPlaying <span class="op">?</span> <span class="st">&quot;Pause&quot;</span> <span class="op">:</span> <span class="st">&quot;Play&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb131-84"><a href="#cb131-84" aria-hidden="true" tabindex="-1"></a>                Task <span class="op">{</span></span>
<span id="cb131-85"><a href="#cb131-85" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> viewModel<span class="op">.</span>selectNextSong<span class="op">()</span></span>
<span id="cb131-86"><a href="#cb131-86" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb131-87"><a href="#cb131-87" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb131-88"><a href="#cb131-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb131-89"><a href="#cb131-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb131-90"><a href="#cb131-90" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="dependency-injection">6.2 Dependency Injection</h2>
<h3 id="protocol-based-dependencies">Protocol-Based Dependencies</h3>
<p><strong>What weâ€™re doing:</strong> Using protocols so we can swap
implementations (real vs mock).</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define protocols for dependencies</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="kw">protocol</span> MusicServiceProtocol <span class="op">{</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">getPlaylistSongs</span><span class="op">()</span> <span class="fu">async</span> -&gt; [<span class="fu">Song</span>]</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">play</span><span class="op">(</span><span class="va">_</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">)</span> <span class="fu">async</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">pause</span><span class="op">()</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a><span class="kw">protocol</span> HealthServiceProtocol <span class="op">{</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">heartRatePublisher</span><span class="op">:</span> AnyPublisher<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;</span> <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">hrvPublisher</span><span class="op">:</span> AnyPublisher<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;</span> <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">requestAuthorization</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span></span>
<span id="cb132-12"><a href="#cb132-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb132-13"><a href="#cb132-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-14"><a href="#cb132-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Real implementation</span></span>
<span id="cb132-15"><a href="#cb132-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MusicKitService<span class="op">:</span> <span class="dt">MusicServiceProtocol</span> <span class="op">{</span></span>
<span id="cb132-16"><a href="#cb132-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">getPlaylistSongs</span><span class="op">()</span> <span class="fu">async</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb132-17"><a href="#cb132-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Real MusicKit API calls</span></span>
<span id="cb132-18"><a href="#cb132-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb132-19"><a href="#cb132-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-20"><a href="#cb132-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">play</span><span class="op">(</span><span class="va">_</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">)</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb132-21"><a href="#cb132-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Real playback</span></span>
<span id="cb132-22"><a href="#cb132-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb132-23"><a href="#cb132-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-24"><a href="#cb132-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">pause</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb132-25"><a href="#cb132-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Real pause</span></span>
<span id="cb132-26"><a href="#cb132-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb132-27"><a href="#cb132-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb132-28"><a href="#cb132-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-29"><a href="#cb132-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Mock for testing</span></span>
<span id="cb132-30"><a href="#cb132-30" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MockMusicService<span class="op">:</span> <span class="dt">MusicServiceProtocol</span> <span class="op">{</span></span>
<span id="cb132-31"><a href="#cb132-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">mockSongs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb132-32"><a href="#cb132-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">playedSong</span><span class="op">:</span> Song<span class="op">?</span></span>
<span id="cb132-33"><a href="#cb132-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-34"><a href="#cb132-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">getPlaylistSongs</span><span class="op">()</span> <span class="fu">async</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb132-35"><a href="#cb132-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> mockSongs</span>
<span id="cb132-36"><a href="#cb132-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb132-37"><a href="#cb132-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-38"><a href="#cb132-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">play</span><span class="op">(</span><span class="va">_</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">)</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb132-39"><a href="#cb132-39" aria-hidden="true" tabindex="-1"></a>        playedSong <span class="op">=</span> song</span>
<span id="cb132-40"><a href="#cb132-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb132-41"><a href="#cb132-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-42"><a href="#cb132-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">pause</span><span class="op">()</span> <span class="op">{}</span></span>
<span id="cb132-43"><a href="#cb132-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="dependency-container">Dependency Container</h3>
<p><strong>What weâ€™re doing:</strong> Centralizing dependency creation
for easy swapping.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DependencyContainer <span class="op">{</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">let</span> <span class="va">shared</span> <span class="op">=</span> DependencyContainer<span class="op">()</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">var</span> <span class="va">musicService</span><span class="op">:</span> MusicServiceProtocol <span class="op">=</span> MusicKitService<span class="op">()</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">var</span> <span class="va">healthService</span><span class="op">:</span> HealthServiceProtocol <span class="op">=</span> HealthKitService<span class="op">()</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">var</span> <span class="va">brain</span><span class="op">:</span> ScoringBrain <span class="op">=</span> ScoringBrain<span class="op">()</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lazy</span> <span class="kw">var</span> <span class="va">persistence</span><span class="op">:</span> PersistenceController <span class="op">=</span> PersistenceController<span class="op">.</span>shared</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">makeNowPlayingViewModel</span><span class="op">()</span> -&gt; <span class="fu">NowPlayingViewModel</span> <span class="op">{</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>        NowPlayingViewModel<span class="op">(</span></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>            musicService<span class="op">:</span> musicService<span class="op">,</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>            healthService<span class="op">:</span> healthService<span class="op">,</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>            brain<span class="op">:</span> brain</span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-18"><a href="#cb133-18" aria-hidden="true" tabindex="-1"></a><span class="co">// For testing</span></span>
<span id="cb133-19"><a href="#cb133-19" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TestDependencyContainer<span class="op">:</span> <span class="dt">DependencyContainer</span> <span class="op">{</span></span>
<span id="cb133-20"><a href="#cb133-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb133-21"><a href="#cb133-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">.</span><span class="kw">init</span><span class="op">()</span></span>
<span id="cb133-22"><a href="#cb133-22" aria-hidden="true" tabindex="-1"></a>        musicService <span class="op">=</span> MockMusicService<span class="op">()</span></span>
<span id="cb133-23"><a href="#cb133-23" aria-hidden="true" tabindex="-1"></a>        healthService <span class="op">=</span> MockHealthService<span class="op">()</span></span>
<span id="cb133-24"><a href="#cb133-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb133-25"><a href="#cb133-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="service-layer-pattern">6.3 Service Layer Pattern</h2>
<h3 id="encapsulating-external-apis">Encapsulating External APIs</h3>
<p><strong>What weâ€™re doing:</strong> Wrapping HealthKit and MusicKit
behind clean interfaces.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthKitService<span class="op">:</span> <span class="dt">HealthServiceProtocol</span> <span class="op">{</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">healthStore</span> <span class="op">=</span> HKHealthStore<span class="op">()</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">heartRateSubject</span> <span class="op">=</span> PassthroughSubject<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;()</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">hrvSubject</span> <span class="op">=</span> PassthroughSubject<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;()</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">heartRatePublisher</span><span class="op">:</span> AnyPublisher<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>        heartRateSubject<span class="op">.</span>eraseToAnyPublisher<span class="op">()</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">hrvPublisher</span><span class="op">:</span> AnyPublisher<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>        hrvSubject<span class="op">.</span>eraseToAnyPublisher<span class="op">()</span></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">requestAuthorization</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">types</span><span class="op">:</span> Set<span class="op">&lt;</span>HKSampleType<span class="op">&gt;</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>            HKQuantityType<span class="op">(.</span>heartRate<span class="op">),</span></span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a>            HKQuantityType<span class="op">(.</span>heartRateVariabilitySDNN<span class="op">)</span></span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> healthStore<span class="op">.</span>requestAuthorization<span class="op">(</span>toShare<span class="op">:</span> <span class="op">[],</span> read<span class="op">:</span> types<span class="op">)</span></span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">startMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set up HKObserverQuery for heart rate</span></span>
<span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb134-26"><a href="#cb134-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-27"><a href="#cb134-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKAnchoredObjectQuery<span class="op">(</span></span>
<span id="cb134-28"><a href="#cb134-28" aria-hidden="true" tabindex="-1"></a>            type<span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb134-29"><a href="#cb134-29" aria-hidden="true" tabindex="-1"></a>            predicate<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb134-30"><a href="#cb134-30" aria-hidden="true" tabindex="-1"></a>            anchor<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb134-31"><a href="#cb134-31" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">:</span> HKObjectQueryNoLimit</span>
<span id="cb134-32"><a href="#cb134-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> query<span class="op">,</span> samples<span class="op">,</span> deleted<span class="op">,</span> anchor<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb134-33"><a href="#cb134-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>processHeartRateSamples<span class="op">(</span>samples <span class="kw">as</span><span class="op">?</span> <span class="op">[</span>HKQuantitySample<span class="op">]</span> <span class="op">??</span> <span class="op">[])</span></span>
<span id="cb134-34"><a href="#cb134-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb134-35"><a href="#cb134-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-36"><a href="#cb134-36" aria-hidden="true" tabindex="-1"></a>        query<span class="op">.</span>updateHandler <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> query<span class="op">,</span> samples<span class="op">,</span> deleted<span class="op">,</span> anchor<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb134-37"><a href="#cb134-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>processHeartRateSamples<span class="op">(</span>samples <span class="kw">as</span><span class="op">?</span> <span class="op">[</span>HKQuantitySample<span class="op">]</span> <span class="op">??</span> <span class="op">[])</span></span>
<span id="cb134-38"><a href="#cb134-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb134-39"><a href="#cb134-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-40"><a href="#cb134-40" aria-hidden="true" tabindex="-1"></a>        healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb134-41"><a href="#cb134-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-42"><a href="#cb134-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-43"><a href="#cb134-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">processHeartRateSamples</span><span class="op">(</span><span class="va">_</span> <span class="va">samples</span><span class="op">:</span> [<span class="dt">HKQuantitySample</span>]<span class="op">)</span> <span class="op">{</span></span>
<span id="cb134-44"><a href="#cb134-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> sample <span class="cf">in</span> samples <span class="op">{</span></span>
<span id="cb134-45"><a href="#cb134-45" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">rate</span> <span class="op">=</span> sample<span class="op">.</span>quantity<span class="op">.</span>doubleValue<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>beatsPerMinute<span class="op">)</span></span>
<span id="cb134-46"><a href="#cb134-46" aria-hidden="true" tabindex="-1"></a>            heartRateSubject<span class="op">.</span>send<span class="op">(</span>rate<span class="op">)</span></span>
<span id="cb134-47"><a href="#cb134-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb134-48"><a href="#cb134-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-49"><a href="#cb134-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="the-brain---core-logic-module">6.4 The Brain - Core Logic
Module</h2>
<h3 id="separating-algorithm-from-infrastructure">Separating Algorithm
from Infrastructure</h3>
<p><strong>What weâ€™re doing:</strong> Creating a pure logic module with
no dependencies on Apple frameworks.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This can be in a Swift Package, shared across all platforms</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ScoringBrain <span class="op">{</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> ScoredSong <span class="op">{</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span><span class="op">:</span> Song</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">score</span><span class="op">:</span> Double</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">reasons</span><span class="op">:</span> <span class="op">[</span>String<span class="op">]</span></span>
<span id="cb135-7"><a href="#cb135-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb135-8"><a href="#cb135-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-9"><a href="#cb135-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">rankSongs</span><span class="op">(</span><span class="va">_</span> <span class="va">songs</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span> <span class="va">for</span> <span class="va">state</span><span class="op">:</span> <span class="dt">BiometricState</span><span class="op">)</span> -&gt; [<span class="fu">ScoredSong</span>] <span class="op">{</span></span>
<span id="cb135-10"><a href="#cb135-10" aria-hidden="true" tabindex="-1"></a>        songs<span class="op">.</span>map <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb135-11"><a href="#cb135-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> (<span class="va">score</span><span class="op">,</span> reasons<span class="op">)</span> <span class="op">=</span> calculateScore<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> state<span class="op">:</span> state<span class="op">)</span></span>
<span id="cb135-12"><a href="#cb135-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> ScoredSong<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> score<span class="op">:</span> score<span class="op">,</span> reasons<span class="op">:</span> reasons<span class="op">)</span></span>
<span id="cb135-13"><a href="#cb135-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb135-14"><a href="#cb135-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sorted <span class="op">{</span> $<span class="fl">0.</span>score <span class="op">&gt;</span> $<span class="fl">1.</span>score <span class="op">}</span></span>
<span id="cb135-15"><a href="#cb135-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb135-16"><a href="#cb135-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-17"><a href="#cb135-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">calculateScore</span><span class="op">(</span><span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">,</span> <span class="va">state</span><span class="op">:</span> <span class="dt">BiometricState</span><span class="op">)</span> -&gt; <span class="op">(</span><span class="va">Double</span><span class="op">,</span> [<span class="va">String</span>]<span class="op">)</span> <span class="op">{</span></span>
<span id="cb135-18"><a href="#cb135-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">score</span> <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb135-19"><a href="#cb135-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">reasons</span><span class="op">:</span> <span class="op">[</span>String<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb135-20"><a href="#cb135-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-21"><a href="#cb135-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// BPM matching</span></span>
<span id="cb135-22"><a href="#cb135-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">bpmDiff</span> <span class="op">=</span> abs<span class="op">(</span>Double<span class="op">(</span>song<span class="op">.</span>bpm<span class="op">)</span> <span class="op">-</span> state<span class="op">.</span>heartRate<span class="op">)</span></span>
<span id="cb135-23"><a href="#cb135-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">bpmScore</span> <span class="op">=</span> max<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="fl">1.0</span> <span class="op">-</span> bpmDiff <span class="op">/</span> <span class="fl">50.0</span><span class="op">)</span></span>
<span id="cb135-24"><a href="#cb135-24" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> bpmScore <span class="op">*</span> <span class="fl">0.3</span></span>
<span id="cb135-25"><a href="#cb135-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bpmScore <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">{</span></span>
<span id="cb135-26"><a href="#cb135-26" aria-hidden="true" tabindex="-1"></a>            reasons<span class="op">.</span>append<span class="op">(</span><span class="st">&quot;BPM matches your rhythm&quot;</span><span class="op">)</span></span>
<span id="cb135-27"><a href="#cb135-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb135-28"><a href="#cb135-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-29"><a href="#cb135-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Energy matching to stress</span></span>
<span id="cb135-30"><a href="#cb135-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">needsCalm</span> <span class="op">=</span> state<span class="op">.</span>stressLevel <span class="op">&gt;</span> <span class="fl">0.6</span></span>
<span id="cb135-31"><a href="#cb135-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">energyScore</span><span class="op">:</span> Double</span>
<span id="cb135-32"><a href="#cb135-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> needsCalm <span class="op">{</span></span>
<span id="cb135-33"><a href="#cb135-33" aria-hidden="true" tabindex="-1"></a>            energyScore <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> song<span class="op">.</span>energyLevel</span>
<span id="cb135-34"><a href="#cb135-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> energyScore <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">{</span></span>
<span id="cb135-35"><a href="#cb135-35" aria-hidden="true" tabindex="-1"></a>                reasons<span class="op">.</span>append<span class="op">(</span><span class="st">&quot;Calming energy for relaxation&quot;</span><span class="op">)</span></span>
<span id="cb135-36"><a href="#cb135-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb135-37"><a href="#cb135-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb135-38"><a href="#cb135-38" aria-hidden="true" tabindex="-1"></a>            energyScore <span class="op">=</span> song<span class="op">.</span>energyLevel</span>
<span id="cb135-39"><a href="#cb135-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> energyScore <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">{</span></span>
<span id="cb135-40"><a href="#cb135-40" aria-hidden="true" tabindex="-1"></a>                reasons<span class="op">.</span>append<span class="op">(</span><span class="st">&quot;Energetic vibe&quot;</span><span class="op">)</span></span>
<span id="cb135-41"><a href="#cb135-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb135-42"><a href="#cb135-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb135-43"><a href="#cb135-43" aria-hidden="true" tabindex="-1"></a>        score <span class="op">+=</span> energyScore <span class="op">*</span> <span class="fl">0.4</span></span>
<span id="cb135-44"><a href="#cb135-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-45"><a href="#cb135-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Could add more factors: familiarity, recency, etc.</span></span>
<span id="cb135-46"><a href="#cb135-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-47"><a href="#cb135-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">(</span>score<span class="op">,</span> reasons<span class="op">)</span></span>
<span id="cb135-48"><a href="#cb135-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb135-49"><a href="#cb135-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Why this matters:</strong> The Brain has no dependencies on
UIKit, SwiftUI, HealthKit, or MusicKit. Itâ€™s pure Swift logic that can
be: - Unit tested with simple inputs - Shared via Swift Package across
iOS, watchOS, macOS - Developed and refined independently</p>
<hr />
<h2 id="key-takeaways---architecture">Key Takeaways - Architecture</h2>
<ol type="1">
<li><strong>MVVM separates concerns</strong> - Models hold data,
ViewModels hold logic, Views display</li>
<li><strong>Protocols enable testing</strong> - Mock dependencies for
unit tests</li>
<li><strong>Dependency injection</strong> - Pass dependencies in, donâ€™t
create them inside</li>
<li><strong>Service layer wraps APIs</strong> - Clean interface to
HealthKit, MusicKit</li>
<li><strong>Brain is pure logic</strong> - No Apple framework
dependencies, fully testable</li>
<li><strong>Swift Packages share code</strong> - Same Brain on iOS,
watchOS, macOS</li>
</ol>
<hr />
<h1 id="musickit-framework">7. MUSICKIT FRAMEWORK</h1>
<h2 id="why-this-matters-for-ai-dj-6">Why This Matters for AI DJ</h2>
<p>MusicKit is how AI DJ accesses Apple Music. It provides the song
library, playback control, and metadata like BPM and energy level.
Without MusicKit, thereâ€™s no music to play. Understanding MusicKit
deeply lets you query songs efficiently, control playback smoothly, and
access the rich metadata needed for intelligent song selection.</p>
<p><strong>In AI DJ, youâ€™ll use MusicKit for:</strong> - Fetching userâ€™s
playlists and library - Getting song metadata (BPM, energy, genre) -
Controlling playback (play, pause, skip) - Searching the Apple Music
catalog</p>
<hr />
<h2 id="authorization">7.1 Authorization</h2>
<h3 id="requesting-music-access">Requesting Music Access</h3>
<p><strong>What weâ€™re doing:</strong> Getting permission to access the
userâ€™s Apple Music.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">MusicKit</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MusicAuthorizationManager <span class="op">{</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">requestAccess</span><span class="op">()</span> <span class="fu">async</span> -&gt; <span class="fu">Bool</span> <span class="op">{</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">status</span> <span class="op">=</span> <span class="cf">await</span> MusicAuthorization<span class="op">.</span>request<span class="op">()</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> status <span class="op">{</span></span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>authorized<span class="op">:</span></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Full access granted&quot;</span><span class="op">)</span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">true</span></span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>denied<span class="op">:</span></span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;User denied access&quot;</span><span class="op">)</span></span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">false</span></span>
<span id="cb136-14"><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>notDetermined<span class="op">:</span></span>
<span id="cb136-15"><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Not yet determined&quot;</span><span class="op">)</span></span>
<span id="cb136-16"><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">false</span></span>
<span id="cb136-17"><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>restricted<span class="op">:</span></span>
<span id="cb136-18"><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Restricted by parental controls&quot;</span><span class="op">)</span></span>
<span id="cb136-19"><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">false</span></span>
<span id="cb136-20"><a href="#cb136-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">@unknown</span> <span class="kw">default</span><span class="op">:</span></span>
<span id="cb136-21"><a href="#cb136-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">false</span></span>
<span id="cb136-22"><a href="#cb136-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb136-23"><a href="#cb136-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb136-24"><a href="#cb136-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-25"><a href="#cb136-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">isAuthorized</span><span class="op">:</span> Bool <span class="op">{</span></span>
<span id="cb136-26"><a href="#cb136-26" aria-hidden="true" tabindex="-1"></a>        MusicAuthorization<span class="op">.</span>currentStatus <span class="op">==</span> <span class="op">.</span>authorized</span>
<span id="cb136-27"><a href="#cb136-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb136-28"><a href="#cb136-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> The system shows a permission dialog.
User must grant access for MusicKit to work. Check status before making
any MusicKit calls.</p>
<p><strong>Info.plist requirement:</strong></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">key</span>&gt;NSAppleMusicUsageDescription&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">string</span>&gt;AI DJ needs access to your music library to select songs based on your biometrics.&lt;/<span class="kw">string</span>&gt;</span></code></pre></div>
<hr />
<h2 id="fetching-music">7.2 Fetching Music</h2>
<h3 id="users-library">Userâ€™s Library</h3>
<p><strong>What weâ€™re doing:</strong> Accessing playlists and songs from
the userâ€™s library.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Fetch all user playlists</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchUserPlaylists</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Playlist</span>] <span class="op">{</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">request</span> <span class="op">=</span> MusicLibraryRequest<span class="op">&lt;</span>Playlist<span class="op">&gt;()</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">response</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> request<span class="op">.</span>response<span class="op">()</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Array<span class="op">(</span>response<span class="op">.</span>items<span class="op">)</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Fetch songs from a specific playlist</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchSongs</span><span class="op">(</span><span class="va">from</span> <span class="va">playlist</span><span class="op">:</span> <span class="dt">Playlist</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Load the tracks relationship</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">detailedPlaylist</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> playlist<span class="op">.</span>with<span class="op">([.</span>tracks<span class="op">])</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">guard</span> <span class="kw">let</span> <span class="va">tracks</span> <span class="op">=</span> detailedPlaylist<span class="op">.</span>tracks <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[]</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> tracks<span class="op">.</span>compactMap <span class="op">{</span> track <span class="op">-&gt;</span> Song<span class="op">?</span> <span class="cf">in</span></span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="cf">case</span> <span class="op">.</span>song<span class="op">(</span><span class="kw">let</span> <span class="va">song</span><span class="op">)</span> <span class="op">=</span> track <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="kw">nil</span> <span class="op">}</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> song</span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Fetch user&#39;s recently played</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">fetchRecentlyPlayed</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">request</span> <span class="op">=</span> MusicRecentlyPlayedRequest<span class="op">&lt;</span>Song<span class="op">&gt;()</span></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">response</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> request<span class="op">.</span>response<span class="op">()</span></span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Array<span class="op">(</span>response<span class="op">.</span>items<span class="op">)</span></span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="song-properties-and-metadata">Song Properties and Metadata</h3>
<p><strong>What weâ€™re doing:</strong> Accessing the rich metadata
MusicKit provides.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">analyzeSong</span><span class="op">(</span><span class="va">_</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">)</span> -&gt; <span class="fu">SongAnalysis</span> <span class="op">{</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> SongAnalysis<span class="op">(</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>        id<span class="op">:</span> song<span class="op">.</span>id<span class="op">.</span>rawValue<span class="op">,</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>        title<span class="op">:</span> song<span class="op">.</span>title<span class="op">,</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>        artist<span class="op">:</span> song<span class="op">.</span>artistName<span class="op">,</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>        album<span class="op">:</span> song<span class="op">.</span>albumTitle <span class="op">??</span> <span class="st">&quot;Unknown&quot;</span><span class="op">,</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>        duration<span class="op">:</span> song<span class="op">.</span>duration <span class="op">??</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Audio features (when available)</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>        bpm<span class="op">:</span> song<span class="op">.</span>tempo<span class="op">,</span>  <span class="co">// Beats per minute</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>        genres<span class="op">:</span> song<span class="op">.</span>genreNames<span class="op">,</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>        releaseDate<span class="op">:</span> song<span class="op">.</span>releaseDate<span class="op">,</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Artwork</span></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>        artworkURL<span class="op">:</span> song<span class="op">.</span>artwork<span class="op">?.</span>url<span class="op">(</span>width<span class="op">:</span> <span class="dv">300</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">300</span><span class="op">)</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> SongAnalysis <span class="op">{</span></span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">id</span><span class="op">:</span> String</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">title</span><span class="op">:</span> String</span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">artist</span><span class="op">:</span> String</span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">album</span><span class="op">:</span> String</span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">duration</span><span class="op">:</span> TimeInterval</span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">bpm</span><span class="op">:</span> Int<span class="op">?</span></span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">genres</span><span class="op">:</span> <span class="op">[</span>String<span class="op">]</span></span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">releaseDate</span><span class="op">:</span> Date<span class="op">?</span></span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">artworkURL</span><span class="op">:</span> URL<span class="op">?</span></span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Estimate energy from genre (when audio analysis unavailable)</span></span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">estimatedEnergy</span><span class="op">:</span> Double <span class="op">{</span></span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">highEnergyGenres</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Electronic&quot;</span><span class="op">,</span> <span class="st">&quot;Dance&quot;</span><span class="op">,</span> <span class="st">&quot;Hip-Hop&quot;</span><span class="op">,</span> <span class="st">&quot;Rock&quot;</span><span class="op">,</span> <span class="st">&quot;Pop&quot;</span><span class="op">]</span></span>
<span id="cb139-31"><a href="#cb139-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">lowEnergyGenres</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Classical&quot;</span><span class="op">,</span> <span class="st">&quot;Jazz&quot;</span><span class="op">,</span> <span class="st">&quot;Ambient&quot;</span><span class="op">,</span> <span class="st">&quot;Acoustic&quot;</span><span class="op">]</span></span>
<span id="cb139-32"><a href="#cb139-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-33"><a href="#cb139-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> genre <span class="cf">in</span> genres <span class="op">{</span></span>
<span id="cb139-34"><a href="#cb139-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> highEnergyGenres<span class="op">.</span>contains<span class="op">(</span><span class="kw">where</span><span class="op">:</span> <span class="op">{</span> genre<span class="op">.</span>contains<span class="op">(</span>$<span class="dv">0</span><span class="op">)</span> <span class="op">})</span> <span class="op">{</span></span>
<span id="cb139-35"><a href="#cb139-35" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="fl">0.8</span></span>
<span id="cb139-36"><a href="#cb139-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb139-37"><a href="#cb139-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> lowEnergyGenres<span class="op">.</span>contains<span class="op">(</span><span class="kw">where</span><span class="op">:</span> <span class="op">{</span> genre<span class="op">.</span>contains<span class="op">(</span>$<span class="dv">0</span><span class="op">)</span> <span class="op">})</span> <span class="op">{</span></span>
<span id="cb139-38"><a href="#cb139-38" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="fl">0.3</span></span>
<span id="cb139-39"><a href="#cb139-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb139-40"><a href="#cb139-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb139-41"><a href="#cb139-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="fl">0.5</span>  <span class="co">// Default medium energy</span></span>
<span id="cb139-42"><a href="#cb139-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb139-43"><a href="#cb139-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="searching-the-catalog">Searching the Catalog</h3>
<div class="sourceCode" id="cb140"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Search Apple Music catalog</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">searchSongs</span><span class="op">(</span><span class="va">query</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">request</span> <span class="op">=</span> MusicCatalogSearchRequest<span class="op">(</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>        term<span class="op">:</span> query<span class="op">,</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>        types<span class="op">:</span> <span class="op">[</span>Song<span class="op">.</span><span class="kw">self</span><span class="op">]</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>limit <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">response</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> request<span class="op">.</span>response<span class="op">()</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> Array<span class="op">(</span>response<span class="op">.</span>songs<span class="op">)</span></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Search with filters</span></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">searchCalmingSongs</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">request</span> <span class="op">=</span> MusicCatalogSearchRequest<span class="op">(</span></span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>        term<span class="op">:</span> <span class="st">&quot;relaxing acoustic&quot;</span><span class="op">,</span></span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>        types<span class="op">:</span> <span class="op">[</span>Song<span class="op">.</span><span class="kw">self</span><span class="op">]</span></span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a>    request<span class="op">.</span>limit <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">response</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> request<span class="op">.</span>response<span class="op">()</span></span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Filter to slower songs</span></span>
<span id="cb140-24"><a href="#cb140-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> response<span class="op">.</span>songs<span class="op">.</span>filter <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb140-25"><a href="#cb140-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">bpm</span> <span class="op">=</span> song<span class="op">.</span>tempo <span class="op">{</span></span>
<span id="cb140-26"><a href="#cb140-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> bpm <span class="op">&lt;</span> <span class="dv">100</span></span>
<span id="cb140-27"><a href="#cb140-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb140-28"><a href="#cb140-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="kw">true</span>  <span class="co">// Include if BPM unknown</span></span>
<span id="cb140-29"><a href="#cb140-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb140-30"><a href="#cb140-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="playback-control">7.3 Playback Control</h2>
<h3 id="system-music-player">System Music Player</h3>
<p><strong>What weâ€™re doing:</strong> Controlling music playback through
the system player.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MusicPlayerController<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">player</span> <span class="op">=</span> SystemMusicPlayer<span class="op">.</span>shared</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> Song<span class="op">?</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">playbackTime</span><span class="op">:</span> TimeInterval <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>        observePlaybackState<span class="op">()</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">play</span><span class="op">(</span><span class="va">_</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>        player<span class="op">.</span>queue <span class="op">=</span> <span class="op">[</span>song<span class="op">]</span></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>play<span class="op">()</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>        currentSong <span class="op">=</span> song</span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>        isPlaying <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">playPlaylist</span><span class="op">(</span><span class="va">_</span> <span class="va">playlist</span><span class="op">:</span> <span class="dt">Playlist</span><span class="op">,</span> <span class="va">startingAt</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">?</span> <span class="op">=</span> nil<span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>        player<span class="op">.</span>queue <span class="op">=</span> <span class="op">.</span><span class="kw">init</span><span class="op">(</span>playlist<span class="op">:</span> playlist<span class="op">,</span> startingAt<span class="op">:</span> song<span class="op">)</span></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>play<span class="op">()</span></span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a>        isPlaying <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">pause</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a>        player<span class="op">.</span>pause<span class="op">()</span></span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a>        isPlaying <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">resume</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>play<span class="op">()</span></span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a>        isPlaying <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-35"><a href="#cb141-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">skipToNext</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb141-36"><a href="#cb141-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>skipToNextEntry<span class="op">()</span></span>
<span id="cb141-37"><a href="#cb141-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-38"><a href="#cb141-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-39"><a href="#cb141-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">skipToPrevious</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb141-40"><a href="#cb141-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>skipToPreviousEntry<span class="op">()</span></span>
<span id="cb141-41"><a href="#cb141-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-42"><a href="#cb141-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-43"><a href="#cb141-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">observePlaybackState</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb141-44"><a href="#cb141-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Observe player state changes</span></span>
<span id="cb141-45"><a href="#cb141-45" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">{</span></span>
<span id="cb141-46"><a href="#cb141-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="cf">await</span> state <span class="cf">in</span> player<span class="op">.</span>state<span class="op">.</span>objectWillChange<span class="op">.</span>values <span class="op">{</span></span>
<span id="cb141-47"><a href="#cb141-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb141-48"><a href="#cb141-48" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>isPlaying <span class="op">=</span> player<span class="op">.</span>state<span class="op">.</span>playbackStatus <span class="op">==</span> <span class="op">.</span>playing</span>
<span id="cb141-49"><a href="#cb141-49" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>playbackTime <span class="op">=</span> player<span class="op">.</span>playbackTime</span>
<span id="cb141-50"><a href="#cb141-50" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb141-51"><a href="#cb141-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb141-52"><a href="#cb141-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb141-53"><a href="#cb141-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb141-54"><a href="#cb141-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="queue-management">Queue Management</h3>
<p><strong>What weâ€™re doing:</strong> Building and managing the playback
queue for AI DJ.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SmartQueueManager <span class="op">{</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">player</span> <span class="op">=</span> SystemMusicPlayer<span class="op">.</span>shared</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">upcomingSongs</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">buildQueue</span><span class="op">(</span><span class="va">from</span> <span class="va">rankedSongs</span><span class="op">:</span> [<span class="dt">ScoredSong</span>]<span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Take top 10 ranked songs</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>        upcomingSongs <span class="op">=</span> rankedSongs<span class="op">.</span>prefix<span class="op">(</span><span class="dv">10</span><span class="op">).</span>map <span class="op">{</span> $<span class="fl">0.</span>song <span class="op">}</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">first</span> <span class="op">=</span> upcomingSongs<span class="op">.</span>first <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set up queue with first song</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>        player<span class="op">.</span>queue <span class="op">=</span> <span class="op">[</span>first<span class="op">]</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>play<span class="op">()</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">queueNext</span><span class="op">(</span><span class="va">_</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Insert at front of queue</span></span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>queue<span class="op">.</span>insert<span class="op">(</span>song<span class="op">,</span> position<span class="op">:</span> <span class="op">.</span>afterCurrentEntry<span class="op">)</span></span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">replaceUpcoming</span><span class="op">(</span><span class="va">with</span> <span class="va">songs</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear and rebuild queue based on new rankings</span></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>        player<span class="op">.</span>queue <span class="op">=</span> <span class="op">.</span><span class="kw">init</span><span class="op">(</span><span class="cf">for</span><span class="op">:</span> songs<span class="op">)</span></span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Called when biometrics change significantly</span></span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">adaptQueue</span><span class="op">(</span><span class="va">for</span> <span class="va">newState</span><span class="op">:</span> <span class="dt">BiometricState</span><span class="op">,</span> <span class="va">brain</span><span class="op">:</span> <span class="dt">ScoringBrain</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Re-rank remaining songs</span></span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">reranked</span> <span class="op">=</span> brain<span class="op">.</span>rankSongs<span class="op">(</span>upcomingSongs<span class="op">,</span> <span class="cf">for</span><span class="op">:</span> newState<span class="op">)</span></span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> replaceUpcoming<span class="op">(</span>with<span class="op">:</span> reranked<span class="op">.</span>map <span class="op">{</span> $<span class="fl">0.</span>song <span class="op">})</span></span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="ai-dj-musickit-service">7.4 AI DJ MusicKit Service</h2>
<h3 id="complete-integration-example">Complete Integration Example</h3>
<div class="sourceCode" id="cb143"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AIDJMusicService<span class="op">:</span> <span class="dt">MusicServiceProtocol</span><span class="op">,</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> Song<span class="op">?</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentPlaylist</span><span class="op">:</span> Playlist<span class="op">?</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">queue</span><span class="op">:</span> <span class="op">[</span>Song<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">player</span> <span class="op">=</span> SystemMusicPlayer<span class="op">.</span>shared</span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Authorization</span></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">requestAccess</span><span class="op">()</span> <span class="fu">async</span> -&gt; <span class="fu">Bool</span> <span class="op">{</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">status</span> <span class="op">=</span> <span class="cf">await</span> MusicAuthorization<span class="op">.</span>request<span class="op">()</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> status <span class="op">==</span> <span class="op">.</span>authorized</span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Library Access</span></span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">getPlaylists</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Playlist</span>] <span class="op">{</span></span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">request</span> <span class="op">=</span> MusicLibraryRequest<span class="op">&lt;</span>Playlist<span class="op">&gt;()</span></span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">response</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> request<span class="op">.</span>response<span class="op">()</span></span>
<span id="cb143-21"><a href="#cb143-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Array<span class="op">(</span>response<span class="op">.</span>items<span class="op">)</span></span>
<span id="cb143-22"><a href="#cb143-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-23"><a href="#cb143-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-24"><a href="#cb143-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">getSongs</span><span class="op">(</span><span class="va">from</span> <span class="va">playlist</span><span class="op">:</span> <span class="dt">Playlist</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb143-25"><a href="#cb143-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">detailed</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> playlist<span class="op">.</span>with<span class="op">([.</span>tracks<span class="op">])</span></span>
<span id="cb143-26"><a href="#cb143-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> detailed<span class="op">.</span>tracks<span class="op">?.</span>compactMap <span class="op">{</span> track <span class="op">-&gt;</span> Song<span class="op">?</span> <span class="cf">in</span></span>
<span id="cb143-27"><a href="#cb143-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="cf">case</span> <span class="op">.</span>song<span class="op">(</span><span class="kw">let</span> <span class="va">song</span><span class="op">)</span> <span class="op">=</span> track <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="kw">nil</span> <span class="op">}</span></span>
<span id="cb143-28"><a href="#cb143-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> song</span>
<span id="cb143-29"><a href="#cb143-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="op">??</span> <span class="op">[]</span></span>
<span id="cb143-30"><a href="#cb143-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-31"><a href="#cb143-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-32"><a href="#cb143-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Playback</span></span>
<span id="cb143-33"><a href="#cb143-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-34"><a href="#cb143-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">play</span><span class="op">(</span><span class="va">_</span> <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb143-35"><a href="#cb143-35" aria-hidden="true" tabindex="-1"></a>        player<span class="op">.</span>queue <span class="op">=</span> <span class="op">[</span>song<span class="op">]</span></span>
<span id="cb143-36"><a href="#cb143-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>play<span class="op">()</span></span>
<span id="cb143-37"><a href="#cb143-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb143-38"><a href="#cb143-38" aria-hidden="true" tabindex="-1"></a>            currentSong <span class="op">=</span> song</span>
<span id="cb143-39"><a href="#cb143-39" aria-hidden="true" tabindex="-1"></a>            isPlaying <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb143-40"><a href="#cb143-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb143-41"><a href="#cb143-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-42"><a href="#cb143-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-43"><a href="#cb143-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">playQueue</span><span class="op">(</span><span class="va">_</span> <span class="va">songs</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb143-44"><a href="#cb143-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="op">!</span>songs<span class="op">.</span>isEmpty <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb143-45"><a href="#cb143-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-46"><a href="#cb143-46" aria-hidden="true" tabindex="-1"></a>        player<span class="op">.</span>queue <span class="op">=</span> <span class="op">.</span><span class="kw">init</span><span class="op">(</span><span class="cf">for</span><span class="op">:</span> songs<span class="op">)</span></span>
<span id="cb143-47"><a href="#cb143-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>play<span class="op">()</span></span>
<span id="cb143-48"><a href="#cb143-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-49"><a href="#cb143-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb143-50"><a href="#cb143-50" aria-hidden="true" tabindex="-1"></a>            queue <span class="op">=</span> songs</span>
<span id="cb143-51"><a href="#cb143-51" aria-hidden="true" tabindex="-1"></a>            currentSong <span class="op">=</span> songs<span class="op">.</span>first</span>
<span id="cb143-52"><a href="#cb143-52" aria-hidden="true" tabindex="-1"></a>            isPlaying <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb143-53"><a href="#cb143-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb143-54"><a href="#cb143-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-55"><a href="#cb143-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-56"><a href="#cb143-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">pause</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb143-57"><a href="#cb143-57" aria-hidden="true" tabindex="-1"></a>        player<span class="op">.</span>pause<span class="op">()</span></span>
<span id="cb143-58"><a href="#cb143-58" aria-hidden="true" tabindex="-1"></a>        isPlaying <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb143-59"><a href="#cb143-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-60"><a href="#cb143-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-61"><a href="#cb143-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">skip</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb143-62"><a href="#cb143-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> player<span class="op">.</span>skipToNextEntry<span class="op">()</span></span>
<span id="cb143-63"><a href="#cb143-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-64"><a href="#cb143-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update current song</span></span>
<span id="cb143-65"><a href="#cb143-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">entry</span> <span class="op">=</span> player<span class="op">.</span>queue<span class="op">.</span>currentEntry<span class="op">,</span></span>
<span id="cb143-66"><a href="#cb143-66" aria-hidden="true" tabindex="-1"></a>           <span class="cf">case</span> <span class="op">.</span>song<span class="op">(</span><span class="kw">let</span> <span class="va">song</span><span class="op">)</span> <span class="op">=</span> entry<span class="op">.</span>item <span class="op">{</span></span>
<span id="cb143-67"><a href="#cb143-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb143-68"><a href="#cb143-68" aria-hidden="true" tabindex="-1"></a>                currentSong <span class="op">=</span> song</span>
<span id="cb143-69"><a href="#cb143-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb143-70"><a href="#cb143-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb143-71"><a href="#cb143-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-72"><a href="#cb143-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-73"><a href="#cb143-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Smart Selection</span></span>
<span id="cb143-74"><a href="#cb143-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-75"><a href="#cb143-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">selectSongsForMood</span><span class="op">(</span></span>
<span id="cb143-76"><a href="#cb143-76" aria-hidden="true" tabindex="-1"></a>        <span class="va">from</span> <span class="va">playlist</span><span class="op">:</span> <span class="dt">Playlist</span><span class="op">,</span></span>
<span id="cb143-77"><a href="#cb143-77" aria-hidden="true" tabindex="-1"></a>        <span class="va">mood</span><span class="op">:</span> <span class="dt">MusicMood</span><span class="op">,</span></span>
<span id="cb143-78"><a href="#cb143-78" aria-hidden="true" tabindex="-1"></a>        <span class="va">limit</span><span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb143-79"><a href="#cb143-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Song</span>] <span class="op">{</span></span>
<span id="cb143-80"><a href="#cb143-80" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">allSongs</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> getSongs<span class="op">(</span>from<span class="op">:</span> playlist<span class="op">)</span></span>
<span id="cb143-81"><a href="#cb143-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-82"><a href="#cb143-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Filter based on mood</span></span>
<span id="cb143-83"><a href="#cb143-83" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> allSongs<span class="op">.</span>filter <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb143-84"><a href="#cb143-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">switch</span> mood <span class="op">{</span></span>
<span id="cb143-85"><a href="#cb143-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>calm<span class="op">:</span></span>
<span id="cb143-86"><a href="#cb143-86" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="op">(</span>song<span class="op">.</span>tempo <span class="op">??</span> <span class="dv">100</span><span class="op">)</span> <span class="op">&lt;</span> <span class="dv">100</span></span>
<span id="cb143-87"><a href="#cb143-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>energize<span class="op">:</span></span>
<span id="cb143-88"><a href="#cb143-88" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="op">(</span>song<span class="op">.</span>tempo <span class="op">??</span> <span class="dv">100</span><span class="op">)</span> <span class="op">&gt;</span> <span class="dv">120</span></span>
<span id="cb143-89"><a href="#cb143-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>focus<span class="op">:</span></span>
<span id="cb143-90"><a href="#cb143-90" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Prefer instrumental or consistent tempo</span></span>
<span id="cb143-91"><a href="#cb143-91" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> song<span class="op">.</span>genreNames<span class="op">.</span>contains<span class="op">(</span><span class="st">&quot;Instrumental&quot;</span><span class="op">)</span> <span class="op">||</span></span>
<span id="cb143-92"><a href="#cb143-92" aria-hidden="true" tabindex="-1"></a>                       song<span class="op">.</span>genreNames<span class="op">.</span>contains<span class="op">(</span><span class="st">&quot;Classical&quot;</span><span class="op">)</span></span>
<span id="cb143-93"><a href="#cb143-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>neutral<span class="op">:</span></span>
<span id="cb143-94"><a href="#cb143-94" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="kw">true</span></span>
<span id="cb143-95"><a href="#cb143-95" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb143-96"><a href="#cb143-96" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb143-97"><a href="#cb143-97" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>prefix<span class="op">(</span>limit<span class="op">)</span></span>
<span id="cb143-98"><a href="#cb143-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>shuffled<span class="op">()</span></span>
<span id="cb143-99"><a href="#cb143-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb143-100"><a href="#cb143-100" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---musickit">Key Takeaways - MusicKit</h2>
<ol type="1">
<li><strong>Request authorization first</strong> - Nothing works without
user permission</li>
<li><strong>Use MusicLibraryRequest for userâ€™s music</strong> -
Playlists, recently played</li>
<li><strong>Load relationships explicitly</strong> - Use
<code>.with([.tracks])</code> to get playlist songs</li>
<li><strong>SystemMusicPlayer for playback</strong> - Shared player,
queue management</li>
<li><strong>Tempo/BPM available on Song</strong> - Key for AI DJâ€™s
rhythm matching</li>
<li><strong>Build smart queues</strong> - Re-rank and rebuild as
biometrics change</li>
</ol>
<hr />
<h1 id="healthkit-framework">8. HEALTHKIT FRAMEWORK</h1>
<h2 id="why-this-matters-for-ai-dj-7">Why This Matters for AI DJ</h2>
<p>HealthKit is Appleâ€™s centralized health data repository, providing a
secure and privacy-focused way to access biometric information from
Apple Watch and other sources. For AI DJ, HealthKit is the foundation of
intelligent music selectionâ€”it provides the real-time heart rate and HRV
data that drive our scoring algorithm.</p>
<p>Understanding HealthKitâ€™s query model is essential because health
data is fundamentally different from other data sources. Itâ€™s sensitive
(requiring explicit user authorization), time-series based (samples
arrive continuously), and sourced from multiple devices (Watch, iPhone,
third-party apps). HealthKit provides several query types optimized for
different access patterns, as detailed by <a href="https://developer.apple.com/documentation/healthkit">Appleâ€™s
documentation</a> and the <a href="https://dmtopolog.com/healthkit-changes-observing/">HealthKit blog
by dmtopolog</a>.</p>
<p><strong>In AI DJ, youâ€™ll use HealthKit for:</strong> - Reading
real-time heart rate from Apple Watch (via HKAnchoredObjectQuery) -
Accessing HRV for stress detection (typically updated less frequently) -
Detecting active workouts (changes monitoring frequency) - Building
userâ€™s baseline profile from historical data (via HKSampleQuery) -
Receiving background updates even when the app isnâ€™t active (via
HKObserverQuery)</p>
<hr />
<h2 id="authorization-1">8.1 Authorization</h2>
<p>HealthKit has the strictest privacy model of any Apple framework.
Users see exactly which data types youâ€™re requesting and can grant or
deny each type individually. Unlike most permissions where you get a
simple yes/no, with HealthKit you might have read access to heart rate
but not sleep data. Your app cannot determine whether authorization was
denied or simply not requestedâ€”this is intentional privacy
protection.</p>
<h3 id="requesting-health-permissions">Requesting Health
Permissions</h3>
<p>Authorization must be requested before any HealthKit operations. The
request is asynchronous and displays a system UI showing exactly what
data youâ€™re requesting. Best practice is to request permissions at the
moment theyâ€™re needed (e.g., when user enables biometric features)
rather than at app launch.</p>
<p><strong>What weâ€™re doing:</strong> Getting permission to read health
data. HealthKit is strict about privacy, and the user sees every data
type you request.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">HealthKit</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthKitManager <span class="op">{</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">healthStore</span> <span class="op">=</span> HKHealthStore<span class="op">()</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Types we want to read</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">readTypes</span><span class="op">:</span> Set<span class="op">&lt;</span>HKObjectType<span class="op">&gt;</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>        HKQuantityType<span class="op">(.</span>heartRate<span class="op">),</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>        HKQuantityType<span class="op">(.</span>heartRateVariabilitySDNN<span class="op">),</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>        HKQuantityType<span class="op">(.</span>stepCount<span class="op">),</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>        HKQuantityType<span class="op">(.</span>activeEnergyBurned<span class="op">),</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>        HKCategoryType<span class="op">(.</span>sleepAnalysis<span class="op">),</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>        HKWorkoutType<span class="op">.</span>workoutType<span class="op">()</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">]</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">requestAuthorization</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> HKHealthStore<span class="op">.</span>isHealthDataAvailable<span class="op">()</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> HealthKitError<span class="op">.</span>notAvailable</span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> healthStore<span class="op">.</span>requestAuthorization<span class="op">(</span></span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>            toShare<span class="op">:</span> <span class="op">[],</span>  <span class="co">// We only read, not write</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>            read<span class="op">:</span> readTypes</span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">checkAuthorizationStatus</span><span class="op">()</span> -&gt; <span class="fu">Bool</span> <span class="op">{</span></span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Note: Can only check for types we requested</span></span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">status</span> <span class="op">=</span> healthStore<span class="op">.</span>authorizationStatus<span class="op">(</span><span class="cf">for</span><span class="op">:</span> heartRateType<span class="op">)</span></span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> status <span class="op">==</span> <span class="op">.</span>sharingAuthorized</span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> HealthKitError<span class="op">:</span> <span class="dt">Error</span> <span class="op">{</span></span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> notAvailable</span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> notAuthorized</span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> noData</span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Info.plist requirements:</strong></p>
<div class="sourceCode" id="cb145"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">key</span>&gt;NSHealthShareUsageDescription&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">string</span>&gt;AI DJ reads your heart rate and HRV to select music that matches your current state.&lt;/<span class="kw">string</span>&gt;</span></code></pre></div>
<hr />
<h2 id="reading-health-data">8.2 Reading Health Data</h2>
<h3 id="querying-recent-samples">Querying Recent Samples</h3>
<p><strong>What weâ€™re doing:</strong> Fetching the most recent health
measurements.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> HealthKitManager <span class="op">{</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get most recent heart rate</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">fetchLatestHeartRate</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sortDescriptor</span> <span class="op">=</span> NSSortDescriptor<span class="op">(</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>            key<span class="op">:</span> HKSampleSortIdentifierStartDate<span class="op">,</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>            ascending<span class="op">:</span> <span class="kw">false</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKSampleQuery<span class="op">(</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>            sampleType<span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>            predicate<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>            sortDescriptors<span class="op">:</span> <span class="op">[</span>sortDescriptor<span class="op">]</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> _<span class="op">,</span> samples<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Handled via continuation below</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="cf">try</span> <span class="cf">await</span> withCheckedThrowingContinuation <span class="op">{</span> continuation <span class="cf">in</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKSampleQuery<span class="op">(</span></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>                sampleType<span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a>                predicate<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a>                limit<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a>                sortDescriptors<span class="op">:</span> <span class="op">[</span>sortDescriptor<span class="op">]</span></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span> <span class="op">{</span> _<span class="op">,</span> samples<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="va">error</span> <span class="op">=</span> error <span class="op">{</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a>                    continuation<span class="op">.</span>resume<span class="op">(</span>throwing<span class="op">:</span> error<span class="op">)</span></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">return</span></span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-32"><a href="#cb146-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">guard</span> <span class="kw">let</span> <span class="va">sample</span> <span class="op">=</span> samples<span class="op">?.</span>first <span class="kw">as</span><span class="op">?</span> HKQuantitySample <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb146-33"><a href="#cb146-33" aria-hidden="true" tabindex="-1"></a>                    continuation<span class="op">.</span>resume<span class="op">(</span>throwing<span class="op">:</span> HealthKitError<span class="op">.</span>noData<span class="op">)</span></span>
<span id="cb146-34"><a href="#cb146-34" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">return</span></span>
<span id="cb146-35"><a href="#cb146-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb146-36"><a href="#cb146-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-37"><a href="#cb146-37" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="va">bpm</span> <span class="op">=</span> sample<span class="op">.</span>quantity<span class="op">.</span>doubleValue<span class="op">(</span></span>
<span id="cb146-38"><a href="#cb146-38" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span><span class="op">:</span> HKUnit<span class="op">.</span>count<span class="op">().</span>unitDivided<span class="op">(</span>by<span class="op">:</span> <span class="op">.</span>minute<span class="op">())</span></span>
<span id="cb146-39"><a href="#cb146-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">)</span></span>
<span id="cb146-40"><a href="#cb146-40" aria-hidden="true" tabindex="-1"></a>                continuation<span class="op">.</span>resume<span class="op">(</span>returning<span class="op">:</span> bpm<span class="op">)</span></span>
<span id="cb146-41"><a href="#cb146-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb146-42"><a href="#cb146-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-43"><a href="#cb146-43" aria-hidden="true" tabindex="-1"></a>            healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb146-44"><a href="#cb146-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb146-45"><a href="#cb146-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb146-46"><a href="#cb146-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-47"><a href="#cb146-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get samples from time range</span></span>
<span id="cb146-48"><a href="#cb146-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">fetchHeartRateSamples</span><span class="op">(</span></span>
<span id="cb146-49"><a href="#cb146-49" aria-hidden="true" tabindex="-1"></a>        <span class="va">from</span> <span class="va">startDate</span><span class="op">:</span> <span class="dt">Date</span><span class="op">,</span></span>
<span id="cb146-50"><a href="#cb146-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">to</span> <span class="va">endDate</span><span class="op">:</span> <span class="dt">Date</span></span>
<span id="cb146-51"><a href="#cb146-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">HKQuantitySample</span>] <span class="op">{</span></span>
<span id="cb146-52"><a href="#cb146-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb146-53"><a href="#cb146-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-54"><a href="#cb146-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">predicate</span> <span class="op">=</span> HKQuery<span class="op">.</span>predicateForSamples<span class="op">(</span></span>
<span id="cb146-55"><a href="#cb146-55" aria-hidden="true" tabindex="-1"></a>            withStart<span class="op">:</span> startDate<span class="op">,</span></span>
<span id="cb146-56"><a href="#cb146-56" aria-hidden="true" tabindex="-1"></a>            end<span class="op">:</span> endDate<span class="op">,</span></span>
<span id="cb146-57"><a href="#cb146-57" aria-hidden="true" tabindex="-1"></a>            options<span class="op">:</span> <span class="op">.</span>strictStartDate</span>
<span id="cb146-58"><a href="#cb146-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb146-59"><a href="#cb146-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-60"><a href="#cb146-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="cf">try</span> <span class="cf">await</span> withCheckedThrowingContinuation <span class="op">{</span> continuation <span class="cf">in</span></span>
<span id="cb146-61"><a href="#cb146-61" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKSampleQuery<span class="op">(</span></span>
<span id="cb146-62"><a href="#cb146-62" aria-hidden="true" tabindex="-1"></a>                sampleType<span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb146-63"><a href="#cb146-63" aria-hidden="true" tabindex="-1"></a>                predicate<span class="op">:</span> predicate<span class="op">,</span></span>
<span id="cb146-64"><a href="#cb146-64" aria-hidden="true" tabindex="-1"></a>                limit<span class="op">:</span> HKObjectQueryNoLimit<span class="op">,</span></span>
<span id="cb146-65"><a href="#cb146-65" aria-hidden="true" tabindex="-1"></a>                sortDescriptors<span class="op">:</span> <span class="op">[</span></span>
<span id="cb146-66"><a href="#cb146-66" aria-hidden="true" tabindex="-1"></a>                    NSSortDescriptor<span class="op">(</span>key<span class="op">:</span> HKSampleSortIdentifierStartDate<span class="op">,</span> ascending<span class="op">:</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb146-67"><a href="#cb146-67" aria-hidden="true" tabindex="-1"></a>                <span class="op">]</span></span>
<span id="cb146-68"><a href="#cb146-68" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span> <span class="op">{</span> _<span class="op">,</span> samples<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb146-69"><a href="#cb146-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="va">error</span> <span class="op">=</span> error <span class="op">{</span></span>
<span id="cb146-70"><a href="#cb146-70" aria-hidden="true" tabindex="-1"></a>                    continuation<span class="op">.</span>resume<span class="op">(</span>throwing<span class="op">:</span> error<span class="op">)</span></span>
<span id="cb146-71"><a href="#cb146-71" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">return</span></span>
<span id="cb146-72"><a href="#cb146-72" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb146-73"><a href="#cb146-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-74"><a href="#cb146-74" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="va">quantitySamples</span> <span class="op">=</span> samples <span class="kw">as</span><span class="op">?</span> <span class="op">[</span>HKQuantitySample<span class="op">]</span> <span class="op">??</span> <span class="op">[]</span></span>
<span id="cb146-75"><a href="#cb146-75" aria-hidden="true" tabindex="-1"></a>                continuation<span class="op">.</span>resume<span class="op">(</span>returning<span class="op">:</span> quantitySamples<span class="op">)</span></span>
<span id="cb146-76"><a href="#cb146-76" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb146-77"><a href="#cb146-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-78"><a href="#cb146-78" aria-hidden="true" tabindex="-1"></a>            healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb146-79"><a href="#cb146-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb146-80"><a href="#cb146-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb146-81"><a href="#cb146-81" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="heart-rate-variability-hrv">Heart Rate Variability (HRV)</h3>
<p><strong>What weâ€™re doing:</strong> Reading HRV, which indicates
stress vs relaxation.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> HealthKitManager <span class="op">{</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">fetchLatestHRV</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hrvType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRateVariabilitySDNN<span class="op">)</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="cf">try</span> <span class="cf">await</span> withCheckedThrowingContinuation <span class="op">{</span> continuation <span class="cf">in</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKSampleQuery<span class="op">(</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>                sampleType<span class="op">:</span> hrvType<span class="op">,</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a>                predicate<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a>                limit<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a>                sortDescriptors<span class="op">:</span> <span class="op">[</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>                    NSSortDescriptor<span class="op">(</span>key<span class="op">:</span> HKSampleSortIdentifierStartDate<span class="op">,</span> ascending<span class="op">:</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>                <span class="op">]</span></span>
<span id="cb147-13"><a href="#cb147-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span> <span class="op">{</span> _<span class="op">,</span> samples<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb147-14"><a href="#cb147-14" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="va">error</span> <span class="op">=</span> error <span class="op">{</span></span>
<span id="cb147-15"><a href="#cb147-15" aria-hidden="true" tabindex="-1"></a>                    continuation<span class="op">.</span>resume<span class="op">(</span>throwing<span class="op">:</span> error<span class="op">)</span></span>
<span id="cb147-16"><a href="#cb147-16" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">return</span></span>
<span id="cb147-17"><a href="#cb147-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb147-18"><a href="#cb147-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-19"><a href="#cb147-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">guard</span> <span class="kw">let</span> <span class="va">sample</span> <span class="op">=</span> samples<span class="op">?.</span>first <span class="kw">as</span><span class="op">?</span> HKQuantitySample <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb147-20"><a href="#cb147-20" aria-hidden="true" tabindex="-1"></a>                    continuation<span class="op">.</span>resume<span class="op">(</span>throwing<span class="op">:</span> HealthKitError<span class="op">.</span>noData<span class="op">)</span></span>
<span id="cb147-21"><a href="#cb147-21" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">return</span></span>
<span id="cb147-22"><a href="#cb147-22" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb147-23"><a href="#cb147-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-24"><a href="#cb147-24" aria-hidden="true" tabindex="-1"></a>                <span class="co">// HRV is in milliseconds</span></span>
<span id="cb147-25"><a href="#cb147-25" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="va">hrv</span> <span class="op">=</span> sample<span class="op">.</span>quantity<span class="op">.</span>doubleValue<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>secondUnit<span class="op">(</span>with<span class="op">:</span> <span class="op">.</span>milli<span class="op">))</span></span>
<span id="cb147-26"><a href="#cb147-26" aria-hidden="true" tabindex="-1"></a>                continuation<span class="op">.</span>resume<span class="op">(</span>returning<span class="op">:</span> hrv<span class="op">)</span></span>
<span id="cb147-27"><a href="#cb147-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb147-28"><a href="#cb147-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-29"><a href="#cb147-29" aria-hidden="true" tabindex="-1"></a>            healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb147-30"><a href="#cb147-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb147-31"><a href="#cb147-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb147-32"><a href="#cb147-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-33"><a href="#cb147-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Interpret HRV value</span></span>
<span id="cb147-34"><a href="#cb147-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">interpretHRV</span><span class="op">(</span><span class="va">_</span> <span class="va">hrv</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">StressLevel</span> <span class="op">{</span></span>
<span id="cb147-35"><a href="#cb147-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Higher HRV = more relaxed</span></span>
<span id="cb147-36"><a href="#cb147-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// These thresholds vary by individual</span></span>
<span id="cb147-37"><a href="#cb147-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> hrv <span class="op">{</span></span>
<span id="cb147-38"><a href="#cb147-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">0.</span><span class="op">.&lt;</span><span class="dv">20</span><span class="op">:</span></span>
<span id="cb147-39"><a href="#cb147-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>high      <span class="co">// Very stressed</span></span>
<span id="cb147-40"><a href="#cb147-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">20.</span><span class="op">.&lt;</span><span class="dv">40</span><span class="op">:</span></span>
<span id="cb147-41"><a href="#cb147-41" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>moderate  <span class="co">// Somewhat stressed</span></span>
<span id="cb147-42"><a href="#cb147-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">40.</span><span class="op">.&lt;</span><span class="dv">70</span><span class="op">:</span></span>
<span id="cb147-43"><a href="#cb147-43" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>low       <span class="co">// Relaxed</span></span>
<span id="cb147-44"><a href="#cb147-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb147-45"><a href="#cb147-45" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>veryLow   <span class="co">// Very relaxed</span></span>
<span id="cb147-46"><a href="#cb147-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb147-47"><a href="#cb147-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb147-48"><a href="#cb147-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="real-time-monitoring">8.3 Real-Time Monitoring</h2>
<p>HealthKit provides two primary query types for monitoring changes:
<strong>HKObserverQuery</strong> and
<strong>HKAnchoredObjectQuery</strong>. Understanding their differences
is crucial for building an efficient health monitoring system.</p>
<p>According to <a href="https://developer.apple.com/documentation/healthkit/hkobserverquery">Appleâ€™s
documentation</a> and <a href="https://dmtopolog.com/healthkit-changes-observing/">developer
analysis</a>:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>HKObserverQuery</th>
<th>HKAnchoredObjectQuery</th>
</tr>
</thead>
<tbody>
<tr>
<td>Notifies of changes</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Returns actual data</td>
<td>âŒ (notification only)</td>
<td>âœ… (includes samples)</td>
</tr>
<tr>
<td>Tracks additions &amp; deletions</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td>Background delivery</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td>Uses anchors to track position</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<p><strong>The typical pattern</strong>: Use HKObserverQuery with
background delivery to wake your app when changes occur in the
background. Use HKAnchoredObjectQuery for foreground monitoring because
it returns actual data and tracks your position in the stream via
anchors.</p>
<h3 id="observer-queries">Observer Queries</h3>
<p>HKObserverQuery is a â€œwake up callâ€â€”it notifies you that something
changed but doesnâ€™t tell you what. You must run a separate query to get
the actual data. Its main advantage is <strong>background
delivery</strong>: iOS can wake your app when new data arrives, even if
your app isnâ€™t running.</p>
<p>One important caveat from <a href="https://developer.apple.com/forums/thread/22012">developer
forums</a>: the observer callback may fire more frequently than actual
data changes. Itâ€™s triggered when your app comes to foreground
regardless of whether data changed. Donâ€™t assume new data exists just
because the callback fired.</p>
<p><strong>What weâ€™re doing:</strong> Setting up a notification system
that alerts us when new health data is recorded, allowing us to then
fetch the latest values.</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> HealthKitManager <span class="op">{</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">observerQuery</span><span class="op">:</span> HKObserverQuery<span class="op">?</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">startMonitoringHeartRate</span><span class="op">(</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">handler</span><span class="op">:</span> @<span class="dt">escaping</span> (<span class="va">Double</span><span class="op">)</span> -&gt; <span class="fu">Void</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKObserverQuery<span class="op">(</span></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>            sampleType<span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a>            predicate<span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> _<span class="op">,</span> completionHandler<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> error <span class="op">==</span> <span class="kw">nil</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>                completionHandler<span class="op">()</span></span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span></span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Fetch the latest sample when notified</span></span>
<span id="cb148-19"><a href="#cb148-19" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span></span>
<span id="cb148-20"><a href="#cb148-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="va">rate</span> <span class="op">=</span> <span class="cf">try</span><span class="op">?</span> <span class="cf">await</span> <span class="kw">self</span><span class="op">?.</span>fetchLatestHeartRate<span class="op">()</span> <span class="op">{</span></span>
<span id="cb148-21"><a href="#cb148-21" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb148-22"><a href="#cb148-22" aria-hidden="true" tabindex="-1"></a>                        handler<span class="op">(</span>rate<span class="op">)</span></span>
<span id="cb148-23"><a href="#cb148-23" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb148-24"><a href="#cb148-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb148-25"><a href="#cb148-25" aria-hidden="true" tabindex="-1"></a>                completionHandler<span class="op">()</span></span>
<span id="cb148-26"><a href="#cb148-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb148-27"><a href="#cb148-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb148-28"><a href="#cb148-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-29"><a href="#cb148-29" aria-hidden="true" tabindex="-1"></a>        observerQuery <span class="op">=</span> query</span>
<span id="cb148-30"><a href="#cb148-30" aria-hidden="true" tabindex="-1"></a>        healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb148-31"><a href="#cb148-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb148-32"><a href="#cb148-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-33"><a href="#cb148-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">stopMonitoringHeartRate</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb148-34"><a href="#cb148-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> observerQuery <span class="op">{</span></span>
<span id="cb148-35"><a href="#cb148-35" aria-hidden="true" tabindex="-1"></a>            healthStore<span class="op">.</span>stop<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb148-36"><a href="#cb148-36" aria-hidden="true" tabindex="-1"></a>            observerQuery <span class="op">=</span> <span class="kw">nil</span></span>
<span id="cb148-37"><a href="#cb148-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb148-38"><a href="#cb148-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb148-39"><a href="#cb148-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="anchored-object-queries">Anchored Object Queries</h3>
<p>HKAnchoredObjectQuery is the more powerful query for real-time
monitoring. As explained by <a href="https://www.devfright.com/how-to-use-healthkit-hkanchoredobjectquery/">DevFrightâ€™s
tutorial</a>, it provides several advantages:</p>
<ol type="1">
<li><strong>Returns actual samples</strong> - No need for a second
query</li>
<li><strong>Tracks position with anchors</strong> - Only returns new
samples since your last check</li>
<li><strong>Reports deletions</strong> - Know when samples are removed
(rare but important)</li>
<li><strong>Continuous monitoring</strong> - With
<code>updateHandler</code>, it becomes a long-running query</li>
</ol>
<p>The anchor mechanism works like a bookmark in the HealthKit database.
When you first query, pass <code>nil</code> for the anchor to get all
matching samples. HealthKit returns the samples plus a new anchor. Save
this anchor and pass it to subsequent queries to receive only samples
added since that point. This is extremely efficient for streaming
data.</p>
<p><strong>Limitation</strong>: Anchored queries only run while your app
is active. For background delivery, you must use HKObserverQuery to wake
the app, then run an anchored query to fetch the actual changes.</p>
<p><strong>What weâ€™re doing:</strong> Setting up efficient, incremental
data fetching that only returns samples we havenâ€™t seen yet. The anchor
tracks our position in the data stream.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HeartRateMonitor <span class="op">{</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">healthStore</span> <span class="op">=</span> HKHealthStore<span class="op">()</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">anchor</span><span class="op">:</span> HKQueryAnchor<span class="op">?</span>  <span class="co">// Saves our position in the data stream</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">query</span><span class="op">:</span> HKAnchoredObjectQuery<span class="op">?</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onNewSamples</span><span class="op">:</span> <span class="op">(([</span>Double<span class="op">])</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">startMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Pass our saved anchor, or nil for first query</span></span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKAnchoredObjectQuery<span class="op">(</span></span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>            type<span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb149-14"><a href="#cb149-14" aria-hidden="true" tabindex="-1"></a>            predicate<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb149-15"><a href="#cb149-15" aria-hidden="true" tabindex="-1"></a>            anchor<span class="op">:</span> anchor<span class="op">,</span></span>
<span id="cb149-16"><a href="#cb149-16" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">:</span> HKObjectQueryNoLimit</span>
<span id="cb149-17"><a href="#cb149-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> query<span class="op">,</span> samples<span class="op">,</span> deleted<span class="op">,</span> newAnchor<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb149-18"><a href="#cb149-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>handleNewSamples<span class="op">(</span>samples<span class="op">,</span> newAnchor<span class="op">:</span> newAnchor<span class="op">)</span></span>
<span id="cb149-19"><a href="#cb149-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb149-20"><a href="#cb149-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-21"><a href="#cb149-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This handler is called for subsequent updates</span></span>
<span id="cb149-22"><a href="#cb149-22" aria-hidden="true" tabindex="-1"></a>        query<span class="op">.</span>updateHandler <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> query<span class="op">,</span> samples<span class="op">,</span> deleted<span class="op">,</span> newAnchor<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb149-23"><a href="#cb149-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>handleNewSamples<span class="op">(</span>samples<span class="op">,</span> newAnchor<span class="op">:</span> newAnchor<span class="op">)</span></span>
<span id="cb149-24"><a href="#cb149-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb149-25"><a href="#cb149-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-26"><a href="#cb149-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>query <span class="op">=</span> query</span>
<span id="cb149-27"><a href="#cb149-27" aria-hidden="true" tabindex="-1"></a>        healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb149-28"><a href="#cb149-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-29"><a href="#cb149-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-30"><a href="#cb149-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">handleNewSamples</span><span class="op">(</span><span class="va">_</span> <span class="va">samples</span><span class="op">:</span> [<span class="dt">HKSample</span>]?<span class="op">,</span> <span class="va">newAnchor</span><span class="op">:</span> <span class="dt">HKQueryAnchor</span><span class="op">?)</span> <span class="op">{</span></span>
<span id="cb149-31"><a href="#cb149-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">samples</span> <span class="op">=</span> samples <span class="kw">as</span><span class="op">?</span> <span class="op">[</span>HKQuantitySample<span class="op">]</span> <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb149-32"><a href="#cb149-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-33"><a href="#cb149-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Save anchor for next query</span></span>
<span id="cb149-34"><a href="#cb149-34" aria-hidden="true" tabindex="-1"></a>        anchor <span class="op">=</span> newAnchor</span>
<span id="cb149-35"><a href="#cb149-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-36"><a href="#cb149-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Convert to BPM values</span></span>
<span id="cb149-37"><a href="#cb149-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">rates</span> <span class="op">=</span> samples<span class="op">.</span>map <span class="op">{</span> sample <span class="cf">in</span></span>
<span id="cb149-38"><a href="#cb149-38" aria-hidden="true" tabindex="-1"></a>            sample<span class="op">.</span>quantity<span class="op">.</span>doubleValue<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>beatsPerMinute<span class="op">())</span></span>
<span id="cb149-39"><a href="#cb149-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb149-40"><a href="#cb149-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-41"><a href="#cb149-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>rates<span class="op">.</span>isEmpty <span class="op">{</span></span>
<span id="cb149-42"><a href="#cb149-42" aria-hidden="true" tabindex="-1"></a>            onNewSamples<span class="op">?(</span>rates<span class="op">)</span></span>
<span id="cb149-43"><a href="#cb149-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb149-44"><a href="#cb149-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-45"><a href="#cb149-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-46"><a href="#cb149-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">stopMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb149-47"><a href="#cb149-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> query <span class="op">{</span></span>
<span id="cb149-48"><a href="#cb149-48" aria-hidden="true" tabindex="-1"></a>            healthStore<span class="op">.</span>stop<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb149-49"><a href="#cb149-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb149-50"><a href="#cb149-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb149-51"><a href="#cb149-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="ai-dj-healthkit-service">8.4 AI DJ HealthKit Service</h2>
<h3 id="complete-integration">Complete Integration</h3>
<div class="sourceCode" id="cb150"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AIDJHealthService<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">healthStore</span> <span class="op">=</span> HKHealthStore<span class="op">()</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">heartRateMonitor</span><span class="op">:</span> HeartRateMonitor<span class="op">?</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">cancellables</span> <span class="op">=</span> Set<span class="op">&lt;</span>AnyCancellable<span class="op">&gt;()</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentHeartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentHRV</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isMonitoring</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subjects for reactive streams</span></span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRateSubject</span> <span class="op">=</span> PassthroughSubject<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;()</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">hrvSubject</span> <span class="op">=</span> PassthroughSubject<span class="op">&lt;</span>Double<span class="op">,</span> Never<span class="op">&gt;()</span></span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Authorization</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">requestAuthorization</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb150-17"><a href="#cb150-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">types</span><span class="op">:</span> Set<span class="op">&lt;</span>HKObjectType<span class="op">&gt;</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb150-18"><a href="#cb150-18" aria-hidden="true" tabindex="-1"></a>            HKQuantityType<span class="op">(.</span>heartRate<span class="op">),</span></span>
<span id="cb150-19"><a href="#cb150-19" aria-hidden="true" tabindex="-1"></a>            HKQuantityType<span class="op">(.</span>heartRateVariabilitySDNN<span class="op">),</span></span>
<span id="cb150-20"><a href="#cb150-20" aria-hidden="true" tabindex="-1"></a>            HKWorkoutType<span class="op">.</span>workoutType<span class="op">()</span></span>
<span id="cb150-21"><a href="#cb150-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb150-22"><a href="#cb150-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-23"><a href="#cb150-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> healthStore<span class="op">.</span>requestAuthorization<span class="op">(</span>toShare<span class="op">:</span> <span class="op">[],</span> read<span class="op">:</span> types<span class="op">)</span></span>
<span id="cb150-24"><a href="#cb150-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-25"><a href="#cb150-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-26"><a href="#cb150-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Monitoring</span></span>
<span id="cb150-27"><a href="#cb150-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-28"><a href="#cb150-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">startMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb150-29"><a href="#cb150-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="op">!</span>isMonitoring <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb150-30"><a href="#cb150-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-31"><a href="#cb150-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">monitor</span> <span class="op">=</span> HeartRateMonitor<span class="op">()</span></span>
<span id="cb150-32"><a href="#cb150-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-33"><a href="#cb150-33" aria-hidden="true" tabindex="-1"></a>        monitor<span class="op">.</span>onNewSamples <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> rates <span class="cf">in</span></span>
<span id="cb150-34"><a href="#cb150-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">latest</span> <span class="op">=</span> rates<span class="op">.</span>last <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb150-35"><a href="#cb150-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-36"><a href="#cb150-36" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb150-37"><a href="#cb150-37" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">?.</span>currentHeartRate <span class="op">=</span> latest</span>
<span id="cb150-38"><a href="#cb150-38" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">?.</span>heartRateSubject<span class="op">.</span>send<span class="op">(</span>latest<span class="op">)</span></span>
<span id="cb150-39"><a href="#cb150-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb150-40"><a href="#cb150-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb150-41"><a href="#cb150-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-42"><a href="#cb150-42" aria-hidden="true" tabindex="-1"></a>        monitor<span class="op">.</span>startMonitoring<span class="op">()</span></span>
<span id="cb150-43"><a href="#cb150-43" aria-hidden="true" tabindex="-1"></a>        heartRateMonitor <span class="op">=</span> monitor</span>
<span id="cb150-44"><a href="#cb150-44" aria-hidden="true" tabindex="-1"></a>        isMonitoring <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb150-45"><a href="#cb150-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-46"><a href="#cb150-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Also poll HRV periodically (updated less frequently)</span></span>
<span id="cb150-47"><a href="#cb150-47" aria-hidden="true" tabindex="-1"></a>        startHRVPolling<span class="op">()</span></span>
<span id="cb150-48"><a href="#cb150-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-49"><a href="#cb150-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-50"><a href="#cb150-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">startHRVPolling</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb150-51"><a href="#cb150-51" aria-hidden="true" tabindex="-1"></a>        Timer<span class="op">.</span>publish<span class="op">(</span>every<span class="op">:</span> <span class="dv">60</span><span class="op">,</span> on<span class="op">:</span> <span class="op">.</span>main<span class="op">,</span> <span class="cf">in</span><span class="op">:</span> <span class="op">.</span>common<span class="op">)</span></span>
<span id="cb150-52"><a href="#cb150-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>autoconnect<span class="op">()</span></span>
<span id="cb150-53"><a href="#cb150-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>sink <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> _ <span class="cf">in</span></span>
<span id="cb150-54"><a href="#cb150-54" aria-hidden="true" tabindex="-1"></a>                Task <span class="op">{</span></span>
<span id="cb150-55"><a href="#cb150-55" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> <span class="kw">self</span><span class="op">?.</span>fetchLatestHRV<span class="op">()</span></span>
<span id="cb150-56"><a href="#cb150-56" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb150-57"><a href="#cb150-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb150-58"><a href="#cb150-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>store<span class="op">(</span><span class="cf">in</span><span class="op">:</span> <span class="op">&amp;</span>cancellables<span class="op">)</span></span>
<span id="cb150-59"><a href="#cb150-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-60"><a href="#cb150-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-61"><a href="#cb150-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">fetchLatestHRV</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb150-62"><a href="#cb150-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hrvType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRateVariabilitySDNN<span class="op">)</span></span>
<span id="cb150-63"><a href="#cb150-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-64"><a href="#cb150-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKSampleQuery<span class="op">(</span></span>
<span id="cb150-65"><a href="#cb150-65" aria-hidden="true" tabindex="-1"></a>            sampleType<span class="op">:</span> hrvType<span class="op">,</span></span>
<span id="cb150-66"><a href="#cb150-66" aria-hidden="true" tabindex="-1"></a>            predicate<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb150-67"><a href="#cb150-67" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb150-68"><a href="#cb150-68" aria-hidden="true" tabindex="-1"></a>            sortDescriptors<span class="op">:</span> <span class="op">[</span>NSSortDescriptor<span class="op">(</span>key<span class="op">:</span> HKSampleSortIdentifierStartDate<span class="op">,</span> ascending<span class="op">:</span> <span class="kw">false</span><span class="op">)]</span></span>
<span id="cb150-69"><a href="#cb150-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> _<span class="op">,</span> samples<span class="op">,</span> _ <span class="cf">in</span></span>
<span id="cb150-70"><a href="#cb150-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">sample</span> <span class="op">=</span> samples<span class="op">?.</span>first <span class="kw">as</span><span class="op">?</span> HKQuantitySample <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb150-71"><a href="#cb150-71" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">hrv</span> <span class="op">=</span> sample<span class="op">.</span>quantity<span class="op">.</span>doubleValue<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>secondUnit<span class="op">(</span>with<span class="op">:</span> <span class="op">.</span>milli<span class="op">))</span></span>
<span id="cb150-72"><a href="#cb150-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-73"><a href="#cb150-73" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb150-74"><a href="#cb150-74" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">?.</span>currentHRV <span class="op">=</span> hrv</span>
<span id="cb150-75"><a href="#cb150-75" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">?.</span>hrvSubject<span class="op">.</span>send<span class="op">(</span>hrv<span class="op">)</span></span>
<span id="cb150-76"><a href="#cb150-76" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb150-77"><a href="#cb150-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb150-78"><a href="#cb150-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-79"><a href="#cb150-79" aria-hidden="true" tabindex="-1"></a>        healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb150-80"><a href="#cb150-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-81"><a href="#cb150-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-82"><a href="#cb150-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">stopMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb150-83"><a href="#cb150-83" aria-hidden="true" tabindex="-1"></a>        heartRateMonitor<span class="op">?.</span>stopMonitoring<span class="op">()</span></span>
<span id="cb150-84"><a href="#cb150-84" aria-hidden="true" tabindex="-1"></a>        heartRateMonitor <span class="op">=</span> <span class="kw">nil</span></span>
<span id="cb150-85"><a href="#cb150-85" aria-hidden="true" tabindex="-1"></a>        isMonitoring <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb150-86"><a href="#cb150-86" aria-hidden="true" tabindex="-1"></a>        cancellables<span class="op">.</span>removeAll<span class="op">()</span></span>
<span id="cb150-87"><a href="#cb150-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-88"><a href="#cb150-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-89"><a href="#cb150-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Historical Data</span></span>
<span id="cb150-90"><a href="#cb150-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-91"><a href="#cb150-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">fetchBaseline</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">UserBaseline</span> <span class="op">{</span></span>
<span id="cb150-92"><a href="#cb150-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">oneWeekAgo</span> <span class="op">=</span> Calendar<span class="op">.</span>current<span class="op">.</span>date<span class="op">(</span>byAdding<span class="op">:</span> <span class="op">.</span>day<span class="op">,</span> value<span class="op">:</span> <span class="op">-</span><span class="dv">7</span><span class="op">,</span> to<span class="op">:</span> Date<span class="op">())!</span></span>
<span id="cb150-93"><a href="#cb150-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-94"><a href="#cb150-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fetch resting heart rate samples (during sleep/rest periods)</span></span>
<span id="cb150-95"><a href="#cb150-95" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">restingHR</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> fetchRestingHeartRate<span class="op">(</span>since<span class="op">:</span> oneWeekAgo<span class="op">)</span></span>
<span id="cb150-96"><a href="#cb150-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-97"><a href="#cb150-97" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fetch HRV history</span></span>
<span id="cb150-98"><a href="#cb150-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hrvHistory</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> fetchHRVHistory<span class="op">(</span>since<span class="op">:</span> oneWeekAgo<span class="op">)</span></span>
<span id="cb150-99"><a href="#cb150-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-100"><a href="#cb150-100" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> UserBaseline<span class="op">(</span></span>
<span id="cb150-101"><a href="#cb150-101" aria-hidden="true" tabindex="-1"></a>            restingHeartRate<span class="op">:</span> restingHR<span class="op">,</span></span>
<span id="cb150-102"><a href="#cb150-102" aria-hidden="true" tabindex="-1"></a>            averageHRV<span class="op">:</span> hrvHistory<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span> <span class="op">/</span> Double<span class="op">(</span>hrvHistory<span class="op">.</span>count<span class="op">),</span></span>
<span id="cb150-103"><a href="#cb150-103" aria-hidden="true" tabindex="-1"></a>            hrvRange<span class="op">:</span> <span class="op">(</span>hrvHistory<span class="op">.</span>min<span class="op">()</span> <span class="op">??</span> <span class="dv">0</span><span class="op">,</span> hrvHistory<span class="op">.</span>max<span class="op">()</span> <span class="op">??</span> <span class="dv">100</span><span class="op">)</span></span>
<span id="cb150-104"><a href="#cb150-104" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb150-105"><a href="#cb150-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-106"><a href="#cb150-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-107"><a href="#cb150-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">fetchRestingHeartRate</span><span class="op">(</span><span class="va">since</span> <span class="va">date</span><span class="op">:</span> <span class="dt">Date</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb150-108"><a href="#cb150-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Query heart rate during typical sleep hours (midnight to 6am)</span></span>
<span id="cb150-109"><a href="#cb150-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This approximates resting heart rate</span></span>
<span id="cb150-110"><a href="#cb150-110" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Implementation similar to fetchHeartRateSamples with time filtering</span></span>
<span id="cb150-111"><a href="#cb150-111" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="fl">65.0</span>  <span class="co">// Placeholder</span></span>
<span id="cb150-112"><a href="#cb150-112" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-113"><a href="#cb150-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-114"><a href="#cb150-114" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">fetchHRVHistory</span><span class="op">(</span><span class="va">since</span> <span class="va">date</span><span class="op">:</span> <span class="dt">Date</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">Double</span>] <span class="op">{</span></span>
<span id="cb150-115"><a href="#cb150-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Similar query pattern for HRV samples</span></span>
<span id="cb150-116"><a href="#cb150-116" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[</span><span class="dv">45</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">42</span><span class="op">,</span> <span class="dv">55</span><span class="op">,</span> <span class="dv">48</span><span class="op">]</span>  <span class="co">// Placeholder</span></span>
<span id="cb150-117"><a href="#cb150-117" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-118"><a href="#cb150-118" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb150-119"><a href="#cb150-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-120"><a href="#cb150-120" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> UserBaseline <span class="op">{</span></span>
<span id="cb150-121"><a href="#cb150-121" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">restingHeartRate</span><span class="op">:</span> Double</span>
<span id="cb150-122"><a href="#cb150-122" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">averageHRV</span><span class="op">:</span> Double</span>
<span id="cb150-123"><a href="#cb150-123" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">hrvRange</span><span class="op">:</span> <span class="op">(</span>min<span class="op">:</span> Double<span class="op">,</span> max<span class="op">:</span> Double<span class="op">)</span></span>
<span id="cb150-124"><a href="#cb150-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-125"><a href="#cb150-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Is current state elevated compared to baseline?</span></span>
<span id="cb150-126"><a href="#cb150-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">isElevated</span><span class="op">(</span><span class="va">currentHR</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">Bool</span> <span class="op">{</span></span>
<span id="cb150-127"><a href="#cb150-127" aria-hidden="true" tabindex="-1"></a>        currentHR <span class="op">&gt;</span> restingHeartRate <span class="op">*</span> <span class="fl">1.3</span>  <span class="co">// 30% above resting</span></span>
<span id="cb150-128"><a href="#cb150-128" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-129"><a href="#cb150-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-130"><a href="#cb150-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Is current HRV indicating stress?</span></span>
<span id="cb150-131"><a href="#cb150-131" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">isStressed</span><span class="op">(</span><span class="va">currentHRV</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">Bool</span> <span class="op">{</span></span>
<span id="cb150-132"><a href="#cb150-132" aria-hidden="true" tabindex="-1"></a>        currentHRV <span class="op">&lt;</span> averageHRV <span class="op">*</span> <span class="fl">0.7</span>  <span class="co">// 30% below average</span></span>
<span id="cb150-133"><a href="#cb150-133" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb150-134"><a href="#cb150-134" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---healthkit">Key Takeaways - HealthKit</h2>
<ol type="1">
<li><strong>Always check availability</strong> -
<code>HKHealthStore.isHealthDataAvailable()</code></li>
<li><strong>Request only what you need</strong> - Users see every type
you request</li>
<li><strong>Use anchored queries for streaming</strong> - Efficient,
only gets new samples</li>
<li><strong>HRV indicates stress</strong> - Low HRV = stressed, High HRV
= relaxed</li>
<li><strong>Build baselines from history</strong> - Personalized
thresholds are more accurate</li>
<li><strong>Handle authorization denial gracefully</strong> - App should
work without health data</li>
</ol>
<hr />
<h1 id="watchos-development">9. WATCHOS DEVELOPMENT</h1>
<h2 id="why-this-matters-for-ai-dj-8">Why This Matters for AI DJ</h2>
<p>Apple Watch is where the biometric magic happens. The Watch has the
sensors (heart rate, accelerometer) and sits on the userâ€™s wrist all
day. For AI DJ, the Watch app collects real-time biometrics and sends
them to iPhone. It can also display Now Playing info and quick controls.
Understanding watchOS development means building a seamless experience
where the Watch is the sensor and the iPhone is the brain.</p>
<p><strong>In AI DJ, the Watch app will:</strong> - Continuously read
heart rate and HRV - Send biometric data to iPhone via WatchConnectivity
- Display current song and biometric status - Provide quick controls
(skip, pause)</p>
<hr />
<h2 id="watchos-project-setup">9.1 watchOS Project Setup</h2>
<h3 id="creating-a-watch-app">Creating a Watch App</h3>
<p><strong>What weâ€™re doing:</strong> Adding a watchOS target to the
existing iOS project.</p>
<pre><code>In Xcode:
1. File â†’ New â†’ Target
2. Choose &quot;watchOS&quot; â†’ &quot;App&quot;
3. Name it &quot;AIDJ Watch App&quot;
4. Ensure &quot;Watch App for Existing iOS App&quot; is selected
5. Click Finish

This creates:
AIDJ Watch App/
â”œâ”€â”€ AIDJWatchApp.swift     (App entry point)
â”œâ”€â”€ ContentView.swift       (Main view)
â”œâ”€â”€ Assets.xcassets        (Watch-specific assets)
â””â”€â”€ Info.plist</code></pre>
<p><strong>What happens:</strong> Xcode creates a watchOS target thatâ€™s
paired with your iOS app. The Watch app and iOS app share a bundle
identifier prefix.</p>
<hr />
<h3 id="watchos-swiftui-differences">watchOS SwiftUI Differences</h3>
<p><strong>What weâ€™re doing:</strong> Understanding how SwiftUI differs
on Watch.</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">SwiftUI</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> WatchNowPlayingView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@StateObject</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">viewModel</span> <span class="op">=</span> WatchViewModel<span class="op">()</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// NavigationStack instead of NavigationView</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>        NavigationStack <span class="op">{</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>            ScrollView <span class="op">{</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>                VStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">12</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Smaller, more compact layouts</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>                    HeartRateGauge<span class="op">(</span>rate<span class="op">:</span> viewModel<span class="op">.</span>heartRate<span class="op">)</span></span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>frame<span class="op">(</span>height<span class="op">:</span> <span class="dv">80</span><span class="op">)</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a>                    Text<span class="op">(</span>viewModel<span class="op">.</span>currentSong<span class="op">?.</span>title <span class="op">??</span> <span class="st">&quot;Not Playing&quot;</span><span class="op">)</span></span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>headline<span class="op">)</span></span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>lineLimit<span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Digital Crown for volume</span></span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>                    Slider<span class="op">(</span>value<span class="op">:</span> $viewModel<span class="op">.</span>volume<span class="op">)</span></span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>focusable<span class="op">()</span>  <span class="co">// Enables Digital Crown</span></span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Compact controls</span></span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>                    HStack <span class="op">{</span></span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>                        Button<span class="op">(</span>action<span class="op">:</span> viewModel<span class="op">.</span>previousTrack<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>                            Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;backward.fill&quot;</span><span class="op">)</span></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>                        Button<span class="op">(</span>action<span class="op">:</span> viewModel<span class="op">.</span>togglePlayback<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a>                            Image<span class="op">(</span>systemName<span class="op">:</span> viewModel<span class="op">.</span>isPlaying <span class="op">?</span> <span class="st">&quot;pause.fill&quot;</span> <span class="op">:</span> <span class="st">&quot;play.fill&quot;</span><span class="op">)</span></span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>                                <span class="op">.</span>font<span class="op">(.</span>title2<span class="op">)</span></span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>buttonStyle<span class="op">(.</span>borderedProminent<span class="op">)</span></span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a>                        Button<span class="op">(</span>action<span class="op">:</span> viewModel<span class="op">.</span>nextTrack<span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a>                            Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;forward.fill&quot;</span><span class="op">)</span></span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb152-40"><a href="#cb152-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>padding<span class="op">()</span></span>
<span id="cb152-41"><a href="#cb152-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb152-42"><a href="#cb152-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>navigationTitle<span class="op">(</span><span class="st">&quot;AI DJ&quot;</span><span class="op">)</span></span>
<span id="cb152-43"><a href="#cb152-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>navigationBarTitleDisplayMode<span class="op">(.</span>inline<span class="op">)</span></span>
<span id="cb152-44"><a href="#cb152-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb152-45"><a href="#cb152-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb152-46"><a href="#cb152-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb152-47"><a href="#cb152-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-48"><a href="#cb152-48" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom gauge for heart rate</span></span>
<span id="cb152-49"><a href="#cb152-49" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> HeartRateGauge<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb152-50"><a href="#cb152-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">rate</span><span class="op">:</span> Double</span>
<span id="cb152-51"><a href="#cb152-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-52"><a href="#cb152-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb152-53"><a href="#cb152-53" aria-hidden="true" tabindex="-1"></a>        Gauge<span class="op">(</span>value<span class="op">:</span> rate<span class="op">,</span> <span class="cf">in</span><span class="op">:</span> <span class="fl">40.</span><span class="op">.</span><span class="fl">.180</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb152-54"><a href="#cb152-54" aria-hidden="true" tabindex="-1"></a>            Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb152-55"><a href="#cb152-55" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>foregroundStyle<span class="op">(.</span>red<span class="op">)</span></span>
<span id="cb152-56"><a href="#cb152-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> currentValueLabel<span class="op">:</span> <span class="op">{</span></span>
<span id="cb152-57"><a href="#cb152-57" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(rate))&quot;</span><span class="op">)</span></span>
<span id="cb152-58"><a href="#cb152-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>system<span class="op">(.</span>title<span class="op">,</span> design<span class="op">:</span> <span class="op">.</span>rounded<span class="op">))</span></span>
<span id="cb152-59"><a href="#cb152-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb152-60"><a href="#cb152-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>gaugeStyle<span class="op">(.</span>accessoryCircular<span class="op">)</span></span>
<span id="cb152-61"><a href="#cb152-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>tint<span class="op">(</span>rate <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">?</span> <span class="op">.</span>red <span class="op">:</span> <span class="op">.</span>green<span class="op">)</span></span>
<span id="cb152-62"><a href="#cb152-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb152-63"><a href="#cb152-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Watch-specific considerations:</strong> - Smaller screen
(40-49mm diagonal) - Limited memory (~32MB for apps) - Digital Crown for
scrolling and input - No keyboardâ€”use voice or gestures - Brief
interactionsâ€”users glance, not stare</p>
<hr />
<h2 id="healthkit-on-watchos">9.2 HealthKit on watchOS</h2>
<h3 id="direct-sensor-access">Direct Sensor Access</h3>
<p><strong>What weâ€™re doing:</strong> Reading heart rate directly on
Watch (faster than iPhone).</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">HealthKit</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WatchHealthManager<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">healthStore</span> <span class="op">=</span> HKHealthStore<span class="op">()</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">heartRateQuery</span><span class="op">:</span> HKAnchoredObjectQuery<span class="op">?</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentHeartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentHRV</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">startHeartRateMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKAnchoredObjectQuery<span class="op">(</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>            type<span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>            predicate<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>            anchor<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>            limit<span class="op">:</span> HKObjectQueryNoLimit</span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> _<span class="op">,</span> samples<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _ <span class="cf">in</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>processHeartRateSamples<span class="op">(</span>samples<span class="op">)</span></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a>        query<span class="op">.</span>updateHandler <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> _<span class="op">,</span> samples<span class="op">,</span> _<span class="op">,</span> _<span class="op">,</span> _ <span class="cf">in</span></span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>processHeartRateSamples<span class="op">(</span>samples<span class="op">)</span></span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a>        heartRateQuery <span class="op">=</span> query</span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>        healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">processHeartRateSamples</span><span class="op">(</span><span class="va">_</span> <span class="va">samples</span><span class="op">:</span> [<span class="dt">HKSample</span>]?<span class="op">)</span> <span class="op">{</span></span>
<span id="cb153-31"><a href="#cb153-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">samples</span> <span class="op">=</span> samples <span class="kw">as</span><span class="op">?</span> <span class="op">[</span>HKQuantitySample<span class="op">],</span></span>
<span id="cb153-32"><a href="#cb153-32" aria-hidden="true" tabindex="-1"></a>              <span class="kw">let</span> <span class="va">latest</span> <span class="op">=</span> samples<span class="op">.</span>last <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb153-33"><a href="#cb153-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-34"><a href="#cb153-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">rate</span> <span class="op">=</span> latest<span class="op">.</span>quantity<span class="op">.</span>doubleValue<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>beatsPerMinute<span class="op">())</span></span>
<span id="cb153-35"><a href="#cb153-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-36"><a href="#cb153-36" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb153-37"><a href="#cb153-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>currentHeartRate <span class="op">=</span> rate</span>
<span id="cb153-38"><a href="#cb153-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb153-39"><a href="#cb153-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb153-40"><a href="#cb153-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-41"><a href="#cb153-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">stopMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb153-42"><a href="#cb153-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> heartRateQuery <span class="op">{</span></span>
<span id="cb153-43"><a href="#cb153-43" aria-hidden="true" tabindex="-1"></a>            healthStore<span class="op">.</span>stop<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb153-44"><a href="#cb153-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb153-45"><a href="#cb153-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb153-46"><a href="#cb153-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="workout-sessions">Workout Sessions</h3>
<p><strong>What weâ€™re doing:</strong> Starting a workout session to get
continuous heart rate.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">HealthKit</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">WorkoutKit</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WorkoutManager<span class="op">:</span> <span class="dt">NSObject</span><span class="op">,</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">healthStore</span> <span class="op">=</span> HKHealthStore<span class="op">()</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">session</span><span class="op">:</span> HKWorkoutSession<span class="op">?</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">builder</span><span class="op">:</span> HKLiveWorkoutBuilder<span class="op">?</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">heartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isActive</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">startWorkout</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">configuration</span> <span class="op">=</span> HKWorkoutConfiguration<span class="op">()</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>        configuration<span class="op">.</span>activityType <span class="op">=</span> <span class="op">.</span>other  <span class="co">// AI DJ listening session</span></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>        configuration<span class="op">.</span>locationType <span class="op">=</span> <span class="op">.</span>indoor</span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>        session <span class="op">=</span> <span class="cf">try</span> HKWorkoutSession<span class="op">(</span></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>            healthStore<span class="op">:</span> healthStore<span class="op">,</span></span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a>            configuration<span class="op">:</span> configuration</span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>        builder <span class="op">=</span> session<span class="op">?.</span>associatedWorkoutBuilder<span class="op">()</span></span>
<span id="cb154-22"><a href="#cb154-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-23"><a href="#cb154-23" aria-hidden="true" tabindex="-1"></a>        session<span class="op">?.</span>delegate <span class="op">=</span> <span class="kw">self</span></span>
<span id="cb154-24"><a href="#cb154-24" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">?.</span>delegate <span class="op">=</span> <span class="kw">self</span></span>
<span id="cb154-25"><a href="#cb154-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-26"><a href="#cb154-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Start collecting data</span></span>
<span id="cb154-27"><a href="#cb154-27" aria-hidden="true" tabindex="-1"></a>        builder<span class="op">?.</span>dataSource <span class="op">=</span> HKLiveWorkoutDataSource<span class="op">(</span></span>
<span id="cb154-28"><a href="#cb154-28" aria-hidden="true" tabindex="-1"></a>            healthStore<span class="op">:</span> healthStore<span class="op">,</span></span>
<span id="cb154-29"><a href="#cb154-29" aria-hidden="true" tabindex="-1"></a>            workoutConfiguration<span class="op">:</span> configuration</span>
<span id="cb154-30"><a href="#cb154-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb154-31"><a href="#cb154-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-32"><a href="#cb154-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">startDate</span> <span class="op">=</span> Date<span class="op">()</span></span>
<span id="cb154-33"><a href="#cb154-33" aria-hidden="true" tabindex="-1"></a>        session<span class="op">?.</span>startActivity<span class="op">(</span>with<span class="op">:</span> startDate<span class="op">)</span></span>
<span id="cb154-34"><a href="#cb154-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> builder<span class="op">?.</span>beginCollection<span class="op">(</span>at<span class="op">:</span> startDate<span class="op">)</span></span>
<span id="cb154-35"><a href="#cb154-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-36"><a href="#cb154-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb154-37"><a href="#cb154-37" aria-hidden="true" tabindex="-1"></a>            isActive <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb154-38"><a href="#cb154-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb154-39"><a href="#cb154-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-40"><a href="#cb154-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-41"><a href="#cb154-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">endWorkout</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb154-42"><a href="#cb154-42" aria-hidden="true" tabindex="-1"></a>        session<span class="op">?.</span>end<span class="op">()</span></span>
<span id="cb154-43"><a href="#cb154-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-44"><a href="#cb154-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb154-45"><a href="#cb154-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="cf">await</span> builder<span class="op">?.</span>endCollection<span class="op">(</span>at<span class="op">:</span> Date<span class="op">())</span></span>
<span id="cb154-46"><a href="#cb154-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="cf">await</span> builder<span class="op">?.</span>finishWorkout<span class="op">()</span></span>
<span id="cb154-47"><a href="#cb154-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb154-48"><a href="#cb154-48" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Failed to end workout: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb154-49"><a href="#cb154-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb154-50"><a href="#cb154-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-51"><a href="#cb154-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb154-52"><a href="#cb154-52" aria-hidden="true" tabindex="-1"></a>            isActive <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb154-53"><a href="#cb154-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb154-54"><a href="#cb154-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-55"><a href="#cb154-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb154-56"><a href="#cb154-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-57"><a href="#cb154-57" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WorkoutManager<span class="op">:</span> <span class="dt">HKWorkoutSessionDelegate</span> <span class="op">{</span></span>
<span id="cb154-58"><a href="#cb154-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">workoutSession</span><span class="op">(</span><span class="va">_</span> <span class="va">workoutSession</span><span class="op">:</span> <span class="dt">HKWorkoutSession</span><span class="op">,</span></span>
<span id="cb154-59"><a href="#cb154-59" aria-hidden="true" tabindex="-1"></a>                       <span class="va">didChangeTo</span> <span class="va">toState</span><span class="op">:</span> <span class="dt">HKWorkoutSessionState</span><span class="op">,</span></span>
<span id="cb154-60"><a href="#cb154-60" aria-hidden="true" tabindex="-1"></a>                       <span class="va">from</span> <span class="va">fromState</span><span class="op">:</span> <span class="dt">HKWorkoutSessionState</span><span class="op">,</span></span>
<span id="cb154-61"><a href="#cb154-61" aria-hidden="true" tabindex="-1"></a>                       <span class="va">date</span><span class="op">:</span> <span class="dt">Date</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-62"><a href="#cb154-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Handle state changes</span></span>
<span id="cb154-63"><a href="#cb154-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-64"><a href="#cb154-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-65"><a href="#cb154-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">workoutSession</span><span class="op">(</span><span class="va">_</span> <span class="va">workoutSession</span><span class="op">:</span> <span class="dt">HKWorkoutSession</span><span class="op">,</span></span>
<span id="cb154-66"><a href="#cb154-66" aria-hidden="true" tabindex="-1"></a>                       <span class="va">didFailWithError</span> <span class="va">error</span><span class="op">:</span> <span class="dt">Error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-67"><a href="#cb154-67" aria-hidden="true" tabindex="-1"></a>        print<span class="op">(</span><span class="st">&quot;Workout session failed: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb154-68"><a href="#cb154-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-69"><a href="#cb154-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb154-70"><a href="#cb154-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-71"><a href="#cb154-71" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WorkoutManager<span class="op">:</span> <span class="dt">HKLiveWorkoutBuilderDelegate</span> <span class="op">{</span></span>
<span id="cb154-72"><a href="#cb154-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">workoutBuilder</span><span class="op">(</span><span class="va">_</span> <span class="va">workoutBuilder</span><span class="op">:</span> <span class="dt">HKLiveWorkoutBuilder</span><span class="op">,</span></span>
<span id="cb154-73"><a href="#cb154-73" aria-hidden="true" tabindex="-1"></a>                       <span class="va">didCollectDataOf</span> <span class="va">collectedTypes</span><span class="op">:</span> <span class="dt">Set</span>&lt;<span class="va">HKSampleType</span>&gt;<span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-74"><a href="#cb154-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> type <span class="cf">in</span> collectedTypes <span class="op">{</span></span>
<span id="cb154-75"><a href="#cb154-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">quantityType</span> <span class="op">=</span> type <span class="kw">as</span><span class="op">?</span> HKQuantityType<span class="op">,</span></span>
<span id="cb154-76"><a href="#cb154-76" aria-hidden="true" tabindex="-1"></a>                  quantityType <span class="op">==</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span> <span class="cf">else</span> <span class="op">{</span> <span class="cf">continue</span> <span class="op">}</span></span>
<span id="cb154-77"><a href="#cb154-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-78"><a href="#cb154-78" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">statistics</span> <span class="op">=</span> workoutBuilder<span class="op">.</span>statistics<span class="op">(</span><span class="cf">for</span><span class="op">:</span> quantityType<span class="op">)</span></span>
<span id="cb154-79"><a href="#cb154-79" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">rate</span> <span class="op">=</span> statistics<span class="op">?.</span>mostRecentQuantity<span class="op">()?.</span>doubleValue<span class="op">(</span><span class="cf">for</span><span class="op">:</span> <span class="op">.</span>beatsPerMinute<span class="op">())</span> <span class="op">??</span> <span class="dv">0</span></span>
<span id="cb154-80"><a href="#cb154-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-81"><a href="#cb154-81" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb154-82"><a href="#cb154-82" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>heartRate <span class="op">=</span> rate</span>
<span id="cb154-83"><a href="#cb154-83" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb154-84"><a href="#cb154-84" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb154-85"><a href="#cb154-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-86"><a href="#cb154-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-87"><a href="#cb154-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">workoutBuilderDidCollectEvent</span><span class="op">(</span><span class="va">_</span> <span class="va">workoutBuilder</span><span class="op">:</span> <span class="dt">HKLiveWorkoutBuilder</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb154-88"><a href="#cb154-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Handle workout events</span></span>
<span id="cb154-89"><a href="#cb154-89" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb154-90"><a href="#cb154-90" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Why workout sessions?</strong> During a workout session,
Apple Watch samples heart rate more frequently (every few seconds vs
every 5 minutes). For AI DJ, this gives much more responsive data.</p>
<hr />
<h2 id="watch-app-architecture">9.3 Watch App Architecture</h2>
<h3 id="watch-view-model">Watch View Model</h3>
<div class="sourceCode" id="cb155"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WatchViewModel<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> SongInfo<span class="op">?</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">heartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">hrv</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">volume</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">healthManager</span> <span class="op">=</span> WatchHealthManager<span class="op">()</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">connectivityManager</span> <span class="op">=</span> WatchConnectivityManager<span class="op">.</span>shared</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a>        setupHealthMonitoring<span class="op">()</span></span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>        setupConnectivity<span class="op">()</span></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">setupHealthMonitoring</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Forward health updates</span></span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a>        healthManager<span class="op">.</span>$currentHeartRate</span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>assign<span class="op">(</span>to<span class="op">:</span> <span class="op">&amp;</span>$heartRate<span class="op">)</span></span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a>        healthManager<span class="op">.</span>startHeartRateMonitoring<span class="op">()</span></span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">setupConnectivity</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Receive song updates from iPhone</span></span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>        connectivityManager<span class="op">.</span>onSongUpdate <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> song <span class="cf">in</span></span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">?.</span>currentSong <span class="op">=</span> song</span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb155-31"><a href="#cb155-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-32"><a href="#cb155-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Send health data to iPhone</span></span>
<span id="cb155-33"><a href="#cb155-33" aria-hidden="true" tabindex="-1"></a>        Timer<span class="op">.</span>publish<span class="op">(</span>every<span class="op">:</span> <span class="dv">5</span><span class="op">,</span> on<span class="op">:</span> <span class="op">.</span>main<span class="op">,</span> <span class="cf">in</span><span class="op">:</span> <span class="op">.</span>common<span class="op">)</span></span>
<span id="cb155-34"><a href="#cb155-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>autoconnect<span class="op">()</span></span>
<span id="cb155-35"><a href="#cb155-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>sink <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> _ <span class="cf">in</span></span>
<span id="cb155-36"><a href="#cb155-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">guard</span> <span class="kw">let</span> <span class="va">self</span> <span class="op">=</span> <span class="kw">self</span> <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb155-37"><a href="#cb155-37" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>sendBiometricsToPhone<span class="op">()</span></span>
<span id="cb155-38"><a href="#cb155-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb155-39"><a href="#cb155-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>store<span class="op">(</span><span class="cf">in</span><span class="op">:</span> <span class="op">&amp;</span>cancellables<span class="op">)</span></span>
<span id="cb155-40"><a href="#cb155-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-41"><a href="#cb155-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-42"><a href="#cb155-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">sendBiometricsToPhone</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb155-43"><a href="#cb155-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">data</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb155-44"><a href="#cb155-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;heartRate&quot;</span><span class="op">:</span> heartRate<span class="op">,</span></span>
<span id="cb155-45"><a href="#cb155-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;hrv&quot;</span><span class="op">:</span> hrv<span class="op">,</span></span>
<span id="cb155-46"><a href="#cb155-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;timestamp&quot;</span><span class="op">:</span> Date<span class="op">().</span>timeIntervalSince1970</span>
<span id="cb155-47"><a href="#cb155-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb155-48"><a href="#cb155-48" aria-hidden="true" tabindex="-1"></a>        connectivityManager<span class="op">.</span>send<span class="op">(</span>data<span class="op">)</span></span>
<span id="cb155-49"><a href="#cb155-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-50"><a href="#cb155-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-51"><a href="#cb155-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">togglePlayback</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb155-52"><a href="#cb155-52" aria-hidden="true" tabindex="-1"></a>        connectivityManager<span class="op">.</span>sendAction<span class="op">(.</span>togglePlayback<span class="op">)</span></span>
<span id="cb155-53"><a href="#cb155-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-54"><a href="#cb155-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-55"><a href="#cb155-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">nextTrack</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb155-56"><a href="#cb155-56" aria-hidden="true" tabindex="-1"></a>        connectivityManager<span class="op">.</span>sendAction<span class="op">(.</span>nextTrack<span class="op">)</span></span>
<span id="cb155-57"><a href="#cb155-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-58"><a href="#cb155-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-59"><a href="#cb155-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">previousTrack</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb155-60"><a href="#cb155-60" aria-hidden="true" tabindex="-1"></a>        connectivityManager<span class="op">.</span>sendAction<span class="op">(.</span>previousTrack<span class="op">)</span></span>
<span id="cb155-61"><a href="#cb155-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-62"><a href="#cb155-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-63"><a href="#cb155-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">cancellables</span> <span class="op">=</span> Set<span class="op">&lt;</span>AnyCancellable<span class="op">&gt;()</span></span>
<span id="cb155-64"><a href="#cb155-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---watchos">Key Takeaways - watchOS</h2>
<ol type="1">
<li><strong>Watch is the sensor</strong> - Best place for real-time
biometrics</li>
<li><strong>Design for glances</strong> - Small screen, brief
interactions</li>
<li><strong>Workout sessions = frequent HR</strong> - Essential for
responsive data</li>
<li><strong>Send data to iPhone</strong> - Watch collects, iPhone
processes</li>
<li><strong>Conserve battery</strong> - Minimize wake time, batch
updates</li>
<li><strong>Use Digital Crown</strong> - Natural input for volume,
scrolling</li>
</ol>
<hr />
<h1 id="watchconnectivity-framework">10. WATCHCONNECTIVITY
FRAMEWORK</h1>
<h2 id="why-this-matters-for-ai-dj-9">Why This Matters for AI DJ</h2>
<p>WatchConnectivity is the bridge between Apple Watch and iPhone. The
Watch collects biometrics, the iPhone runs the Brain and controls music.
WatchConnectivity transfers this data in real-time, handles background
delivery, and keeps the two devices in sync even when one is asleep.</p>
<p><strong>In AI DJ, WatchConnectivity handles:</strong> - Sending heart
rate from Watch to iPhone - Sending Now Playing info from iPhone to
Watch - Syncing user preferences across devices - Handling playback
control commands from Watch</p>
<hr />
<h2 id="setup-and-activation">10.1 Setup and Activation</h2>
<h3 id="session-configuration">Session Configuration</h3>
<p><strong>What weâ€™re doing:</strong> Setting up the communication
channel between devices.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">WatchConnectivity</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WatchConnectivityManager<span class="op">:</span> <span class="dt">NSObject</span><span class="op">,</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">let</span> <span class="va">shared</span> <span class="op">=</span> WatchConnectivityManager<span class="op">()</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">session</span> <span class="op">=</span> WCSession<span class="op">.</span><span class="kw">default</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isReachable</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isPaired</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">.</span><span class="kw">init</span><span class="op">()</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> WCSession<span class="op">.</span>isSupported<span class="op">()</span> <span class="op">{</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>            session<span class="op">.</span>delegate <span class="op">=</span> <span class="kw">self</span></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>            session<span class="op">.</span>activate<span class="op">()</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">isSessionActive</span><span class="op">:</span> Bool <span class="op">{</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span>activationState <span class="op">==</span> <span class="op">.</span>activated</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WatchConnectivityManager<span class="op">:</span> <span class="dt">WCSessionDelegate</span> <span class="op">{</span></span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">session</span><span class="op">(</span><span class="va">_</span> <span class="va">session</span><span class="op">:</span> <span class="dt">WCSession</span><span class="op">,</span></span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>                <span class="va">activationDidCompleteWith</span> <span class="va">activationState</span><span class="op">:</span> <span class="dt">WCSessionActivationState</span><span class="op">,</span></span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>                <span class="va">error</span><span class="op">:</span> <span class="dt">Error</span><span class="op">?)</span> <span class="op">{</span></span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>isPaired <span class="op">=</span> session<span class="op">.</span>isPaired</span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>isReachable <span class="op">=</span> session<span class="op">.</span>isReachable</span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// iOS only - required delegate methods</span></span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>    #if os<span class="op">(</span>iOS<span class="op">)</span></span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sessionDidBecomeInactive</span><span class="op">(</span><span class="va">_</span> <span class="va">session</span><span class="op">:</span> <span class="dt">WCSession</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Handle session becoming inactive</span></span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-41"><a href="#cb156-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sessionDidDeactivate</span><span class="op">(</span><span class="va">_</span> <span class="va">session</span><span class="op">:</span> <span class="dt">WCSession</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-42"><a href="#cb156-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Reactivate session</span></span>
<span id="cb156-43"><a href="#cb156-43" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span>activate<span class="op">()</span></span>
<span id="cb156-44"><a href="#cb156-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-45"><a href="#cb156-45" aria-hidden="true" tabindex="-1"></a>    #endif</span>
<span id="cb156-46"><a href="#cb156-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-47"><a href="#cb156-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sessionReachabilityDidChange</span><span class="op">(</span><span class="va">_</span> <span class="va">session</span><span class="op">:</span> <span class="dt">WCSession</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb156-48"><a href="#cb156-48" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb156-49"><a href="#cb156-49" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>isReachable <span class="op">=</span> session<span class="op">.</span>isReachable</span>
<span id="cb156-50"><a href="#cb156-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb156-51"><a href="#cb156-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb156-52"><a href="#cb156-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="data-transfer-methods">10.2 Data Transfer Methods</h2>
<h3 id="application-context-latest-state">Application Context (Latest
State)</h3>
<p><strong>What weâ€™re doing:</strong> Sending the current state that
overwrites previous values.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WatchConnectivityManager <span class="op">{</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Send current state (overwrites previous)</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">updateContext</span><span class="op">(</span><span class="va">_</span> <span class="va">data</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">Any</span>]<span class="op">)</span> <span class="op">{</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> session<span class="op">.</span>activationState <span class="op">==</span> <span class="op">.</span>activated <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> session<span class="op">.</span>updateApplicationContext<span class="op">(</span>data<span class="op">)</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Failed to update context: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// iPhone sends song info to Watch</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sendNowPlaying</span><span class="op">(</span><span class="va">song</span><span class="op">:</span> <span class="dt">SongInfo</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">context</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;songTitle&quot;</span><span class="op">:</span> song<span class="op">.</span>title<span class="op">,</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;artist&quot;</span><span class="op">:</span> song<span class="op">.</span>artist<span class="op">,</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;artworkData&quot;</span><span class="op">:</span> song<span class="op">.</span>artworkData <span class="op">??</span> Data<span class="op">(),</span></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;isPlaying&quot;</span><span class="op">:</span> song<span class="op">.</span>isPlaying</span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>        updateContext<span class="op">(</span>context<span class="op">)</span></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Receiving on Watch</span></span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WatchConnectivityManager <span class="op">{</span></span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">session</span><span class="op">(</span><span class="va">_</span> <span class="va">session</span><span class="op">:</span> <span class="dt">WCSession</span><span class="op">,</span></span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a>                <span class="va">didReceiveApplicationContext</span> <span class="va">applicationContext</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">Any</span>]<span class="op">)</span> <span class="op">{</span></span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="va">title</span> <span class="op">=</span> applicationContext<span class="op">[</span><span class="st">&quot;songTitle&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String<span class="op">,</span></span>
<span id="cb157-31"><a href="#cb157-31" aria-hidden="true" tabindex="-1"></a>               <span class="kw">let</span> <span class="va">artist</span> <span class="op">=</span> applicationContext<span class="op">[</span><span class="st">&quot;artist&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="op">{</span></span>
<span id="cb157-32"><a href="#cb157-32" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> SongInfo<span class="op">(</span>title<span class="op">:</span> title<span class="op">,</span> artist<span class="op">:</span> artist<span class="op">)</span></span>
<span id="cb157-33"><a href="#cb157-33" aria-hidden="true" tabindex="-1"></a>                onSongUpdate<span class="op">?(</span>song<span class="op">)</span></span>
<span id="cb157-34"><a href="#cb157-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb157-35"><a href="#cb157-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb157-36"><a href="#cb157-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb157-37"><a href="#cb157-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-38"><a href="#cb157-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onSongUpdate</span><span class="op">:</span> <span class="op">((</span>SongInfo<span class="op">)</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb157-39"><a href="#cb157-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>When to use:</strong> Current state that should always be
latest (Now Playing info, user preferences).</p>
<hr />
<h3 id="message-sending-real-time">Message Sending (Real-time)</h3>
<p><strong>What weâ€™re doing:</strong> Sending immediate messages when
both devices are reachable.</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WatchConnectivityManager <span class="op">{</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Real-time message (requires reachability)</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sendMessage</span><span class="op">(</span><span class="va">_</span> <span class="va">message</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">Any</span>]<span class="op">,</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>                    <span class="va">replyHandler</span><span class="op">:</span> <span class="op">(</span>([<span class="dt">String</span>: <span class="dt">Any</span>]<span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">Void</span><span class="op">)</span>? <span class="op">=</span> <span class="kw">nil</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> session<span class="op">.</span>isReachable <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Watch not reachable&quot;</span><span class="op">)</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span>sendMessage<span class="op">(</span>message<span class="op">,</span> replyHandler<span class="op">:</span> replyHandler<span class="op">)</span> <span class="op">{</span> error <span class="cf">in</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Message failed: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Watch sends biometrics to iPhone</span></span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sendBiometrics</span><span class="op">(</span><span class="va">heartRate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="va">hrv</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">message</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;biometrics&quot;</span><span class="op">,</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;heartRate&quot;</span><span class="op">:</span> heartRate<span class="op">,</span></span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;hrv&quot;</span><span class="op">:</span> hrv<span class="op">,</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;timestamp&quot;</span><span class="op">:</span> Date<span class="op">().</span>timeIntervalSince1970</span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>        sendMessage<span class="op">(</span>message<span class="op">)</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Watch sends control command</span></span>
<span id="cb158-27"><a href="#cb158-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sendAction</span><span class="op">(</span><span class="va">_</span> <span class="va">action</span><span class="op">:</span> <span class="dt">PlaybackAction</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-28"><a href="#cb158-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">message</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb158-29"><a href="#cb158-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;action&quot;</span><span class="op">,</span></span>
<span id="cb158-30"><a href="#cb158-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;action&quot;</span><span class="op">:</span> action<span class="op">.</span>rawValue</span>
<span id="cb158-31"><a href="#cb158-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb158-32"><a href="#cb158-32" aria-hidden="true" tabindex="-1"></a>        sendMessage<span class="op">(</span>message<span class="op">)</span></span>
<span id="cb158-33"><a href="#cb158-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-34"><a href="#cb158-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb158-35"><a href="#cb158-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-36"><a href="#cb158-36" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> PlaybackAction<span class="op">:</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb158-37"><a href="#cb158-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> togglePlayback</span>
<span id="cb158-38"><a href="#cb158-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> nextTrack</span>
<span id="cb158-39"><a href="#cb158-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> previousTrack</span>
<span id="cb158-40"><a href="#cb158-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> like</span>
<span id="cb158-41"><a href="#cb158-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> skip</span>
<span id="cb158-42"><a href="#cb158-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb158-43"><a href="#cb158-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-44"><a href="#cb158-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Receiving on iPhone</span></span>
<span id="cb158-45"><a href="#cb158-45" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WatchConnectivityManager <span class="op">{</span></span>
<span id="cb158-46"><a href="#cb158-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">session</span><span class="op">(</span><span class="va">_</span> <span class="va">session</span><span class="op">:</span> <span class="dt">WCSession</span><span class="op">,</span></span>
<span id="cb158-47"><a href="#cb158-47" aria-hidden="true" tabindex="-1"></a>                <span class="va">didReceiveMessage</span> <span class="va">message</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">Any</span>]<span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-48"><a href="#cb158-48" aria-hidden="true" tabindex="-1"></a>        Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb158-49"><a href="#cb158-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">type</span> <span class="op">=</span> message<span class="op">[</span><span class="st">&quot;type&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb158-50"><a href="#cb158-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-51"><a href="#cb158-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">switch</span> type <span class="op">{</span></span>
<span id="cb158-52"><a href="#cb158-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;biometrics&quot;</span><span class="op">:</span></span>
<span id="cb158-53"><a href="#cb158-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="va">hr</span> <span class="op">=</span> message<span class="op">[</span><span class="st">&quot;heartRate&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> Double<span class="op">,</span></span>
<span id="cb158-54"><a href="#cb158-54" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">let</span> <span class="va">hrv</span> <span class="op">=</span> message<span class="op">[</span><span class="st">&quot;hrv&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> Double <span class="op">{</span></span>
<span id="cb158-55"><a href="#cb158-55" aria-hidden="true" tabindex="-1"></a>                    onBiometricsReceived<span class="op">?(</span>hr<span class="op">,</span> hrv<span class="op">)</span></span>
<span id="cb158-56"><a href="#cb158-56" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb158-57"><a href="#cb158-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">&quot;action&quot;</span><span class="op">:</span></span>
<span id="cb158-58"><a href="#cb158-58" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="va">actionRaw</span> <span class="op">=</span> message<span class="op">[</span><span class="st">&quot;action&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String<span class="op">,</span></span>
<span id="cb158-59"><a href="#cb158-59" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">let</span> <span class="va">action</span> <span class="op">=</span> PlaybackAction<span class="op">(</span>rawValue<span class="op">:</span> actionRaw<span class="op">)</span> <span class="op">{</span></span>
<span id="cb158-60"><a href="#cb158-60" aria-hidden="true" tabindex="-1"></a>                    onActionReceived<span class="op">?(</span>action<span class="op">)</span></span>
<span id="cb158-61"><a href="#cb158-61" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb158-62"><a href="#cb158-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">default</span><span class="op">:</span></span>
<span id="cb158-63"><a href="#cb158-63" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb158-64"><a href="#cb158-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb158-65"><a href="#cb158-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb158-66"><a href="#cb158-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-67"><a href="#cb158-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-68"><a href="#cb158-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onBiometricsReceived</span><span class="op">:</span> <span class="op">((</span>Double<span class="op">,</span> Double<span class="op">)</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb158-69"><a href="#cb158-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onActionReceived</span><span class="op">:</span> <span class="op">((</span>PlaybackAction<span class="op">)</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb158-70"><a href="#cb158-70" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>When to use:</strong> Time-sensitive data (biometrics,
playback commands).</p>
<hr />
<h3 id="user-info-transfer-queued">User Info Transfer (Queued)</h3>
<p><strong>What weâ€™re doing:</strong> Queuing data for background
delivery when devices arenâ€™t connected.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WatchConnectivityManager <span class="op">{</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Queue for background delivery</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">queueBiometricBatch</span><span class="op">(</span><span class="va">_</span> <span class="va">samples</span><span class="op">:</span> [<span class="dt">BiometricSample</span>]<span class="op">)</span> <span class="op">{</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">userInfo</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;biometricBatch&quot;</span><span class="op">,</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;samples&quot;</span><span class="op">:</span> samples<span class="op">.</span>map <span class="op">{</span> $<span class="fl">0.</span>toDictionary<span class="op">()</span> <span class="op">}</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>        session<span class="op">.</span>transferUserInfo<span class="op">(</span>userInfo<span class="op">)</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> BiometricSample <span class="op">{</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRate</span><span class="op">:</span> Double</span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">hrv</span><span class="op">:</span> Double</span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">timestamp</span><span class="op">:</span> Date</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">toDictionary</span><span class="op">()</span> -&gt; [<span class="fu">String</span><span class="op">:</span> <span class="dt">Any</span>] <span class="op">{</span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;heartRate&quot;</span><span class="op">:</span> heartRate<span class="op">,</span></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;hrv&quot;</span><span class="op">:</span> hrv<span class="op">,</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;timestamp&quot;</span><span class="op">:</span> timestamp<span class="op">.</span>timeIntervalSince1970</span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Receiving queued data</span></span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> WatchConnectivityManager <span class="op">{</span></span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">session</span><span class="op">(</span><span class="va">_</span> <span class="va">session</span><span class="op">:</span> <span class="dt">WCSession</span><span class="op">,</span></span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a>                <span class="va">didReceiveUserInfo</span> <span class="va">userInfo</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">Any</span>]<span class="op">)</span> <span class="op">{</span></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">type</span> <span class="op">=</span> userInfo<span class="op">[</span><span class="st">&quot;type&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String<span class="op">,</span></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a>              type <span class="op">==</span> <span class="st">&quot;biometricBatch&quot;</span><span class="op">,</span></span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a>              <span class="kw">let</span> <span class="va">samplesData</span> <span class="op">=</span> userInfo<span class="op">[</span><span class="st">&quot;samples&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> <span class="op">[[</span>String<span class="op">:</span> Any<span class="op">]]</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span></span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">samples</span> <span class="op">=</span> samplesData<span class="op">.</span>compactMap <span class="op">{</span> dict <span class="op">-&gt;</span> BiometricSample<span class="op">?</span> <span class="cf">in</span></span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">hr</span> <span class="op">=</span> dict<span class="op">[</span><span class="st">&quot;heartRate&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> Double<span class="op">,</span></span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">let</span> <span class="va">hrv</span> <span class="op">=</span> dict<span class="op">[</span><span class="st">&quot;hrv&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> Double<span class="op">,</span></span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">let</span> <span class="va">ts</span> <span class="op">=</span> dict<span class="op">[</span><span class="st">&quot;timestamp&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> TimeInterval <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> <span class="kw">nil</span></span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> BiometricSample<span class="op">(</span>heartRate<span class="op">:</span> hr<span class="op">,</span> hrv<span class="op">:</span> hrv<span class="op">,</span> timestamp<span class="op">:</span> Date<span class="op">(</span>timeIntervalSince1970<span class="op">:</span> ts<span class="op">))</span></span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a>        onBiometricBatchReceived<span class="op">?(</span>samples<span class="op">)</span></span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">onBiometricBatchReceived</span><span class="op">:</span> <span class="op">(([</span>BiometricSample<span class="op">])</span> <span class="op">-&gt;</span> Void<span class="op">)?</span></span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>When to use:</strong> Data that must be delivered eventually
but not immediately (batch uploads, historical data).</p>
<hr />
<h2 id="complete-ai-dj-connectivity">10.3 Complete AI DJ
Connectivity</h2>
<h3 id="iphone-side">iPhone Side</h3>
<div class="sourceCode" id="cb160"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> iPhoneConnectivityService<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">connectivity</span> <span class="op">=</span> WatchConnectivityManager<span class="op">.</span>shared</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">latestHeartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">latestHRV</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isWatchConnected</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>        setupHandlers<span class="op">()</span></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">setupHandlers</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>        connectivity<span class="op">.</span>onBiometricsReceived <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> hr<span class="op">,</span> hrv <span class="cf">in</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">?.</span>latestHeartRate <span class="op">=</span> hr</span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">?.</span>latestHRV <span class="op">=</span> hrv</span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>        connectivity<span class="op">.</span>onActionReceived <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> action <span class="cf">in</span></span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>handlePlaybackAction<span class="op">(</span>action<span class="op">)</span></span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a>        connectivity<span class="op">.</span>$isReachable</span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>assign<span class="op">(</span>to<span class="op">:</span> <span class="op">&amp;</span>$isWatchConnected<span class="op">)</span></span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">handlePlaybackAction</span><span class="op">(</span><span class="va">_</span> <span class="va">action</span><span class="op">:</span> <span class="dt">PlaybackAction</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> action <span class="op">{</span></span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>togglePlayback<span class="op">:</span></span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a>            MusicPlayerController<span class="op">.</span>shared<span class="op">.</span>togglePlayback<span class="op">()</span></span>
<span id="cb160-32"><a href="#cb160-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>nextTrack<span class="op">:</span></span>
<span id="cb160-33"><a href="#cb160-33" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="cf">try</span><span class="op">?</span> <span class="cf">await</span> MusicPlayerController<span class="op">.</span>shared<span class="op">.</span>skipToNext<span class="op">()</span> <span class="op">}</span></span>
<span id="cb160-34"><a href="#cb160-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>previousTrack<span class="op">:</span></span>
<span id="cb160-35"><a href="#cb160-35" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="cf">try</span><span class="op">?</span> <span class="cf">await</span> MusicPlayerController<span class="op">.</span>shared<span class="op">.</span>skipToPrevious<span class="op">()</span> <span class="op">}</span></span>
<span id="cb160-36"><a href="#cb160-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>like<span class="op">:</span></span>
<span id="cb160-37"><a href="#cb160-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Record positive feedback</span></span>
<span id="cb160-38"><a href="#cb160-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb160-39"><a href="#cb160-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>skip<span class="op">:</span></span>
<span id="cb160-40"><a href="#cb160-40" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Record skip and advance</span></span>
<span id="cb160-41"><a href="#cb160-41" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="cf">try</span><span class="op">?</span> <span class="cf">await</span> MusicPlayerController<span class="op">.</span>shared<span class="op">.</span>skipToNext<span class="op">()</span> <span class="op">}</span></span>
<span id="cb160-42"><a href="#cb160-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb160-43"><a href="#cb160-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-44"><a href="#cb160-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-45"><a href="#cb160-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sendNowPlayingToWatch</span><span class="op">(</span><span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">,</span> <span class="va">isPlaying</span><span class="op">:</span> <span class="dt">Bool</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb160-46"><a href="#cb160-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">info</span> <span class="op">=</span> SongInfo<span class="op">(</span></span>
<span id="cb160-47"><a href="#cb160-47" aria-hidden="true" tabindex="-1"></a>            title<span class="op">:</span> song<span class="op">.</span>title<span class="op">,</span></span>
<span id="cb160-48"><a href="#cb160-48" aria-hidden="true" tabindex="-1"></a>            artist<span class="op">:</span> song<span class="op">.</span>artistName<span class="op">,</span></span>
<span id="cb160-49"><a href="#cb160-49" aria-hidden="true" tabindex="-1"></a>            isPlaying<span class="op">:</span> isPlaying</span>
<span id="cb160-50"><a href="#cb160-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb160-51"><a href="#cb160-51" aria-hidden="true" tabindex="-1"></a>        connectivity<span class="op">.</span>sendNowPlaying<span class="op">(</span>song<span class="op">:</span> info<span class="op">)</span></span>
<span id="cb160-52"><a href="#cb160-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb160-53"><a href="#cb160-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="watch-side">Watch Side</h3>
<div class="sourceCode" id="cb161"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WatchConnectivityService<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">connectivity</span> <span class="op">=</span> WatchConnectivityManager<span class="op">.</span>shared</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">pendingSamples</span><span class="op">:</span> <span class="op">[</span>BiometricSample<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> SongInfo<span class="op">?</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>        connectivity<span class="op">.</span>onSongUpdate <span class="op">=</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> song <span class="cf">in</span></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span> <span class="at">@MainActor</span> <span class="cf">in</span></span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">?.</span>currentSong <span class="op">=</span> song</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb161-14"><a href="#cb161-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-15"><a href="#cb161-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sendBiometrics</span><span class="op">(</span><span class="va">heartRate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="va">hrv</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb161-16"><a href="#cb161-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> connectivity<span class="op">.</span>isReachable <span class="op">{</span></span>
<span id="cb161-17"><a href="#cb161-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Send immediately</span></span>
<span id="cb161-18"><a href="#cb161-18" aria-hidden="true" tabindex="-1"></a>            connectivity<span class="op">.</span>sendBiometrics<span class="op">(</span>heartRate<span class="op">:</span> heartRate<span class="op">,</span> hrv<span class="op">:</span> hrv<span class="op">)</span></span>
<span id="cb161-19"><a href="#cb161-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb161-20"><a href="#cb161-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Queue for later</span></span>
<span id="cb161-21"><a href="#cb161-21" aria-hidden="true" tabindex="-1"></a>            pendingSamples<span class="op">.</span>append<span class="op">(</span>BiometricSample<span class="op">(</span></span>
<span id="cb161-22"><a href="#cb161-22" aria-hidden="true" tabindex="-1"></a>                heartRate<span class="op">:</span> heartRate<span class="op">,</span></span>
<span id="cb161-23"><a href="#cb161-23" aria-hidden="true" tabindex="-1"></a>                hrv<span class="op">:</span> hrv<span class="op">,</span></span>
<span id="cb161-24"><a href="#cb161-24" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> Date<span class="op">()</span></span>
<span id="cb161-25"><a href="#cb161-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">))</span></span>
<span id="cb161-26"><a href="#cb161-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-27"><a href="#cb161-27" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Batch send when we have enough</span></span>
<span id="cb161-28"><a href="#cb161-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pendingSamples<span class="op">.</span>count <span class="op">&gt;=</span> <span class="dv">10</span> <span class="op">{</span></span>
<span id="cb161-29"><a href="#cb161-29" aria-hidden="true" tabindex="-1"></a>                connectivity<span class="op">.</span>queueBiometricBatch<span class="op">(</span>pendingSamples<span class="op">)</span></span>
<span id="cb161-30"><a href="#cb161-30" aria-hidden="true" tabindex="-1"></a>                pendingSamples<span class="op">.</span>removeAll<span class="op">()</span></span>
<span id="cb161-31"><a href="#cb161-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb161-32"><a href="#cb161-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb161-33"><a href="#cb161-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb161-34"><a href="#cb161-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-35"><a href="#cb161-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">sendPlaybackCommand</span><span class="op">(</span><span class="va">_</span> <span class="va">action</span><span class="op">:</span> <span class="dt">PlaybackAction</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb161-36"><a href="#cb161-36" aria-hidden="true" tabindex="-1"></a>        connectivity<span class="op">.</span>sendAction<span class="op">(</span>action<span class="op">)</span></span>
<span id="cb161-37"><a href="#cb161-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb161-38"><a href="#cb161-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---watchconnectivity">Key Takeaways -
WatchConnectivity</h2>
<ol type="1">
<li><strong>Three transfer methods</strong> - Context (latest), Message
(real-time), UserInfo (queued)</li>
<li><strong>Check isReachable before messages</strong> - Fall back to
queued transfer</li>
<li><strong>Context overwrites</strong> - Use for current state like Now
Playing</li>
<li><strong>UserInfo queues</strong> - Use for batched biometrics when
disconnected</li>
<li><strong>Handle both directions</strong> - Watch sends biometrics,
iPhone sends song info</li>
<li><strong>Activate on both devices</strong> - Session must be active
on iPhone and Watch</li>
</ol>
<hr />
<h1 id="macos-development-menu-bar-apps">11. MACOS DEVELOPMENT (MENU BAR
APPS)</h1>
<h2 id="why-this-matters-for-ai-dj-10">Why This Matters for AI DJ</h2>
<p>The macOS menu bar app is a lightweight companion that runs in the
background. It provides quick access to AI DJ controls, shows current
song info, and can display biometric data synced from iPhone. Menu bar
apps are unobtrusiveâ€”always available but never in the way.</p>
<p><strong>In AI DJ, the macOS app will:</strong> - Show Now Playing in
the menu bar - Display synced heart rate from iPhone/Watch - Provide
quick playback controls - Run in the background without a Dock icon</p>
<hr />
<h2 id="menu-bar-app-structure">11.1 Menu Bar App Structure</h2>
<h3 id="app-configuration">App Configuration</h3>
<p><strong>What weâ€™re doing:</strong> Creating an app that lives in the
menu bar instead of the Dock.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">SwiftUI</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a><span class="at">@main</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AIDJMenuBarApp<span class="op">:</span> <span class="dt">App</span> <span class="op">{</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NSApplicationDelegateAdaptor</span><span class="op">(</span>AppDelegate<span class="op">.</span><span class="kw">self</span><span class="op">)</span> <span class="kw">var</span> <span class="va">appDelegate</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some Scene <span class="op">{</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// No WindowGroup - this is a menu bar only app</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>        Settings <span class="op">{</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>            SettingsView<span class="op">()</span></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AppDelegate<span class="op">:</span> <span class="dt">NSObject</span><span class="op">,</span> <span class="dt">NSApplicationDelegate</span> <span class="op">{</span></span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">statusItem</span><span class="op">:</span> NSStatusItem<span class="op">!</span></span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">popover</span><span class="op">:</span> NSPopover<span class="op">!</span></span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">applicationDidFinishLaunching</span><span class="op">(</span><span class="va">_</span> <span class="va">notification</span><span class="op">:</span> <span class="dt">Notification</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a>        setupMenuBar<span class="op">()</span></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">setupMenuBar</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create status item in menu bar</span></span>
<span id="cb162-25"><a href="#cb162-25" aria-hidden="true" tabindex="-1"></a>        statusItem <span class="op">=</span> NSStatusBar<span class="op">.</span>system<span class="op">.</span>statusItem<span class="op">(</span></span>
<span id="cb162-26"><a href="#cb162-26" aria-hidden="true" tabindex="-1"></a>            withLength<span class="op">:</span> NSStatusItem<span class="op">.</span>variableLength</span>
<span id="cb162-27"><a href="#cb162-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb162-28"><a href="#cb162-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-29"><a href="#cb162-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set up the button</span></span>
<span id="cb162-30"><a href="#cb162-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">button</span> <span class="op">=</span> statusItem<span class="op">.</span>button <span class="op">{</span></span>
<span id="cb162-31"><a href="#cb162-31" aria-hidden="true" tabindex="-1"></a>            button<span class="op">.</span>image <span class="op">=</span> NSImage<span class="op">(</span>systemSymbolName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">,</span> accessibilityDescription<span class="op">:</span> <span class="st">&quot;AI DJ&quot;</span><span class="op">)</span></span>
<span id="cb162-32"><a href="#cb162-32" aria-hidden="true" tabindex="-1"></a>            button<span class="op">.</span>action <span class="op">=</span> #selector<span class="op">(</span>togglePopover<span class="op">)</span></span>
<span id="cb162-33"><a href="#cb162-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb162-34"><a href="#cb162-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-35"><a href="#cb162-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create popover</span></span>
<span id="cb162-36"><a href="#cb162-36" aria-hidden="true" tabindex="-1"></a>        popover <span class="op">=</span> NSPopover<span class="op">()</span></span>
<span id="cb162-37"><a href="#cb162-37" aria-hidden="true" tabindex="-1"></a>        popover<span class="op">.</span>contentSize <span class="op">=</span> NSSize<span class="op">(</span>width<span class="op">:</span> <span class="dv">300</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">400</span><span class="op">)</span></span>
<span id="cb162-38"><a href="#cb162-38" aria-hidden="true" tabindex="-1"></a>        popover<span class="op">.</span>behavior <span class="op">=</span> <span class="op">.</span>transient</span>
<span id="cb162-39"><a href="#cb162-39" aria-hidden="true" tabindex="-1"></a>        popover<span class="op">.</span>contentViewController <span class="op">=</span> NSHostingController<span class="op">(</span></span>
<span id="cb162-40"><a href="#cb162-40" aria-hidden="true" tabindex="-1"></a>            rootView<span class="op">:</span> MenuBarContentView<span class="op">()</span></span>
<span id="cb162-41"><a href="#cb162-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb162-42"><a href="#cb162-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb162-43"><a href="#cb162-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-44"><a href="#cb162-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">@objc</span> <span class="kw">func</span> <span class="fu">togglePopover</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb162-45"><a href="#cb162-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">button</span> <span class="op">=</span> statusItem<span class="op">.</span>button <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb162-46"><a href="#cb162-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-47"><a href="#cb162-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> popover<span class="op">.</span>isShown <span class="op">{</span></span>
<span id="cb162-48"><a href="#cb162-48" aria-hidden="true" tabindex="-1"></a>            popover<span class="op">.</span>performClose<span class="op">(</span><span class="kw">nil</span><span class="op">)</span></span>
<span id="cb162-49"><a href="#cb162-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb162-50"><a href="#cb162-50" aria-hidden="true" tabindex="-1"></a>            popover<span class="op">.</span>show<span class="op">(</span>relativeTo<span class="op">:</span> button<span class="op">.</span>bounds<span class="op">,</span> of<span class="op">:</span> button<span class="op">,</span> preferredEdge<span class="op">:</span> <span class="op">.</span>minY<span class="op">)</span></span>
<span id="cb162-51"><a href="#cb162-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb162-52"><a href="#cb162-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb162-53"><a href="#cb162-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Info.plist for menu bar only app:</strong></p>
<div class="sourceCode" id="cb163"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">key</span>&gt;LSUIElement&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">true</span>/&gt;</span></code></pre></div>
<p>This hides the app from the Dock, making it menu bar only.</p>
<hr />
<h3 id="menu-bar-content-view">Menu Bar Content View</h3>
<div class="sourceCode" id="cb164"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MenuBarContentView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@StateObject</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">viewModel</span> <span class="op">=</span> MenuBarViewModel<span class="op">()</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>        VStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">16</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Now Playing</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> viewModel<span class="op">.</span>currentSong <span class="op">{</span></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>                NowPlayingCard<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> isPlaying<span class="op">:</span> viewModel<span class="op">.</span>isPlaying<span class="op">)</span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span><span class="st">&quot;Not Playing&quot;</span><span class="op">)</span></span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>            Divider<span class="op">()</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Biometrics (synced from iPhone)</span></span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> viewModel<span class="op">.</span>hasHealthData <span class="op">{</span></span>
<span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a>                HStack <span class="op">{</span></span>
<span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(viewModel.heartRate)) BPM&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb164-20"><a href="#cb164-20" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>foregroundStyle<span class="op">(.</span>red<span class="op">)</span></span>
<span id="cb164-21"><a href="#cb164-21" aria-hidden="true" tabindex="-1"></a>                    Spacer<span class="op">()</span></span>
<span id="cb164-22"><a href="#cb164-22" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(viewModel.hrv)) HRV&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;waveform.path.ecg&quot;</span><span class="op">)</span></span>
<span id="cb164-23"><a href="#cb164-23" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>foregroundStyle<span class="op">(.</span>green<span class="op">)</span></span>
<span id="cb164-24"><a href="#cb164-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb164-25"><a href="#cb164-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb164-26"><a href="#cb164-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb164-27"><a href="#cb164-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-28"><a href="#cb164-28" aria-hidden="true" tabindex="-1"></a>            Divider<span class="op">()</span></span>
<span id="cb164-29"><a href="#cb164-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-30"><a href="#cb164-30" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Controls</span></span>
<span id="cb164-31"><a href="#cb164-31" aria-hidden="true" tabindex="-1"></a>            HStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-32"><a href="#cb164-32" aria-hidden="true" tabindex="-1"></a>                Button<span class="op">(</span>action<span class="op">:</span> viewModel<span class="op">.</span>previousTrack<span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-33"><a href="#cb164-33" aria-hidden="true" tabindex="-1"></a>                    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;backward.fill&quot;</span><span class="op">)</span></span>
<span id="cb164-34"><a href="#cb164-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb164-35"><a href="#cb164-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-36"><a href="#cb164-36" aria-hidden="true" tabindex="-1"></a>                Button<span class="op">(</span>action<span class="op">:</span> viewModel<span class="op">.</span>togglePlayback<span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-37"><a href="#cb164-37" aria-hidden="true" tabindex="-1"></a>                    Image<span class="op">(</span>systemName<span class="op">:</span> viewModel<span class="op">.</span>isPlaying <span class="op">?</span> <span class="st">&quot;pause.fill&quot;</span> <span class="op">:</span> <span class="st">&quot;play.fill&quot;</span><span class="op">)</span></span>
<span id="cb164-38"><a href="#cb164-38" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>title2<span class="op">)</span></span>
<span id="cb164-39"><a href="#cb164-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb164-40"><a href="#cb164-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>buttonStyle<span class="op">(.</span>borderedProminent<span class="op">)</span></span>
<span id="cb164-41"><a href="#cb164-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-42"><a href="#cb164-42" aria-hidden="true" tabindex="-1"></a>                Button<span class="op">(</span>action<span class="op">:</span> viewModel<span class="op">.</span>nextTrack<span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-43"><a href="#cb164-43" aria-hidden="true" tabindex="-1"></a>                    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;forward.fill&quot;</span><span class="op">)</span></span>
<span id="cb164-44"><a href="#cb164-44" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb164-45"><a href="#cb164-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb164-46"><a href="#cb164-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-47"><a href="#cb164-47" aria-hidden="true" tabindex="-1"></a>            Divider<span class="op">()</span></span>
<span id="cb164-48"><a href="#cb164-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-49"><a href="#cb164-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Quick actions</span></span>
<span id="cb164-50"><a href="#cb164-50" aria-hidden="true" tabindex="-1"></a>            Button<span class="op">(</span><span class="st">&quot;Open AI DJ on iPhone&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-51"><a href="#cb164-51" aria-hidden="true" tabindex="-1"></a>                <span class="co">// This would use Universal Links or Handoff</span></span>
<span id="cb164-52"><a href="#cb164-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb164-53"><a href="#cb164-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>buttonStyle<span class="op">(.</span>link<span class="op">)</span></span>
<span id="cb164-54"><a href="#cb164-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-55"><a href="#cb164-55" aria-hidden="true" tabindex="-1"></a>            Button<span class="op">(</span><span class="st">&quot;Quit&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-56"><a href="#cb164-56" aria-hidden="true" tabindex="-1"></a>                NSApplication<span class="op">.</span>shared<span class="op">.</span>terminate<span class="op">(</span><span class="kw">nil</span><span class="op">)</span></span>
<span id="cb164-57"><a href="#cb164-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb164-58"><a href="#cb164-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>buttonStyle<span class="op">(.</span>link<span class="op">)</span></span>
<span id="cb164-59"><a href="#cb164-59" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>foregroundStyle<span class="op">(.</span>red<span class="op">)</span></span>
<span id="cb164-60"><a href="#cb164-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb164-61"><a href="#cb164-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">()</span></span>
<span id="cb164-62"><a href="#cb164-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>frame<span class="op">(</span>width<span class="op">:</span> <span class="dv">280</span><span class="op">)</span></span>
<span id="cb164-63"><a href="#cb164-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb164-64"><a href="#cb164-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb164-65"><a href="#cb164-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-66"><a href="#cb164-66" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> NowPlayingCard<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb164-67"><a href="#cb164-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">song</span><span class="op">:</span> SongInfo</span>
<span id="cb164-68"><a href="#cb164-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">isPlaying</span><span class="op">:</span> Bool</span>
<span id="cb164-69"><a href="#cb164-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-70"><a href="#cb164-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb164-71"><a href="#cb164-71" aria-hidden="true" tabindex="-1"></a>        HStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">12</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-72"><a href="#cb164-72" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Album art placeholder</span></span>
<span id="cb164-73"><a href="#cb164-73" aria-hidden="true" tabindex="-1"></a>            RoundedRectangle<span class="op">(</span>cornerRadius<span class="op">:</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb164-74"><a href="#cb164-74" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>fill<span class="op">(.</span>gray<span class="op">.</span>opacity<span class="op">(</span><span class="fl">0.3</span><span class="op">))</span></span>
<span id="cb164-75"><a href="#cb164-75" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>frame<span class="op">(</span>width<span class="op">:</span> <span class="dv">50</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">50</span><span class="op">)</span></span>
<span id="cb164-76"><a href="#cb164-76" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>overlay <span class="op">{</span></span>
<span id="cb164-77"><a href="#cb164-77" aria-hidden="true" tabindex="-1"></a>                    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">)</span></span>
<span id="cb164-78"><a href="#cb164-78" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb164-79"><a href="#cb164-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-80"><a href="#cb164-80" aria-hidden="true" tabindex="-1"></a>            VStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">,</span> spacing<span class="op">:</span> <span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-81"><a href="#cb164-81" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>song<span class="op">.</span>title<span class="op">)</span></span>
<span id="cb164-82"><a href="#cb164-82" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>headline<span class="op">)</span></span>
<span id="cb164-83"><a href="#cb164-83" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>lineLimit<span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb164-84"><a href="#cb164-84" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>song<span class="op">.</span>artist<span class="op">)</span></span>
<span id="cb164-85"><a href="#cb164-85" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>subheadline<span class="op">)</span></span>
<span id="cb164-86"><a href="#cb164-86" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb164-87"><a href="#cb164-87" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>lineLimit<span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb164-88"><a href="#cb164-88" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb164-89"><a href="#cb164-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-90"><a href="#cb164-90" aria-hidden="true" tabindex="-1"></a>            Spacer<span class="op">()</span></span>
<span id="cb164-91"><a href="#cb164-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-92"><a href="#cb164-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> isPlaying <span class="op">{</span></span>
<span id="cb164-93"><a href="#cb164-93" aria-hidden="true" tabindex="-1"></a>                Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;speaker.wave.2.fill&quot;</span><span class="op">)</span></span>
<span id="cb164-94"><a href="#cb164-94" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>blue<span class="op">)</span></span>
<span id="cb164-95"><a href="#cb164-95" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb164-96"><a href="#cb164-96" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb164-97"><a href="#cb164-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb164-98"><a href="#cb164-98" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="syncing-with-iphone">11.2 Syncing with iPhone</h2>
<h3 id="cloudkit-or-custom-sync">CloudKit or Custom Sync</h3>
<p><strong>What weâ€™re doing:</strong> Receiving Now Playing info from
iPhone.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MenuBarViewModel<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">currentSong</span><span class="op">:</span> SongInfo<span class="op">?</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">isPlaying</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">heartRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">hrv</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">hasHealthData</span> <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">var</span> <span class="va">cancellables</span> <span class="op">=</span> Set<span class="op">&lt;</span>AnyCancellable<span class="op">&gt;()</span></span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>        setupCloudKitSync<span class="op">()</span></span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">setupCloudKitSync</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Listen for iCloud key-value store changes</span></span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>        NotificationCenter<span class="op">.</span><span class="kw">default</span><span class="op">.</span>publisher<span class="op">(</span></span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">:</span> NSUbiquitousKeyValueStore<span class="op">.</span>didChangeExternallyNotification</span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>sink <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> notification <span class="cf">in</span></span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">?.</span>handleCloudUpdate<span class="op">()</span></span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb165-22"><a href="#cb165-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>store<span class="op">(</span><span class="cf">in</span><span class="op">:</span> <span class="op">&amp;</span>cancellables<span class="op">)</span></span>
<span id="cb165-23"><a href="#cb165-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-24"><a href="#cb165-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initial load</span></span>
<span id="cb165-25"><a href="#cb165-25" aria-hidden="true" tabindex="-1"></a>        handleCloudUpdate<span class="op">()</span></span>
<span id="cb165-26"><a href="#cb165-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb165-27"><a href="#cb165-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-28"><a href="#cb165-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">handleCloudUpdate</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb165-29"><a href="#cb165-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">store</span> <span class="op">=</span> NSUbiquitousKeyValueStore<span class="op">.</span><span class="kw">default</span></span>
<span id="cb165-30"><a href="#cb165-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-31"><a href="#cb165-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">title</span> <span class="op">=</span> store<span class="op">.</span>string<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;nowPlayingTitle&quot;</span><span class="op">),</span></span>
<span id="cb165-32"><a href="#cb165-32" aria-hidden="true" tabindex="-1"></a>           <span class="kw">let</span> <span class="va">artist</span> <span class="op">=</span> store<span class="op">.</span>string<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;nowPlayingArtist&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb165-33"><a href="#cb165-33" aria-hidden="true" tabindex="-1"></a>            currentSong <span class="op">=</span> SongInfo<span class="op">(</span>title<span class="op">:</span> title<span class="op">,</span> artist<span class="op">:</span> artist<span class="op">)</span></span>
<span id="cb165-34"><a href="#cb165-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb165-35"><a href="#cb165-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-36"><a href="#cb165-36" aria-hidden="true" tabindex="-1"></a>        isPlaying <span class="op">=</span> store<span class="op">.</span>bool<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;isPlaying&quot;</span><span class="op">)</span></span>
<span id="cb165-37"><a href="#cb165-37" aria-hidden="true" tabindex="-1"></a>        heartRate <span class="op">=</span> store<span class="op">.</span>double<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;heartRate&quot;</span><span class="op">)</span></span>
<span id="cb165-38"><a href="#cb165-38" aria-hidden="true" tabindex="-1"></a>        hrv <span class="op">=</span> store<span class="op">.</span>double<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;hrv&quot;</span><span class="op">)</span></span>
<span id="cb165-39"><a href="#cb165-39" aria-hidden="true" tabindex="-1"></a>        hasHealthData <span class="op">=</span> heartRate <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb165-40"><a href="#cb165-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb165-41"><a href="#cb165-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-42"><a href="#cb165-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Controls send commands back to iPhone</span></span>
<span id="cb165-43"><a href="#cb165-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">togglePlayback</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb165-44"><a href="#cb165-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use iCloud or push notification to trigger iPhone</span></span>
<span id="cb165-45"><a href="#cb165-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">store</span> <span class="op">=</span> NSUbiquitousKeyValueStore<span class="op">.</span><span class="kw">default</span></span>
<span id="cb165-46"><a href="#cb165-46" aria-hidden="true" tabindex="-1"></a>        store<span class="op">.</span><span class="kw">set</span><span class="op">(</span><span class="st">&quot;togglePlayback&quot;</span><span class="op">,</span> forKey<span class="op">:</span> <span class="st">&quot;pendingCommand&quot;</span><span class="op">)</span></span>
<span id="cb165-47"><a href="#cb165-47" aria-hidden="true" tabindex="-1"></a>        store<span class="op">.</span>synchronize<span class="op">()</span></span>
<span id="cb165-48"><a href="#cb165-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb165-49"><a href="#cb165-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-50"><a href="#cb165-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">nextTrack</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb165-51"><a href="#cb165-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">store</span> <span class="op">=</span> NSUbiquitousKeyValueStore<span class="op">.</span><span class="kw">default</span></span>
<span id="cb165-52"><a href="#cb165-52" aria-hidden="true" tabindex="-1"></a>        store<span class="op">.</span><span class="kw">set</span><span class="op">(</span><span class="st">&quot;nextTrack&quot;</span><span class="op">,</span> forKey<span class="op">:</span> <span class="st">&quot;pendingCommand&quot;</span><span class="op">)</span></span>
<span id="cb165-53"><a href="#cb165-53" aria-hidden="true" tabindex="-1"></a>        store<span class="op">.</span>synchronize<span class="op">()</span></span>
<span id="cb165-54"><a href="#cb165-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb165-55"><a href="#cb165-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-56"><a href="#cb165-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">previousTrack</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb165-57"><a href="#cb165-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">store</span> <span class="op">=</span> NSUbiquitousKeyValueStore<span class="op">.</span><span class="kw">default</span></span>
<span id="cb165-58"><a href="#cb165-58" aria-hidden="true" tabindex="-1"></a>        store<span class="op">.</span><span class="kw">set</span><span class="op">(</span><span class="st">&quot;previousTrack&quot;</span><span class="op">,</span> forKey<span class="op">:</span> <span class="st">&quot;pendingCommand&quot;</span><span class="op">)</span></span>
<span id="cb165-59"><a href="#cb165-59" aria-hidden="true" tabindex="-1"></a>        store<span class="op">.</span>synchronize<span class="op">()</span></span>
<span id="cb165-60"><a href="#cb165-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb165-61"><a href="#cb165-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="macos-specific-considerations">11.3 macOS-Specific
Considerations</h2>
<h3 id="keyboard-shortcuts">Keyboard Shortcuts</h3>
<div class="sourceCode" id="cb166"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> AppDelegate <span class="op">{</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">setupGlobalHotkeys</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Note: Requires accessibility permissions for global hotkeys</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>        NSEvent<span class="op">.</span>addGlobalMonitorForEvents<span class="op">(</span>matching<span class="op">:</span> <span class="op">.</span>keyDown<span class="op">)</span> <span class="op">{</span> event <span class="cf">in</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Command + Shift + P to toggle playback</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> event<span class="op">.</span>modifierFlags<span class="op">.</span>contains<span class="op">([.</span>command<span class="op">,</span> <span class="op">.</span>shift<span class="op">])</span> <span class="op">&amp;&amp;</span> event<span class="op">.</span>keyCode <span class="op">==</span> <span class="dv">35</span> <span class="op">{</span></span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>togglePlayback<span class="op">()</span></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">togglePlayback</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Send to view model</span></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="menu-bar-icon-updates">Menu Bar Icon Updates</h3>
<div class="sourceCode" id="cb167"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> AppDelegate <span class="op">{</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">updateMenuBarIcon</span><span class="op">(</span><span class="va">isPlaying</span><span class="op">:</span> <span class="dt">Bool</span><span class="op">,</span> <span class="va">heartRate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">?)</span> <span class="op">{</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">button</span> <span class="op">=</span> statusItem<span class="op">.</span>button <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">}</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> isPlaying <span class="op">{</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>            button<span class="op">.</span>image <span class="op">=</span> NSImage<span class="op">(</span>systemSymbolName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">,</span> accessibilityDescription<span class="op">:</span> <span class="st">&quot;Playing&quot;</span><span class="op">)</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Optionally show heart rate in menu bar</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="va">hr</span> <span class="op">=</span> heartRate <span class="op">{</span></span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>                button<span class="op">.</span>title <span class="op">=</span> <span class="st">&quot; </span><span class="er">\(</span><span class="st">Int(hr))&quot;</span></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>            button<span class="op">.</span>image <span class="op">=</span> NSImage<span class="op">(</span>systemSymbolName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">,</span> accessibilityDescription<span class="op">:</span> <span class="st">&quot;Paused&quot;</span><span class="op">)</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>            button<span class="op">.</span>title <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---macos-menu-bar">Key Takeaways - macOS Menu
Bar</h2>
<ol type="1">
<li><strong>LSUIElement = true</strong> - Hides from Dock, menu bar
only</li>
<li><strong>NSStatusItem</strong> - Creates the menu bar icon</li>
<li><strong>NSPopover</strong> - Shows content when clicking menu bar
item</li>
<li><strong>Sync via iCloud</strong> - NSUbiquitousKeyValueStore for
simple sync</li>
<li><strong>No window needed</strong> - Settings scene for
preferences</li>
<li><strong>Lightweight</strong> - Menu bar apps should be minimal</li>
</ol>
<hr />
<h1 id="background-processing-app-lifecycle">12. BACKGROUND PROCESSING
&amp; APP LIFECYCLE</h1>
<h2 id="why-this-matters-for-ai-dj-11">Why This Matters for AI DJ</h2>
<p>Music apps need to keep playing when the user switches to other apps.
AI DJ also needs to continue monitoring health data and updating song
selection in the background. Understanding the iOS app lifecycle and
background modes is essential for a seamless experience.</p>
<p><strong>In AI DJ, background processing handles:</strong> -
Continuing music playback when app is backgrounded - Receiving HealthKit
updates in the background - Periodic data sync between devices -
Processing biometric data while screen is off</p>
<hr />
<h2 id="app-lifecycle">12.1 App Lifecycle</h2>
<h3 id="swiftui-app-lifecycle">SwiftUI App Lifecycle</h3>
<p><strong>What weâ€™re doing:</strong> Responding to app state
changes.</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="at">@main</span></span>
<span id="cb168-2"><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AIDJApp<span class="op">:</span> <span class="dt">App</span> <span class="op">{</span></span>
<span id="cb168-3"><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Environment</span><span class="op">(</span>\<span class="op">.</span>scenePhase<span class="op">)</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">scenePhase</span></span>
<span id="cb168-4"><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-5"><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some Scene <span class="op">{</span></span>
<span id="cb168-6"><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>        WindowGroup <span class="op">{</span></span>
<span id="cb168-7"><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>            ContentView<span class="op">()</span></span>
<span id="cb168-8"><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb168-9"><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>onChange<span class="op">(</span>of<span class="op">:</span> scenePhase<span class="op">)</span> <span class="op">{</span> oldPhase<span class="op">,</span> newPhase <span class="cf">in</span></span>
<span id="cb168-10"><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">switch</span> newPhase <span class="op">{</span></span>
<span id="cb168-11"><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>active<span class="op">:</span></span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a>                <span class="co">// App is in foreground</span></span>
<span id="cb168-13"><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>                handleBecameActive<span class="op">()</span></span>
<span id="cb168-14"><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>inactive<span class="op">:</span></span>
<span id="cb168-15"><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>                <span class="co">// App is transitioning (between active and background)</span></span>
<span id="cb168-16"><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>                handleBecameInactive<span class="op">()</span></span>
<span id="cb168-17"><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>background<span class="op">:</span></span>
<span id="cb168-18"><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>                <span class="co">// App is in background</span></span>
<span id="cb168-19"><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>                handleEnteredBackground<span class="op">()</span></span>
<span id="cb168-20"><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">@unknown</span> <span class="kw">default</span><span class="op">:</span></span>
<span id="cb168-21"><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb168-22"><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb168-23"><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb168-24"><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb168-25"><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-26"><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">handleBecameActive</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb168-27"><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Resume health monitoring</span></span>
<span id="cb168-28"><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>        HealthService<span class="op">.</span>shared<span class="op">.</span>startMonitoring<span class="op">()</span></span>
<span id="cb168-29"><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Refresh now playing state</span></span>
<span id="cb168-30"><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a>        MusicService<span class="op">.</span>shared<span class="op">.</span>syncState<span class="op">()</span></span>
<span id="cb168-31"><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb168-32"><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-33"><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">handleBecameInactive</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Prepare for possible background</span></span>
<span id="cb168-35"><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a>        DataManager<span class="op">.</span>shared<span class="op">.</span>saveState<span class="op">()</span></span>
<span id="cb168-36"><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb168-37"><a href="#cb168-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-38"><a href="#cb168-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">handleEnteredBackground</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb168-39"><a href="#cb168-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Schedule background tasks</span></span>
<span id="cb168-40"><a href="#cb168-40" aria-hidden="true" tabindex="-1"></a>        BackgroundTaskManager<span class="op">.</span>shared<span class="op">.</span>scheduleRefresh<span class="op">()</span></span>
<span id="cb168-41"><a href="#cb168-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb168-42"><a href="#cb168-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="scene-phase-states">Scene Phase States</h3>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    App Lifecycle                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  .active â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º .inactive â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º .background â”‚
â”‚    â”‚                      â”‚                      â”‚       â”‚
â”‚    â”‚ User is              â”‚ Transitioning        â”‚ User  â”‚
â”‚    â”‚ interacting          â”‚ (call coming,        â”‚ left  â”‚
â”‚    â”‚                      â”‚  control center)     â”‚ app   â”‚
â”‚                                                          â”‚
â”‚  Full UI      â”‚        Limited        â”‚      Suspended   â”‚
â”‚  Unlimited    â”‚        Short tasks    â”‚      Frozen      â”‚
â”‚  resources    â”‚        allowed        â”‚      state       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<hr />
<h2 id="background-modes">12.2 Background Modes</h2>
<h3 id="enabling-background-capabilities">Enabling Background
Capabilities</h3>
<p><strong>What weâ€™re doing:</strong> Declaring which background modes
the app uses.</p>
<p>In Xcode: Target â†’ Signing &amp; Capabilities â†’ + Capability â†’
Background Modes</p>
<p><strong>Background modes for AI DJ:</strong> - [x] Audio, AirPlay,
and Picture in Picture (music playback) - [x] Background fetch (periodic
data refresh) - [x] Background processing (long tasks) - [x] Remote
notifications (push-triggered updates)</p>
<hr />
<h3 id="audio-background-mode">Audio Background Mode</h3>
<p><strong>What weâ€™re doing:</strong> Keeping music playing when app is
backgrounded.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">AVFoundation</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AudioSessionManager <span class="op">{</span></span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">let</span> <span class="va">shared</span> <span class="op">=</span> AudioSessionManager<span class="op">()</span></span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">configureAudioSession</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">session</span> <span class="op">=</span> AVAudioSession<span class="op">.</span>sharedInstance<span class="op">()</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> session<span class="op">.</span>setCategory<span class="op">(</span></span>
<span id="cb170-11"><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>playback<span class="op">,</span></span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a>                mode<span class="op">:</span> <span class="op">.</span><span class="kw">default</span><span class="op">,</span></span>
<span id="cb170-13"><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a>                options<span class="op">:</span> <span class="op">[.</span>mixWithOthers<span class="op">,</span> <span class="op">.</span>allowAirPlay<span class="op">]</span></span>
<span id="cb170-14"><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb170-15"><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> session<span class="op">.</span>setActive<span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb170-16"><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb170-17"><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Failed to configure audio session: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb170-19"><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb170-20"><a href="#cb170-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>What happens:</strong> With <code>.playback</code> category
and audio background mode enabled, music continues when the app is
backgrounded.</p>
<hr />
<h3 id="background-tasks-bgtaskscheduler">Background Tasks
(BGTaskScheduler)</h3>
<p><strong>What weâ€™re doing:</strong> Scheduling work to run
periodically in the background.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">BackgroundTasks</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BackgroundTaskManager <span class="op">{</span></span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">let</span> <span class="va">shared</span> <span class="op">=</span> BackgroundTaskManager<span class="op">()</span></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">refreshTaskIdentifier</span> <span class="op">=</span> <span class="st">&quot;com.aidj.refresh&quot;</span></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">processingTaskIdentifier</span> <span class="op">=</span> <span class="st">&quot;com.aidj.processing&quot;</span></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">registerTasks</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>        BGTaskScheduler<span class="op">.</span>shared<span class="op">.</span>register<span class="op">(</span></span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a>            forTaskWithIdentifier<span class="op">:</span> refreshTaskIdentifier<span class="op">,</span></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>            using<span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> task <span class="cf">in</span></span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>handleRefreshTask<span class="op">(</span>task <span class="kw">as</span><span class="op">!</span> BGAppRefreshTask<span class="op">)</span></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb171-16"><a href="#cb171-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-17"><a href="#cb171-17" aria-hidden="true" tabindex="-1"></a>        BGTaskScheduler<span class="op">.</span>shared<span class="op">.</span>register<span class="op">(</span></span>
<span id="cb171-18"><a href="#cb171-18" aria-hidden="true" tabindex="-1"></a>            forTaskWithIdentifier<span class="op">:</span> processingTaskIdentifier<span class="op">,</span></span>
<span id="cb171-19"><a href="#cb171-19" aria-hidden="true" tabindex="-1"></a>            using<span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb171-20"><a href="#cb171-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> task <span class="cf">in</span></span>
<span id="cb171-21"><a href="#cb171-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>handleProcessingTask<span class="op">(</span>task <span class="kw">as</span><span class="op">!</span> BGProcessingTask<span class="op">)</span></span>
<span id="cb171-22"><a href="#cb171-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb171-23"><a href="#cb171-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb171-24"><a href="#cb171-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-25"><a href="#cb171-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">scheduleRefresh</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb171-26"><a href="#cb171-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">request</span> <span class="op">=</span> BGAppRefreshTaskRequest<span class="op">(</span>identifier<span class="op">:</span> refreshTaskIdentifier<span class="op">)</span></span>
<span id="cb171-27"><a href="#cb171-27" aria-hidden="true" tabindex="-1"></a>        request<span class="op">.</span>earliestBeginDate <span class="op">=</span> Date<span class="op">(</span>timeIntervalSinceNow<span class="op">:</span> <span class="dv">15</span> <span class="op">*</span> <span class="dv">60</span><span class="op">)</span> <span class="co">// 15 min</span></span>
<span id="cb171-28"><a href="#cb171-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-29"><a href="#cb171-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb171-30"><a href="#cb171-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> BGTaskScheduler<span class="op">.</span>shared<span class="op">.</span>submit<span class="op">(</span>request<span class="op">)</span></span>
<span id="cb171-31"><a href="#cb171-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb171-32"><a href="#cb171-32" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Failed to schedule refresh: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb171-33"><a href="#cb171-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb171-34"><a href="#cb171-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb171-35"><a href="#cb171-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-36"><a href="#cb171-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">scheduleProcessing</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb171-37"><a href="#cb171-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">request</span> <span class="op">=</span> BGProcessingTaskRequest<span class="op">(</span>identifier<span class="op">:</span> processingTaskIdentifier<span class="op">)</span></span>
<span id="cb171-38"><a href="#cb171-38" aria-hidden="true" tabindex="-1"></a>        request<span class="op">.</span>requiresNetworkConnectivity <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb171-39"><a href="#cb171-39" aria-hidden="true" tabindex="-1"></a>        request<span class="op">.</span>requiresExternalPower <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb171-40"><a href="#cb171-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-41"><a href="#cb171-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb171-42"><a href="#cb171-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> BGTaskScheduler<span class="op">.</span>shared<span class="op">.</span>submit<span class="op">(</span>request<span class="op">)</span></span>
<span id="cb171-43"><a href="#cb171-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb171-44"><a href="#cb171-44" aria-hidden="true" tabindex="-1"></a>            print<span class="op">(</span><span class="st">&quot;Failed to schedule processing: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb171-45"><a href="#cb171-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb171-46"><a href="#cb171-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb171-47"><a href="#cb171-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-48"><a href="#cb171-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">handleRefreshTask</span><span class="op">(</span><span class="va">_</span> <span class="va">task</span><span class="op">:</span> <span class="dt">BGAppRefreshTask</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb171-49"><a href="#cb171-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Schedule the next refresh</span></span>
<span id="cb171-50"><a href="#cb171-50" aria-hidden="true" tabindex="-1"></a>        scheduleRefresh<span class="op">()</span></span>
<span id="cb171-51"><a href="#cb171-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-52"><a href="#cb171-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create a task to do the work</span></span>
<span id="cb171-53"><a href="#cb171-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">refreshOperation</span> <span class="op">=</span> Task <span class="op">{</span></span>
<span id="cb171-54"><a href="#cb171-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb171-55"><a href="#cb171-55" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Sync data from Watch</span></span>
<span id="cb171-56"><a href="#cb171-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">await</span> WatchConnectivityManager<span class="op">.</span>shared<span class="op">.</span>syncPendingData<span class="op">()</span></span>
<span id="cb171-57"><a href="#cb171-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-58"><a href="#cb171-58" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Update song recommendations</span></span>
<span id="cb171-59"><a href="#cb171-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">await</span> RecommendationEngine<span class="op">.</span>shared<span class="op">.</span>refresh<span class="op">()</span></span>
<span id="cb171-60"><a href="#cb171-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-61"><a href="#cb171-61" aria-hidden="true" tabindex="-1"></a>                task<span class="op">.</span>setTaskCompleted<span class="op">(</span>success<span class="op">:</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb171-62"><a href="#cb171-62" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb171-63"><a href="#cb171-63" aria-hidden="true" tabindex="-1"></a>                task<span class="op">.</span>setTaskCompleted<span class="op">(</span>success<span class="op">:</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb171-64"><a href="#cb171-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb171-65"><a href="#cb171-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb171-66"><a href="#cb171-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-67"><a href="#cb171-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Handle cancellation</span></span>
<span id="cb171-68"><a href="#cb171-68" aria-hidden="true" tabindex="-1"></a>        task<span class="op">.</span>expirationHandler <span class="op">=</span> <span class="op">{</span></span>
<span id="cb171-69"><a href="#cb171-69" aria-hidden="true" tabindex="-1"></a>            refreshOperation<span class="op">.</span>cancel<span class="op">()</span></span>
<span id="cb171-70"><a href="#cb171-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb171-71"><a href="#cb171-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb171-72"><a href="#cb171-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-73"><a href="#cb171-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">handleProcessingTask</span><span class="op">(</span><span class="va">_</span> <span class="va">task</span><span class="op">:</span> <span class="dt">BGProcessingTask</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb171-74"><a href="#cb171-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Long-running background work</span></span>
<span id="cb171-75"><a href="#cb171-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">processingOperation</span> <span class="op">=</span> Task <span class="op">{</span></span>
<span id="cb171-76"><a href="#cb171-76" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Analyze historical data for improved recommendations</span></span>
<span id="cb171-77"><a href="#cb171-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> DataAnalyzer<span class="op">.</span>shared<span class="op">.</span>analyzeHistory<span class="op">()</span></span>
<span id="cb171-78"><a href="#cb171-78" aria-hidden="true" tabindex="-1"></a>            task<span class="op">.</span>setTaskCompleted<span class="op">(</span>success<span class="op">:</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb171-79"><a href="#cb171-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb171-80"><a href="#cb171-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-81"><a href="#cb171-81" aria-hidden="true" tabindex="-1"></a>        task<span class="op">.</span>expirationHandler <span class="op">=</span> <span class="op">{</span></span>
<span id="cb171-82"><a href="#cb171-82" aria-hidden="true" tabindex="-1"></a>            processingOperation<span class="op">.</span>cancel<span class="op">()</span></span>
<span id="cb171-83"><a href="#cb171-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb171-84"><a href="#cb171-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb171-85"><a href="#cb171-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Info.plist:</strong></p>
<div class="sourceCode" id="cb172"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">key</span>&gt;BGTaskSchedulerPermittedIdentifiers&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">array</span>&gt;</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">string</span>&gt;com.aidj.refresh&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">string</span>&gt;com.aidj.processing&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">array</span>&gt;</span></code></pre></div>
<hr />
<h2 id="healthkit-background-delivery">12.3 HealthKit Background
Delivery</h2>
<h3 id="receiving-health-updates-in-background">Receiving Health Updates
in Background</h3>
<p><strong>What weâ€™re doing:</strong> Getting notified when new health
data is recorded.</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> HealthKitManager <span class="op">{</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">enableBackgroundDelivery</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>        healthStore<span class="op">.</span>enableBackgroundDelivery<span class="op">(</span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>            frequency<span class="op">:</span> <span class="op">.</span>immediate</span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> success<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> success <span class="op">{</span></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>                print<span class="op">(</span><span class="st">&quot;Background delivery enabled for heart rate&quot;</span><span class="op">)</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="kw">let</span> <span class="va">error</span> <span class="op">=</span> error <span class="op">{</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>                print<span class="op">(</span><span class="st">&quot;Failed to enable background delivery: </span><span class="er">\(</span><span class="st">error)&quot;</span><span class="op">)</span></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">setupBackgroundObserver</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateType</span> <span class="op">=</span> HKQuantityType<span class="op">(.</span>heartRate<span class="op">)</span></span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span> <span class="op">=</span> HKObserverQuery<span class="op">(</span></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>            sampleType<span class="op">:</span> heartRateType<span class="op">,</span></span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>            predicate<span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span> <span class="op">{</span> <span class="op">[</span><span class="kw">weak</span> <span class="kw">self</span><span class="op">]</span> query<span class="op">,</span> completionHandler<span class="op">,</span> error <span class="cf">in</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Called when new heart rate samples are recorded</span></span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a>            Task <span class="op">{</span></span>
<span id="cb173-26"><a href="#cb173-26" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="va">rate</span> <span class="op">=</span> <span class="cf">try</span><span class="op">?</span> <span class="cf">await</span> <span class="kw">self</span><span class="op">?.</span>fetchLatestHeartRate<span class="op">()</span> <span class="op">{</span></span>
<span id="cb173-27"><a href="#cb173-27" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">await</span> <span class="kw">self</span><span class="op">?.</span>processBackgroundHeartRate<span class="op">(</span>rate<span class="op">)</span></span>
<span id="cb173-28"><a href="#cb173-28" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb173-29"><a href="#cb173-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb173-30"><a href="#cb173-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-31"><a href="#cb173-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Must call completion handler</span></span>
<span id="cb173-32"><a href="#cb173-32" aria-hidden="true" tabindex="-1"></a>            completionHandler<span class="op">()</span></span>
<span id="cb173-33"><a href="#cb173-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb173-34"><a href="#cb173-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-35"><a href="#cb173-35" aria-hidden="true" tabindex="-1"></a>        healthStore<span class="op">.</span>execute<span class="op">(</span>query<span class="op">)</span></span>
<span id="cb173-36"><a href="#cb173-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb173-37"><a href="#cb173-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-38"><a href="#cb173-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">processBackgroundHeartRate</span><span class="op">(</span><span class="va">_</span> <span class="va">rate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb173-39"><a href="#cb173-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Send to Watch Connectivity</span></span>
<span id="cb173-40"><a href="#cb173-40" aria-hidden="true" tabindex="-1"></a>        WatchConnectivityManager<span class="op">.</span>shared<span class="op">.</span>updateContext<span class="op">([</span></span>
<span id="cb173-41"><a href="#cb173-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;latestHeartRate&quot;</span><span class="op">:</span> rate<span class="op">,</span></span>
<span id="cb173-42"><a href="#cb173-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;timestamp&quot;</span><span class="op">:</span> Date<span class="op">().</span>timeIntervalSince1970</span>
<span id="cb173-43"><a href="#cb173-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">])</span></span>
<span id="cb173-44"><a href="#cb173-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-45"><a href="#cb173-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Maybe trigger song change if significant</span></span>
<span id="cb173-46"><a href="#cb173-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rate <span class="op">&gt;</span> <span class="dv">120</span> <span class="op">{</span></span>
<span id="cb173-47"><a href="#cb173-47" aria-hidden="true" tabindex="-1"></a>            <span class="co">// User&#39;s heart rate elevated - might need calmer music</span></span>
<span id="cb173-48"><a href="#cb173-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb173-49"><a href="#cb173-49" aria-hidden="true" tabindex="-1"></a>                NotificationCenter<span class="op">.</span><span class="kw">default</span><span class="op">.</span>post<span class="op">(</span></span>
<span id="cb173-50"><a href="#cb173-50" aria-hidden="true" tabindex="-1"></a>                    name<span class="op">:</span> <span class="op">.</span>heartRateElevated<span class="op">,</span></span>
<span id="cb173-51"><a href="#cb173-51" aria-hidden="true" tabindex="-1"></a>                    object<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb173-52"><a href="#cb173-52" aria-hidden="true" tabindex="-1"></a>                    userInfo<span class="op">:</span> <span class="op">[</span><span class="st">&quot;heartRate&quot;</span><span class="op">:</span> rate<span class="op">]</span></span>
<span id="cb173-53"><a href="#cb173-53" aria-hidden="true" tabindex="-1"></a>                <span class="op">)</span></span>
<span id="cb173-54"><a href="#cb173-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb173-55"><a href="#cb173-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb173-56"><a href="#cb173-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb173-57"><a href="#cb173-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb173-58"><a href="#cb173-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-59"><a href="#cb173-59" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> Notification<span class="op">.</span>Name <span class="op">{</span></span>
<span id="cb173-60"><a href="#cb173-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">let</span> <span class="va">heartRateElevated</span> <span class="op">=</span> Notification<span class="op">.</span>Name<span class="op">(</span><span class="st">&quot;heartRateElevated&quot;</span><span class="op">)</span></span>
<span id="cb173-61"><a href="#cb173-61" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---background-processing">Key Takeaways -
Background Processing</h2>
<ol type="1">
<li><strong>Audio mode keeps music playing</strong> - Essential for any
music app</li>
<li><strong>BGTaskScheduler for periodic work</strong> - Register tasks
at app launch</li>
<li><strong>HealthKit background delivery</strong> - Get notified of new
health data</li>
<li><strong>Handle expiration</strong> - Always implement
expirationHandler</li>
<li><strong>Scene phase for lifecycle</strong> - .active, .inactive,
.background</li>
<li><strong>Save state on background</strong> - User might not return
for hours</li>
</ol>
<hr />
<h1 id="widgets-complications">13. WIDGETS &amp; COMPLICATIONS</h1>
<h2 id="why-this-matters-for-ai-dj-12">Why This Matters for AI DJ</h2>
<p>Widgets bring AI DJ to the home screen and lock screen. A glance at
the widget shows whatâ€™s playing and current biometrics. Watch
complications do the same on the wrist. These arenâ€™t interactive
appsâ€”theyâ€™re snapshots that update periodically to keep the user
informed.</p>
<p><strong>In AI DJ, widgets and complications show:</strong> - Current
song and artist - Heart rate and stress level - Music
mood/recommendation - Quick launch into the app</p>
<hr />
<h2 id="ios-widgets-widgetkit">13.1 iOS Widgets (WidgetKit)</h2>
<h3 id="widget-structure">Widget Structure</h3>
<p><strong>What weâ€™re doing:</strong> Creating a widget extension that
displays AI DJ info.</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">WidgetKit</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">SwiftUI</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AIDJWidget<span class="op">:</span> <span class="dt">Widget</span> <span class="op">{</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">kind</span><span class="op">:</span> String <span class="op">=</span> <span class="st">&quot;AIDJWidget&quot;</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some WidgetConfiguration <span class="op">{</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>        StaticConfiguration<span class="op">(</span>kind<span class="op">:</span> kind<span class="op">,</span> provider<span class="op">:</span> AIDJTimelineProvider<span class="op">())</span> <span class="op">{</span> entry <span class="cf">in</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>            AIDJWidgetEntryView<span class="op">(</span>entry<span class="op">:</span> entry<span class="op">)</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>containerBackground<span class="op">(.</span>fill<span class="op">.</span>tertiary<span class="op">,</span> <span class="cf">for</span><span class="op">:</span> <span class="op">.</span>widget<span class="op">)</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>configurationDisplayName<span class="op">(</span><span class="st">&quot;AI DJ&quot;</span><span class="op">)</span></span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>description<span class="op">(</span><span class="st">&quot;Shows what&#39;s playing and your current state&quot;</span><span class="op">)</span></span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>supportedFamilies<span class="op">([.</span>systemSmall<span class="op">,</span> <span class="op">.</span>systemMedium<span class="op">,</span> <span class="op">.</span>accessoryCircular<span class="op">,</span> <span class="op">.</span>accessoryRectangular<span class="op">])</span></span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="timeline-provider">Timeline Provider</h3>
<p><strong>What weâ€™re doing:</strong> Providing snapshots and timeline
entries for the widget.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AIDJTimelineProvider<span class="op">:</span> <span class="dt">TimelineProvider</span> <span class="op">{</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">typealias</span> Entry <span class="op">=</span> AIDJWidgetEntry</span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Placeholder shown while loading</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">placeholder</span><span class="op">(</span><span class="va">in</span> <span class="va">context</span><span class="op">:</span> <span class="dt">Context</span><span class="op">)</span> -&gt; <span class="fu">AIDJWidgetEntry</span> <span class="op">{</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>        AIDJWidgetEntry<span class="op">(</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>            date<span class="op">:</span> Date<span class="op">(),</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>            songTitle<span class="op">:</span> <span class="st">&quot;AI DJ&quot;</span><span class="op">,</span></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>            artist<span class="op">:</span> <span class="st">&quot;Select a song&quot;</span><span class="op">,</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>            heartRate<span class="op">:</span> <span class="dv">72</span><span class="op">,</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>            mood<span class="op">:</span> <span class="op">.</span>neutral</span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Quick snapshot for widget gallery</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">getSnapshot</span><span class="op">(</span><span class="va">in</span> <span class="va">context</span><span class="op">:</span> <span class="dt">Context</span><span class="op">,</span> <span class="va">completion</span><span class="op">:</span> @<span class="dt">escaping</span> (<span class="va">AIDJWidgetEntry</span><span class="op">)</span> -&gt; <span class="fu">Void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">entry</span> <span class="op">=</span> AIDJWidgetEntry<span class="op">(</span></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a>            date<span class="op">:</span> Date<span class="op">(),</span></span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a>            songTitle<span class="op">:</span> <span class="st">&quot;Calm Waves&quot;</span><span class="op">,</span></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a>            artist<span class="op">:</span> <span class="st">&quot;Relaxation Artist&quot;</span><span class="op">,</span></span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a>            heartRate<span class="op">:</span> <span class="dv">68</span><span class="op">,</span></span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a>            mood<span class="op">:</span> <span class="op">.</span>calm</span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a>        completion<span class="op">(</span>entry<span class="op">)</span></span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-27"><a href="#cb175-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Timeline of entries</span></span>
<span id="cb175-28"><a href="#cb175-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">getTimeline</span><span class="op">(</span><span class="va">in</span> <span class="va">context</span><span class="op">:</span> <span class="dt">Context</span><span class="op">,</span> <span class="va">completion</span><span class="op">:</span> @<span class="dt">escaping</span> (<span class="va">Timeline</span>&lt;<span class="va">AIDJWidgetEntry</span>&gt;<span class="op">)</span> -&gt; <span class="fu">Void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-29"><a href="#cb175-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read from shared container (App Groups)</span></span>
<span id="cb175-30"><a href="#cb175-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sharedDefaults</span> <span class="op">=</span> UserDefaults<span class="op">(</span>suiteName<span class="op">:</span> <span class="st">&quot;group.com.aidj.shared&quot;</span><span class="op">)</span></span>
<span id="cb175-31"><a href="#cb175-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-32"><a href="#cb175-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">entry</span> <span class="op">=</span> AIDJWidgetEntry<span class="op">(</span></span>
<span id="cb175-33"><a href="#cb175-33" aria-hidden="true" tabindex="-1"></a>            date<span class="op">:</span> Date<span class="op">(),</span></span>
<span id="cb175-34"><a href="#cb175-34" aria-hidden="true" tabindex="-1"></a>            songTitle<span class="op">:</span> sharedDefaults<span class="op">?.</span>string<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;nowPlayingTitle&quot;</span><span class="op">)</span> <span class="op">??</span> <span class="st">&quot;Not Playing&quot;</span><span class="op">,</span></span>
<span id="cb175-35"><a href="#cb175-35" aria-hidden="true" tabindex="-1"></a>            artist<span class="op">:</span> sharedDefaults<span class="op">?.</span>string<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;nowPlayingArtist&quot;</span><span class="op">)</span> <span class="op">??</span> <span class="st">&quot;&quot;</span><span class="op">,</span></span>
<span id="cb175-36"><a href="#cb175-36" aria-hidden="true" tabindex="-1"></a>            heartRate<span class="op">:</span> sharedDefaults<span class="op">?.</span>double<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;heartRate&quot;</span><span class="op">)</span> <span class="op">??</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb175-37"><a href="#cb175-37" aria-hidden="true" tabindex="-1"></a>            mood<span class="op">:</span> MusicMood<span class="op">(</span>rawValue<span class="op">:</span> sharedDefaults<span class="op">?.</span>string<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;mood&quot;</span><span class="op">)</span> <span class="op">??</span> <span class="st">&quot;&quot;</span><span class="op">)</span> <span class="op">??</span> <span class="op">.</span>neutral</span>
<span id="cb175-38"><a href="#cb175-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb175-39"><a href="#cb175-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-40"><a href="#cb175-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Refresh in 15 minutes</span></span>
<span id="cb175-41"><a href="#cb175-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">nextUpdate</span> <span class="op">=</span> Calendar<span class="op">.</span>current<span class="op">.</span>date<span class="op">(</span>byAdding<span class="op">:</span> <span class="op">.</span>minute<span class="op">,</span> value<span class="op">:</span> <span class="dv">15</span><span class="op">,</span> to<span class="op">:</span> Date<span class="op">())!</span></span>
<span id="cb175-42"><a href="#cb175-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">timeline</span> <span class="op">=</span> Timeline<span class="op">(</span>entries<span class="op">:</span> <span class="op">[</span>entry<span class="op">],</span> policy<span class="op">:</span> <span class="op">.</span>after<span class="op">(</span>nextUpdate<span class="op">))</span></span>
<span id="cb175-43"><a href="#cb175-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-44"><a href="#cb175-44" aria-hidden="true" tabindex="-1"></a>        completion<span class="op">(</span>timeline<span class="op">)</span></span>
<span id="cb175-45"><a href="#cb175-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb175-46"><a href="#cb175-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb175-47"><a href="#cb175-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-48"><a href="#cb175-48" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AIDJWidgetEntry<span class="op">:</span> <span class="dt">TimelineEntry</span> <span class="op">{</span></span>
<span id="cb175-49"><a href="#cb175-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">date</span><span class="op">:</span> Date</span>
<span id="cb175-50"><a href="#cb175-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">songTitle</span><span class="op">:</span> String</span>
<span id="cb175-51"><a href="#cb175-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">artist</span><span class="op">:</span> String</span>
<span id="cb175-52"><a href="#cb175-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRate</span><span class="op">:</span> Double</span>
<span id="cb175-53"><a href="#cb175-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">mood</span><span class="op">:</span> MusicMood</span>
<span id="cb175-54"><a href="#cb175-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="widget-views">Widget Views</h3>
<div class="sourceCode" id="cb176"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> AIDJWidgetEntryView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Environment</span><span class="op">(</span>\<span class="op">.</span>widgetFamily<span class="op">)</span> <span class="kw">var</span> <span class="va">family</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">entry</span><span class="op">:</span> AIDJTimelineProvider<span class="op">.</span>Entry</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> family <span class="op">{</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>systemSmall<span class="op">:</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>            SmallWidgetView<span class="op">(</span>entry<span class="op">:</span> entry<span class="op">)</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>systemMedium<span class="op">:</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>            MediumWidgetView<span class="op">(</span>entry<span class="op">:</span> entry<span class="op">)</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>accessoryCircular<span class="op">:</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a>            CircularWidgetView<span class="op">(</span>entry<span class="op">:</span> entry<span class="op">)</span></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>accessoryRectangular<span class="op">:</span></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>            RectangularWidgetView<span class="op">(</span>entry<span class="op">:</span> entry<span class="op">)</span></span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>            SmallWidgetView<span class="op">(</span>entry<span class="op">:</span> entry<span class="op">)</span></span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> SmallWidgetView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">entry</span><span class="op">:</span> AIDJWidgetEntry</span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-24"><a href="#cb176-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb176-25"><a href="#cb176-25" aria-hidden="true" tabindex="-1"></a>        VStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">,</span> spacing<span class="op">:</span> <span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb176-26"><a href="#cb176-26" aria-hidden="true" tabindex="-1"></a>            HStack <span class="op">{</span></span>
<span id="cb176-27"><a href="#cb176-27" aria-hidden="true" tabindex="-1"></a>                Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">)</span></span>
<span id="cb176-28"><a href="#cb176-28" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(</span>entry<span class="op">.</span>mood<span class="op">.</span>color<span class="op">)</span></span>
<span id="cb176-29"><a href="#cb176-29" aria-hidden="true" tabindex="-1"></a>                Spacer<span class="op">()</span></span>
<span id="cb176-30"><a href="#cb176-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> entry<span class="op">.</span>heartRate <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb176-31"><a href="#cb176-31" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(entry.heartRate))&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb176-32"><a href="#cb176-32" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>caption2<span class="op">)</span></span>
<span id="cb176-33"><a href="#cb176-33" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>foregroundStyle<span class="op">(.</span>red<span class="op">)</span></span>
<span id="cb176-34"><a href="#cb176-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb176-35"><a href="#cb176-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb176-36"><a href="#cb176-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-37"><a href="#cb176-37" aria-hidden="true" tabindex="-1"></a>            Spacer<span class="op">()</span></span>
<span id="cb176-38"><a href="#cb176-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-39"><a href="#cb176-39" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span>entry<span class="op">.</span>songTitle<span class="op">)</span></span>
<span id="cb176-40"><a href="#cb176-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>headline<span class="op">)</span></span>
<span id="cb176-41"><a href="#cb176-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>lineLimit<span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb176-42"><a href="#cb176-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-43"><a href="#cb176-43" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span>entry<span class="op">.</span>artist<span class="op">)</span></span>
<span id="cb176-44"><a href="#cb176-44" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb176-45"><a href="#cb176-45" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb176-46"><a href="#cb176-46" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>lineLimit<span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb176-47"><a href="#cb176-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb176-48"><a href="#cb176-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">()</span></span>
<span id="cb176-49"><a href="#cb176-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb176-50"><a href="#cb176-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb176-51"><a href="#cb176-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-52"><a href="#cb176-52" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> MediumWidgetView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb176-53"><a href="#cb176-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">entry</span><span class="op">:</span> AIDJWidgetEntry</span>
<span id="cb176-54"><a href="#cb176-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-55"><a href="#cb176-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb176-56"><a href="#cb176-56" aria-hidden="true" tabindex="-1"></a>        HStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">16</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb176-57"><a href="#cb176-57" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Album art placeholder</span></span>
<span id="cb176-58"><a href="#cb176-58" aria-hidden="true" tabindex="-1"></a>            RoundedRectangle<span class="op">(</span>cornerRadius<span class="op">:</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb176-59"><a href="#cb176-59" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>fill<span class="op">(</span>entry<span class="op">.</span>mood<span class="op">.</span>color<span class="op">.</span>opacity<span class="op">(</span><span class="fl">0.3</span><span class="op">))</span></span>
<span id="cb176-60"><a href="#cb176-60" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>frame<span class="op">(</span>width<span class="op">:</span> <span class="dv">80</span><span class="op">,</span> height<span class="op">:</span> <span class="dv">80</span><span class="op">)</span></span>
<span id="cb176-61"><a href="#cb176-61" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>overlay <span class="op">{</span></span>
<span id="cb176-62"><a href="#cb176-62" aria-hidden="true" tabindex="-1"></a>                    Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">)</span></span>
<span id="cb176-63"><a href="#cb176-63" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>title<span class="op">)</span></span>
<span id="cb176-64"><a href="#cb176-64" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>foregroundStyle<span class="op">(</span>entry<span class="op">.</span>mood<span class="op">.</span>color<span class="op">)</span></span>
<span id="cb176-65"><a href="#cb176-65" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb176-66"><a href="#cb176-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-67"><a href="#cb176-67" aria-hidden="true" tabindex="-1"></a>            VStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">,</span> spacing<span class="op">:</span> <span class="dv">4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb176-68"><a href="#cb176-68" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>entry<span class="op">.</span>songTitle<span class="op">)</span></span>
<span id="cb176-69"><a href="#cb176-69" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>headline<span class="op">)</span></span>
<span id="cb176-70"><a href="#cb176-70" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>lineLimit<span class="op">(</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb176-71"><a href="#cb176-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-72"><a href="#cb176-72" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>entry<span class="op">.</span>artist<span class="op">)</span></span>
<span id="cb176-73"><a href="#cb176-73" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>subheadline<span class="op">)</span></span>
<span id="cb176-74"><a href="#cb176-74" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb176-75"><a href="#cb176-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-76"><a href="#cb176-76" aria-hidden="true" tabindex="-1"></a>                Spacer<span class="op">()</span></span>
<span id="cb176-77"><a href="#cb176-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-78"><a href="#cb176-78" aria-hidden="true" tabindex="-1"></a>                HStack <span class="op">{</span></span>
<span id="cb176-79"><a href="#cb176-79" aria-hidden="true" tabindex="-1"></a>                    Label<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(entry.heartRate)) BPM&quot;</span><span class="op">,</span> systemImage<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb176-80"><a href="#cb176-80" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>foregroundStyle<span class="op">(.</span>red<span class="op">)</span></span>
<span id="cb176-81"><a href="#cb176-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-82"><a href="#cb176-82" aria-hidden="true" tabindex="-1"></a>                    Spacer<span class="op">()</span></span>
<span id="cb176-83"><a href="#cb176-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-84"><a href="#cb176-84" aria-hidden="true" tabindex="-1"></a>                    Text<span class="op">(</span>entry<span class="op">.</span>mood<span class="op">.</span>displayName<span class="op">)</span></span>
<span id="cb176-85"><a href="#cb176-85" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb176-86"><a href="#cb176-86" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>padding<span class="op">(.</span>horizontal<span class="op">,</span> <span class="dv">8</span><span class="op">)</span></span>
<span id="cb176-87"><a href="#cb176-87" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>padding<span class="op">(.</span>vertical<span class="op">,</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="cb176-88"><a href="#cb176-88" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>background<span class="op">(</span>entry<span class="op">.</span>mood<span class="op">.</span>color<span class="op">.</span>opacity<span class="op">(</span><span class="fl">0.2</span><span class="op">))</span></span>
<span id="cb176-89"><a href="#cb176-89" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>clipShape<span class="op">(</span>Capsule<span class="op">())</span></span>
<span id="cb176-90"><a href="#cb176-90" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb176-91"><a href="#cb176-91" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb176-92"><a href="#cb176-92" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb176-93"><a href="#cb176-93" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb176-94"><a href="#cb176-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>padding<span class="op">()</span></span>
<span id="cb176-95"><a href="#cb176-95" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb176-96"><a href="#cb176-96" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb176-97"><a href="#cb176-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-98"><a href="#cb176-98" aria-hidden="true" tabindex="-1"></a><span class="co">// Lock screen widget</span></span>
<span id="cb176-99"><a href="#cb176-99" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> CircularWidgetView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb176-100"><a href="#cb176-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">entry</span><span class="op">:</span> AIDJWidgetEntry</span>
<span id="cb176-101"><a href="#cb176-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-102"><a href="#cb176-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb176-103"><a href="#cb176-103" aria-hidden="true" tabindex="-1"></a>        Gauge<span class="op">(</span>value<span class="op">:</span> entry<span class="op">.</span>heartRate<span class="op">,</span> <span class="cf">in</span><span class="op">:</span> <span class="fl">40.</span><span class="op">.</span><span class="fl">.180</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb176-104"><a href="#cb176-104" aria-hidden="true" tabindex="-1"></a>            Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb176-105"><a href="#cb176-105" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> currentValueLabel<span class="op">:</span> <span class="op">{</span></span>
<span id="cb176-106"><a href="#cb176-106" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(entry.heartRate))&quot;</span><span class="op">)</span></span>
<span id="cb176-107"><a href="#cb176-107" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb176-108"><a href="#cb176-108" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>gaugeStyle<span class="op">(.</span>accessoryCircular<span class="op">)</span></span>
<span id="cb176-109"><a href="#cb176-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb176-110"><a href="#cb176-110" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb176-111"><a href="#cb176-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-112"><a href="#cb176-112" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> RectangularWidgetView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb176-113"><a href="#cb176-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">entry</span><span class="op">:</span> AIDJWidgetEntry</span>
<span id="cb176-114"><a href="#cb176-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-115"><a href="#cb176-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb176-116"><a href="#cb176-116" aria-hidden="true" tabindex="-1"></a>        VStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">)</span> <span class="op">{</span></span>
<span id="cb176-117"><a href="#cb176-117" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span>entry<span class="op">.</span>songTitle<span class="op">)</span></span>
<span id="cb176-118"><a href="#cb176-118" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>headline<span class="op">)</span></span>
<span id="cb176-119"><a href="#cb176-119" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>lineLimit<span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb176-120"><a href="#cb176-120" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span>entry<span class="op">.</span>artist<span class="op">)</span></span>
<span id="cb176-121"><a href="#cb176-121" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb176-122"><a href="#cb176-122" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>foregroundStyle<span class="op">(.</span>secondary<span class="op">)</span></span>
<span id="cb176-123"><a href="#cb176-123" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb176-124"><a href="#cb176-124" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb176-125"><a href="#cb176-125" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="updating-widgets-from-main-app">Updating Widgets from Main
App</h3>
<div class="sourceCode" id="cb177"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In main app, when song changes</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">updateWidget</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Write to shared container</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">sharedDefaults</span> <span class="op">=</span> UserDefaults<span class="op">(</span>suiteName<span class="op">:</span> <span class="st">&quot;group.com.aidj.shared&quot;</span><span class="op">)</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>    sharedDefaults<span class="op">?.</span><span class="kw">set</span><span class="op">(</span>currentSong<span class="op">.</span>title<span class="op">,</span> forKey<span class="op">:</span> <span class="st">&quot;nowPlayingTitle&quot;</span><span class="op">)</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>    sharedDefaults<span class="op">?.</span><span class="kw">set</span><span class="op">(</span>currentSong<span class="op">.</span>artist<span class="op">,</span> forKey<span class="op">:</span> <span class="st">&quot;nowPlayingArtist&quot;</span><span class="op">)</span></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>    sharedDefaults<span class="op">?.</span><span class="kw">set</span><span class="op">(</span>currentHeartRate<span class="op">,</span> forKey<span class="op">:</span> <span class="st">&quot;heartRate&quot;</span><span class="op">)</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>    sharedDefaults<span class="op">?.</span><span class="kw">set</span><span class="op">(</span>currentMood<span class="op">.</span>rawValue<span class="op">,</span> forKey<span class="op">:</span> <span class="st">&quot;mood&quot;</span><span class="op">)</span></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Tell WidgetKit to refresh</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a>    WidgetCenter<span class="op">.</span>shared<span class="op">.</span>reloadAllTimelines<span class="op">()</span></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="watch-complications">13.2 Watch Complications</h2>
<h3 id="clockkit-complications">ClockKit Complications</h3>
<p><strong>What weâ€™re doing:</strong> Displaying AI DJ info on the Watch
face.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">ClockKit</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">SwiftUI</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ComplicationController<span class="op">:</span> <span class="dt">NSObject</span><span class="op">,</span> <span class="dt">CLKComplicationDataSource</span> <span class="op">{</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Current data</span></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">currentTimelineEntry</span><span class="op">(</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">for</span> <span class="va">complication</span><span class="op">:</span> <span class="dt">CLKComplication</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="fu">async</span> -&gt; <span class="fu">CLKComplicationTimelineEntry</span>? <span class="op">{</span></span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">template</span> <span class="op">=</span> makeTemplate<span class="op">(</span><span class="cf">for</span><span class="op">:</span> complication<span class="op">.</span>family<span class="op">)</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> CLKComplicationTimelineEntry<span class="op">(</span>date<span class="op">:</span> Date<span class="op">(),</span> complicationTemplate<span class="op">:</span> template<span class="op">)</span></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Placeholder</span></span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">getLocalizableSampleTemplate</span><span class="op">(</span></span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">for</span> <span class="va">complication</span><span class="op">:</span> <span class="dt">CLKComplication</span></span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="fu">async</span> -&gt; <span class="fu">CLKComplicationTemplate</span>? <span class="op">{</span></span>
<span id="cb178-18"><a href="#cb178-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> makeTemplate<span class="op">(</span><span class="cf">for</span><span class="op">:</span> complication<span class="op">.</span>family<span class="op">)</span></span>
<span id="cb178-19"><a href="#cb178-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb178-20"><a href="#cb178-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-21"><a href="#cb178-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">makeTemplate</span><span class="op">(</span><span class="va">for</span> <span class="va">family</span><span class="op">:</span> <span class="dt">CLKComplicationFamily</span><span class="op">)</span> -&gt; <span class="fu">CLKComplicationTemplate</span> <span class="op">{</span></span>
<span id="cb178-22"><a href="#cb178-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get data from shared storage</span></span>
<span id="cb178-23"><a href="#cb178-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRate</span> <span class="op">=</span> UserDefaults<span class="op">.</span>standard<span class="op">.</span>double<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;heartRate&quot;</span><span class="op">)</span></span>
<span id="cb178-24"><a href="#cb178-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">songTitle</span> <span class="op">=</span> UserDefaults<span class="op">.</span>standard<span class="op">.</span>string<span class="op">(</span>forKey<span class="op">:</span> <span class="st">&quot;songTitle&quot;</span><span class="op">)</span> <span class="op">??</span> <span class="st">&quot;AI DJ&quot;</span></span>
<span id="cb178-25"><a href="#cb178-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-26"><a href="#cb178-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> family <span class="op">{</span></span>
<span id="cb178-27"><a href="#cb178-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>circularSmall<span class="op">:</span></span>
<span id="cb178-28"><a href="#cb178-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> CLKComplicationTemplateCircularSmallSimpleImage<span class="op">(</span></span>
<span id="cb178-29"><a href="#cb178-29" aria-hidden="true" tabindex="-1"></a>                imageProvider<span class="op">:</span> CLKImageProvider<span class="op">(</span>onePieceImage<span class="op">:</span> UIImage<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)!)</span></span>
<span id="cb178-30"><a href="#cb178-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb178-31"><a href="#cb178-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-32"><a href="#cb178-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>graphicCircular<span class="op">:</span></span>
<span id="cb178-33"><a href="#cb178-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> CLKComplicationTemplateGraphicCircularView<span class="op">(</span></span>
<span id="cb178-34"><a href="#cb178-34" aria-hidden="true" tabindex="-1"></a>                ComplicationCircularView<span class="op">(</span>heartRate<span class="op">:</span> heartRate<span class="op">)</span></span>
<span id="cb178-35"><a href="#cb178-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb178-36"><a href="#cb178-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-37"><a href="#cb178-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>graphicRectangular<span class="op">:</span></span>
<span id="cb178-38"><a href="#cb178-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> CLKComplicationTemplateGraphicRectangularFullView<span class="op">(</span></span>
<span id="cb178-39"><a href="#cb178-39" aria-hidden="true" tabindex="-1"></a>                ComplicationRectangularView<span class="op">(</span>songTitle<span class="op">:</span> songTitle<span class="op">,</span> heartRate<span class="op">:</span> heartRate<span class="op">)</span></span>
<span id="cb178-40"><a href="#cb178-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb178-41"><a href="#cb178-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-42"><a href="#cb178-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb178-43"><a href="#cb178-43" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> CLKComplicationTemplateCircularSmallSimpleImage<span class="op">(</span></span>
<span id="cb178-44"><a href="#cb178-44" aria-hidden="true" tabindex="-1"></a>                imageProvider<span class="op">:</span> CLKImageProvider<span class="op">(</span>onePieceImage<span class="op">:</span> UIImage<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">)!)</span></span>
<span id="cb178-45"><a href="#cb178-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb178-46"><a href="#cb178-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb178-47"><a href="#cb178-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb178-48"><a href="#cb178-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb178-49"><a href="#cb178-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-50"><a href="#cb178-50" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ComplicationCircularView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb178-51"><a href="#cb178-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRate</span><span class="op">:</span> Double</span>
<span id="cb178-52"><a href="#cb178-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-53"><a href="#cb178-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb178-54"><a href="#cb178-54" aria-hidden="true" tabindex="-1"></a>        Gauge<span class="op">(</span>value<span class="op">:</span> heartRate<span class="op">,</span> <span class="cf">in</span><span class="op">:</span> <span class="fl">40.</span><span class="op">.</span><span class="fl">.180</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb178-55"><a href="#cb178-55" aria-hidden="true" tabindex="-1"></a>            Image<span class="op">(</span>systemName<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">)</span></span>
<span id="cb178-56"><a href="#cb178-56" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>foregroundStyle<span class="op">(.</span>red<span class="op">)</span></span>
<span id="cb178-57"><a href="#cb178-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb178-58"><a href="#cb178-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>gaugeStyle<span class="op">(.</span>accessoryCircular<span class="op">)</span></span>
<span id="cb178-59"><a href="#cb178-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb178-60"><a href="#cb178-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb178-61"><a href="#cb178-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-62"><a href="#cb178-62" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ComplicationRectangularView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb178-63"><a href="#cb178-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">songTitle</span><span class="op">:</span> String</span>
<span id="cb178-64"><a href="#cb178-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRate</span><span class="op">:</span> Double</span>
<span id="cb178-65"><a href="#cb178-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-66"><a href="#cb178-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb178-67"><a href="#cb178-67" aria-hidden="true" tabindex="-1"></a>        HStack <span class="op">{</span></span>
<span id="cb178-68"><a href="#cb178-68" aria-hidden="true" tabindex="-1"></a>            VStack<span class="op">(</span>alignment<span class="op">:</span> <span class="op">.</span>leading<span class="op">)</span> <span class="op">{</span></span>
<span id="cb178-69"><a href="#cb178-69" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span>songTitle<span class="op">)</span></span>
<span id="cb178-70"><a href="#cb178-70" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>headline<span class="op">)</span></span>
<span id="cb178-71"><a href="#cb178-71" aria-hidden="true" tabindex="-1"></a>                Text<span class="op">(</span><span class="st">&quot;</span><span class="er">\(</span><span class="st">Int(heartRate)) BPM&quot;</span><span class="op">)</span></span>
<span id="cb178-72"><a href="#cb178-72" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>font<span class="op">(.</span>caption<span class="op">)</span></span>
<span id="cb178-73"><a href="#cb178-73" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>foregroundStyle<span class="op">(.</span>red<span class="op">)</span></span>
<span id="cb178-74"><a href="#cb178-74" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb178-75"><a href="#cb178-75" aria-hidden="true" tabindex="-1"></a>            Spacer<span class="op">()</span></span>
<span id="cb178-76"><a href="#cb178-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb178-77"><a href="#cb178-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb178-78"><a href="#cb178-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---widgets-complications">Key Takeaways - Widgets
&amp; Complications</h2>
<ol type="1">
<li><strong>Widgets are snapshots</strong> - Not interactive apps, just
views</li>
<li><strong>Timeline provider gives entries</strong> - WidgetKit calls
for updates</li>
<li><strong>Use App Groups for shared data</strong> - Main app writes,
widget reads</li>
<li><strong>Call reloadAllTimelines()</strong> - When data changes in
main app</li>
<li><strong>Support multiple families</strong> - Small, medium, lock
screen</li>
<li><strong>Complications use ClockKit</strong> - Similar concept for
Watch faces</li>
</ol>
<hr />
<h1 id="biometrics-signal-processing">14. BIOMETRICS &amp; SIGNAL
PROCESSING</h1>
<h2 id="why-this-matters-for-ai-dj-13">Why This Matters for AI DJ</h2>
<p>Raw heart rate and HRV numbers are just dataâ€”meaningless without
interpretation. A heart rate of 90 BPM might be â€œelevatedâ€ for one
person but â€œrestingâ€ for another. To make intelligent music decisions,
AI DJ must transform raw sensor readings into meaningful user state
classifications, and this requires understanding both the physiology
behind the numbers and the mathematics of signal processing.</p>
<p>This section covers two interconnected domains:
<strong>biometrics</strong> (the science of what heart rate and HRV
actually mean physiologically) and <strong>signal processing</strong>
(the mathematical techniques for cleaning noisy data, detecting trends,
and making reliable classifications). These concepts draw on resources
like the <a href="https://elitehrv.com/what-is-heart-rate-variability">Elite HRV
Knowledge Base</a> for physiological understanding and <a href="https://www.khanacademy.org/math/statistics-probability">Khan
Academyâ€™s Statistics courses</a> for the mathematical foundations.</p>
<p><strong>In AI DJ, biometric processing includes:</strong> -
Establishing personal baselines (critical for accurate interpretation) -
Smoothing noisy sensor data (removing random fluctuations) - Detecting
trends and anomalies (is the user calming down or getting more
stressed?) - Classifying user states (mapping numbers to actionable
categories)</p>
<hr />
<h2 id="heart-rate-fundamentals">14.1 Heart Rate Fundamentals</h2>
<p>Heart rate is the number of times your heart beats per minute (BPM).
Itâ€™s controlled by the autonomic nervous system (ANS), which has two
branches: the <strong>sympathetic</strong> (fight-or-flight, increases
HR) and <strong>parasympathetic</strong> (rest-and-digest, decreases
HR). Understanding this is key to AI DJâ€™s logic: when someone is
stressed, their sympathetic system is activated, raising heart rate.
Calming music may help activate the parasympathetic response.</p>
<p><strong>Key physiological facts:</strong> - <strong>Resting heart
rate</strong>: 60-100 BPM for most adults; athletes may be 40-60 BPM -
<strong>Maximum heart rate</strong>: Roughly 220 minus age (e.g., 190
BPM for a 30-year-old) - <strong>Response time</strong>: Heart rate
changes within seconds of stimulus changes - <strong>Individual
variation</strong>: Whatâ€™s â€œhighâ€ for one person is â€œnormalâ€ for
anotherâ€”baselines are essential</p>
<h3 id="understanding-heart-rate">Understanding Heart Rate</h3>
<p>Population averages are useful starting points, but personalized
baselines are far more accurate. A trained athlete with a resting HR of
50 BPM is in a very different state at 90 BPM (80% elevation) than an
untrained person with resting HR of 75 BPM at the same 90 BPM (only 20%
elevation). AI DJ should classify based on deviation from personal
baseline, not absolute values.</p>
<p><strong>What weâ€™re doing:</strong> Building a classification system
that interprets heart rate relative to a userâ€™s personal baseline rather
than using absolute thresholds.</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> HeartRateAnalyzer <span class="op">{</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Population averages (will be personalized)</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Baselines <span class="op">{</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">static</span> <span class="kw">let</span> <span class="va">restingHR</span><span class="op">:</span> ClosedRange<span class="op">&lt;</span>Double<span class="op">&gt;</span> <span class="op">=</span> <span class="fl">60.</span><span class="op">.</span><span class="fl">.100</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">static</span> <span class="kw">let</span> <span class="va">athleteRestingHR</span><span class="op">:</span> ClosedRange<span class="op">&lt;</span>Double<span class="op">&gt;</span> <span class="op">=</span> <span class="fl">40.</span><span class="op">.</span><span class="fl">.60</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">static</span> <span class="kw">let</span> <span class="va">elevatedHR</span><span class="op">:</span> Double <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">static</span> <span class="kw">let</span> <span class="va">maxHR</span><span class="op">:</span> <span class="op">(</span>age<span class="op">:</span> Int<span class="op">)</span> <span class="op">-&gt;</span> Double <span class="op">=</span> <span class="op">{</span> age <span class="cf">in</span> Double<span class="op">(</span><span class="dv">220</span> <span class="op">-</span> age<span class="op">)</span> <span class="op">}</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Interpret a single reading</span></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">classify</span><span class="op">(</span><span class="va">_</span> <span class="va">heartRate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="va">baseline</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">HeartRateZone</span> <span class="op">{</span></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">percentOfBaseline</span> <span class="op">=</span> heartRate <span class="op">/</span> baseline</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> percentOfBaseline <span class="op">{</span></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">..&lt;</span><span class="fl">0.9</span><span class="op">:</span></span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>belowBaseline  <span class="co">// Very relaxed or cold</span></span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">0.9</span><span class="op">..&lt;</span><span class="fl">1.1</span><span class="op">:</span></span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>baseline       <span class="co">// Normal resting</span></span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">1.1</span><span class="op">..&lt;</span><span class="fl">1.3</span><span class="op">:</span></span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>slightlyElevated  <span class="co">// Light activity or mild stress</span></span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">1.3</span><span class="op">..&lt;</span><span class="fl">1.6</span><span class="op">:</span></span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>elevated       <span class="co">// Moderate activity or stress</span></span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">1.6</span><span class="op">..&lt;</span><span class="fl">1.8</span><span class="op">:</span></span>
<span id="cb179-24"><a href="#cb179-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>high           <span class="co">// Intense activity or high stress</span></span>
<span id="cb179-25"><a href="#cb179-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb179-26"><a href="#cb179-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>veryHigh       <span class="co">// Near max HR</span></span>
<span id="cb179-27"><a href="#cb179-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb179-28"><a href="#cb179-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb179-29"><a href="#cb179-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb179-30"><a href="#cb179-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-31"><a href="#cb179-31" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> HeartRateZone<span class="op">:</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb179-32"><a href="#cb179-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> belowBaseline <span class="op">=</span> <span class="st">&quot;Below Baseline&quot;</span></span>
<span id="cb179-33"><a href="#cb179-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> baseline <span class="op">=</span> <span class="st">&quot;Baseline&quot;</span></span>
<span id="cb179-34"><a href="#cb179-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> slightlyElevated <span class="op">=</span> <span class="st">&quot;Slightly Elevated&quot;</span></span>
<span id="cb179-35"><a href="#cb179-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> elevated <span class="op">=</span> <span class="st">&quot;Elevated&quot;</span></span>
<span id="cb179-36"><a href="#cb179-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> high <span class="op">=</span> <span class="st">&quot;High&quot;</span></span>
<span id="cb179-37"><a href="#cb179-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> veryHigh <span class="op">=</span> <span class="st">&quot;Very High&quot;</span></span>
<span id="cb179-38"><a href="#cb179-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-39"><a href="#cb179-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">suggestedMusicEnergy</span><span class="op">:</span> Double <span class="op">{</span></span>
<span id="cb179-40"><a href="#cb179-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb179-41"><a href="#cb179-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>belowBaseline<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.4</span>    <span class="co">// Gentle, can energize slightly</span></span>
<span id="cb179-42"><a href="#cb179-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>baseline<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.5</span>          <span class="co">// Neutral</span></span>
<span id="cb179-43"><a href="#cb179-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>slightlyElevated<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.5</span>  <span class="co">// Maintain</span></span>
<span id="cb179-44"><a href="#cb179-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>elevated<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.3</span>          <span class="co">// Start calming</span></span>
<span id="cb179-45"><a href="#cb179-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>high<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.2</span>              <span class="co">// Strongly calming</span></span>
<span id="cb179-46"><a href="#cb179-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>veryHigh<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.1</span>          <span class="co">// Very calming</span></span>
<span id="cb179-47"><a href="#cb179-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb179-48"><a href="#cb179-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb179-49"><a href="#cb179-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="heart-rate-variability-hrv-1">Heart Rate Variability (HRV)</h3>
<p>Heart Rate Variability is arguably the most valuable biometric for AI
DJ because it directly reflects the balance between sympathetic (stress)
and parasympathetic (relaxation) nervous system activity. Unlike heart
rate, which can be elevated by both physical exercise and psychological
stress, HRV specifically reflects <strong>autonomic
balance</strong>â€”making it excellent for detecting mental/emotional
stress.</p>
<p><strong>The science explained:</strong> Your heart doesnâ€™t beat like
a metronome. Even at rest, thereâ€™s natural variation in the time between
beats (the â€œRR intervalsâ€). A healthy, relaxed nervous system produces
<strong>high variability</strong>â€”the parasympathetic system modulates
heart rate breath-by-breath. When stressed, the sympathetic system
dominates with steady adrenaline output, producing <strong>low
variability</strong>â€”the heart beats more mechanically.</p>
<p><strong>SDNN</strong> (Standard Deviation of NN intervals) is the HRV
metric Apple Watch reports. Itâ€™s the standard deviation of the time
intervals between normal heartbeats, measured in milliseconds. Typical
values range from 20-80ms, though this varies dramatically by age,
fitness, and individual physiology.</p>
<p><strong>Critical insight</strong>: HRV is even more individual than
heart rate. An HRV of 40ms might indicate relaxation for one person and
stress for another. Personal baselines are essential, and we use
z-scores (standard deviations from personal mean) for
classification.</p>
<p><strong>What weâ€™re doing:</strong> Classifying stress levels based on
how the current HRV reading compares to the userâ€™s personal baseline
using statistical z-scores.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> HRVAnalyzer <span class="op">{</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a><span class="co">    HRV = variation in time between heartbeats</span></span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Higher HRV = more adaptable nervous system = relaxed</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Lower HRV = less variation = stressed or fatigued</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Apple Watch reports SDNN (standard deviation of NN intervals)</span></span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Typical values: 20-80 ms</span></span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a><span class="co">    We use z-scores for classification:</span></span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a><span class="co">    z = (current - mean) / stdDev</span></span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Positive z = above average (more relaxed than usual)</span></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Negative z = below average (more stressed than usual)</span></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// HRV is highly individual - must establish baseline</span></span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">establishBaseline</span><span class="op">(</span><span class="va">from</span> <span class="va">samples</span><span class="op">:</span> [<span class="dt">Double</span>]<span class="op">)</span> -&gt; <span class="fu">HRVBaseline</span> <span class="op">{</span></span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="op">!</span>samples<span class="op">.</span>isEmpty <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> HRVBaseline<span class="op">(</span>mean<span class="op">:</span> <span class="dv">50</span><span class="op">,</span> stdDev<span class="op">:</span> <span class="dv">15</span><span class="op">)</span> <span class="co">// Population default</span></span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb180-21"><a href="#cb180-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-22"><a href="#cb180-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">mean</span> <span class="op">=</span> samples<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span> <span class="op">/</span> Double<span class="op">(</span>samples<span class="op">.</span>count<span class="op">)</span></span>
<span id="cb180-23"><a href="#cb180-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-24"><a href="#cb180-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">variance</span> <span class="op">=</span> samples<span class="op">.</span>map <span class="op">{</span> pow<span class="op">(</span>$<span class="dv">0</span> <span class="op">-</span> mean<span class="op">,</span> <span class="dv">2</span><span class="op">)</span> <span class="op">}.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span> <span class="op">/</span> Double<span class="op">(</span>samples<span class="op">.</span>count<span class="op">)</span></span>
<span id="cb180-25"><a href="#cb180-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">stdDev</span> <span class="op">=</span> sqrt<span class="op">(</span>variance<span class="op">)</span></span>
<span id="cb180-26"><a href="#cb180-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-27"><a href="#cb180-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> HRVBaseline<span class="op">(</span>mean<span class="op">:</span> mean<span class="op">,</span> stdDev<span class="op">:</span> stdDev<span class="op">)</span></span>
<span id="cb180-28"><a href="#cb180-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb180-29"><a href="#cb180-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-30"><a href="#cb180-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">classify</span><span class="op">(</span><span class="va">_</span> <span class="va">hrv</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="va">baseline</span><span class="op">:</span> <span class="dt">HRVBaseline</span><span class="op">)</span> -&gt; <span class="fu">StressLevel</span> <span class="op">{</span></span>
<span id="cb180-31"><a href="#cb180-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">zScore</span> <span class="op">=</span> <span class="op">(</span>hrv <span class="op">-</span> baseline<span class="op">.</span>mean<span class="op">)</span> <span class="op">/</span> baseline<span class="op">.</span>stdDev</span>
<span id="cb180-32"><a href="#cb180-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-33"><a href="#cb180-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> zScore <span class="op">{</span></span>
<span id="cb180-34"><a href="#cb180-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">1.</span><span class="op">..:</span></span>
<span id="cb180-35"><a href="#cb180-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>veryLow     <span class="co">// HRV above average = very relaxed</span></span>
<span id="cb180-36"><a href="#cb180-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">0.</span><span class="op">.&lt;</span><span class="dv">1</span><span class="op">:</span></span>
<span id="cb180-37"><a href="#cb180-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>low         <span class="co">// HRV slightly above average = relaxed</span></span>
<span id="cb180-38"><a href="#cb180-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">-</span><span class="fl">1.</span><span class="op">.&lt;</span><span class="dv">0</span><span class="op">:</span></span>
<span id="cb180-39"><a href="#cb180-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>moderate    <span class="co">// HRV slightly below = mild stress</span></span>
<span id="cb180-40"><a href="#cb180-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">-</span><span class="fl">2.</span><span class="op">.&lt;(-</span><span class="dv">1</span><span class="op">):</span></span>
<span id="cb180-41"><a href="#cb180-41" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>high        <span class="co">// HRV well below = stressed</span></span>
<span id="cb180-42"><a href="#cb180-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb180-43"><a href="#cb180-43" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>veryHigh    <span class="co">// HRV very low = very stressed or fatigued</span></span>
<span id="cb180-44"><a href="#cb180-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb180-45"><a href="#cb180-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb180-46"><a href="#cb180-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb180-47"><a href="#cb180-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-48"><a href="#cb180-48" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> HRVBaseline <span class="op">{</span></span>
<span id="cb180-49"><a href="#cb180-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">mean</span><span class="op">:</span> Double</span>
<span id="cb180-50"><a href="#cb180-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">stdDev</span><span class="op">:</span> Double</span>
<span id="cb180-51"><a href="#cb180-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb180-52"><a href="#cb180-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-53"><a href="#cb180-53" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> StressLevel<span class="op">:</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb180-54"><a href="#cb180-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> veryLow <span class="op">=</span> <span class="st">&quot;Very Relaxed&quot;</span></span>
<span id="cb180-55"><a href="#cb180-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> low <span class="op">=</span> <span class="st">&quot;Relaxed&quot;</span></span>
<span id="cb180-56"><a href="#cb180-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> moderate <span class="op">=</span> <span class="st">&quot;Moderate&quot;</span></span>
<span id="cb180-57"><a href="#cb180-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> high <span class="op">=</span> <span class="st">&quot;Stressed&quot;</span></span>
<span id="cb180-58"><a href="#cb180-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> veryHigh <span class="op">=</span> <span class="st">&quot;Very Stressed&quot;</span></span>
<span id="cb180-59"><a href="#cb180-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-60"><a href="#cb180-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">needsCalming</span><span class="op">:</span> Bool <span class="op">{</span></span>
<span id="cb180-61"><a href="#cb180-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span> <span class="op">==</span> <span class="op">.</span>high <span class="op">||</span> <span class="kw">self</span> <span class="op">==</span> <span class="op">.</span>veryHigh</span>
<span id="cb180-62"><a href="#cb180-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb180-63"><a href="#cb180-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="signal-processing">14.2 Signal Processing</h2>
<p>Signal processing is the mathematical discipline of extracting useful
information from noisy data. Apple Watch sensors are remarkably
accurate, but all sensors have some noiseâ€”random fluctuations that donâ€™t
reflect actual physiological changes. Without smoothing, a heart rate
stream might jump from 72 to 78 to 71 to 75, making it hard to determine
the â€œtrueâ€ value or detect genuine trends.</p>
<p>We use two fundamental techniques: <strong>moving averages</strong>
(for smoothing) and <strong>linear regression</strong> (for trend
detection). These are simple enough to implement efficiently on-device
while being powerful enough for our needs.</p>
<h3 id="moving-average-smoothing">Moving Average (Smoothing)</h3>
<p>A moving average replaces each data point with the average of itself
and its neighbors. This reduces noise while preserving the overall
signal shape. There are two common variants:</p>
<p><strong>Simple Moving Average (SMA)</strong>: Average of the last N
values. Easy to understand but gives equal weight to all values in the
window, and older readings affect the result as much as recent ones.</p>
<p><strong>Exponential Moving Average (EMA)</strong>: Weighted average
where recent values have exponentially more influence. Controlled by
alpha (Î±), the â€œsmoothing factor.â€ Higher Î± = more responsive to recent
changes but less smoothing. Lower Î± = smoother but slower to react.</p>
<p>The EMA formula is:
<code>EMA_today = Î± Ã— value_today + (1-Î±) Ã— EMA_yesterday</code></p>
<p>For heart rate, Î± = 0.3 works wellâ€”responsive enough to detect
changes within a few readings, smooth enough to filter single-reading
spikes.</p>
<p><strong>What weâ€™re doing:</strong> Removing random noise from sensor
readings while preserving genuine physiological changes. This produces
cleaner data for trend detection and classification.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SignalProcessor <span class="op">{</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simple moving average</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">movingAverage</span><span class="op">(</span><span class="va">_</span> <span class="va">values</span><span class="op">:</span> [<span class="dt">Double</span>]<span class="op">,</span> <span class="va">windowSize</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; [<span class="fu">Double</span>] <span class="op">{</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> values<span class="op">.</span>count <span class="op">&gt;=</span> windowSize <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> values <span class="op">}</span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">result</span><span class="op">:</span> <span class="op">[</span>Double<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="cf">in</span> <span class="fl">0.</span><span class="op">..(</span>values<span class="op">.</span>count <span class="op">-</span> windowSize<span class="op">)</span> <span class="op">{</span></span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">window</span> <span class="op">=</span> values<span class="op">[</span>i<span class="op">..&lt;(</span>i <span class="op">+</span> windowSize<span class="op">)]</span></span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">average</span> <span class="op">=</span> window<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span> <span class="op">/</span> Double<span class="op">(</span>windowSize<span class="op">)</span></span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>            result<span class="op">.</span>append<span class="op">(</span>average<span class="op">)</span></span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> result</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Exponential moving average (weights recent values more)</span></span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">exponentialMovingAverage</span><span class="op">(</span><span class="va">_</span> <span class="va">values</span><span class="op">:</span> [<span class="dt">Double</span>]<span class="op">,</span> <span class="va">alpha</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> -&gt; [<span class="fu">Double</span>] <span class="op">{</span></span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="op">!</span>values<span class="op">.</span>isEmpty <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">[]</span> <span class="op">}</span></span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">result</span><span class="op">:</span> <span class="op">[</span>Double<span class="op">]</span> <span class="op">=</span> <span class="op">[</span>values<span class="op">[</span><span class="dv">0</span><span class="op">]]</span></span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="cf">in</span> <span class="fl">1.</span><span class="op">.&lt;</span>values<span class="op">.</span>count <span class="op">{</span></span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">ema</span> <span class="op">=</span> alpha <span class="op">*</span> values<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> <span class="op">(</span><span class="dv">1</span> <span class="op">-</span> alpha<span class="op">)</span> <span class="op">*</span> result<span class="op">[</span>i <span class="op">-</span> <span class="dv">1</span><span class="op">]</span></span>
<span id="cb181-25"><a href="#cb181-25" aria-hidden="true" tabindex="-1"></a>            result<span class="op">.</span>append<span class="op">(</span>ema<span class="op">)</span></span>
<span id="cb181-26"><a href="#cb181-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb181-27"><a href="#cb181-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-28"><a href="#cb181-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> result</span>
<span id="cb181-29"><a href="#cb181-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb181-30"><a href="#cb181-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="trend-detection">Trend Detection</h3>
<p>Knowing the current value isnâ€™t enoughâ€”we need to know the
<strong>direction</strong>. Is heart rate rising (indicating increasing
stress or activity) or falling (indicating the user is calming down)?
This influences song selection: a falling HR might mean the current
calming music is working and we should continue the approach, while a
rising HR might signal the need for a different strategy.</p>
<p>We implement two trend detection approaches:</p>
<p><strong>Split-half comparison</strong>: Divide recent samples into
â€œolderâ€ and â€œnewerâ€ halves, compare their averages. Simple and robust,
but only gives coarse direction (rising/falling/stable).</p>
<p><strong>Linear regression</strong>: Fit a straight line through the
data points and examine the slope. Mathematically rigorous, gives a
continuous measure of how fast values are changing. A slope of +2 means
â€œrising by 2 BPM per sample period.â€</p>
<p>The linear regression formula for slope is:</p>
<pre><code>slope = (nÃ—Î£xy - Î£xÃ—Î£y) / (nÃ—Î£xÂ² - (Î£x)Â²)</code></pre>
<p>Where x is the sample index and y is the value. Positive slope =
rising, negative = falling, near-zero = stable.</p>
<p><strong>What weâ€™re doing:</strong> Determining whether biometric
values are trending upward, downward, or staying stable. This
information helps decide whether current music intervention is working
or needs adjustment.</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> SignalProcessor <span class="op">{</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> Trend <span class="op">{</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> rising</span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> falling</span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> stable</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">description</span><span class="op">:</span> String <span class="op">{</span></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">switch</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>rising<span class="op">:</span> <span class="kw">return</span> <span class="st">&quot;â†‘ Rising&quot;</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>falling<span class="op">:</span> <span class="kw">return</span> <span class="st">&quot;â†“ Falling&quot;</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>stable<span class="op">:</span> <span class="kw">return</span> <span class="st">&quot;â†’ Stable&quot;</span></span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">detectTrend</span><span class="op">(</span><span class="va">_</span> <span class="va">values</span><span class="op">:</span> [<span class="dt">Double</span>]<span class="op">,</span> <span class="va">threshold</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> -&gt; <span class="fu">Trend</span> <span class="op">{</span></span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> values<span class="op">.</span>count <span class="op">&gt;=</span> <span class="dv">3</span> <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="op">.</span>stable <span class="op">}</span></span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Compare recent average to older average</span></span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">midpoint</span> <span class="op">=</span> values<span class="op">.</span>count <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">older</span> <span class="op">=</span> Array<span class="op">(</span>values<span class="op">.</span>prefix<span class="op">(</span>midpoint<span class="op">))</span></span>
<span id="cb183-22"><a href="#cb183-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">recent</span> <span class="op">=</span> Array<span class="op">(</span>values<span class="op">.</span>suffix<span class="op">(</span>midpoint<span class="op">))</span></span>
<span id="cb183-23"><a href="#cb183-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-24"><a href="#cb183-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">olderAvg</span> <span class="op">=</span> older<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span> <span class="op">/</span> Double<span class="op">(</span>older<span class="op">.</span>count<span class="op">)</span></span>
<span id="cb183-25"><a href="#cb183-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">recentAvg</span> <span class="op">=</span> recent<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span> <span class="op">/</span> Double<span class="op">(</span>recent<span class="op">.</span>count<span class="op">)</span></span>
<span id="cb183-26"><a href="#cb183-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-27"><a href="#cb183-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">percentChange</span> <span class="op">=</span> <span class="op">(</span>recentAvg <span class="op">-</span> olderAvg<span class="op">)</span> <span class="op">/</span> olderAvg</span>
<span id="cb183-28"><a href="#cb183-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-29"><a href="#cb183-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> percentChange <span class="op">&gt;</span> threshold <span class="op">{</span></span>
<span id="cb183-30"><a href="#cb183-30" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>rising</span>
<span id="cb183-31"><a href="#cb183-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> percentChange <span class="op">&lt;</span> <span class="op">-</span>threshold <span class="op">{</span></span>
<span id="cb183-32"><a href="#cb183-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>falling</span>
<span id="cb183-33"><a href="#cb183-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb183-34"><a href="#cb183-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>stable</span>
<span id="cb183-35"><a href="#cb183-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb183-36"><a href="#cb183-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb183-37"><a href="#cb183-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-38"><a href="#cb183-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// More sophisticated: linear regression slope</span></span>
<span id="cb183-39"><a href="#cb183-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">linearTrend</span><span class="op">(</span><span class="va">_</span> <span class="va">values</span><span class="op">:</span> [<span class="dt">Double</span>]<span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb183-40"><a href="#cb183-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> values<span class="op">.</span>count <span class="op">&gt;=</span> <span class="dv">2</span> <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="dv">0</span> <span class="op">}</span></span>
<span id="cb183-41"><a href="#cb183-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-42"><a href="#cb183-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">n</span> <span class="op">=</span> Double<span class="op">(</span>values<span class="op">.</span>count<span class="op">)</span></span>
<span id="cb183-43"><a href="#cb183-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">indices</span> <span class="op">=</span> values<span class="op">.</span>indices<span class="op">.</span>map <span class="op">{</span> Double<span class="op">(</span>$<span class="dv">0</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb183-44"><a href="#cb183-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-45"><a href="#cb183-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sumX</span> <span class="op">=</span> indices<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span></span>
<span id="cb183-46"><a href="#cb183-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sumY</span> <span class="op">=</span> values<span class="op">.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span></span>
<span id="cb183-47"><a href="#cb183-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sumXY</span> <span class="op">=</span> zip<span class="op">(</span>indices<span class="op">,</span> values<span class="op">).</span>map <span class="op">{</span> $<span class="dv">0</span> <span class="op">*</span> $<span class="dv">1</span> <span class="op">}.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span></span>
<span id="cb183-48"><a href="#cb183-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sumX2</span> <span class="op">=</span> indices<span class="op">.</span>map <span class="op">{</span> $<span class="dv">0</span> <span class="op">*</span> $<span class="dv">0</span> <span class="op">}.</span>reduce<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="op">+)</span></span>
<span id="cb183-49"><a href="#cb183-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-50"><a href="#cb183-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">slope</span> <span class="op">=</span> <span class="op">(</span>n <span class="op">*</span> sumXY <span class="op">-</span> sumX <span class="op">*</span> sumY<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>n <span class="op">*</span> sumX2 <span class="op">-</span> sumX <span class="op">*</span> sumX<span class="op">)</span></span>
<span id="cb183-51"><a href="#cb183-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-52"><a href="#cb183-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> slope  <span class="co">// Positive = rising, Negative = falling</span></span>
<span id="cb183-53"><a href="#cb183-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb183-54"><a href="#cb183-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="user-state-classification">14.3 User State Classification</h2>
<p>The ultimate goal of biometric processing is to answer a simple
question: â€œWhat kind of music does this user need right now?â€ We answer
this by combining multiple signals (HR, HRV, trends) into a single
<strong>UserState</strong> classification that our scoring algorithm can
act on.</p>
<h3 id="combining-signals">Combining Signals</h3>
<p>Neither heart rate nor HRV alone tells the complete story. Consider
these scenarios: - <strong>High HR + Low HRV</strong>: Almost certainly
stressed (unless in vigorous workout) - <strong>High HR + High
HRV</strong>: Likely exercising (sympathetic activation but healthy
variability) - <strong>Low HR + Low HRV</strong>: Could be fatigued or
ill - <strong>Low HR + High HRV</strong>: Relaxed and recovered</p>
<p>By combining multiple signals, we can disambiguate scenarios and make
more accurate classifications. We also incorporate
<strong>trends</strong>â€”a rising HR is different from a stable high HR,
even if the absolute value is the same. Rising suggests the intervention
isnâ€™t working; stable suggests a steady state.</p>
<p>The classification outputs a <strong>MusicIntervention</strong>
recommendation: urgently calming, gently calming, maintaining, or
potentially energizing. This feeds directly into the scoring algorithmâ€™s
weight selection and energy targeting.</p>
<p><strong>What weâ€™re doing:</strong> Fusing heart rate, HRV, and trend
information into a unified user state that directly informs music
selection strategy.</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> UserStateClassifier <span class="op">{</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">hrAnalyzer</span> <span class="op">=</span> HeartRateAnalyzer<span class="op">()</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">hrvAnalyzer</span> <span class="op">=</span> HRVAnalyzer<span class="op">()</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">signalProcessor</span> <span class="op">=</span> SignalProcessor<span class="op">()</span></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">classify</span><span class="op">(</span></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">heartRateSamples</span><span class="op">:</span> [<span class="dt">Double</span>]<span class="op">,</span></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">hrvSamples</span><span class="op">:</span> [<span class="dt">Double</span>]<span class="op">,</span></span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">hrBaseline</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">hrvBaseline</span><span class="op">:</span> <span class="dt">HRVBaseline</span></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> -&gt; <span class="fu">UserState</span> <span class="op">{</span></span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Smooth the data</span></span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">smoothedHR</span> <span class="op">=</span> signalProcessor<span class="op">.</span>exponentialMovingAverage<span class="op">(</span>heartRateSamples<span class="op">)</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">smoothedHRV</span> <span class="op">=</span> signalProcessor<span class="op">.</span>exponentialMovingAverage<span class="op">(</span>hrvSamples<span class="op">)</span></span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get current values</span></span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">currentHR</span> <span class="op">=</span> smoothedHR<span class="op">.</span>last <span class="op">??</span> hrBaseline</span>
<span id="cb184-18"><a href="#cb184-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">currentHRV</span> <span class="op">=</span> smoothedHRV<span class="op">.</span>last <span class="op">??</span> hrvBaseline<span class="op">.</span>mean</span>
<span id="cb184-19"><a href="#cb184-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-20"><a href="#cb184-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Classify each metric</span></span>
<span id="cb184-21"><a href="#cb184-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hrZone</span> <span class="op">=</span> hrAnalyzer<span class="op">.</span>classify<span class="op">(</span>currentHR<span class="op">,</span> baseline<span class="op">:</span> hrBaseline<span class="op">)</span></span>
<span id="cb184-22"><a href="#cb184-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">stressLevel</span> <span class="op">=</span> hrvAnalyzer<span class="op">.</span>classify<span class="op">(</span>currentHRV<span class="op">,</span> baseline<span class="op">:</span> hrvBaseline<span class="op">)</span></span>
<span id="cb184-23"><a href="#cb184-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-24"><a href="#cb184-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Detect trends</span></span>
<span id="cb184-25"><a href="#cb184-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hrTrend</span> <span class="op">=</span> signalProcessor<span class="op">.</span>detectTrend<span class="op">(</span>smoothedHR<span class="op">)</span></span>
<span id="cb184-26"><a href="#cb184-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hrvTrend</span> <span class="op">=</span> signalProcessor<span class="op">.</span>detectTrend<span class="op">(</span>smoothedHRV<span class="op">)</span></span>
<span id="cb184-27"><a href="#cb184-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-28"><a href="#cb184-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Combine into user state</span></span>
<span id="cb184-29"><a href="#cb184-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> UserState<span class="op">(</span></span>
<span id="cb184-30"><a href="#cb184-30" aria-hidden="true" tabindex="-1"></a>            heartRate<span class="op">:</span> currentHR<span class="op">,</span></span>
<span id="cb184-31"><a href="#cb184-31" aria-hidden="true" tabindex="-1"></a>            hrv<span class="op">:</span> currentHRV<span class="op">,</span></span>
<span id="cb184-32"><a href="#cb184-32" aria-hidden="true" tabindex="-1"></a>            heartRateZone<span class="op">:</span> hrZone<span class="op">,</span></span>
<span id="cb184-33"><a href="#cb184-33" aria-hidden="true" tabindex="-1"></a>            stressLevel<span class="op">:</span> stressLevel<span class="op">,</span></span>
<span id="cb184-34"><a href="#cb184-34" aria-hidden="true" tabindex="-1"></a>            heartRateTrend<span class="op">:</span> hrTrend<span class="op">,</span></span>
<span id="cb184-35"><a href="#cb184-35" aria-hidden="true" tabindex="-1"></a>            hrvTrend<span class="op">:</span> hrvTrend<span class="op">,</span></span>
<span id="cb184-36"><a href="#cb184-36" aria-hidden="true" tabindex="-1"></a>            needsIntervention<span class="op">:</span> determineIntervention<span class="op">(</span>hrZone<span class="op">:</span> hrZone<span class="op">,</span> stress<span class="op">:</span> stressLevel<span class="op">,</span> hrTrend<span class="op">:</span> hrTrend<span class="op">)</span></span>
<span id="cb184-37"><a href="#cb184-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb184-38"><a href="#cb184-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb184-39"><a href="#cb184-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-40"><a href="#cb184-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">determineIntervention</span><span class="op">(</span></span>
<span id="cb184-41"><a href="#cb184-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">hrZone</span><span class="op">:</span> <span class="dt">HeartRateZone</span><span class="op">,</span></span>
<span id="cb184-42"><a href="#cb184-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">stress</span><span class="op">:</span> <span class="dt">StressLevel</span><span class="op">,</span></span>
<span id="cb184-43"><a href="#cb184-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">hrTrend</span><span class="op">:</span> <span class="dt">SignalProcessor</span>.<span class="va">Trend</span></span>
<span id="cb184-44"><a href="#cb184-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> -&gt; <span class="fu">MusicIntervention</span> <span class="op">{</span></span>
<span id="cb184-45"><a href="#cb184-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// High stress + elevated HR + rising = urgent calming needed</span></span>
<span id="cb184-46"><a href="#cb184-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stress<span class="op">.</span>needsCalming <span class="op">&amp;&amp;</span> <span class="op">(</span>hrZone <span class="op">==</span> <span class="op">.</span>elevated <span class="op">||</span> hrZone <span class="op">==</span> <span class="op">.</span>high<span class="op">)</span> <span class="op">&amp;&amp;</span> hrTrend <span class="op">==</span> <span class="op">.</span>rising <span class="op">{</span></span>
<span id="cb184-47"><a href="#cb184-47" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>urgentCalm</span>
<span id="cb184-48"><a href="#cb184-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb184-49"><a href="#cb184-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-50"><a href="#cb184-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// High stress but stable = gentle calming</span></span>
<span id="cb184-51"><a href="#cb184-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stress<span class="op">.</span>needsCalming <span class="op">{</span></span>
<span id="cb184-52"><a href="#cb184-52" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>gentleCalm</span>
<span id="cb184-53"><a href="#cb184-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb184-54"><a href="#cb184-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-55"><a href="#cb184-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Low HR, relaxed state = could energize if desired</span></span>
<span id="cb184-56"><a href="#cb184-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> hrZone <span class="op">==</span> <span class="op">.</span>belowBaseline <span class="op">&amp;&amp;</span> stress <span class="op">==</span> <span class="op">.</span>veryLow <span class="op">{</span></span>
<span id="cb184-57"><a href="#cb184-57" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>canEnergize</span>
<span id="cb184-58"><a href="#cb184-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb184-59"><a href="#cb184-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-60"><a href="#cb184-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Everything normal</span></span>
<span id="cb184-61"><a href="#cb184-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">.</span>maintain</span>
<span id="cb184-62"><a href="#cb184-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb184-63"><a href="#cb184-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb184-64"><a href="#cb184-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-65"><a href="#cb184-65" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> UserState <span class="op">{</span></span>
<span id="cb184-66"><a href="#cb184-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRate</span><span class="op">:</span> Double</span>
<span id="cb184-67"><a href="#cb184-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">hrv</span><span class="op">:</span> Double</span>
<span id="cb184-68"><a href="#cb184-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRateZone</span><span class="op">:</span> HeartRateZone</span>
<span id="cb184-69"><a href="#cb184-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">stressLevel</span><span class="op">:</span> StressLevel</span>
<span id="cb184-70"><a href="#cb184-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">heartRateTrend</span><span class="op">:</span> SignalProcessor<span class="op">.</span>Trend</span>
<span id="cb184-71"><a href="#cb184-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">hrvTrend</span><span class="op">:</span> SignalProcessor<span class="op">.</span>Trend</span>
<span id="cb184-72"><a href="#cb184-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">needsIntervention</span><span class="op">:</span> MusicIntervention</span>
<span id="cb184-73"><a href="#cb184-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb184-74"><a href="#cb184-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-75"><a href="#cb184-75" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> MusicIntervention <span class="op">{</span></span>
<span id="cb184-76"><a href="#cb184-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> urgentCalm     <span class="co">// Play calming music immediately</span></span>
<span id="cb184-77"><a href="#cb184-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> gentleCalm     <span class="co">// Gradually shift to calmer music</span></span>
<span id="cb184-78"><a href="#cb184-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> maintain       <span class="co">// Current music is fine</span></span>
<span id="cb184-79"><a href="#cb184-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> canEnergize    <span class="co">// User is very relaxed, could boost energy</span></span>
<span id="cb184-80"><a href="#cb184-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-81"><a href="#cb184-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">targetEnergy</span><span class="op">:</span> ClosedRange<span class="op">&lt;</span>Double<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb184-82"><a href="#cb184-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb184-83"><a href="#cb184-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>urgentCalm<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.0</span><span class="op">..</span><span class="fl">.0.3</span></span>
<span id="cb184-84"><a href="#cb184-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>gentleCalm<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.2</span><span class="op">..</span><span class="fl">.0.5</span></span>
<span id="cb184-85"><a href="#cb184-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>maintain<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.3</span><span class="op">..</span><span class="fl">.0.7</span></span>
<span id="cb184-86"><a href="#cb184-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>canEnergize<span class="op">:</span> <span class="kw">return</span> <span class="fl">0.5</span><span class="op">..</span><span class="fl">.0.9</span></span>
<span id="cb184-87"><a href="#cb184-87" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb184-88"><a href="#cb184-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb184-89"><a href="#cb184-89" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---biometrics-signal-processing">Key Takeaways -
Biometrics &amp; Signal Processing</h2>
<ol type="1">
<li><strong>Personalized baselines</strong> - Population averages are
starting points only</li>
<li><strong>HRV indicates stress</strong> - Lower HRV = more
stressed</li>
<li><strong>Smooth noisy data</strong> - Use moving averages to reduce
sensor noise</li>
<li><strong>Detect trends</strong> - Rising HR might need intervention
before it peaks</li>
<li><strong>Combine signals</strong> - HR + HRV together tell more than
either alone</li>
<li><strong>Context matters</strong> - 120 BPM during workout vs rest
means different things</li>
</ol>
<hr />
<h1 id="algorithm-scoring-system-design">15. ALGORITHM &amp; SCORING
SYSTEM DESIGN</h1>
<h2 id="why-this-matters-for-ai-dj-14">Why This Matters for AI DJ</h2>
<p>The scoring algorithm is the brain of AI DJâ€”the intelligence that
transforms raw biometric data into meaningful music selections. Unlike
simple rule-based systems (â€œif heart rate high, play slow musicâ€), a
well-designed scoring algorithm can weigh multiple factors
simultaneously, learn from user preferences over time, and adapt to
different contexts. This is what separates a smart DJ from a random
playlist shuffler.</p>
<p>The core challenge in algorithm design is <strong>multi-criteria
decision making</strong>: we have multiple factors that matter (BPM
match, energy level, user history, recency) and we need to combine them
into a single decision about which song to play next. This is a
well-studied problem in machine learning and recommendation systems,
drawing on techniques from <a href="https://developers.google.com/machine-learning/crash-course/representation/feature-engineering">Googleâ€™s
Feature Engineering course</a> and <a href="https://www.microsoft.com/en-us/research/project/learning-to-rank/">Microsoftâ€™s
Learning to Rank research</a>.</p>
<p><strong>In AI DJ, the scoring system:</strong> - Ranks songs by
fitness for current state using weighted multi-factor scoring - Balances
multiple factors (BPM match, energy, familiarity) with configurable
weights - Explains why a song was selected (transparency for user trust)
- Learns from user feedback over time using reinforcement learning
principles - Handles the exploration-exploitation tradeoff to discover
new favorites</p>
<hr />
<h2 id="scoring-fundamentals">15.1 Scoring Fundamentals</h2>
<h3 id="multi-factor-scoring">Multi-Factor Scoring</h3>
<p>The heart of AI DJâ€™s intelligence is a <strong>weighted linear
combination</strong> of multiple scoring factors. Each factor produces a
score between 0 and 1, representing how well a song matches that
criterion. These individual scores are then multiplied by weights (also
0 to 1, summing to 1.0) and added together to produce a final composite
score.</p>
<p><strong>The mathematical formula is:</strong></p>
<pre><code>FinalScore = Î£ (weight_i Ã— score_i) for all factors i
           = (w_bpm Ã— s_bpm) + (w_energy Ã— s_energy) + (w_stress Ã— s_stress) + ...</code></pre>
<p>This approach is powerful because: 1. <strong>Interpretable</strong>:
You can explain exactly why a song scored high or low 2.
<strong>Tunable</strong>: Adjusting weights changes behavior predictably
3. <strong>Efficient</strong>: O(n) to score n songs, no complex
optimization needed 4. <strong>Extensible</strong>: Adding new factors
is straightforward</p>
<p>The challenge is <strong>feature engineering</strong>â€”designing
scoring functions that accurately capture what makes a song â€œgoodâ€ for a
given situation. Each individual score function must: - Return values
consistently in the 0-1 range (normalization) - Respond appropriately to
edge cases (missing data, extreme values) - Align with human intuition
about what â€œgoodâ€ means</p>
<p><strong>What weâ€™re doing:</strong> Combining multiple criteria into a
single score using a weighted sum, where each factor contributes
proportionally to its assigned weight.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> SongScorer <span class="op">{</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Weights for different factors (must sum to 1.0)</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Weights <span class="op">{</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">bpmMatch</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">energyMatch</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.30</span></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">stressResponse</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.20</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">familiarity</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">recency</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.10</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Weights can be adjusted based on context</span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">static</span> <span class="kw">let</span> <span class="va">workout</span> <span class="op">=</span> Weights<span class="op">(</span></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a>            bpmMatch<span class="op">:</span> <span class="fl">0.35</span><span class="op">,</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a>            energyMatch<span class="op">:</span> <span class="fl">0.35</span><span class="op">,</span></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a>            stressResponse<span class="op">:</span> <span class="fl">0.10</span><span class="op">,</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a>            familiarity<span class="op">:</span> <span class="fl">0.10</span><span class="op">,</span></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a>            recency<span class="op">:</span> <span class="fl">0.10</span></span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">static</span> <span class="kw">let</span> <span class="va">relaxation</span> <span class="op">=</span> Weights<span class="op">(</span></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a>            bpmMatch<span class="op">:</span> <span class="fl">0.15</span><span class="op">,</span></span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a>            energyMatch<span class="op">:</span> <span class="fl">0.35</span><span class="op">,</span></span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a>            stressResponse<span class="op">:</span> <span class="fl">0.30</span><span class="op">,</span></span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a>            familiarity<span class="op">:</span> <span class="fl">0.15</span><span class="op">,</span></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a>            recency<span class="op">:</span> <span class="fl">0.05</span></span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-27"><a href="#cb186-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-28"><a href="#cb186-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">score</span><span class="op">(</span><span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">,</span> <span class="va">state</span><span class="op">:</span> <span class="dt">UserState</span><span class="op">,</span> <span class="va">history</span><span class="op">:</span> <span class="dt">SongHistory</span><span class="op">?,</span> <span class="va">weights</span><span class="op">:</span> <span class="dt">Weights</span><span class="op">)</span> -&gt; <span class="fu">ScoredSong</span> <span class="op">{</span></span>
<span id="cb186-29"><a href="#cb186-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">components</span><span class="op">:</span> <span class="op">[</span>ScoreComponent<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb186-30"><a href="#cb186-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-31"><a href="#cb186-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. BPM Match (how close is song BPM to heart rate?)</span></span>
<span id="cb186-32"><a href="#cb186-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">bpmScore</span> <span class="op">=</span> calculateBPMScore<span class="op">(</span>songBPM<span class="op">:</span> song<span class="op">.</span>bpm<span class="op">,</span> heartRate<span class="op">:</span> state<span class="op">.</span>heartRate<span class="op">)</span></span>
<span id="cb186-33"><a href="#cb186-33" aria-hidden="true" tabindex="-1"></a>        components<span class="op">.</span>append<span class="op">(</span>ScoreComponent<span class="op">(</span></span>
<span id="cb186-34"><a href="#cb186-34" aria-hidden="true" tabindex="-1"></a>            factor<span class="op">:</span> <span class="st">&quot;BPM Match&quot;</span><span class="op">,</span></span>
<span id="cb186-35"><a href="#cb186-35" aria-hidden="true" tabindex="-1"></a>            score<span class="op">:</span> bpmScore<span class="op">,</span></span>
<span id="cb186-36"><a href="#cb186-36" aria-hidden="true" tabindex="-1"></a>            weight<span class="op">:</span> weights<span class="op">.</span>bpmMatch<span class="op">,</span></span>
<span id="cb186-37"><a href="#cb186-37" aria-hidden="true" tabindex="-1"></a>            reason<span class="op">:</span> bpmScore <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">?</span> <span class="st">&quot;Rhythm matches your heartbeat&quot;</span> <span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb186-38"><a href="#cb186-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">))</span></span>
<span id="cb186-39"><a href="#cb186-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-40"><a href="#cb186-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Energy Match (does song energy match what user needs?)</span></span>
<span id="cb186-41"><a href="#cb186-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">energyScore</span> <span class="op">=</span> calculateEnergyScore<span class="op">(</span></span>
<span id="cb186-42"><a href="#cb186-42" aria-hidden="true" tabindex="-1"></a>            songEnergy<span class="op">:</span> song<span class="op">.</span>energyLevel<span class="op">,</span></span>
<span id="cb186-43"><a href="#cb186-43" aria-hidden="true" tabindex="-1"></a>            intervention<span class="op">:</span> state<span class="op">.</span>needsIntervention</span>
<span id="cb186-44"><a href="#cb186-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb186-45"><a href="#cb186-45" aria-hidden="true" tabindex="-1"></a>        components<span class="op">.</span>append<span class="op">(</span>ScoreComponent<span class="op">(</span></span>
<span id="cb186-46"><a href="#cb186-46" aria-hidden="true" tabindex="-1"></a>            factor<span class="op">:</span> <span class="st">&quot;Energy Match&quot;</span><span class="op">,</span></span>
<span id="cb186-47"><a href="#cb186-47" aria-hidden="true" tabindex="-1"></a>            score<span class="op">:</span> energyScore<span class="op">,</span></span>
<span id="cb186-48"><a href="#cb186-48" aria-hidden="true" tabindex="-1"></a>            weight<span class="op">:</span> weights<span class="op">.</span>energyMatch<span class="op">,</span></span>
<span id="cb186-49"><a href="#cb186-49" aria-hidden="true" tabindex="-1"></a>            reason<span class="op">:</span> energyScore <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">?</span> describeEnergyMatch<span class="op">(</span>intervention<span class="op">:</span> state<span class="op">.</span>needsIntervention<span class="op">)</span> <span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb186-50"><a href="#cb186-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">))</span></span>
<span id="cb186-51"><a href="#cb186-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-52"><a href="#cb186-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. Stress Response (has this song helped with stress before?)</span></span>
<span id="cb186-53"><a href="#cb186-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">stressScore</span> <span class="op">=</span> history<span class="op">?.</span>effectivenessForCalming <span class="op">??</span> <span class="fl">0.5</span></span>
<span id="cb186-54"><a href="#cb186-54" aria-hidden="true" tabindex="-1"></a>        components<span class="op">.</span>append<span class="op">(</span>ScoreComponent<span class="op">(</span></span>
<span id="cb186-55"><a href="#cb186-55" aria-hidden="true" tabindex="-1"></a>            factor<span class="op">:</span> <span class="st">&quot;Stress Response&quot;</span><span class="op">,</span></span>
<span id="cb186-56"><a href="#cb186-56" aria-hidden="true" tabindex="-1"></a>            score<span class="op">:</span> stressScore<span class="op">,</span></span>
<span id="cb186-57"><a href="#cb186-57" aria-hidden="true" tabindex="-1"></a>            weight<span class="op">:</span> weights<span class="op">.</span>stressResponse<span class="op">,</span></span>
<span id="cb186-58"><a href="#cb186-58" aria-hidden="true" tabindex="-1"></a>            reason<span class="op">:</span> stressScore <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">?</span> <span class="st">&quot;Previously helped you relax&quot;</span> <span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb186-59"><a href="#cb186-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">))</span></span>
<span id="cb186-60"><a href="#cb186-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-61"><a href="#cb186-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4. Familiarity (known songs can be comforting)</span></span>
<span id="cb186-62"><a href="#cb186-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">familiarityScore</span> <span class="op">=</span> calculateFamiliarityScore<span class="op">(</span>playCount<span class="op">:</span> history<span class="op">?.</span>playCount <span class="op">??</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb186-63"><a href="#cb186-63" aria-hidden="true" tabindex="-1"></a>        components<span class="op">.</span>append<span class="op">(</span>ScoreComponent<span class="op">(</span></span>
<span id="cb186-64"><a href="#cb186-64" aria-hidden="true" tabindex="-1"></a>            factor<span class="op">:</span> <span class="st">&quot;Familiarity&quot;</span><span class="op">,</span></span>
<span id="cb186-65"><a href="#cb186-65" aria-hidden="true" tabindex="-1"></a>            score<span class="op">:</span> familiarityScore<span class="op">,</span></span>
<span id="cb186-66"><a href="#cb186-66" aria-hidden="true" tabindex="-1"></a>            weight<span class="op">:</span> weights<span class="op">.</span>familiarity<span class="op">,</span></span>
<span id="cb186-67"><a href="#cb186-67" aria-hidden="true" tabindex="-1"></a>            reason<span class="op">:</span> familiarityScore <span class="op">&gt;</span> <span class="fl">0.7</span> <span class="op">?</span> <span class="st">&quot;One of your favorites&quot;</span> <span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb186-68"><a href="#cb186-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">))</span></span>
<span id="cb186-69"><a href="#cb186-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-70"><a href="#cb186-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 5. Recency penalty (avoid repeating recent songs)</span></span>
<span id="cb186-71"><a href="#cb186-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">recencyScore</span> <span class="op">=</span> calculateRecencyScore<span class="op">(</span>lastPlayed<span class="op">:</span> history<span class="op">?.</span>lastPlayed<span class="op">)</span></span>
<span id="cb186-72"><a href="#cb186-72" aria-hidden="true" tabindex="-1"></a>        components<span class="op">.</span>append<span class="op">(</span>ScoreComponent<span class="op">(</span></span>
<span id="cb186-73"><a href="#cb186-73" aria-hidden="true" tabindex="-1"></a>            factor<span class="op">:</span> <span class="st">&quot;Freshness&quot;</span><span class="op">,</span></span>
<span id="cb186-74"><a href="#cb186-74" aria-hidden="true" tabindex="-1"></a>            score<span class="op">:</span> recencyScore<span class="op">,</span></span>
<span id="cb186-75"><a href="#cb186-75" aria-hidden="true" tabindex="-1"></a>            weight<span class="op">:</span> weights<span class="op">.</span>recency<span class="op">,</span></span>
<span id="cb186-76"><a href="#cb186-76" aria-hidden="true" tabindex="-1"></a>            reason<span class="op">:</span> <span class="kw">nil</span></span>
<span id="cb186-77"><a href="#cb186-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">))</span></span>
<span id="cb186-78"><a href="#cb186-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-79"><a href="#cb186-79" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate weighted total</span></span>
<span id="cb186-80"><a href="#cb186-80" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">totalScore</span> <span class="op">=</span> components<span class="op">.</span>reduce<span class="op">(</span><span class="fl">0.0</span><span class="op">)</span> <span class="op">{</span> sum<span class="op">,</span> component <span class="cf">in</span></span>
<span id="cb186-81"><a href="#cb186-81" aria-hidden="true" tabindex="-1"></a>            sum <span class="op">+</span> <span class="op">(</span>component<span class="op">.</span>score <span class="op">*</span> component<span class="op">.</span>weight<span class="op">)</span></span>
<span id="cb186-82"><a href="#cb186-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb186-83"><a href="#cb186-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-84"><a href="#cb186-84" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Collect non-nil reasons</span></span>
<span id="cb186-85"><a href="#cb186-85" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">reasons</span> <span class="op">=</span> components<span class="op">.</span>compactMap <span class="op">{</span> $<span class="fl">0.</span>reason <span class="op">}</span></span>
<span id="cb186-86"><a href="#cb186-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-87"><a href="#cb186-87" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> ScoredSong<span class="op">(</span></span>
<span id="cb186-88"><a href="#cb186-88" aria-hidden="true" tabindex="-1"></a>            song<span class="op">:</span> song<span class="op">,</span></span>
<span id="cb186-89"><a href="#cb186-89" aria-hidden="true" tabindex="-1"></a>            score<span class="op">:</span> totalScore<span class="op">,</span></span>
<span id="cb186-90"><a href="#cb186-90" aria-hidden="true" tabindex="-1"></a>            components<span class="op">:</span> components<span class="op">,</span></span>
<span id="cb186-91"><a href="#cb186-91" aria-hidden="true" tabindex="-1"></a>            reasons<span class="op">:</span> reasons</span>
<span id="cb186-92"><a href="#cb186-92" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb186-93"><a href="#cb186-93" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-94"><a href="#cb186-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-95"><a href="#cb186-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Score Calculations</span></span>
<span id="cb186-96"><a href="#cb186-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-97"><a href="#cb186-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">calculateBPMScore</span><span class="op">(</span><span class="va">songBPM</span><span class="op">:</span> <span class="dt">Int</span><span class="op">?,</span> <span class="va">heartRate</span><span class="op">:</span> <span class="dt">Double</span><span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb186-98"><a href="#cb186-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">bpm</span> <span class="op">=</span> songBPM <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="fl">0.5</span> <span class="op">}</span> <span class="co">// Unknown BPM = neutral</span></span>
<span id="cb186-99"><a href="#cb186-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-100"><a href="#cb186-100" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">diff</span> <span class="op">=</span> abs<span class="op">(</span>Double<span class="op">(</span>bpm<span class="op">)</span> <span class="op">-</span> heartRate<span class="op">)</span></span>
<span id="cb186-101"><a href="#cb186-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-102"><a href="#cb186-102" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perfect match at 0 diff, falls off as diff increases</span></span>
<span id="cb186-103"><a href="#cb186-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Score of 0.5 at 30 BPM difference, 0 at 60+</span></span>
<span id="cb186-104"><a href="#cb186-104" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> max<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="fl">1.0</span> <span class="op">-</span> diff <span class="op">/</span> <span class="fl">60.0</span><span class="op">)</span></span>
<span id="cb186-105"><a href="#cb186-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-106"><a href="#cb186-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-107"><a href="#cb186-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">calculateEnergyScore</span><span class="op">(</span><span class="va">songEnergy</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="va">intervention</span><span class="op">:</span> <span class="dt">MusicIntervention</span><span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb186-108"><a href="#cb186-108" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">targetRange</span> <span class="op">=</span> intervention<span class="op">.</span>targetEnergy</span>
<span id="cb186-109"><a href="#cb186-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-110"><a href="#cb186-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> targetRange<span class="op">.</span>contains<span class="op">(</span>songEnergy<span class="op">)</span> <span class="op">{</span></span>
<span id="cb186-111"><a href="#cb186-111" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Perfect - energy is in target range</span></span>
<span id="cb186-112"><a href="#cb186-112" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fl">1.0</span></span>
<span id="cb186-113"><a href="#cb186-113" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> songEnergy <span class="op">&lt;</span> targetRange<span class="op">.</span>lowerBound <span class="op">{</span></span>
<span id="cb186-114"><a href="#cb186-114" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Song is calmer than needed</span></span>
<span id="cb186-115"><a href="#cb186-115" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">diff</span> <span class="op">=</span> targetRange<span class="op">.</span>lowerBound <span class="op">-</span> songEnergy</span>
<span id="cb186-116"><a href="#cb186-116" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> max<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="fl">1.0</span> <span class="op">-</span> diff <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb186-117"><a href="#cb186-117" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb186-118"><a href="#cb186-118" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Song is more energetic than needed</span></span>
<span id="cb186-119"><a href="#cb186-119" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">diff</span> <span class="op">=</span> songEnergy <span class="op">-</span> targetRange<span class="op">.</span>upperBound</span>
<span id="cb186-120"><a href="#cb186-120" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> max<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="fl">1.0</span> <span class="op">-</span> diff <span class="op">*</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb186-121"><a href="#cb186-121" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb186-122"><a href="#cb186-122" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-123"><a href="#cb186-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-124"><a href="#cb186-124" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">calculateFamiliarityScore</span><span class="op">(</span><span class="va">playCount</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb186-125"><a href="#cb186-125" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Diminishing returns on familiarity</span></span>
<span id="cb186-126"><a href="#cb186-126" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 0 plays = 0.3 (unknown is slightly negative)</span></span>
<span id="cb186-127"><a href="#cb186-127" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1-5 plays = 0.5-0.8 (building familiarity)</span></span>
<span id="cb186-128"><a href="#cb186-128" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 6+ plays = 0.8-1.0 (well known)</span></span>
<span id="cb186-129"><a href="#cb186-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> playCount <span class="op">{</span></span>
<span id="cb186-130"><a href="#cb186-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span></span>
<span id="cb186-131"><a href="#cb186-131" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fl">0.3</span></span>
<span id="cb186-132"><a href="#cb186-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">1.</span><span class="op">.</span><span class="fl">.5</span><span class="op">:</span></span>
<span id="cb186-133"><a href="#cb186-133" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fl">0.5</span> <span class="op">+</span> Double<span class="op">(</span>playCount<span class="op">)</span> <span class="op">*</span> <span class="fl">0.06</span></span>
<span id="cb186-134"><a href="#cb186-134" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb186-135"><a href="#cb186-135" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> min<span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> <span class="fl">0.8</span> <span class="op">+</span> Double<span class="op">(</span>playCount <span class="op">-</span> <span class="dv">5</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span id="cb186-136"><a href="#cb186-136" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb186-137"><a href="#cb186-137" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-138"><a href="#cb186-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-139"><a href="#cb186-139" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">calculateRecencyScore</span><span class="op">(</span><span class="va">lastPlayed</span><span class="op">:</span> <span class="dt">Date</span><span class="op">?)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb186-140"><a href="#cb186-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">lastPlayed</span> <span class="op">=</span> lastPlayed <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb186-141"><a href="#cb186-141" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fl">1.0</span>  <span class="co">// Never played = fully fresh</span></span>
<span id="cb186-142"><a href="#cb186-142" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb186-143"><a href="#cb186-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-144"><a href="#cb186-144" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">hoursSincePlay</span> <span class="op">=</span> Date<span class="op">().</span>timeIntervalSince<span class="op">(</span>lastPlayed<span class="op">)</span> <span class="op">/</span> <span class="dv">3600</span></span>
<span id="cb186-145"><a href="#cb186-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-146"><a href="#cb186-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> hoursSincePlay <span class="op">{</span></span>
<span id="cb186-147"><a href="#cb186-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">..&lt;</span><span class="dv">1</span><span class="op">:</span></span>
<span id="cb186-148"><a href="#cb186-148" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fl">0.0</span>  <span class="co">// Played within last hour = don&#39;t repeat</span></span>
<span id="cb186-149"><a href="#cb186-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">1.</span><span class="op">.&lt;</span><span class="dv">4</span><span class="op">:</span></span>
<span id="cb186-150"><a href="#cb186-150" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fl">0.3</span>  <span class="co">// Played recently = mostly avoid</span></span>
<span id="cb186-151"><a href="#cb186-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="fl">4.</span><span class="op">.&lt;</span><span class="dv">24</span><span class="op">:</span></span>
<span id="cb186-152"><a href="#cb186-152" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fl">0.6</span>  <span class="co">// Played today = slight penalty</span></span>
<span id="cb186-153"><a href="#cb186-153" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb186-154"><a href="#cb186-154" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="fl">1.0</span>  <span class="co">// Not played today = fresh</span></span>
<span id="cb186-155"><a href="#cb186-155" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb186-156"><a href="#cb186-156" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-157"><a href="#cb186-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-158"><a href="#cb186-158" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">describeEnergyMatch</span><span class="op">(</span><span class="va">intervention</span><span class="op">:</span> <span class="dt">MusicIntervention</span><span class="op">)</span> -&gt; <span class="fu">String</span> <span class="op">{</span></span>
<span id="cb186-159"><a href="#cb186-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> intervention <span class="op">{</span></span>
<span id="cb186-160"><a href="#cb186-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>urgentCalm<span class="op">:</span></span>
<span id="cb186-161"><a href="#cb186-161" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;Calming energy for relaxation&quot;</span></span>
<span id="cb186-162"><a href="#cb186-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>gentleCalm<span class="op">:</span></span>
<span id="cb186-163"><a href="#cb186-163" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;Gently calming&quot;</span></span>
<span id="cb186-164"><a href="#cb186-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>maintain<span class="op">:</span></span>
<span id="cb186-165"><a href="#cb186-165" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;Matches your current vibe&quot;</span></span>
<span id="cb186-166"><a href="#cb186-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>canEnergize<span class="op">:</span></span>
<span id="cb186-167"><a href="#cb186-167" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;Upbeat to boost your energy&quot;</span></span>
<span id="cb186-168"><a href="#cb186-168" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb186-169"><a href="#cb186-169" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-170"><a href="#cb186-170" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb186-171"><a href="#cb186-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-172"><a href="#cb186-172" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ScoreComponent <span class="op">{</span></span>
<span id="cb186-173"><a href="#cb186-173" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">factor</span><span class="op">:</span> String</span>
<span id="cb186-174"><a href="#cb186-174" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">score</span><span class="op">:</span> Double</span>
<span id="cb186-175"><a href="#cb186-175" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">weight</span><span class="op">:</span> Double</span>
<span id="cb186-176"><a href="#cb186-176" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">reason</span><span class="op">:</span> String<span class="op">?</span></span>
<span id="cb186-177"><a href="#cb186-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-178"><a href="#cb186-178" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">weightedScore</span><span class="op">:</span> Double <span class="op">{</span></span>
<span id="cb186-179"><a href="#cb186-179" aria-hidden="true" tabindex="-1"></a>        score <span class="op">*</span> weight</span>
<span id="cb186-180"><a href="#cb186-180" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-181"><a href="#cb186-181" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb186-182"><a href="#cb186-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-183"><a href="#cb186-183" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> ScoredSong <span class="op">{</span></span>
<span id="cb186-184"><a href="#cb186-184" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">song</span><span class="op">:</span> Song</span>
<span id="cb186-185"><a href="#cb186-185" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">score</span><span class="op">:</span> Double</span>
<span id="cb186-186"><a href="#cb186-186" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">components</span><span class="op">:</span> <span class="op">[</span>ScoreComponent<span class="op">]</span></span>
<span id="cb186-187"><a href="#cb186-187" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">reasons</span><span class="op">:</span> <span class="op">[</span>String<span class="op">]</span></span>
<span id="cb186-188"><a href="#cb186-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-189"><a href="#cb186-189" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">primaryReason</span><span class="op">:</span> String <span class="op">{</span></span>
<span id="cb186-190"><a href="#cb186-190" aria-hidden="true" tabindex="-1"></a>        reasons<span class="op">.</span>first <span class="op">??</span> <span class="st">&quot;Good match for your current state&quot;</span></span>
<span id="cb186-191"><a href="#cb186-191" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb186-192"><a href="#cb186-192" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="ranking-and-selection">15.2 Ranking and Selection</h2>
<h3 id="ranking-songs">Ranking Songs</h3>
<p>Once we can score individual songs, the ranking problem is
straightforward: score all candidates and sort by score descending. The
highest-scoring song is our selection. However, there are important
considerations in how we implement this.</p>
<p><strong>Computational Complexity</strong>: With n songs, we perform n
scoring operations (each O(1) with constant factors) and one sort (O(n
log n)). For typical playlist sizes (100-1000 songs), this completes in
milliseconds. However, if scoring involves database lookups or expensive
computations, we might cache results or score incrementally.</p>
<p><strong>Determinism vs Variety</strong>: Always picking the top song
can lead to repetitive selections. If the same song consistently scores
highest, the user might hear it repeatedly. We address this through
recency penalties and exploration strategies (covered below).</p>
<p><strong>Context-Aware Weighting</strong>: Different situations call
for different priorities. During a workout, BPM match and energy might
matter most. During relaxation, stress-relief history becomes more
important. We implement this by maintaining multiple weight presets and
selecting based on context.</p>
<p><strong>What weâ€™re doing:</strong> Scoring all candidate songs
against the current user state, sorting them by score, and selecting the
best match. The ranking incorporates context-aware weight selection to
adapt to different usage scenarios.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MusicBrain <span class="op">{</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">scorer</span> <span class="op">=</span> SongScorer<span class="op">()</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">historyStore</span><span class="op">:</span> SongHistoryStore</span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">(</span>historyStore<span class="op">:</span> SongHistoryStore<span class="op">)</span> <span class="op">{</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>historyStore <span class="op">=</span> historyStore</span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">rankSongs</span><span class="op">(</span></span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">candidates</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span></span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">state</span><span class="op">:</span> <span class="dt">UserState</span><span class="op">,</span></span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">context</span><span class="op">:</span> <span class="dt">MusicContext</span> <span class="op">=</span> <span class="op">.</span>default</span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> -&gt; [<span class="fu">ScoredSong</span>] <span class="op">{</span></span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">weights</span> <span class="op">=</span> selectWeights<span class="op">(</span><span class="cf">for</span><span class="op">:</span> context<span class="op">)</span></span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> candidates</span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map <span class="op">{</span> song <span class="cf">in</span></span>
<span id="cb187-18"><a href="#cb187-18" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="va">history</span> <span class="op">=</span> historyStore<span class="op">.</span>getHistory<span class="op">(</span><span class="cf">for</span><span class="op">:</span> song<span class="op">.</span>id<span class="op">)</span></span>
<span id="cb187-19"><a href="#cb187-19" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> scorer<span class="op">.</span>score<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> state<span class="op">:</span> state<span class="op">,</span> history<span class="op">:</span> history<span class="op">,</span> weights<span class="op">:</span> weights<span class="op">)</span></span>
<span id="cb187-20"><a href="#cb187-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb187-21"><a href="#cb187-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>sorted <span class="op">{</span> $<span class="fl">0.</span>score <span class="op">&gt;</span> $<span class="fl">1.</span>score <span class="op">}</span></span>
<span id="cb187-22"><a href="#cb187-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-23"><a href="#cb187-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-24"><a href="#cb187-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">selectNextSong</span><span class="op">(</span></span>
<span id="cb187-25"><a href="#cb187-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">from</span> <span class="va">candidates</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span></span>
<span id="cb187-26"><a href="#cb187-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">state</span><span class="op">:</span> <span class="dt">UserState</span><span class="op">,</span></span>
<span id="cb187-27"><a href="#cb187-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">context</span><span class="op">:</span> <span class="dt">MusicContext</span> <span class="op">=</span> <span class="op">.</span>default</span>
<span id="cb187-28"><a href="#cb187-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> -&gt; <span class="fu">ScoredSong</span>? <span class="op">{</span></span>
<span id="cb187-29"><a href="#cb187-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">ranked</span> <span class="op">=</span> rankSongs<span class="op">(</span>candidates<span class="op">:</span> candidates<span class="op">,</span> state<span class="op">:</span> state<span class="op">,</span> context<span class="op">:</span> context<span class="op">)</span></span>
<span id="cb187-30"><a href="#cb187-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> ranked<span class="op">.</span>first</span>
<span id="cb187-31"><a href="#cb187-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-32"><a href="#cb187-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-33"><a href="#cb187-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">selectWeights</span><span class="op">(</span><span class="va">for</span> <span class="va">context</span><span class="op">:</span> <span class="dt">MusicContext</span><span class="op">)</span> -&gt; <span class="fu">SongScorer</span><span class="op">.</span><span class="fu">Weights</span> <span class="op">{</span></span>
<span id="cb187-34"><a href="#cb187-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> context <span class="op">{</span></span>
<span id="cb187-35"><a href="#cb187-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>workout<span class="op">:</span></span>
<span id="cb187-36"><a href="#cb187-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>workout</span>
<span id="cb187-37"><a href="#cb187-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>relaxation<span class="op">,</span> <span class="op">.</span>sleep<span class="op">:</span></span>
<span id="cb187-38"><a href="#cb187-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">.</span>relaxation</span>
<span id="cb187-39"><a href="#cb187-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>focus<span class="op">:</span></span>
<span id="cb187-40"><a href="#cb187-40" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> SongScorer<span class="op">.</span>Weights<span class="op">(</span></span>
<span id="cb187-41"><a href="#cb187-41" aria-hidden="true" tabindex="-1"></a>                bpmMatch<span class="op">:</span> <span class="fl">0.15</span><span class="op">,</span></span>
<span id="cb187-42"><a href="#cb187-42" aria-hidden="true" tabindex="-1"></a>                energyMatch<span class="op">:</span> <span class="fl">0.20</span><span class="op">,</span></span>
<span id="cb187-43"><a href="#cb187-43" aria-hidden="true" tabindex="-1"></a>                stressResponse<span class="op">:</span> <span class="fl">0.25</span><span class="op">,</span></span>
<span id="cb187-44"><a href="#cb187-44" aria-hidden="true" tabindex="-1"></a>                familiarity<span class="op">:</span> <span class="fl">0.30</span><span class="op">,</span>  <span class="co">// Familiar music is less distracting</span></span>
<span id="cb187-45"><a href="#cb187-45" aria-hidden="true" tabindex="-1"></a>                recency<span class="op">:</span> <span class="fl">0.10</span></span>
<span id="cb187-46"><a href="#cb187-46" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb187-47"><a href="#cb187-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span><span class="kw">default</span><span class="op">:</span></span>
<span id="cb187-48"><a href="#cb187-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> SongScorer<span class="op">.</span>Weights<span class="op">()</span></span>
<span id="cb187-49"><a href="#cb187-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb187-50"><a href="#cb187-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-51"><a href="#cb187-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb187-52"><a href="#cb187-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-53"><a href="#cb187-53" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> MusicContext <span class="op">{</span></span>
<span id="cb187-54"><a href="#cb187-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> `default`</span>
<span id="cb187-55"><a href="#cb187-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> workout</span>
<span id="cb187-56"><a href="#cb187-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> relaxation</span>
<span id="cb187-57"><a href="#cb187-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> sleep</span>
<span id="cb187-58"><a href="#cb187-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> focus</span>
<span id="cb187-59"><a href="#cb187-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h3 id="exploration-vs-exploitation">Exploration vs Exploitation</h3>
<p>This is one of the fundamental problems in recommendation systems,
known as the <strong>multi-armed bandit problem</strong>. The dilemma:
should we <strong>exploit</strong> what we know works (play songs that
have performed well) or <strong>explore</strong> less-known options that
might be even better?</p>
<p><strong>The Problem with Pure Exploitation</strong>: If we always
pick the highest-scoring song, we never discover new favorites. A song
the user hasnâ€™t heard yet has no history data, so it gets a neutral
familiarity score and canâ€™t compete with established favorites. The
userâ€™s experience becomes stale.</p>
<p><strong>The Problem with Pure Exploration</strong>: Random selection
ignores everything weâ€™ve learned. The user experiences a seemingly
random playlist with no connection to their state.</p>
<p><strong>Îµ-Greedy Strategy</strong>: The simplest solution is to
exploit most of the time (e.g., 90%) but randomly explore occasionally
(10%). This is called Îµ-greedy (epsilon-greedy) where Îµ is the
exploration rate. Itâ€™s simple but crudeâ€”exploration is completely random
without considering how uncertain we are about different options.</p>
<p><strong>Thompson Sampling</strong>: A more sophisticated approach
that naturally balances exploration and exploitation. The key insight is
that <strong>uncertainty should drive exploration</strong>. Songs weâ€™ve
played many times have stable, reliable scores. Songs weâ€™ve rarely
played have uncertain scoresâ€”they might be better or worse than we
think. Thompson Sampling adds random noise proportional to this
uncertainty, giving less-known songs a chance to bubble up
occasionally.</p>
<p>The mathematical intuition: if a songâ€™s true quality is unknown, its
observed score is a sample from a probability distribution. By sampling
from this distribution (approximated by adding uncertainty-scaled
noise), we naturally explore uncertain options while still preferring
likely-good choices.</p>
<p><strong>What weâ€™re doing:</strong> Implementing strategies that
balance between selecting known-good songs (exploitation) and trying
less-familiar songs to discover new favorites (exploration). We use
epsilon-greedy for simplicity and Thompson Sampling for smarter
uncertainty-aware exploration.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> MusicBrain <span class="op">{</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">selectWithExploration</span><span class="op">(</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">from</span> <span class="va">candidates</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">state</span><span class="op">:</span> <span class="dt">UserState</span><span class="op">,</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">explorationRate</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> -&gt; <span class="fu">ScoredSong</span>? <span class="op">{</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">ranked</span> <span class="op">=</span> rankSongs<span class="op">(</span>candidates<span class="op">:</span> candidates<span class="op">,</span> state<span class="op">:</span> state<span class="op">)</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="op">!</span>ranked<span class="op">.</span>isEmpty <span class="cf">else</span> <span class="op">{</span> <span class="kw">return</span> <span class="kw">nil</span> <span class="op">}</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 90% of the time, pick the best song (exploitation)</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 10% of the time, pick randomly from top 20% (exploration)</span></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> Double<span class="op">.</span>random<span class="op">(</span><span class="cf">in</span><span class="op">:</span> <span class="fl">0.</span><span class="op">.</span><span class="fl">.1</span><span class="op">)</span> <span class="op">&gt;</span> explorationRate <span class="op">{</span></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> ranked<span class="op">.</span>first</span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">topTwentyPercent</span> <span class="op">=</span> max<span class="op">(</span><span class="dv">1</span><span class="op">,</span> ranked<span class="op">.</span>count <span class="op">/</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">explorationPool</span> <span class="op">=</span> Array<span class="op">(</span>ranked<span class="op">.</span>prefix<span class="op">(</span>topTwentyPercent<span class="op">))</span></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> explorationPool<span class="op">.</span>randomElement<span class="op">()</span></span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Thompson Sampling - smarter, uncertainty-aware exploration</span></span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Songs with fewer plays have higher uncertainty, giving them</span></span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">// a chance to &quot;win&quot; occasionally through positive noise</span></span>
<span id="cb188-25"><a href="#cb188-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">selectWithThompsonSampling</span><span class="op">(</span></span>
<span id="cb188-26"><a href="#cb188-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">from</span> <span class="va">candidates</span><span class="op">:</span> [<span class="dt">Song</span>]<span class="op">,</span></span>
<span id="cb188-27"><a href="#cb188-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">state</span><span class="op">:</span> <span class="dt">UserState</span></span>
<span id="cb188-28"><a href="#cb188-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> -&gt; <span class="fu">ScoredSong</span>? <span class="op">{</span></span>
<span id="cb188-29"><a href="#cb188-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">ranked</span> <span class="op">=</span> rankSongs<span class="op">(</span>candidates<span class="op">:</span> candidates<span class="op">,</span> state<span class="op">:</span> state<span class="op">)</span></span>
<span id="cb188-30"><a href="#cb188-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-31"><a href="#cb188-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Add randomness based on uncertainty</span></span>
<span id="cb188-32"><a href="#cb188-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Songs with fewer plays have higher uncertainty</span></span>
<span id="cb188-33"><a href="#cb188-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sampledScores</span> <span class="op">=</span> ranked<span class="op">.</span>map <span class="op">{</span> scored <span class="op">-&gt;</span> <span class="op">(</span>ScoredSong<span class="op">,</span> Double<span class="op">)</span> <span class="cf">in</span></span>
<span id="cb188-34"><a href="#cb188-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">history</span> <span class="op">=</span> historyStore<span class="op">.</span>getHistory<span class="op">(</span><span class="cf">for</span><span class="op">:</span> scored<span class="op">.</span>song<span class="op">.</span>id<span class="op">)</span></span>
<span id="cb188-35"><a href="#cb188-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">playCount</span> <span class="op">=</span> history<span class="op">?.</span>playCount <span class="op">??</span> <span class="dv">0</span></span>
<span id="cb188-36"><a href="#cb188-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-37"><a href="#cb188-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Uncertainty decreases as we gather more data</span></span>
<span id="cb188-38"><a href="#cb188-38" aria-hidden="true" tabindex="-1"></a>            <span class="co">// After 10 plays, uncertainty is ~0.09; after 100 plays, ~0.01</span></span>
<span id="cb188-39"><a href="#cb188-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">uncertainty</span> <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="op">(</span>Double<span class="op">(</span>playCount<span class="op">)</span> <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb188-40"><a href="#cb188-40" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">noise</span> <span class="op">=</span> Double<span class="op">.</span>random<span class="op">(</span><span class="cf">in</span><span class="op">:</span> <span class="op">-</span>uncertainty<span class="op">...</span>uncertainty<span class="op">)</span></span>
<span id="cb188-41"><a href="#cb188-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-42"><a href="#cb188-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">(</span>scored<span class="op">,</span> scored<span class="op">.</span>score <span class="op">+</span> noise<span class="op">)</span></span>
<span id="cb188-43"><a href="#cb188-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb188-44"><a href="#cb188-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-45"><a href="#cb188-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> sampledScores<span class="op">.</span>max <span class="op">{</span> $<span class="fl">0.1</span> <span class="op">&lt;</span> $<span class="fl">1.1</span> <span class="op">}?</span><span class="fl">.0</span></span>
<span id="cb188-46"><a href="#cb188-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb188-47"><a href="#cb188-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="learning-from-feedback">15.3 Learning from Feedback</h2>
<p>The most powerful aspect of AI DJ is its ability to learn and improve
over time. Unlike static recommendation systems, AI DJ observes user
behavior and adjusts its model accordingly. This is a form of
<strong>online learning</strong> or <strong>reinforcement
learning</strong>â€”the system takes actions (plays songs), observes
outcomes (user response), and updates its beliefs (effectiveness
scores).</p>
<h3 id="implicit-vs-explicit-feedback">Implicit vs Explicit
Feedback</h3>
<p><strong>Explicit feedback</strong> is when users directly rate
content (thumbs up/down, 5-star ratings). Itâ€™s high-quality signal but
rareâ€”most users donâ€™t rate most content.</p>
<p><strong>Implicit feedback</strong> is derived from user behavior: did
they skip the song? How much of it did they listen to? Did they adjust
volume? Implicit feedback is abundant but noisyâ€”maybe they skipped
because of an interruption, not because they disliked the song.</p>
<p>AI DJ primarily uses implicit feedback because: 1. It requires no
user effort 2. Every song play generates data 3. Combined with biometric
data, itâ€™s actually more reliable than explicit ratings 4. Users may not
consciously know what helps them relaxâ€”their body does</p>
<h3 id="the-feedback-loop">The Feedback Loop</h3>
<p>The learning loop works as follows: 1. <strong>Before song</strong>:
Capture current biometric state (HR, HRV) 2. <strong>During
song</strong>: Monitor for skip, track play duration 3. <strong>After
song</strong>: Capture new biometric state, calculate delta 4.
<strong>Update model</strong>: Adjust songâ€™s effectiveness scores based
on: - <strong>Completion rate</strong>: Did user listen fully? (higher =
positive signal) - <strong>Skip rate</strong>: How often is this song
skipped? (lower = better) - <strong>Biometric delta</strong>: Did HR
decrease and HRV increase? (= calming effect) - <strong>Context
match</strong>: Did the song help achieve the intended intervention?</p>
<h3 id="exponential-moving-average-for-learning">Exponential Moving
Average for Learning</h3>
<p>We use exponential moving average (EMA) to blend new observations
with historical data. This gives more weight to recent experiences while
still remembering the past. The formula:</p>
<pre><code>new_score = Î± Ã— new_observation + (1 - Î±) Ã— old_score</code></pre>
<p>Where Î± (alpha) is the learning rate, typically 0.1-0.3. Higher Î± =
faster adaptation to new data but more susceptible to noise. Lower Î± =
more stable but slower to adapt.</p>
<p><strong>What weâ€™re doing:</strong> Learning from user behavior
without explicit ratings, using implicit signals like skip rate,
completion rate, and most importantly, biometric changes that indicate
whether the song achieved its intended effect.</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FeedbackProcessor <span class="op">{</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">historyStore</span><span class="op">:</span> SongHistoryStore</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">(</span>historyStore<span class="op">:</span> SongHistoryStore<span class="op">)</span> <span class="op">{</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>historyStore <span class="op">=</span> historyStore</span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Called when a song finishes or user takes action</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">processFeedback</span><span class="op">(</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">song</span><span class="op">:</span> <span class="dt">Song</span><span class="op">,</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">action</span><span class="op">:</span> <span class="dt">UserAction</span><span class="op">,</span></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">biometricsBefore</span><span class="op">:</span> <span class="dt">UserState</span><span class="op">,</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">biometricsAfter</span><span class="op">:</span> <span class="dt">UserState</span><span class="op">?</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">history</span> <span class="op">=</span> historyStore<span class="op">.</span>getHistory<span class="op">(</span><span class="cf">for</span><span class="op">:</span> song<span class="op">.</span>id<span class="op">)</span> <span class="op">??</span> SongHistory<span class="op">(</span>songId<span class="op">:</span> song<span class="op">.</span>id<span class="op">)</span></span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update play/skip counts</span></span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> action <span class="op">{</span></span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>listenedFully<span class="op">:</span></span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>            history<span class="op">.</span>playCount <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>            history<span class="op">.</span>completionRate <span class="op">=</span> updateRunningAverage<span class="op">(</span></span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a>                current<span class="op">:</span> history<span class="op">.</span>completionRate<span class="op">,</span></span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>                new<span class="op">:</span> <span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>                count<span class="op">:</span> history<span class="op">.</span>playCount</span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>skipped<span class="op">(</span><span class="kw">let</span> <span class="va">percentPlayed</span><span class="op">):</span></span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>            history<span class="op">.</span>playCount <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>            history<span class="op">.</span>skipCount <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>            history<span class="op">.</span>completionRate <span class="op">=</span> updateRunningAverage<span class="op">(</span></span>
<span id="cb190-30"><a href="#cb190-30" aria-hidden="true" tabindex="-1"></a>                current<span class="op">:</span> history<span class="op">.</span>completionRate<span class="op">,</span></span>
<span id="cb190-31"><a href="#cb190-31" aria-hidden="true" tabindex="-1"></a>                new<span class="op">:</span> percentPlayed<span class="op">,</span></span>
<span id="cb190-32"><a href="#cb190-32" aria-hidden="true" tabindex="-1"></a>                count<span class="op">:</span> history<span class="op">.</span>playCount</span>
<span id="cb190-33"><a href="#cb190-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb190-34"><a href="#cb190-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>liked<span class="op">:</span></span>
<span id="cb190-35"><a href="#cb190-35" aria-hidden="true" tabindex="-1"></a>            history<span class="op">.</span>likeCount <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb190-36"><a href="#cb190-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>disliked<span class="op">:</span></span>
<span id="cb190-37"><a href="#cb190-37" aria-hidden="true" tabindex="-1"></a>            history<span class="op">.</span>dislikeCount <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb190-38"><a href="#cb190-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb190-39"><a href="#cb190-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-40"><a href="#cb190-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update effectiveness scores based on biometric changes</span></span>
<span id="cb190-41"><a href="#cb190-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="va">after</span> <span class="op">=</span> biometricsAfter <span class="op">{</span></span>
<span id="cb190-42"><a href="#cb190-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">hrvChange</span> <span class="op">=</span> after<span class="op">.</span>hrv <span class="op">-</span> biometricsBefore<span class="op">.</span>hrv</span>
<span id="cb190-43"><a href="#cb190-43" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">hrChange</span> <span class="op">=</span> biometricsBefore<span class="op">.</span>heartRate <span class="op">-</span> after<span class="op">.</span>heartRate</span>
<span id="cb190-44"><a href="#cb190-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-45"><a href="#cb190-45" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Positive HRV change + HR decrease = calming effect</span></span>
<span id="cb190-46"><a href="#cb190-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> biometricsBefore<span class="op">.</span>stressLevel<span class="op">.</span>needsCalming <span class="op">{</span></span>
<span id="cb190-47"><a href="#cb190-47" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> <span class="va">calmingEffect</span> <span class="op">=</span> <span class="op">(</span>hrvChange <span class="op">/</span> <span class="dv">20</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span>hrChange <span class="op">/</span> <span class="dv">20</span><span class="op">)</span>  <span class="co">// Normalize</span></span>
<span id="cb190-48"><a href="#cb190-48" aria-hidden="true" tabindex="-1"></a>                history<span class="op">.</span>effectivenessForCalming <span class="op">=</span> updateRunningAverage<span class="op">(</span></span>
<span id="cb190-49"><a href="#cb190-49" aria-hidden="true" tabindex="-1"></a>                    current<span class="op">:</span> history<span class="op">.</span>effectivenessForCalming<span class="op">,</span></span>
<span id="cb190-50"><a href="#cb190-50" aria-hidden="true" tabindex="-1"></a>                    new<span class="op">:</span> min<span class="op">(</span><span class="dv">1</span><span class="op">,</span> max<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="fl">0.5</span> <span class="op">+</span> calmingEffect<span class="op">)),</span></span>
<span id="cb190-51"><a href="#cb190-51" aria-hidden="true" tabindex="-1"></a>                    count<span class="op">:</span> history<span class="op">.</span>playCount</span>
<span id="cb190-52"><a href="#cb190-52" aria-hidden="true" tabindex="-1"></a>                <span class="op">)</span></span>
<span id="cb190-53"><a href="#cb190-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb190-54"><a href="#cb190-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb190-55"><a href="#cb190-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-56"><a href="#cb190-56" aria-hidden="true" tabindex="-1"></a>        history<span class="op">.</span>lastPlayed <span class="op">=</span> Date<span class="op">()</span></span>
<span id="cb190-57"><a href="#cb190-57" aria-hidden="true" tabindex="-1"></a>        historyStore<span class="op">.</span>save<span class="op">(</span>history<span class="op">)</span></span>
<span id="cb190-58"><a href="#cb190-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb190-59"><a href="#cb190-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-60"><a href="#cb190-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">updateRunningAverage</span><span class="op">(</span><span class="va">current</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="va">new</span><span class="op">:</span> <span class="dt">Double</span><span class="op">,</span> <span class="va">count</span><span class="op">:</span> <span class="dt">Int</span><span class="op">)</span> -&gt; <span class="fu">Double</span> <span class="op">{</span></span>
<span id="cb190-61"><a href="#cb190-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Exponential moving average</span></span>
<span id="cb190-62"><a href="#cb190-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">alpha</span> <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> Double<span class="op">(</span>min<span class="op">(</span>count<span class="op">,</span> <span class="dv">10</span><span class="op">))</span>  <span class="co">// Cap influence of single data point</span></span>
<span id="cb190-63"><a href="#cb190-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> current <span class="op">*</span> <span class="op">(</span><span class="dv">1</span> <span class="op">-</span> alpha<span class="op">)</span> <span class="op">+</span> new <span class="op">*</span> alpha</span>
<span id="cb190-64"><a href="#cb190-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb190-65"><a href="#cb190-65" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb190-66"><a href="#cb190-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-67"><a href="#cb190-67" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> UserAction <span class="op">{</span></span>
<span id="cb190-68"><a href="#cb190-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> listenedFully</span>
<span id="cb190-69"><a href="#cb190-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> skipped<span class="op">(</span>percentPlayed<span class="op">:</span> Double<span class="op">)</span></span>
<span id="cb190-70"><a href="#cb190-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> liked</span>
<span id="cb190-71"><a href="#cb190-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> disliked</span>
<span id="cb190-72"><a href="#cb190-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb190-73"><a href="#cb190-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-74"><a href="#cb190-74" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> SongHistory <span class="op">{</span></span>
<span id="cb190-75"><a href="#cb190-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">songId</span><span class="op">:</span> String</span>
<span id="cb190-76"><a href="#cb190-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">playCount</span><span class="op">:</span> Int <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb190-77"><a href="#cb190-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">skipCount</span><span class="op">:</span> Int <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb190-78"><a href="#cb190-78" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">likeCount</span><span class="op">:</span> Int <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb190-79"><a href="#cb190-79" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">dislikeCount</span><span class="op">:</span> Int <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb190-80"><a href="#cb190-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">completionRate</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb190-81"><a href="#cb190-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">effectivenessForCalming</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb190-82"><a href="#cb190-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">effectivenessForEnergizing</span><span class="op">:</span> Double <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb190-83"><a href="#cb190-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">lastPlayed</span><span class="op">:</span> Date<span class="op">?</span></span>
<span id="cb190-84"><a href="#cb190-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="advanced-scoring-concepts">15.4 Advanced Scoring Concepts</h2>
<h3 id="normalization-and-feature-scaling">Normalization and Feature
Scaling</h3>
<p>All scoring factors must produce values in a consistent range (0 to
1) for the weighted sum to work properly. Without normalization, a
factor producing values 0-100 would dominate one producing values 0-1,
regardless of weights.</p>
<p>Common normalization approaches: - <strong>Min-Max</strong>:
<code>(value - min) / (max - min)</code> â†’ maps to 0-1 - <strong>Linear
decay</strong>: <code>max(0, 1 - value / threshold)</code> â†’ 1 at 0, 0
at threshold - <strong>Sigmoid</strong>:
<code>1 / (1 + e^(-k*(value-midpoint)))</code> â†’ smooth S-curve</p>
<p>For BPM matching, we use linear decay from perfect match (1.0) to
threshold difference (0.0). This provides intuitive, predictable
behavior.</p>
<h3 id="cold-start-problem">Cold Start Problem</h3>
<p>New songs have no history dataâ€”no play counts, no effectiveness
scores. This is the â€œcold startâ€ problem. Our solution: - Default scores
to 0.5 (neutral) rather than 0 (bad) or 1 (good) - Use Thompson Sampling
to give new songs exploration chances - Leverage song metadata (genre,
BPM) for initial estimates - After 5-10 plays, learned scores become
reliable</p>
<h3 id="score-smoothing-and-stability">Score Smoothing and
Stability</h3>
<p>Raw scores can fluctuate significantly based on small input changes.
To prevent jarring song selection changes, we can apply smoothing: -
<strong>Temporal smoothing</strong>: Average scores over the last N
biometric readings - <strong>Hysteresis</strong>: Require a minimum
score advantage before switching from current song -
<strong>Momentum</strong>: Consider not just current fit but trend
direction</p>
<h3 id="weight-tuning">Weight Tuning</h3>
<p>The default weights are starting points. Optimal weights depend on: -
User population characteristics - Music library composition - Specific
goals (stress reduction vs exercise motivation)</p>
<p>Weights can be tuned through: - <strong>A/B testing</strong>: Compare
different weight sets on user satisfaction metrics - <strong>Bayesian
optimization</strong>: Systematically search weight space - <strong>User
personalization</strong>: Allow users to adjust factor importance</p>
<hr />
<h2 id="key-takeaways---algorithm-scoring">Key Takeaways - Algorithm
&amp; Scoring</h2>
<ol type="1">
<li><strong>Weighted linear combination</strong> - Each factor scores
0-1, weights sum to 1.0, final score is weighted sum</li>
<li><strong>Normalization is critical</strong> - All factors must
produce comparable scales</li>
<li><strong>Context-adaptive weights</strong> - Workout emphasizes
BPM/energy; relaxation emphasizes calming history</li>
<li><strong>Explainability builds trust</strong> - Users should
understand why songs are chosen</li>
<li><strong>Explore vs exploit</strong> - Thompson Sampling balances
trying new songs vs proven favorites</li>
<li><strong>Implicit feedback is gold</strong> - Skips, completion rate,
and biometric deltas reveal true preference</li>
<li><strong>EMA for learning</strong> - Exponential moving average
balances recency with stability</li>
<li><strong>Cold start handling</strong> - Default to neutral (0.5), let
exploration discover quality</li>
<li><strong>The algorithm IS the product</strong> - This scoring logic
is what makes AI DJ smart</li>
</ol>
<hr />
<h1 id="testing-in-swift">16. TESTING IN SWIFT</h1>
<h2 id="why-this-matters-for-ai-dj-15">Why This Matters for AI DJ</h2>
<p>Untested code is broken code waiting to happen. AI DJ has complex
logic: scoring algorithms, biometric processing, state machines. Testing
ensures the Brain makes correct decisions. It also lets you refactor
with confidence and catch regressions before users do.</p>
<p><strong>In AI DJ, testing covers:</strong> - Unit tests for scoring
algorithm - Integration tests for HealthKit/MusicKit services - UI tests
for critical flows - Snapshot tests for widget appearances</p>
<hr />
<h2 id="xctest-basics">16.1 XCTest Basics</h2>
<h3 id="writing-unit-tests">Writing Unit Tests</h3>
<p><strong>What weâ€™re doing:</strong> Testing individual functions in
isolation.</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">XCTest</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="kw">@testable</span> <span class="im">import</span> <span class="im">AIDJ</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SongScorerTests<span class="op">:</span> <span class="dt">XCTestCase</span> <span class="op">{</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">scorer</span><span class="op">:</span> SongScorer<span class="op">!</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">func</span> <span class="fu">setUp</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">.</span>setUp<span class="op">()</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>        scorer <span class="op">=</span> SongScorer<span class="op">()</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">func</span> <span class="fu">tearDown</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>        scorer <span class="op">=</span> <span class="kw">nil</span></span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">super</span><span class="op">.</span>tearDown<span class="op">()</span></span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - BPM Score Tests</span></span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testBPMScore_perfectMatch_returns1</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Given</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> Song<span class="op">.</span>mock<span class="op">(</span>bpm<span class="op">:</span> <span class="dv">75</span><span class="op">)</span></span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">state</span> <span class="op">=</span> UserState<span class="op">.</span>mock<span class="op">(</span>heartRate<span class="op">:</span> <span class="dv">75</span><span class="op">)</span></span>
<span id="cb191-24"><a href="#cb191-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-25"><a href="#cb191-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// When</span></span>
<span id="cb191-26"><a href="#cb191-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> scorer<span class="op">.</span>score<span class="op">(</span></span>
<span id="cb191-27"><a href="#cb191-27" aria-hidden="true" tabindex="-1"></a>            song<span class="op">:</span> song<span class="op">,</span></span>
<span id="cb191-28"><a href="#cb191-28" aria-hidden="true" tabindex="-1"></a>            state<span class="op">:</span> state<span class="op">,</span></span>
<span id="cb191-29"><a href="#cb191-29" aria-hidden="true" tabindex="-1"></a>            history<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span></span>
<span id="cb191-30"><a href="#cb191-30" aria-hidden="true" tabindex="-1"></a>            weights<span class="op">:</span> <span class="op">.</span><span class="kw">init</span><span class="op">()</span></span>
<span id="cb191-31"><a href="#cb191-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb191-32"><a href="#cb191-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-33"><a href="#cb191-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Then</span></span>
<span id="cb191-34"><a href="#cb191-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">bpmComponent</span> <span class="op">=</span> result<span class="op">.</span>components<span class="op">.</span>first <span class="op">{</span> $<span class="fl">0.</span>factor <span class="op">==</span> <span class="st">&quot;BPM Match&quot;</span> <span class="op">}</span></span>
<span id="cb191-35"><a href="#cb191-35" aria-hidden="true" tabindex="-1"></a>        XCTAssertEqual<span class="op">(</span>bpmComponent<span class="op">?.</span>score<span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> accuracy<span class="op">:</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span id="cb191-36"><a href="#cb191-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-37"><a href="#cb191-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-38"><a href="#cb191-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testBPMScore_30bpmDifference_returns0_5</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-39"><a href="#cb191-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> Song<span class="op">.</span>mock<span class="op">(</span>bpm<span class="op">:</span> <span class="dv">100</span><span class="op">)</span></span>
<span id="cb191-40"><a href="#cb191-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">state</span> <span class="op">=</span> UserState<span class="op">.</span>mock<span class="op">(</span>heartRate<span class="op">:</span> <span class="dv">70</span><span class="op">)</span></span>
<span id="cb191-41"><a href="#cb191-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-42"><a href="#cb191-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> scorer<span class="op">.</span>score<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> state<span class="op">:</span> state<span class="op">,</span> history<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span> weights<span class="op">:</span> <span class="op">.</span><span class="kw">init</span><span class="op">())</span></span>
<span id="cb191-43"><a href="#cb191-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-44"><a href="#cb191-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">bpmComponent</span> <span class="op">=</span> result<span class="op">.</span>components<span class="op">.</span>first <span class="op">{</span> $<span class="fl">0.</span>factor <span class="op">==</span> <span class="st">&quot;BPM Match&quot;</span> <span class="op">}</span></span>
<span id="cb191-45"><a href="#cb191-45" aria-hidden="true" tabindex="-1"></a>        XCTAssertEqual<span class="op">(</span>bpmComponent<span class="op">?.</span>score <span class="op">??</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">,</span> accuracy<span class="op">:</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span id="cb191-46"><a href="#cb191-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-47"><a href="#cb191-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-48"><a href="#cb191-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testBPMScore_60bpmDifference_returns0</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-49"><a href="#cb191-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> Song<span class="op">.</span>mock<span class="op">(</span>bpm<span class="op">:</span> <span class="dv">130</span><span class="op">)</span></span>
<span id="cb191-50"><a href="#cb191-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">state</span> <span class="op">=</span> UserState<span class="op">.</span>mock<span class="op">(</span>heartRate<span class="op">:</span> <span class="dv">70</span><span class="op">)</span></span>
<span id="cb191-51"><a href="#cb191-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-52"><a href="#cb191-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> scorer<span class="op">.</span>score<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> state<span class="op">:</span> state<span class="op">,</span> history<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span> weights<span class="op">:</span> <span class="op">.</span><span class="kw">init</span><span class="op">())</span></span>
<span id="cb191-53"><a href="#cb191-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-54"><a href="#cb191-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">bpmComponent</span> <span class="op">=</span> result<span class="op">.</span>components<span class="op">.</span>first <span class="op">{</span> $<span class="fl">0.</span>factor <span class="op">==</span> <span class="st">&quot;BPM Match&quot;</span> <span class="op">}</span></span>
<span id="cb191-55"><a href="#cb191-55" aria-hidden="true" tabindex="-1"></a>        XCTAssertEqual<span class="op">(</span>bpmComponent<span class="op">?.</span>score <span class="op">??</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> accuracy<span class="op">:</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span id="cb191-56"><a href="#cb191-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-57"><a href="#cb191-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-58"><a href="#cb191-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Energy Score Tests</span></span>
<span id="cb191-59"><a href="#cb191-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-60"><a href="#cb191-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testEnergyScore_matchesUrgentCalm_returnsHigh</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-61"><a href="#cb191-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> Song<span class="op">.</span>mock<span class="op">(</span>energyLevel<span class="op">:</span> <span class="fl">0.2</span><span class="op">)</span>  <span class="co">// Calm song</span></span>
<span id="cb191-62"><a href="#cb191-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">state</span> <span class="op">=</span> UserState<span class="op">.</span>mock<span class="op">(</span>needsIntervention<span class="op">:</span> <span class="op">.</span>urgentCalm<span class="op">)</span></span>
<span id="cb191-63"><a href="#cb191-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-64"><a href="#cb191-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> scorer<span class="op">.</span>score<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> state<span class="op">:</span> state<span class="op">,</span> history<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span> weights<span class="op">:</span> <span class="op">.</span><span class="kw">init</span><span class="op">())</span></span>
<span id="cb191-65"><a href="#cb191-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-66"><a href="#cb191-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">energyComponent</span> <span class="op">=</span> result<span class="op">.</span>components<span class="op">.</span>first <span class="op">{</span> $<span class="fl">0.</span>factor <span class="op">==</span> <span class="st">&quot;Energy Match&quot;</span> <span class="op">}</span></span>
<span id="cb191-67"><a href="#cb191-67" aria-hidden="true" tabindex="-1"></a>        XCTAssertGreaterThan<span class="op">(</span>energyComponent<span class="op">?.</span>score <span class="op">??</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span id="cb191-68"><a href="#cb191-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-69"><a href="#cb191-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-70"><a href="#cb191-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testEnergyScore_tooEnergeticForCalm_returnsLow</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-71"><a href="#cb191-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> Song<span class="op">.</span>mock<span class="op">(</span>energyLevel<span class="op">:</span> <span class="fl">0.9</span><span class="op">)</span>  <span class="co">// High energy song</span></span>
<span id="cb191-72"><a href="#cb191-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">state</span> <span class="op">=</span> UserState<span class="op">.</span>mock<span class="op">(</span>needsIntervention<span class="op">:</span> <span class="op">.</span>urgentCalm<span class="op">)</span></span>
<span id="cb191-73"><a href="#cb191-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-74"><a href="#cb191-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> scorer<span class="op">.</span>score<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> state<span class="op">:</span> state<span class="op">,</span> history<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span> weights<span class="op">:</span> <span class="op">.</span><span class="kw">init</span><span class="op">())</span></span>
<span id="cb191-75"><a href="#cb191-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-76"><a href="#cb191-76" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">energyComponent</span> <span class="op">=</span> result<span class="op">.</span>components<span class="op">.</span>first <span class="op">{</span> $<span class="fl">0.</span>factor <span class="op">==</span> <span class="st">&quot;Energy Match&quot;</span> <span class="op">}</span></span>
<span id="cb191-77"><a href="#cb191-77" aria-hidden="true" tabindex="-1"></a>        XCTAssertLessThan<span class="op">(</span>energyComponent<span class="op">?.</span>score <span class="op">??</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span id="cb191-78"><a href="#cb191-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-79"><a href="#cb191-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-80"><a href="#cb191-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MARK: - Overall Score Tests</span></span>
<span id="cb191-81"><a href="#cb191-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-82"><a href="#cb191-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testOverallScore_perfectSong_scoresHigh</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb191-83"><a href="#cb191-83" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">song</span> <span class="op">=</span> Song<span class="op">.</span>mock<span class="op">(</span>bpm<span class="op">:</span> <span class="dv">70</span><span class="op">,</span> energyLevel<span class="op">:</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span id="cb191-84"><a href="#cb191-84" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">state</span> <span class="op">=</span> UserState<span class="op">.</span>mock<span class="op">(</span>heartRate<span class="op">:</span> <span class="dv">70</span><span class="op">,</span> needsIntervention<span class="op">:</span> <span class="op">.</span>urgentCalm<span class="op">)</span></span>
<span id="cb191-85"><a href="#cb191-85" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">history</span> <span class="op">=</span> SongHistory<span class="op">.</span>mock<span class="op">(</span>playCount<span class="op">:</span> <span class="dv">10</span><span class="op">,</span> effectivenessForCalming<span class="op">:</span> <span class="fl">0.9</span><span class="op">)</span></span>
<span id="cb191-86"><a href="#cb191-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-87"><a href="#cb191-87" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> scorer<span class="op">.</span>score<span class="op">(</span>song<span class="op">:</span> song<span class="op">,</span> state<span class="op">:</span> state<span class="op">,</span> history<span class="op">:</span> history<span class="op">,</span> weights<span class="op">:</span> <span class="op">.</span><span class="kw">init</span><span class="op">())</span></span>
<span id="cb191-88"><a href="#cb191-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-89"><a href="#cb191-89" aria-hidden="true" tabindex="-1"></a>        XCTAssertGreaterThan<span class="op">(</span>result<span class="op">.</span>score<span class="op">,</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span id="cb191-90"><a href="#cb191-90" aria-hidden="true" tabindex="-1"></a>        XCTAssertFalse<span class="op">(</span>result<span class="op">.</span>reasons<span class="op">.</span>isEmpty<span class="op">)</span></span>
<span id="cb191-91"><a href="#cb191-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-92"><a href="#cb191-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb191-93"><a href="#cb191-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-94"><a href="#cb191-94" aria-hidden="true" tabindex="-1"></a><span class="co">// MARK: - Test Mocks</span></span>
<span id="cb191-95"><a href="#cb191-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-96"><a href="#cb191-96" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> Song <span class="op">{</span></span>
<span id="cb191-97"><a href="#cb191-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">func</span> <span class="fu">mock</span><span class="op">(</span><span class="va">bpm</span><span class="op">:</span> <span class="dt">Int</span><span class="op">?</span> <span class="op">=</span> <span class="dv">100</span><span class="op">,</span> <span class="va">energyLevel</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> -&gt; <span class="fu">Song</span> <span class="op">{</span></span>
<span id="cb191-98"><a href="#cb191-98" aria-hidden="true" tabindex="-1"></a>        Song<span class="op">(</span></span>
<span id="cb191-99"><a href="#cb191-99" aria-hidden="true" tabindex="-1"></a>            id<span class="op">:</span> UUID<span class="op">().</span>uuidString<span class="op">,</span></span>
<span id="cb191-100"><a href="#cb191-100" aria-hidden="true" tabindex="-1"></a>            title<span class="op">:</span> <span class="st">&quot;Test Song&quot;</span><span class="op">,</span></span>
<span id="cb191-101"><a href="#cb191-101" aria-hidden="true" tabindex="-1"></a>            artist<span class="op">:</span> <span class="st">&quot;Test Artist&quot;</span><span class="op">,</span></span>
<span id="cb191-102"><a href="#cb191-102" aria-hidden="true" tabindex="-1"></a>            bpm<span class="op">:</span> bpm<span class="op">,</span></span>
<span id="cb191-103"><a href="#cb191-103" aria-hidden="true" tabindex="-1"></a>            energyLevel<span class="op">:</span> energyLevel</span>
<span id="cb191-104"><a href="#cb191-104" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb191-105"><a href="#cb191-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-106"><a href="#cb191-106" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb191-107"><a href="#cb191-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-108"><a href="#cb191-108" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> UserState <span class="op">{</span></span>
<span id="cb191-109"><a href="#cb191-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">func</span> <span class="fu">mock</span><span class="op">(</span></span>
<span id="cb191-110"><a href="#cb191-110" aria-hidden="true" tabindex="-1"></a>        <span class="va">heartRate</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="dv">70</span><span class="op">,</span></span>
<span id="cb191-111"><a href="#cb191-111" aria-hidden="true" tabindex="-1"></a>        <span class="va">hrv</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb191-112"><a href="#cb191-112" aria-hidden="true" tabindex="-1"></a>        <span class="va">needsIntervention</span><span class="op">:</span> <span class="dt">MusicIntervention</span> <span class="op">=</span> <span class="op">.</span>maintain</span>
<span id="cb191-113"><a href="#cb191-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> -&gt; <span class="fu">UserState</span> <span class="op">{</span></span>
<span id="cb191-114"><a href="#cb191-114" aria-hidden="true" tabindex="-1"></a>        UserState<span class="op">(</span></span>
<span id="cb191-115"><a href="#cb191-115" aria-hidden="true" tabindex="-1"></a>            heartRate<span class="op">:</span> heartRate<span class="op">,</span></span>
<span id="cb191-116"><a href="#cb191-116" aria-hidden="true" tabindex="-1"></a>            hrv<span class="op">:</span> hrv<span class="op">,</span></span>
<span id="cb191-117"><a href="#cb191-117" aria-hidden="true" tabindex="-1"></a>            heartRateZone<span class="op">:</span> <span class="op">.</span>baseline<span class="op">,</span></span>
<span id="cb191-118"><a href="#cb191-118" aria-hidden="true" tabindex="-1"></a>            stressLevel<span class="op">:</span> <span class="op">.</span>low<span class="op">,</span></span>
<span id="cb191-119"><a href="#cb191-119" aria-hidden="true" tabindex="-1"></a>            heartRateTrend<span class="op">:</span> <span class="op">.</span>stable<span class="op">,</span></span>
<span id="cb191-120"><a href="#cb191-120" aria-hidden="true" tabindex="-1"></a>            hrvTrend<span class="op">:</span> <span class="op">.</span>stable<span class="op">,</span></span>
<span id="cb191-121"><a href="#cb191-121" aria-hidden="true" tabindex="-1"></a>            needsIntervention<span class="op">:</span> needsIntervention</span>
<span id="cb191-122"><a href="#cb191-122" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb191-123"><a href="#cb191-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-124"><a href="#cb191-124" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb191-125"><a href="#cb191-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-126"><a href="#cb191-126" aria-hidden="true" tabindex="-1"></a><span class="kw">extension</span> SongHistory <span class="op">{</span></span>
<span id="cb191-127"><a href="#cb191-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">func</span> <span class="fu">mock</span><span class="op">(</span></span>
<span id="cb191-128"><a href="#cb191-128" aria-hidden="true" tabindex="-1"></a>        <span class="va">playCount</span><span class="op">:</span> <span class="dt">Int</span> <span class="op">=</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb191-129"><a href="#cb191-129" aria-hidden="true" tabindex="-1"></a>        <span class="va">effectivenessForCalming</span><span class="op">:</span> <span class="dt">Double</span> <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb191-130"><a href="#cb191-130" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> -&gt; <span class="fu">SongHistory</span> <span class="op">{</span></span>
<span id="cb191-131"><a href="#cb191-131" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">history</span> <span class="op">=</span> SongHistory<span class="op">(</span>songId<span class="op">:</span> <span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb191-132"><a href="#cb191-132" aria-hidden="true" tabindex="-1"></a>        history<span class="op">.</span>playCount <span class="op">=</span> playCount</span>
<span id="cb191-133"><a href="#cb191-133" aria-hidden="true" tabindex="-1"></a>        history<span class="op">.</span>effectivenessForCalming <span class="op">=</span> effectivenessForCalming</span>
<span id="cb191-134"><a href="#cb191-134" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> history</span>
<span id="cb191-135"><a href="#cb191-135" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb191-136"><a href="#cb191-136" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="async-testing">16.2 Async Testing</h2>
<h3 id="testing-async-functions">Testing Async Functions</h3>
<p><strong>What weâ€™re doing:</strong> Testing functions that use
async/await.</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthKitServiceTests<span class="op">:</span> <span class="dt">XCTestCase</span> <span class="op">{</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">mockHealthStore</span><span class="op">:</span> MockHealthStore<span class="op">!</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">service</span><span class="op">:</span> HealthKitService<span class="op">!</span></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">func</span> <span class="fu">setUp</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>        mockHealthStore <span class="op">=</span> MockHealthStore<span class="op">()</span></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>        service <span class="op">=</span> HealthKitService<span class="op">(</span>healthStore<span class="op">:</span> mockHealthStore<span class="op">)</span></span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testFetchLatestHeartRate_returnsMostRecent</span><span class="op">()</span> <span class="fu">async</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Given</span></span>
<span id="cb192-13"><a href="#cb192-13" aria-hidden="true" tabindex="-1"></a>        mockHealthStore<span class="op">.</span>mockHeartRateSamples <span class="op">=</span> <span class="op">[</span></span>
<span id="cb192-14"><a href="#cb192-14" aria-hidden="true" tabindex="-1"></a>            MockSample<span class="op">(</span>value<span class="op">:</span> <span class="dv">70</span><span class="op">,</span> date<span class="op">:</span> Date<span class="op">().</span>addingTimeInterval<span class="op">(-</span><span class="dv">60</span><span class="op">)),</span></span>
<span id="cb192-15"><a href="#cb192-15" aria-hidden="true" tabindex="-1"></a>            MockSample<span class="op">(</span>value<span class="op">:</span> <span class="dv">75</span><span class="op">,</span> date<span class="op">:</span> Date<span class="op">().</span>addingTimeInterval<span class="op">(-</span><span class="dv">30</span><span class="op">)),</span></span>
<span id="cb192-16"><a href="#cb192-16" aria-hidden="true" tabindex="-1"></a>            MockSample<span class="op">(</span>value<span class="op">:</span> <span class="dv">80</span><span class="op">,</span> date<span class="op">:</span> Date<span class="op">())</span>  <span class="co">// Most recent</span></span>
<span id="cb192-17"><a href="#cb192-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb192-18"><a href="#cb192-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-19"><a href="#cb192-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// When</span></span>
<span id="cb192-20"><a href="#cb192-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> service<span class="op">.</span>fetchLatestHeartRate<span class="op">()</span></span>
<span id="cb192-21"><a href="#cb192-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-22"><a href="#cb192-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Then</span></span>
<span id="cb192-23"><a href="#cb192-23" aria-hidden="true" tabindex="-1"></a>        XCTAssertEqual<span class="op">(</span>result<span class="op">,</span> <span class="dv">80</span><span class="op">)</span></span>
<span id="cb192-24"><a href="#cb192-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb192-25"><a href="#cb192-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-26"><a href="#cb192-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testFetchLatestHeartRate_noData_throws</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb192-27"><a href="#cb192-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Given</span></span>
<span id="cb192-28"><a href="#cb192-28" aria-hidden="true" tabindex="-1"></a>        mockHealthStore<span class="op">.</span>mockHeartRateSamples <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb192-29"><a href="#cb192-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-30"><a href="#cb192-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// When/Then</span></span>
<span id="cb192-31"><a href="#cb192-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb192-32"><a href="#cb192-32" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> service<span class="op">.</span>fetchLatestHeartRate<span class="op">()</span></span>
<span id="cb192-33"><a href="#cb192-33" aria-hidden="true" tabindex="-1"></a>            XCTFail<span class="op">(</span><span class="st">&quot;Expected error to be thrown&quot;</span><span class="op">)</span></span>
<span id="cb192-34"><a href="#cb192-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb192-35"><a href="#cb192-35" aria-hidden="true" tabindex="-1"></a>            XCTAssertEqual<span class="op">(</span>error <span class="kw">as</span><span class="op">?</span> HealthKitError<span class="op">,</span> <span class="op">.</span>noData<span class="op">)</span></span>
<span id="cb192-36"><a href="#cb192-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb192-37"><a href="#cb192-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb192-38"><a href="#cb192-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb192-39"><a href="#cb192-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-40"><a href="#cb192-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Mock HealthKit store for testing</span></span>
<span id="cb192-41"><a href="#cb192-41" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MockHealthStore<span class="op">:</span> <span class="dt">HealthStoreProtocol</span> <span class="op">{</span></span>
<span id="cb192-42"><a href="#cb192-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">mockHeartRateSamples</span><span class="op">:</span> <span class="op">[</span>MockSample<span class="op">]</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb192-43"><a href="#cb192-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-44"><a href="#cb192-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">execute</span><span class="op">(</span><span class="va">_</span> <span class="va">query</span><span class="op">:</span> <span class="dt">HKQuery</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb192-45"><a href="#cb192-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Simulate query execution</span></span>
<span id="cb192-46"><a href="#cb192-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb192-47"><a href="#cb192-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-48"><a href="#cb192-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">fetchLatestSample</span><span class="op">(</span><span class="va">type</span><span class="op">:</span> <span class="dt">HKQuantityType</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">HKQuantitySample</span>? <span class="op">{</span></span>
<span id="cb192-49"><a href="#cb192-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> mockHeartRateSamples<span class="op">.</span>last<span class="op">?.</span>toHKSample<span class="op">()</span></span>
<span id="cb192-50"><a href="#cb192-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb192-51"><a href="#cb192-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="dependency-injection-for-testability">16.3 Dependency Injection
for Testability</h2>
<h3 id="protocol-based-dependencies-1">Protocol-Based Dependencies</h3>
<p><strong>What weâ€™re doing:</strong> Making components testable by
injecting dependencies.</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Instead of creating dependencies internally, inject them</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NowPlayingViewModel<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">musicService</span><span class="op">:</span> MusicServiceProtocol</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">healthService</span><span class="op">:</span> HealthServiceProtocol</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">brain</span><span class="op">:</span> MusicBrainProtocol</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Inject dependencies - can be real or mock</span></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">(</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>        musicService<span class="op">:</span> MusicServiceProtocol<span class="op">,</span></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>        healthService<span class="op">:</span> HealthServiceProtocol<span class="op">,</span></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>        brain<span class="op">:</span> MusicBrainProtocol</span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>musicService <span class="op">=</span> musicService</span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>healthService <span class="op">=</span> healthService</span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>brain <span class="op">=</span> brain</span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb193-18"><a href="#cb193-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-19"><a href="#cb193-19" aria-hidden="true" tabindex="-1"></a><span class="co">// In tests, inject mocks</span></span>
<span id="cb193-20"><a href="#cb193-20" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NowPlayingViewModelTests<span class="op">:</span> <span class="dt">XCTestCase</span> <span class="op">{</span></span>
<span id="cb193-21"><a href="#cb193-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-22"><a href="#cb193-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testSelectNextSong_usesTopRankedSong</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb193-23"><a href="#cb193-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Given</span></span>
<span id="cb193-24"><a href="#cb193-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">mockMusic</span> <span class="op">=</span> MockMusicService<span class="op">()</span></span>
<span id="cb193-25"><a href="#cb193-25" aria-hidden="true" tabindex="-1"></a>        mockMusic<span class="op">.</span>mockPlaylistSongs <span class="op">=</span> <span class="op">[</span></span>
<span id="cb193-26"><a href="#cb193-26" aria-hidden="true" tabindex="-1"></a>            Song<span class="op">.</span>mock<span class="op">(</span>title<span class="op">:</span> <span class="st">&quot;Song A&quot;</span><span class="op">),</span></span>
<span id="cb193-27"><a href="#cb193-27" aria-hidden="true" tabindex="-1"></a>            Song<span class="op">.</span>mock<span class="op">(</span>title<span class="op">:</span> <span class="st">&quot;Song B&quot;</span><span class="op">)</span></span>
<span id="cb193-28"><a href="#cb193-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb193-29"><a href="#cb193-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-30"><a href="#cb193-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">mockHealth</span> <span class="op">=</span> MockHealthService<span class="op">()</span></span>
<span id="cb193-31"><a href="#cb193-31" aria-hidden="true" tabindex="-1"></a>        mockHealth<span class="op">.</span>mockHeartRate <span class="op">=</span> <span class="dv">70</span></span>
<span id="cb193-32"><a href="#cb193-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-33"><a href="#cb193-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">mockBrain</span> <span class="op">=</span> MockMusicBrain<span class="op">()</span></span>
<span id="cb193-34"><a href="#cb193-34" aria-hidden="true" tabindex="-1"></a>        mockBrain<span class="op">.</span>mockTopSong <span class="op">=</span> Song<span class="op">.</span>mock<span class="op">(</span>title<span class="op">:</span> <span class="st">&quot;Song B&quot;</span><span class="op">)</span></span>
<span id="cb193-35"><a href="#cb193-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-36"><a href="#cb193-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">viewModel</span> <span class="op">=</span> NowPlayingViewModel<span class="op">(</span></span>
<span id="cb193-37"><a href="#cb193-37" aria-hidden="true" tabindex="-1"></a>            musicService<span class="op">:</span> mockMusic<span class="op">,</span></span>
<span id="cb193-38"><a href="#cb193-38" aria-hidden="true" tabindex="-1"></a>            healthService<span class="op">:</span> mockHealth<span class="op">,</span></span>
<span id="cb193-39"><a href="#cb193-39" aria-hidden="true" tabindex="-1"></a>            brain<span class="op">:</span> mockBrain</span>
<span id="cb193-40"><a href="#cb193-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb193-41"><a href="#cb193-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-42"><a href="#cb193-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// When</span></span>
<span id="cb193-43"><a href="#cb193-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> viewModel<span class="op">.</span>selectNextSong<span class="op">()</span></span>
<span id="cb193-44"><a href="#cb193-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-45"><a href="#cb193-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Then</span></span>
<span id="cb193-46"><a href="#cb193-46" aria-hidden="true" tabindex="-1"></a>        XCTAssertEqual<span class="op">(</span>viewModel<span class="op">.</span>currentSong<span class="op">?.</span>title<span class="op">,</span> <span class="st">&quot;Song B&quot;</span><span class="op">)</span></span>
<span id="cb193-47"><a href="#cb193-47" aria-hidden="true" tabindex="-1"></a>        XCTAssertEqual<span class="op">(</span>mockMusic<span class="op">.</span>playedSong<span class="op">?.</span>title<span class="op">,</span> <span class="st">&quot;Song B&quot;</span><span class="op">)</span></span>
<span id="cb193-48"><a href="#cb193-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb193-49"><a href="#cb193-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="ui-testing">16.4 UI Testing</h2>
<h3 id="xcuitest-basics">XCUITest Basics</h3>
<p><strong>What weâ€™re doing:</strong> Testing the actual UI
interactions.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">XCTest</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AIDJUITests<span class="op">:</span> <span class="dt">XCTestCase</span> <span class="op">{</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">app</span><span class="op">:</span> XCUIApplication<span class="op">!</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">override</span> <span class="kw">func</span> <span class="fu">setUp</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>        continueAfterFailure <span class="op">=</span> <span class="kw">false</span></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>        app <span class="op">=</span> XCUIApplication<span class="op">()</span></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>        app<span class="op">.</span>launchArguments <span class="op">=</span> <span class="op">[</span><span class="st">&quot;--uitesting&quot;</span><span class="op">]</span>  <span class="co">// Use test data</span></span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>        app<span class="op">.</span>launch<span class="op">()</span></span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testPlaybackControls</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Given</span></span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">playButton</span> <span class="op">=</span> app<span class="op">.</span>buttons<span class="op">[</span><span class="st">&quot;PlayPauseButton&quot;</span><span class="op">]</span></span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// When - tap play</span></span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a>        playButton<span class="op">.</span>tap<span class="op">()</span></span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Then - button should change to pause</span></span>
<span id="cb194-22"><a href="#cb194-22" aria-hidden="true" tabindex="-1"></a>        XCTAssertTrue<span class="op">(</span>app<span class="op">.</span>buttons<span class="op">[</span><span class="st">&quot;PauseButton&quot;</span><span class="op">].</span>exists <span class="op">||</span></span>
<span id="cb194-23"><a href="#cb194-23" aria-hidden="true" tabindex="-1"></a>                     playButton<span class="op">.</span>label<span class="op">.</span>contains<span class="op">(</span><span class="st">&quot;Pause&quot;</span><span class="op">))</span></span>
<span id="cb194-24"><a href="#cb194-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb194-25"><a href="#cb194-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-26"><a href="#cb194-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testNavigationToSettings</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb194-27"><a href="#cb194-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Given</span></span>
<span id="cb194-28"><a href="#cb194-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">settingsButton</span> <span class="op">=</span> app<span class="op">.</span>buttons<span class="op">[</span><span class="st">&quot;SettingsButton&quot;</span><span class="op">]</span></span>
<span id="cb194-29"><a href="#cb194-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-30"><a href="#cb194-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// When</span></span>
<span id="cb194-31"><a href="#cb194-31" aria-hidden="true" tabindex="-1"></a>        settingsButton<span class="op">.</span>tap<span class="op">()</span></span>
<span id="cb194-32"><a href="#cb194-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-33"><a href="#cb194-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Then</span></span>
<span id="cb194-34"><a href="#cb194-34" aria-hidden="true" tabindex="-1"></a>        XCTAssertTrue<span class="op">(</span>app<span class="op">.</span>navigationBars<span class="op">[</span><span class="st">&quot;Settings&quot;</span><span class="op">].</span>exists<span class="op">)</span></span>
<span id="cb194-35"><a href="#cb194-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb194-36"><a href="#cb194-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-37"><a href="#cb194-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">testHeartRateDisplay</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb194-38"><a href="#cb194-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Given - mock heart rate data in launch arguments</span></span>
<span id="cb194-39"><a href="#cb194-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-40"><a href="#cb194-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Then</span></span>
<span id="cb194-41"><a href="#cb194-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">heartRateLabel</span> <span class="op">=</span> app<span class="op">.</span>staticTexts<span class="op">.</span>matching<span class="op">(</span></span>
<span id="cb194-42"><a href="#cb194-42" aria-hidden="true" tabindex="-1"></a>            NSPredicate<span class="op">(</span>format<span class="op">:</span> <span class="st">&quot;label CONTAINS &#39;BPM&#39;&quot;</span><span class="op">)</span></span>
<span id="cb194-43"><a href="#cb194-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">).</span>firstMatch</span>
<span id="cb194-44"><a href="#cb194-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb194-45"><a href="#cb194-45" aria-hidden="true" tabindex="-1"></a>        XCTAssertTrue<span class="op">(</span>heartRateLabel<span class="op">.</span>exists<span class="op">)</span></span>
<span id="cb194-46"><a href="#cb194-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb194-47"><a href="#cb194-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="key-takeaways---testing">Key Takeaways - Testing</h2>
<ol type="1">
<li><strong>Unit test the Brain</strong> - Scoring logic should be
thoroughly tested</li>
<li><strong>Use mocks for external services</strong> - Donâ€™t hit real
HealthKit in tests</li>
<li><strong>Dependency injection enables testing</strong> - Pass
dependencies, donâ€™t create them</li>
<li><strong>Async tests with <code>async throws</code></strong> - XCTest
supports async natively</li>
<li><strong>UI tests for critical paths</strong> - Playback controls,
navigation</li>
<li><strong>Test edge cases</strong> - Empty data, nil values, extreme
inputs</li>
</ol>
<hr />
<h1 id="security-privacy-entitlements">17. SECURITY, PRIVACY &amp;
ENTITLEMENTS</h1>
<h2 id="why-this-matters-for-ai-dj-16">Why This Matters for AI DJ</h2>
<p>AI DJ handles sensitive data: health metrics and music listening
history. Users trust us with their heart rate data. Apple mandates
specific privacy protections, and violating them means App Store
rejection. Beyond compliance, respecting privacy builds user trust.</p>
<p><strong>In AI DJ, security and privacy cover:</strong> - Requesting
only necessary permissions - Securing stored health data - Explaining
data usage to users - Proper entitlements configuration</p>
<hr />
<h2 id="privacy-permissions">17.1 Privacy Permissions</h2>
<h3 id="info.plist-privacy-descriptions">Info.plist Privacy
Descriptions</h3>
<p><strong>What weâ€™re doing:</strong> Explaining why we need each
permission.</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span> <span class="ot">version=</span><span class="st">&quot;1.0&quot;</span> <span class="ot">encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">plist</span> PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; ...<span class="dt">&gt;</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">plist</span> <span class="ot">version=</span><span class="st">&quot;1.0&quot;</span>&gt;</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dict</span>&gt;</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- HealthKit --&gt;</span></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;NSHealthShareUsageDescription&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">string</span>&gt;AI DJ reads your heart rate and heart rate variability to select music that matches your current state, helping you relax or energize as needed.&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Music Library --&gt;</span></span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;NSAppleMusicUsageDescription&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">string</span>&gt;AI DJ needs access to your Apple Music library to play songs from your playlists.&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Microphone (if using for ambient sound analysis) --&gt;</span></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;NSMicrophoneUsageDescription&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">string</span>&gt;AI DJ can listen to ambient sound to enhance music selection for your environment.&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Location (if using for context) --&gt;</span></span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;NSLocationWhenInUseUsageDescription&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">string</span>&gt;AI DJ uses your location to suggest music appropriate for your current environment (gym, home, commute).&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dict</span>&gt;</span>
<span id="cb195-21"><a href="#cb195-21" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">plist</span>&gt;</span></code></pre></div>
<p><strong>Best practices:</strong> - Explain the benefit to the user,
not just what you access - Be specific: â€œheart rate to select calming
musicâ€ not â€œhealth dataâ€ - Request permissions at the point of use, not
at app launch</p>
<hr />
<h3 id="progressive-permission-requests">Progressive Permission
Requests</h3>
<p><strong>What weâ€™re doing:</strong> Requesting permissions only when
needed, with context.</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PermissionManager<span class="op">:</span> <span class="dt">ObservableObject</span> <span class="op">{</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">healthPermissionStatus</span><span class="op">:</span> PermissionStatus <span class="op">=</span> <span class="op">.</span>notDetermined</span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Published</span> <span class="kw">var</span> <span class="va">musicPermissionStatus</span><span class="op">:</span> PermissionStatus <span class="op">=</span> <span class="op">.</span>notDetermined</span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> PermissionStatus <span class="op">{</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> notDetermined</span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> authorized</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> denied</span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Called when user first tries to use biometric features</span></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">requestHealthPermission</span><span class="op">()</span> <span class="fu">async</span> -&gt; <span class="fu">Bool</span> <span class="op">{</span></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Show explanation first</span></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// &quot;To select music that matches your state, AI DJ needs to read your heart rate.&quot;</span></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">healthManager</span> <span class="op">=</span> HealthKitManager<span class="op">()</span></span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-18"><a href="#cb196-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb196-19"><a href="#cb196-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="cf">await</span> healthManager<span class="op">.</span>requestAuthorization<span class="op">()</span></span>
<span id="cb196-20"><a href="#cb196-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb196-21"><a href="#cb196-21" aria-hidden="true" tabindex="-1"></a>                healthPermissionStatus <span class="op">=</span> <span class="op">.</span>authorized</span>
<span id="cb196-22"><a href="#cb196-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb196-23"><a href="#cb196-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">true</span></span>
<span id="cb196-24"><a href="#cb196-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb196-25"><a href="#cb196-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb196-26"><a href="#cb196-26" aria-hidden="true" tabindex="-1"></a>                healthPermissionStatus <span class="op">=</span> <span class="op">.</span>denied</span>
<span id="cb196-27"><a href="#cb196-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb196-28"><a href="#cb196-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="kw">false</span></span>
<span id="cb196-29"><a href="#cb196-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb196-30"><a href="#cb196-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb196-31"><a href="#cb196-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-32"><a href="#cb196-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Called when user first tries to play music</span></span>
<span id="cb196-33"><a href="#cb196-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">requestMusicPermission</span><span class="op">()</span> <span class="fu">async</span> -&gt; <span class="fu">Bool</span> <span class="op">{</span></span>
<span id="cb196-34"><a href="#cb196-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">status</span> <span class="op">=</span> <span class="cf">await</span> MusicAuthorization<span class="op">.</span>request<span class="op">()</span></span>
<span id="cb196-35"><a href="#cb196-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-36"><a href="#cb196-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> MainActor<span class="op">.</span>run <span class="op">{</span></span>
<span id="cb196-37"><a href="#cb196-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">switch</span> status <span class="op">{</span></span>
<span id="cb196-38"><a href="#cb196-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">.</span>authorized<span class="op">:</span></span>
<span id="cb196-39"><a href="#cb196-39" aria-hidden="true" tabindex="-1"></a>                musicPermissionStatus <span class="op">=</span> <span class="op">.</span>authorized</span>
<span id="cb196-40"><a href="#cb196-40" aria-hidden="true" tabindex="-1"></a>            <span class="kw">default</span><span class="op">:</span></span>
<span id="cb196-41"><a href="#cb196-41" aria-hidden="true" tabindex="-1"></a>                musicPermissionStatus <span class="op">=</span> <span class="op">.</span>denied</span>
<span id="cb196-42"><a href="#cb196-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb196-43"><a href="#cb196-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb196-44"><a href="#cb196-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-45"><a href="#cb196-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> status <span class="op">==</span> <span class="op">.</span>authorized</span>
<span id="cb196-46"><a href="#cb196-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb196-47"><a href="#cb196-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb196-48"><a href="#cb196-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-49"><a href="#cb196-49" aria-hidden="true" tabindex="-1"></a><span class="co">// In UI</span></span>
<span id="cb196-50"><a href="#cb196-50" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> OnboardingView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb196-51"><a href="#cb196-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">@StateObject</span> <span class="kw">private</span> <span class="kw">var</span> <span class="va">permissions</span> <span class="op">=</span> PermissionManager<span class="op">()</span></span>
<span id="cb196-52"><a href="#cb196-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-53"><a href="#cb196-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb196-54"><a href="#cb196-54" aria-hidden="true" tabindex="-1"></a>        VStack<span class="op">(</span>spacing<span class="op">:</span> <span class="dv">20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb196-55"><a href="#cb196-55" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span><span class="st">&quot;AI DJ needs a few permissions to work its magic&quot;</span><span class="op">)</span></span>
<span id="cb196-56"><a href="#cb196-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-57"><a href="#cb196-57" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Health permission card</span></span>
<span id="cb196-58"><a href="#cb196-58" aria-hidden="true" tabindex="-1"></a>            PermissionCard<span class="op">(</span></span>
<span id="cb196-59"><a href="#cb196-59" aria-hidden="true" tabindex="-1"></a>                title<span class="op">:</span> <span class="st">&quot;Health Data&quot;</span><span class="op">,</span></span>
<span id="cb196-60"><a href="#cb196-60" aria-hidden="true" tabindex="-1"></a>                description<span class="op">:</span> <span class="st">&quot;Read your heart rate to select the perfect music&quot;</span><span class="op">,</span></span>
<span id="cb196-61"><a href="#cb196-61" aria-hidden="true" tabindex="-1"></a>                icon<span class="op">:</span> <span class="st">&quot;heart.fill&quot;</span><span class="op">,</span></span>
<span id="cb196-62"><a href="#cb196-62" aria-hidden="true" tabindex="-1"></a>                status<span class="op">:</span> permissions<span class="op">.</span>healthPermissionStatus<span class="op">,</span></span>
<span id="cb196-63"><a href="#cb196-63" aria-hidden="true" tabindex="-1"></a>                action<span class="op">:</span> <span class="op">{</span></span>
<span id="cb196-64"><a href="#cb196-64" aria-hidden="true" tabindex="-1"></a>                    Task <span class="op">{</span></span>
<span id="cb196-65"><a href="#cb196-65" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">await</span> permissions<span class="op">.</span>requestHealthPermission<span class="op">()</span></span>
<span id="cb196-66"><a href="#cb196-66" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb196-67"><a href="#cb196-67" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb196-68"><a href="#cb196-68" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb196-69"><a href="#cb196-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-70"><a href="#cb196-70" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Music permission card</span></span>
<span id="cb196-71"><a href="#cb196-71" aria-hidden="true" tabindex="-1"></a>            PermissionCard<span class="op">(</span></span>
<span id="cb196-72"><a href="#cb196-72" aria-hidden="true" tabindex="-1"></a>                title<span class="op">:</span> <span class="st">&quot;Apple Music&quot;</span><span class="op">,</span></span>
<span id="cb196-73"><a href="#cb196-73" aria-hidden="true" tabindex="-1"></a>                description<span class="op">:</span> <span class="st">&quot;Access your playlists and play songs&quot;</span><span class="op">,</span></span>
<span id="cb196-74"><a href="#cb196-74" aria-hidden="true" tabindex="-1"></a>                icon<span class="op">:</span> <span class="st">&quot;music.note&quot;</span><span class="op">,</span></span>
<span id="cb196-75"><a href="#cb196-75" aria-hidden="true" tabindex="-1"></a>                status<span class="op">:</span> permissions<span class="op">.</span>musicPermissionStatus<span class="op">,</span></span>
<span id="cb196-76"><a href="#cb196-76" aria-hidden="true" tabindex="-1"></a>                action<span class="op">:</span> <span class="op">{</span></span>
<span id="cb196-77"><a href="#cb196-77" aria-hidden="true" tabindex="-1"></a>                    Task <span class="op">{</span></span>
<span id="cb196-78"><a href="#cb196-78" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">await</span> permissions<span class="op">.</span>requestMusicPermission<span class="op">()</span></span>
<span id="cb196-79"><a href="#cb196-79" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb196-80"><a href="#cb196-80" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb196-81"><a href="#cb196-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb196-82"><a href="#cb196-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb196-83"><a href="#cb196-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb196-84"><a href="#cb196-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="data-security">17.2 Data Security</h2>
<h3 id="keychain-for-sensitive-data">Keychain for Sensitive Data</h3>
<p><strong>What weâ€™re doing:</strong> Storing sensitive data
securely.</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">Security</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> KeychainManager <span class="op">{</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> KeychainError<span class="op">:</span> <span class="dt">Error</span> <span class="op">{</span></span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> duplicateEntry</span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> unknown<span class="op">(</span>OSStatus<span class="op">)</span></span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> notFound</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> invalidData</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">save</span><span class="op">(</span><span class="va">_</span> <span class="va">data</span><span class="op">:</span> <span class="dt">Data</span><span class="op">,</span> <span class="va">service</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">account</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>            kSecClass <span class="kw">as</span> String<span class="op">:</span> kSecClassGenericPassword<span class="op">,</span></span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>            kSecAttrService <span class="kw">as</span> String<span class="op">:</span> service<span class="op">,</span></span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a>            kSecAttrAccount <span class="kw">as</span> String<span class="op">:</span> account<span class="op">,</span></span>
<span id="cb197-16"><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a>            kSecValueData <span class="kw">as</span> String<span class="op">:</span> data</span>
<span id="cb197-17"><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb197-18"><a href="#cb197-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-19"><a href="#cb197-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">status</span> <span class="op">=</span> SecItemAdd<span class="op">(</span>query <span class="kw">as</span> CFDictionary<span class="op">,</span> <span class="kw">nil</span><span class="op">)</span></span>
<span id="cb197-20"><a href="#cb197-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-21"><a href="#cb197-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> status <span class="op">==</span> errSecDuplicateItem <span class="op">{</span></span>
<span id="cb197-22"><a href="#cb197-22" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update existing item</span></span>
<span id="cb197-23"><a href="#cb197-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">updateQuery</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb197-24"><a href="#cb197-24" aria-hidden="true" tabindex="-1"></a>                kSecClass <span class="kw">as</span> String<span class="op">:</span> kSecClassGenericPassword<span class="op">,</span></span>
<span id="cb197-25"><a href="#cb197-25" aria-hidden="true" tabindex="-1"></a>                kSecAttrService <span class="kw">as</span> String<span class="op">:</span> service<span class="op">,</span></span>
<span id="cb197-26"><a href="#cb197-26" aria-hidden="true" tabindex="-1"></a>                kSecAttrAccount <span class="kw">as</span> String<span class="op">:</span> account</span>
<span id="cb197-27"><a href="#cb197-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">]</span></span>
<span id="cb197-28"><a href="#cb197-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">attributes</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb197-29"><a href="#cb197-29" aria-hidden="true" tabindex="-1"></a>                kSecValueData <span class="kw">as</span> String<span class="op">:</span> data</span>
<span id="cb197-30"><a href="#cb197-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">]</span></span>
<span id="cb197-31"><a href="#cb197-31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">updateStatus</span> <span class="op">=</span> SecItemUpdate<span class="op">(</span>updateQuery <span class="kw">as</span> CFDictionary<span class="op">,</span> attributes <span class="kw">as</span> CFDictionary<span class="op">)</span></span>
<span id="cb197-32"><a href="#cb197-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-33"><a href="#cb197-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> updateStatus <span class="op">==</span> errSecSuccess <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb197-34"><a href="#cb197-34" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throw</span> KeychainError<span class="op">.</span>unknown<span class="op">(</span>updateStatus<span class="op">)</span></span>
<span id="cb197-35"><a href="#cb197-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb197-36"><a href="#cb197-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> status <span class="op">!=</span> errSecSuccess <span class="op">{</span></span>
<span id="cb197-37"><a href="#cb197-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> KeychainError<span class="op">.</span>unknown<span class="op">(</span>status<span class="op">)</span></span>
<span id="cb197-38"><a href="#cb197-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb197-39"><a href="#cb197-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb197-40"><a href="#cb197-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-41"><a href="#cb197-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">retrieve</span><span class="op">(</span><span class="va">service</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">account</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="kw">throws</span> -&gt; <span class="fu">Data</span> <span class="op">{</span></span>
<span id="cb197-42"><a href="#cb197-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb197-43"><a href="#cb197-43" aria-hidden="true" tabindex="-1"></a>            kSecClass <span class="kw">as</span> String<span class="op">:</span> kSecClassGenericPassword<span class="op">,</span></span>
<span id="cb197-44"><a href="#cb197-44" aria-hidden="true" tabindex="-1"></a>            kSecAttrService <span class="kw">as</span> String<span class="op">:</span> service<span class="op">,</span></span>
<span id="cb197-45"><a href="#cb197-45" aria-hidden="true" tabindex="-1"></a>            kSecAttrAccount <span class="kw">as</span> String<span class="op">:</span> account<span class="op">,</span></span>
<span id="cb197-46"><a href="#cb197-46" aria-hidden="true" tabindex="-1"></a>            kSecReturnData <span class="kw">as</span> String<span class="op">:</span> <span class="kw">true</span></span>
<span id="cb197-47"><a href="#cb197-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb197-48"><a href="#cb197-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-49"><a href="#cb197-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> <span class="va">result</span><span class="op">:</span> AnyObject<span class="op">?</span></span>
<span id="cb197-50"><a href="#cb197-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">status</span> <span class="op">=</span> SecItemCopyMatching<span class="op">(</span>query <span class="kw">as</span> CFDictionary<span class="op">,</span> <span class="op">&amp;</span>result<span class="op">)</span></span>
<span id="cb197-51"><a href="#cb197-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-52"><a href="#cb197-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> status <span class="op">==</span> errSecSuccess <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb197-53"><a href="#cb197-53" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> status <span class="op">==</span> errSecItemNotFound <span class="op">?</span> KeychainError<span class="op">.</span>notFound <span class="op">:</span> KeychainError<span class="op">.</span>unknown<span class="op">(</span>status<span class="op">)</span></span>
<span id="cb197-54"><a href="#cb197-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb197-55"><a href="#cb197-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-56"><a href="#cb197-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">data</span> <span class="op">=</span> result <span class="kw">as</span><span class="op">?</span> Data <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb197-57"><a href="#cb197-57" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> KeychainError<span class="op">.</span>invalidData</span>
<span id="cb197-58"><a href="#cb197-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb197-59"><a href="#cb197-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-60"><a href="#cb197-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> data</span>
<span id="cb197-61"><a href="#cb197-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb197-62"><a href="#cb197-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-63"><a href="#cb197-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">delete</span><span class="op">(</span><span class="va">service</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">account</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb197-64"><a href="#cb197-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">query</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb197-65"><a href="#cb197-65" aria-hidden="true" tabindex="-1"></a>            kSecClass <span class="kw">as</span> String<span class="op">:</span> kSecClassGenericPassword<span class="op">,</span></span>
<span id="cb197-66"><a href="#cb197-66" aria-hidden="true" tabindex="-1"></a>            kSecAttrService <span class="kw">as</span> String<span class="op">:</span> service<span class="op">,</span></span>
<span id="cb197-67"><a href="#cb197-67" aria-hidden="true" tabindex="-1"></a>            kSecAttrAccount <span class="kw">as</span> String<span class="op">:</span> account</span>
<span id="cb197-68"><a href="#cb197-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">]</span></span>
<span id="cb197-69"><a href="#cb197-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-70"><a href="#cb197-70" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">status</span> <span class="op">=</span> SecItemDelete<span class="op">(</span>query <span class="kw">as</span> CFDictionary<span class="op">)</span></span>
<span id="cb197-71"><a href="#cb197-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-72"><a href="#cb197-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> status <span class="op">==</span> errSecSuccess <span class="op">||</span> status <span class="op">==</span> errSecItemNotFound <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb197-73"><a href="#cb197-73" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> KeychainError<span class="op">.</span>unknown<span class="op">(</span>status<span class="op">)</span></span>
<span id="cb197-74"><a href="#cb197-74" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb197-75"><a href="#cb197-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb197-76"><a href="#cb197-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="entitlements">17.3 Entitlements</h2>
<h3 id="required-entitlements-for-ai-dj">Required Entitlements for AI
DJ</h3>
<p><strong>What weâ€™re doing:</strong> Configuring app capabilities in
Xcode.</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- AIDJ.entitlements --&gt;</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span> <span class="ot">version=</span><span class="st">&quot;1.0&quot;</span> <span class="ot">encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE</span> <span class="dt">plist</span> PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; ...<span class="dt">&gt;</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">plist</span> <span class="ot">version=</span><span class="st">&quot;1.0&quot;</span>&gt;</span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">dict</span>&gt;</span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- HealthKit access --&gt;</span></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;com.apple.developer.healthkit&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">true</span>/&gt;</span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;com.apple.developer.healthkit.access&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">array</span>&gt;</span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">string</span>&gt;health-records&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">array</span>&gt;</span>
<span id="cb198-13"><a href="#cb198-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-14"><a href="#cb198-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- App Groups for sharing data with widgets and watch --&gt;</span></span>
<span id="cb198-15"><a href="#cb198-15" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;com.apple.security.application-groups&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb198-16"><a href="#cb198-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">array</span>&gt;</span>
<span id="cb198-17"><a href="#cb198-17" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">string</span>&gt;group.com.yourcompany.aidj&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb198-18"><a href="#cb198-18" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">array</span>&gt;</span>
<span id="cb198-19"><a href="#cb198-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-20"><a href="#cb198-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- iCloud for CloudKit sync --&gt;</span></span>
<span id="cb198-21"><a href="#cb198-21" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;com.apple.developer.icloud-container-identifiers&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb198-22"><a href="#cb198-22" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">array</span>&gt;</span>
<span id="cb198-23"><a href="#cb198-23" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">string</span>&gt;iCloud.com.yourcompany.aidj&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb198-24"><a href="#cb198-24" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">array</span>&gt;</span>
<span id="cb198-25"><a href="#cb198-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-26"><a href="#cb198-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Background modes --&gt;</span></span>
<span id="cb198-27"><a href="#cb198-27" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">key</span>&gt;com.apple.developer.background-modes&lt;/<span class="kw">key</span>&gt;</span>
<span id="cb198-28"><a href="#cb198-28" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">array</span>&gt;</span>
<span id="cb198-29"><a href="#cb198-29" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">string</span>&gt;audio&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb198-30"><a href="#cb198-30" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">string</span>&gt;fetch&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb198-31"><a href="#cb198-31" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">string</span>&gt;processing&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb198-32"><a href="#cb198-32" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">array</span>&gt;</span>
<span id="cb198-33"><a href="#cb198-33" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">dict</span>&gt;</span>
<span id="cb198-34"><a href="#cb198-34" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">plist</span>&gt;</span></code></pre></div>
<hr />
<h2 id="key-takeaways---security-privacy">Key Takeaways - Security &amp;
Privacy</h2>
<ol type="1">
<li><strong>Request minimum permissions</strong> - Only what you truly
need</li>
<li><strong>Explain benefits in privacy strings</strong> - â€œTo help you
relaxâ€ not â€œto read dataâ€</li>
<li><strong>Progressive permission requests</strong> - Ask at point of
use, not app launch</li>
<li><strong>Use Keychain for secrets</strong> - Never store tokens in
UserDefaults</li>
<li><strong>Configure entitlements correctly</strong> - HealthKit, App
Groups, Background Modes</li>
<li><strong>App Privacy labels</strong> - Accurately declare data
collection in App Store Connect</li>
</ol>
<hr />
<h1 id="app-distribution-deployment">18. APP DISTRIBUTION &amp;
DEPLOYMENT</h1>
<h2 id="why-this-matters-for-ai-dj-17">Why This Matters for AI DJ</h2>
<p>Building the app is just the beginning. Getting it to users means
navigating TestFlight, App Store Review, and release management.
Understanding this process prevents rejection, enables rapid iteration,
and ensures smooth updates.</p>
<p><strong>In AI DJ, distribution covers:</strong> - TestFlight for beta
testing - App Store submission - Handling review feedback - Managing
releases across platforms</p>
<hr />
<h2 id="build-archive">18.1 Build &amp; Archive</h2>
<h3 id="preparing-for-distribution">Preparing for Distribution</h3>
<p><strong>What weâ€™re doing:</strong> Creating a build ready for
TestFlight or App Store.</p>
<pre><code>In Xcode:
1. Select &quot;Any iOS Device&quot; as destination (not a simulator)
2. Product â†’ Archive
3. Wait for archive to complete
4. Organizer window opens automatically

Archive checklist:
â–¡ Version number updated (CFBundleShortVersionString)
â–¡ Build number incremented (CFBundleVersion)
â–¡ Correct provisioning profile (App Store Distribution)
â–¡ All targets building successfully
â–¡ No warnings in release configuration</code></pre>
<hr />
<h3 id="automatic-version-numbering">Automatic Version Numbering</h3>
<div class="sourceCode" id="cb200"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In Build Settings, you can use scripts to auto-increment</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Build Phase Script (Run Script):</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Automatically increment build number</span></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>buildNumber<span class="op">=</span>$<span class="op">(/</span>usr<span class="op">/</span>libexec<span class="op">/</span>PlistBuddy <span class="op">-</span>c <span class="st">&quot;Print CFBundleVersion&quot;</span> <span class="st">&quot;</span><span class="ss">${</span>PROJECT_DIR<span class="ss">}</span><span class="st">/</span><span class="ss">${</span>INFOPLIST_FILE<span class="ss">}</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>buildNumber<span class="op">=</span>$<span class="op">((</span>$buildNumber <span class="op">+</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a><span class="op">/</span>usr<span class="op">/</span>libexec<span class="op">/</span>PlistBuddy <span class="op">-</span>c <span class="st">&quot;Set :CFBundleVersion </span><span class="ss">$buildNumber</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="ss">${</span>PROJECT_DIR<span class="ss">}</span><span class="st">/</span><span class="ss">${</span>INFOPLIST_FILE<span class="ss">}</span><span class="st">&quot;</span></span></code></pre></div>
<hr />
<h2 id="testflight">18.2 TestFlight</h2>
<h3 id="uploading-to-testflight">Uploading to TestFlight</h3>
<p><strong>What weâ€™re doing:</strong> Distributing beta builds to
testers.</p>
<pre><code>1. In Organizer, select your archive
2. Click &quot;Distribute App&quot;
3. Choose &quot;App Store Connect&quot;
4. Choose &quot;Upload&quot;
5. Follow prompts (signing, symbols, etc.)
6. Wait for upload and processing (~15-30 minutes)

In App Store Connect:
1. Go to TestFlight tab
2. Wait for build to finish processing
3. Add testers (internal or external)
4. Submit for Beta App Review (external only)</code></pre>
<hr />
<h3 id="managing-test-groups">Managing Test Groups</h3>
<pre><code>Internal Testers:
- Up to 100 Apple Developer team members
- No review required
- Immediate access after processing

External Testers:
- Up to 10,000 users
- Requires Beta App Review (usually 24-48 hours)
- Invite via email or public link
- Can create multiple groups (e.g., &quot;Early Adopters&quot;, &quot;Bug Hunters&quot;)

Test Information:
- What to Test: &quot;Try creating a workout playlist and monitor how songs change with your heart rate&quot;
- App Description: Brief for testers
- Feedback Email: Where bug reports go</code></pre>
<hr />
<h2 id="app-store-submission">18.3 App Store Submission</h2>
<h3 id="app-store-connect-setup">App Store Connect Setup</h3>
<p><strong>What weâ€™re doing:</strong> Preparing the App Store
listing.</p>
<pre><code>App Information:
â”œâ”€â”€ Name: AI DJ - Biometric Music
â”œâ”€â”€ Subtitle: Music that matches your mood
â”œâ”€â”€ Primary Category: Music
â”œâ”€â”€ Secondary Category: Health &amp; Fitness
â”œâ”€â”€ Privacy Policy URL: Required for HealthKit apps
â”œâ”€â”€ Age Rating: 4+ (no objectionable content)
â””â”€â”€ Copyright: Â© 2026 Your Company

App Privacy:
â”œâ”€â”€ Data Used to Track You: None (ideally)
â”œâ”€â”€ Data Linked to You:
â”‚   â”œâ”€â”€ Health &amp; Fitness (heart rate, HRV)
â”‚   â””â”€â”€ Usage Data (song play history)
â””â”€â”€ Data Not Linked to You:
    â””â”€â”€ Diagnostics

Pricing:
â”œâ”€â”€ Price: Free (or price tier)
â”œâ”€â”€ In-App Purchases: (if applicable)
â””â”€â”€ Availability: All territories or specific

Screenshots (required for each device size):
â”œâ”€â”€ iPhone 6.7&quot; (1290 Ã— 2796)
â”œâ”€â”€ iPhone 6.5&quot; (1284 Ã— 2778)
â”œâ”€â”€ iPhone 5.5&quot; (1242 Ã— 2208)
â”œâ”€â”€ iPad Pro 12.9&quot; (2048 Ã— 2732)
â””â”€â”€ Apple Watch (varies by size)

App Preview Videos: Optional but recommended</code></pre>
<hr />
<h3 id="common-review-rejections-and-how-to-avoid">Common Review
Rejections and How to Avoid</h3>
<div class="sourceCode" id="cb204"><pre class="sourceCode swift"><code class="sourceCode swift"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 1. Guideline 2.1 - App Completeness</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Problem: Crashes, placeholder content, broken features</span></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Solution: Test thoroughly, use TestFlight first</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a><span class="co">// 2. Guideline 4.2 - Minimum Functionality</span></span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Problem: App doesn&#39;t do enough, or is just a website wrapper</span></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Solution: Ensure unique native functionality</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a><span class="co">// 3. Guideline 5.1.1 - Data Collection and Privacy</span></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Problem: Collecting data without clear purpose or consent</span></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Solution:</span></span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> HealthPermissionView<span class="op">:</span> <span class="dt">View</span> <span class="op">{</span></span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> <span class="va">body</span><span class="op">:</span> some View <span class="op">{</span></span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a>        VStack <span class="op">{</span></span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span><span class="st">&quot;Why we need health access&quot;</span><span class="op">)</span></span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>font<span class="op">(.</span>headline<span class="op">)</span></span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>            Text<span class="op">(</span><span class="st">&quot;AI DJ reads your heart rate in real-time to select music that helps you relax or energize. This data never leaves your device.&quot;</span><span class="op">)</span></span>
<span id="cb204-18"><a href="#cb204-18" aria-hidden="true" tabindex="-1"></a>            Button<span class="op">(</span><span class="st">&quot;Allow Access&quot;</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb204-19"><a href="#cb204-19" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Request permission</span></span>
<span id="cb204-20"><a href="#cb204-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb204-21"><a href="#cb204-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb204-22"><a href="#cb204-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb204-23"><a href="#cb204-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb204-24"><a href="#cb204-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-25"><a href="#cb204-25" aria-hidden="true" tabindex="-1"></a><span class="co">// 4. Guideline 2.3.3 - Accurate Screenshots</span></span>
<span id="cb204-26"><a href="#cb204-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Problem: Screenshots don&#39;t match app functionality</span></span>
<span id="cb204-27"><a href="#cb204-27" aria-hidden="true" tabindex="-1"></a><span class="co">// Solution: Use actual app screenshots, not mockups</span></span>
<span id="cb204-28"><a href="#cb204-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-29"><a href="#cb204-29" aria-hidden="true" tabindex="-1"></a><span class="co">// 5. Guideline 4.0 - Design</span></span>
<span id="cb204-30"><a href="#cb204-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Problem: Poor user experience, confusing navigation</span></span>
<span id="cb204-31"><a href="#cb204-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Solution: Follow Human Interface Guidelines</span></span></code></pre></div>
<hr />
<h3 id="responding-to-rejections">Responding to Rejections</h3>
<pre><code>If rejected:
1. Read the rejection reason carefully
2. Don&#39;t argue - understand their concern
3. Fix the issue
4. Reply in Resolution Center explaining your fix
5. Resubmit for review

Common resolution strategies:
- Add demo mode if login required
- Improve permission request explanations
- Fix crashes (check crash logs in Organizer)
- Add missing privacy policy
- Remove misleading marketing claims</code></pre>
<hr />
<h2 id="release-management">18.4 Release Management</h2>
<h3 id="phased-releases">Phased Releases</h3>
<p><strong>What weâ€™re doing:</strong> Gradually rolling out updates to
catch issues.</p>
<pre><code>App Store Connect â†’ App Store â†’ Version â†’ Phased Release

Phased Release Schedule:
Day 1: 1% of users
Day 2: 2% of users
Day 3: 5% of users
Day 4: 10% of users
Day 5: 20% of users
Day 6: 50% of users
Day 7: 100% of users

Benefits:
- Catch issues before affecting everyone
- Can pause or halt if problems arise
- Users can still manually update if eager

Monitoring during rollout:
- Watch crash reports in Xcode Organizer
- Monitor App Store reviews
- Check analytics for engagement drops</code></pre>
<hr />
<h3 id="multi-platform-releases">Multi-Platform Releases</h3>
<p><strong>What weâ€™re doing:</strong> Coordinating iOS, watchOS, and
macOS releases.</p>
<pre><code>For AI DJ:
1. iOS app is primary - submit first
2. watchOS app is bundled with iOS (same submission)
3. macOS is separate app record

Best practice:
- Keep version numbers aligned across platforms
- Test Watch features with iOS app together
- Submit macOS separately but coordinate timing

In App Store Connect:
- iOS + watchOS: One app record, both platforms in same submission
- macOS: Separate app record, can share iCloud container</code></pre>
<hr />
<h2 id="key-takeaways---distribution">Key Takeaways - Distribution</h2>
<ol type="1">
<li><strong>Archive from â€œAny iOS Deviceâ€</strong> - Not simulator</li>
<li><strong>Use TestFlight extensively</strong> - Catch issues before
public release</li>
<li><strong>Prepare app metadata early</strong> - Screenshots,
descriptions, privacy labels</li>
<li><strong>Read rejection reasons carefully</strong> - Understand,
donâ€™t argue</li>
<li><strong>Use phased releases</strong> - Protect users from widespread
bugs</li>
<li><strong>Keep platforms in sync</strong> - Coordinate iOS, watchOS,
macOS releases</li>
</ol>
<hr />
<h1 id="conclusion">Conclusion</h1>
<p>Youâ€™ve now covered everything needed to build AI DJ:</p>
<ol type="1">
<li><strong>Swift Fundamentals</strong> - The language powering it
all</li>
<li><strong>Xcode</strong> - Your development environment</li>
<li><strong>SwiftUI</strong> - Building the user interface</li>
<li><strong>Concurrency</strong> - Handling async operations</li>
<li><strong>CoreData</strong> - Persisting learning data</li>
<li><strong>Architecture</strong> - Organizing code properly</li>
<li><strong>MusicKit</strong> - Accessing Apple Music</li>
<li><strong>HealthKit</strong> - Reading biometrics</li>
<li><strong>watchOS</strong> - The sensor on the wrist</li>
<li><strong>WatchConnectivity</strong> - Bridging Watch and iPhone</li>
<li><strong>macOS</strong> - Menu bar companion</li>
<li><strong>Background Processing</strong> - Keeping music playing</li>
<li><strong>Widgets</strong> - Glanceable info</li>
<li><strong>Biometrics</strong> - Understanding the data</li>
<li><strong>Algorithms</strong> - The scoring brain</li>
<li><strong>Testing</strong> - Ensuring quality</li>
<li><strong>Security</strong> - Protecting user data</li>
<li><strong>Distribution</strong> - Getting it to users</li>
</ol>
<p>Now go build something amazing.</p>
<hr />
<p><em>Last Updated: 2026-02-06</em></p>
</body>
</html>
